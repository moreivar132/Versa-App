(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function a(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=a(r);fetch(r.href,o)}})();const Se="versa_auth_store_v1",_e=["admin","empleado"],K=Object.freeze({email:"admin@versa.com",name:"Administrador Versa",role:"admin",password:"VersaAdmin#2024"}),Te=Object.freeze([Object.freeze({email:"ivan.moreno@goversa.es",name:"Iván Moreno",role:"admin",password:"1523699292",metadata:Object.freeze({createdBy:"seed:default"})}),Object.freeze({email:"rafael.quintero@goversa.es",name:"Rafael Quintero",role:"admin",password:"1234567891",metadata:Object.freeze({createdBy:"seed:default"})}),Object.freeze({email:"moreivar132@gmail.com",name:"Empleado Moreivar",role:"empleado",password:"1515151515",metadata:Object.freeze({createdBy:"seed:default"})})]),xe=new TextEncoder,q=window.crypto||window.msCrypto;if(!q||!q.subtle)throw new Error("Este navegador no soporta las primitivas criptográficas necesarias.");const U={store:null,initialized:!1};function X(){return new Date().toISOString()}function ue(t){const e=new Uint8Array(t);let a="";for(let n=0;n<e.byteLength;n+=1)a+=String.fromCharCode(e[n]);return btoa(a)}function me(t=16){const e=new Uint8Array(t);return q.getRandomValues(e),e}function Re(t=24){const e="ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz0123456789@$&#!?",a=me(t);let n="";for(let r=0;r<t;r+=1)n+=e[a[r]%e.length];return n}function re(t){return(t||"").trim().toLowerCase()}function j(){if(U.store)return U.store;const t=localStorage.getItem(Se);if(!t)return U.store={users:[],accessLogs:[]},U.store;try{const e=JSON.parse(t);(!e.users||!Array.isArray(e.users))&&(e.users=[]),(!e.accessLogs||!Array.isArray(e.accessLogs))&&(e.accessLogs=[]),U.store=e}catch(e){console.warn("UserStore: no se pudo parsear el almacenamiento, se reinicia.",e),U.store={users:[],accessLogs:[]}}return U.store}function k(){const t=JSON.stringify(U.store);localStorage.setItem(Se,t)}async function fe(t,e){if(!t)throw new Error("Se requiere una clave para generar el hash.");const a=xe.encode(`${e}:${t}`),n=await q.subtle.digest("SHA-256",a);return ue(n)}function H(t){return{email:t.email,name:t.name,role:t.role,createdAt:t.createdAt,updatedAt:t.updatedAt,lastLoginAt:t.lastLoginAt||null}}function Ae(t){if(!_e.includes(t))throw new Error('Rol no válido. Usa "admin" o "empleado".')}function Z(t){const e=re(t);return e&&j().users.find(a=>a.normalizedEmail===e)||null}function Ie(t){const{users:e}=j();if(e.filter(n=>n.role==="admin").length===0)throw new Error(t||"Debe existir al menos un administrador.")}async function De(){const t=j(),e=new Set(t.users.map(r=>r.normalizedEmail)),a=[{email:K.email,name:K.name,role:K.role,password:K.password,metadata:{createdBy:"seed:default"}},...Te.map(r=>({email:r.email,name:r.name,role:r.role,password:r.password,metadata:{...r.metadata||{}}}))],n=[];for(const r of a){const o=re(r.email);!o||e.has(o)||(await Le({email:r.email,name:r.name,role:r.role,password:r.password,skipDuplicateCheck:!0,metadata:{...r.metadata||{},seed:!0}}),e.add(o),n.push(r.email.trim()))}n.length>0&&console.info("UserStore: se inicializaron cuentas predeterminadas.",n)}async function Le({email:t,name:e="",role:a="empleado",password:n,skipDuplicateCheck:r=!1,metadata:o={}}){const c=re(t);if(!c)throw new Error("El email es obligatorio.");if(Ae(a),!n||n.length<10)throw new Error("La contraseña debe tener al menos 10 caracteres.");if(!r&&Z(c))throw new Error("Ya existe un usuario con ese email.");const i=ue(me(16)),u=await fe(n,i),m=X(),h={id:o.id||(q.randomUUID?q.randomUUID():`user-${Date.now()}`),email:t.trim(),normalizedEmail:c,name:e.trim(),role:a,salt:i,passwordHash:u,createdAt:m,updatedAt:m,lastLoginAt:null,metadata:o};return j().users.push(h),k(),H(h)}async function Ue(t,e){const a=Z(t);if(!a)throw new Error("Credenciales inválidas.");if(!e)throw new Error("Introduce tu contraseña.");if(await fe(e,a.salt)!==a.passwordHash)throw new Error("Credenciales inválidas.");return a.lastLoginAt=X(),k(),H(a)}function Ve(t){const e=Z(t);return e?H(e):null}function ke(){return j().users.slice().sort((t,e)=>t.email.localeCompare(e.email)).map(H)}async function Pe(t,e){Ae(e);const a=Z(t);if(!a)throw new Error("Usuario no encontrado.");const n=a.role;a.role=e,a.updatedAt=X(),k();try{Ie("No puedes dejar al sistema sin administradores.")}catch(r){throw a.role=n,a.updatedAt=X(),k(),r}return H(a)}async function je(t,e){if(!e||e.length<10)throw new Error("La nueva contraseña debe tener al menos 10 caracteres.");const a=Z(t);if(!a)throw new Error("Usuario no encontrado.");const n=ue(me(16)),r=await fe(e,n);return a.salt=n,a.passwordHash=r,a.updatedAt=X(),k(),H(a)}async function Be(t){const e=re(t),a=j(),n=a.users.findIndex(o=>o.normalizedEmail===e);if(n===-1)throw new Error("Usuario no encontrado.");const[r]=a.users.splice(n,1);k();try{Ie("No puedes eliminar al último administrador.")}catch(o){throw a.users.splice(n,0,r),k(),o}return!0}function qe(t=16){return t<10&&(t=10),Re(t)}async function He(){return U.initialized||(j(),await De(),U.initialized=!0),te}const te=Object.freeze({init:He,authenticate:Ue,createUser:Le,listUsers:ke,getUser:Ve,changeRole:Pe,resetPassword:je,deleteUser:Be,generateSecurePassword:qe,DEFAULT_ADMIN:K}),x=te;window.UserStore=te;async function We(){var Y,ee;const t=location.pathname.endsWith("login.html")||location.href.endsWith("login.html");function e(f){const w=document.getElementById("loginError");if(w){if(!f){w.hidden=!0,w.textContent="";return}w.hidden=!1,w.textContent=f}}try{await x.init()}catch(f){console.error("No se pudo inicializar el almacén de usuarios.",f),t?e("Este navegador no soporta el módulo de seguridad necesario."):(alert("No se pudo validar tu sesión de forma segura. Vuelve a iniciar sesión."),location.href="login.html");return}if(t){const f=document.getElementById("loginForm");if(!f)return;f.addEventListener("submit",async w=>{w.preventDefault(),e("");const M=document.getElementById("email").value.trim(),z=document.getElementById("password").value;if(!M||!z){e("Completa tu email y contraseña.");return}try{const N=await x.authenticate(M,z);localStorage.setItem("userEmail",N.email),localStorage.setItem("userRole",N.role),localStorage.setItem("userName",N.name||""),location.href="index.html"}catch(N){e(N.message||"No se pudo iniciar sesión.")}});return}function a(){localStorage.removeItem("userEmail"),localStorage.removeItem("userRole"),localStorage.removeItem("userName"),location.href="login.html"}const n=localStorage.getItem("userEmail")||"";if(!n){a();return}const r=x.getUser(n);if(!r){a();return}localStorage.setItem("userRole",r.role),localStorage.setItem("userName",r.name||"");const c=`${r.name||r.email} · ${r.role}`,i=document.getElementById("userInfo");i&&(i.textContent=c);const u=document.getElementById("mobileUserInfo");u&&(u.textContent=c),(Y=document.body)==null||Y.setAttribute("data-user-role",r.role),document.querySelectorAll('[data-requires="admin"]').forEach(f=>{f.style.display=r.role==="admin"?"":"none"});const m=Array.from(document.querySelectorAll(".navlink")),h=["dashboard","facturas","admin"],v=new Map(h.map(f=>{const w=document.querySelector(`[data-view="${f}"]`)||document.getElementById(f);return[f,w||null]}).filter(([,f])=>!!f));function _(f){m.forEach(w=>{const M=(w.getAttribute("href")||"").replace("#","");if(!M)return;const z=M===f;z?w.setAttribute("aria-current","page"):w.removeAttribute("aria-current"),w.classList.toggle("active",z)})}const A=h.filter(f=>v.has(f));function I(f){var M;const w=v.has(f)?f:A[0];v.forEach((z,N)=>{if(!z)return;const ve=N===w;z.style.display=ve?"":"none",ve?z.removeAttribute("hidden"):z.setAttribute("hidden","")}),_(w||f),(M=document.body)==null||M.setAttribute("data-current-view",w||f)}function b(f){if(!A.length)return f;const w=A.includes("dashboard")?"dashboard":A[0],M=A.includes("facturas")?"facturas":A[0],z=r.role==="admin"?w:M,N=f||z;return A.includes(N)?N!=="facturas"&&r.role!=="admin"&&A.includes("facturas")?"facturas":N!=="facturas"&&r.role!=="admin"&&z||N:z||N}window.addEventListener("hashchange",()=>{const f=b(location.hash.replace("#",""));I(f),d()&&O()}),I(b(location.hash.replace("#","")));const S=document.getElementById("mobileMenuBtn"),l=document.getElementById("mobileNavOverlay"),p=document.getElementById("mobileNavPanel"),g=document.getElementById("mobileNavClose"),$='a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])';let C=null;const d=()=>(l==null?void 0:l.getAttribute("aria-hidden"))==="false";function E(f){if(!d())return;if(f.key==="Escape"){f.preventDefault(),O();return}if(f.key!=="Tab"||!p)return;const w=Array.from(p.querySelectorAll($)).filter(N=>!N.hasAttribute("disabled"));if(!w.length)return;const M=w[0],z=w[w.length-1];f.shiftKey?document.activeElement===M&&(f.preventDefault(),z.focus()):document.activeElement===z&&(f.preventDefault(),M.focus())}function D(){!l||!p||d()||(C=document.activeElement instanceof HTMLElement?document.activeElement:null,l.setAttribute("aria-hidden","false"),document.body.classList.add("nav-open"),S==null||S.setAttribute("aria-expanded","true"),requestAnimationFrame(()=>{const f=p.querySelector($);f instanceof HTMLElement?f.focus():p.focus()}),document.addEventListener("keydown",E))}function O(){l&&(d()||(l.setAttribute("aria-hidden","true"),document.body.classList.remove("nav-open"),S==null||S.setAttribute("aria-expanded","false"),document.removeEventListener("keydown",E),C?(C.focus(),C=null):S==null||S.focus()))}S==null||S.addEventListener("click",()=>{d()?O():D()}),g==null||g.addEventListener("click",O),l==null||l.addEventListener("click",f=>{f.target===l&&O()}),m.forEach(f=>{f.addEventListener("click",()=>{d()&&setTimeout(O,150)})}),(ee=document.getElementById("btnLogout"))==null||ee.addEventListener("click",a)}We();async function Ye(){var S;await x.init();const t=document.getElementById("userList"),e=document.getElementById("createUserForm");if(!t||!e||((S=document.body)==null?void 0:S.getAttribute("data-user-role"))!=="admin")return;const n=document.getElementById("adminFeedback"),r=document.getElementById("adminGeneratedSecret"),o=r==null?void 0:r.querySelector(".generated-secret__value"),c=document.getElementById("newUserPassword"),i=document.getElementById("btnGeneratePassword"),u=(localStorage.getItem("userEmail")||"").trim().toLowerCase(),m=(l="")=>`${l}`.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");function h(l,p="info"){if(n){if(!l){n.textContent="",n.dataset.variant="",n.hidden=!0;return}n.textContent=l,n.dataset.variant=p,n.hidden=!1}}function v(l){if(!(!r||!o)){if(!l){r.hidden=!0,o.textContent="";return}o.textContent=l,r.hidden=!1}}function _(l){return l==="admin"?"Administrador":"Empleado"}function A(l){if(!l)return"—";const p=new Date(l);return Number.isNaN(p.getTime())?l:p.toLocaleString("es-ES",{dateStyle:"medium",timeStyle:"short"})}function I(){t.setAttribute("aria-busy","true");const l=x.listUsers();if(!l.length){t.innerHTML='<p class="helper-text">Aún no hay usuarios registrados.</p>',t.setAttribute("aria-busy","false");return}const p=l.map(g=>{const C=g.email.trim().toLowerCase()===u,d=`
          <option value="empleado"${g.role==="empleado"?" selected":""}>Empleado</option>
          <option value="admin"${g.role==="admin"?" selected":""}>Administrador</option>`;return`
          <article class="user-card" data-email="${m(g.email)}">
            <header class="user-card__header">
              <div>
                <strong>${m(g.name||g.email)}</strong>
                <p class="helper-text">${m(g.email)}</p>
              </div>
              <span class="badge ${g.role==="admin"?"badge--accent":"badge--subtle"}">${_(g.role)}</span>
            </header>
            <dl class="user-card__meta">
              <div>
                <dt>Creado</dt>
                <dd>${m(A(g.createdAt))}</dd>
              </div>
              <div>
                <dt>Último acceso</dt>
                <dd>${m(A(g.lastLoginAt))}</dd>
              </div>
            </dl>
            <div class="user-card__actions">
              <label class="user-card__role">
                <span>Rol</span>
                <select class="input" data-action="change-role" ${C?"disabled":""}>
                  ${d}
                </select>
              </label>
              <button type="button" class="btn btn-dark btn-sm" data-action="reset-password">
                Restablecer contraseña
              </button>
              <button type="button" class="btn btn-ghost btn-sm" data-action="delete-user" ${C?"disabled":""}>
                Revocar acceso
              </button>
            </div>
          </article>`}).join("");t.innerHTML=p,t.setAttribute("aria-busy","false")}function b(l){const p=l.closest(".user-card");return p?p.getAttribute("data-email"):""}i==null||i.addEventListener("click",()=>{const l=x.generateSecurePassword();c&&(c.value=l,c.focus(),c.select()),v(l),h("Se generó una contraseña robusta. Copia y compártela de forma segura.","info")}),e.addEventListener("submit",async l=>{l.preventDefault();const p=new FormData(e),g=(p.get("email")||"").toString().trim(),$=(p.get("name")||"").toString().trim(),C=(p.get("role")||"empleado").toString(),d=(p.get("password")||"").toString();if(!g||!d){h("Completa los campos obligatorios para crear la cuenta.","error");return}try{await x.createUser({email:g,name:$,role:C,password:d}),I(),e.reset(),v(d),h(`Cuenta creada para ${g}. Recuerda compartir la contraseña mostrada una sola vez.`,"success")}catch(E){h(E.message||"No se pudo crear el usuario.","error")}}),t.addEventListener("change",async l=>{const p=l.target.closest('[data-action="change-role"]');if(!p)return;const g=b(p),$=p.value;try{await x.changeRole(g,$),h(`El rol de ${g} ahora es ${_($)}.`,"success"),I()}catch(C){h(C.message||"No se pudo actualizar el rol.","error"),I()}}),t.addEventListener("click",async l=>{const p=l.target;if(!(p instanceof HTMLElement))return;const g=p.getAttribute("data-action");if(!g)return;const $=b(p);if($){if(g==="reset-password"){const C=x.generateSecurePassword();try{await x.resetPassword($,C),v(C),h(`Contraseña restablecida para ${$}. Comunica la nueva clave de inmediato.`,"success")}catch(d){h(d.message||"No se pudo restablecer la contraseña.","error")}return}if(g==="delete-user"){if(!window.confirm(`¿Seguro que deseas revocar el acceso de ${$}?`))return;try{await x.deleteUser($),h(`Se revocó el acceso de ${$}.`,"success"),I()}catch(d){h(d.message||"No se pudo revocar el acceso.","error")}}}}),I()}Ye();const Ke=Object.freeze(["Ingreso","Egreso"]),oe=["Tarjeta","Transferencia","Efectivo"],pe=["Combustible","Mantenimiento","Recambios","Seguros","Alquiler","Nóminas","Suscripciones","Impuestos","Servicios externos","Ventas","Reparaciones","Electricidad / Agua / Luz","Publicidad","Herramientas / Equipos","Otros"],L=Object.freeze({descripcion:"",area:"",naturaleza:"Egreso",metodoPago:"Tarjeta",categoria:"Otros",fecha:"",subtotal:"",iva:"",total:"",notas:""}),ge=Object.freeze({descripcion:"Descripción",area:"Área",naturaleza:"Naturaleza",metodoPago:"Método de pago",categoria:"Categoría",fecha:"Fecha",subtotal:"Subtotal",iva:"IVA",total:"Total",notas:"Notas"}),Ge=Object.freeze({descripcion:["descripcion","descripción","description","detalle","concepto"],area:["area","área","departamento","unidad"],naturaleza:["naturaleza","tipo","tipomovimiento"],metodoPago:["metodopago","metodo_pago","metodo-de-pago","pago","forma_pago"],categoria:["categoria","categoría","rubro"],fecha:["fecha","fechaemision","fechafactura","fecha_documento","date"],subtotal:["subtotal","neto","importe","base"],iva:["iva","impuesto","tax"],total:["total","monto","importe_total","totalfactura"],notas:["notas","comentarios","observaciones","notes"]}),be=["descripcion","area"],se=5,Je=["descripcion","area","naturaleza","fecha","total"];function V(){return{entries:[],filename:"",headers:[],columns:{},error:null,missingRequired:[],missingOptional:[],detectedFields:[],skippedRows:[],delimiter:",",file:null}}const s={files:[],sending:!1,MAX_FILES:50,MAX_MB:50,intakeMode:"files",csvImport:V()},y=t=>document.querySelector(t),Xe=t=>{if(!t&&t!==0)return"";const e=["B","KB","MB","GB"];let a=0;for(;t>1024&&a<e.length-1;)t/=1024,a++;return`${t.toFixed(1)} ${e[a]}`},G=(t="")=>`${t}`.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),F=t=>t==null?"":`${t}`.replace(/^\uFEFF/,"").trim(),Qe=t=>F(t).normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").replace(/[^a-z0-9]+/gi,"").toLowerCase(),le=(t=[])=>t.map(e=>ge[e]||e).join(", "),Ze=(t="")=>{const e=F(t);if(!e)return",";const a={",":(e.match(/,/g)||[]).length,";":(e.match(/;/g)||[]).length,"	":(e.match(/\t/g)||[]).length};let n=",",r=a[n];return Object.entries(a).forEach(([o,c])=>{c>r&&(n=o,r=c)}),r===0?",":n},et=(t="",e=",")=>{const a=[];let n="",r=[],o=!1;for(let c=0;c<t.length;c+=1){const i=t[c];if(i==='"'){o&&t[c+1]==='"'?(n+='"',c+=1):o=!o;continue}if(i===e&&!o){r.push(F(n)),n="";continue}if((i===`
`||i==="\r")&&!o){i==="\r"&&t[c+1]===`
`&&(c+=1),r.push(F(n)),a.push(r),r=[],n="";continue}n+=i}return(n.length||r.length)&&(r.push(F(n)),a.push(r)),a.map(c=>[...c]).filter(c=>c.some(i=>F(i)))},$e=(t,e=[])=>{const a=F(t);return a?e.find(r=>r.toLowerCase()===a.toLowerCase())||a:""},J=(t,e=[],a="")=>{const n=$e(t,e);return n&&e.find(o=>o.toLowerCase()===n.toLowerCase())||a},Ce=(t,e=L.categoria)=>{const a=F(t);if(!a)return e;const n=a.toLowerCase().replace(/[^a-z0-9]+/g,"");return n==="repuestos"||n==="recambios"?"Recambios":n==="otrascosas"?"Otros":J(a,pe,e)||e},P=(t={})=>{const e={...t};return e.descripcion=F(e.descripcion||L.descripcion),e.area=J(e.area||L.area,AREA_OPTIONS),e.naturaleza=J(e.naturaleza||L.naturaleza,Ke,L.naturaleza),e.metodoPago=J(e.metodoPago||L.metodoPago,oe,L.metodoPago),e.categoria=Ce(e.categoria||L.categoria),e.fecha=ze(e.fecha||L.fecha),e.subtotal=B(e.subtotal||L.subtotal),e.iva=B(e.iva||L.iva),e.total=B(e.total||L.total),e.notas=F(e.notas||L.notas),e},tt=t=>{const e=F(t).toLowerCase();return e==="ingreso"?"Ingreso":e==="egreso"||e==="gasto"?"Egreso":e?e.charAt(0).toUpperCase()+e.slice(1):L.naturaleza},B=t=>{const e=F(t);if(!e)return"";const a=e.replace(/\s+/g,"").replace(/,/g,"."),n=Number(a);return Number.isNaN(n)?e:n.toFixed(2)},ze=t=>{const e=F(t);if(!e)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const a=e.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);if(a){const[,r,o,c]=a;return`${c}-${o}-${r}`}const n=new Date(e);if(!Number.isNaN(n.getTime())){const r=String(n.getMonth()+1).padStart(2,"0"),o=String(n.getDate()).padStart(2,"0");return`${n.getFullYear()}-${r}-${o}`}return e},at=(t="")=>{const e=t??"",n=e.split(/\r?\n/).find(c=>F(c)),r=Ze(n||"");return{rows:et(e,r),delimiter:r}},nt=(t=[],e=",")=>{if(!Array.isArray(t)||t.length===0)return{...V(),error:"El CSV está vacío o no tiene datos.",delimiter:e};const a=t[0].map(v=>F(v));if(!a.length)return{...V(),error:"No se pudieron detectar encabezados en el CSV.",delimiter:e};const n={};a.forEach((v,_)=>{const A=Qe(v);Object.entries(Ge).forEach(([I,b])=>{n[I]===void 0&&b.includes(A)&&(n[I]=_)})});const r=Object.keys(n),o=be.filter(v=>n[v]===void 0),i=Object.keys(ge).filter(v=>!be.includes(v)).filter(v=>n[v]===void 0);if(o.length)return{...V(),delimiter:e,headers:a,columns:n,missingRequired:o,missingOptional:i,detectedFields:r,error:`El CSV debe incluir las columnas obligatorias: ${le(o)}.`};const u=[],m=[];if(t.slice(1).forEach((v,_)=>{const A=a.map((p,g)=>F(v[g]??""));if(!Object.values(n).some(p=>F(A[p])))return;const b={...L},S=_+2,l=p=>{const g=n[p];return g===void 0?"":A[g]??""};if(b.descripcion=l("descripcion")||"",!b.descripcion){m.push(S);return}if(n.area!==void 0){const p=J(l("area"),AREA_OPTIONS);b.area=p||b.area}if(!b.area){m.push(S);return}if(n.naturaleza!==void 0&&(b.naturaleza=tt(l("naturaleza"))),n.metodoPago!==void 0){const p=$e(l("metodoPago"),oe);b.metodoPago=p||b.metodoPago}n.categoria!==void 0&&(b.categoria=Ce(l("categoria"),b.categoria)),n.fecha!==void 0&&(b.fecha=ze(l("fecha"))),n.subtotal!==void 0&&(b.subtotal=B(l("subtotal"))),n.iva!==void 0&&(b.iva=B(l("iva"))),n.total!==void 0&&(b.total=B(l("total"))),n.notas!==void 0&&(b.notas=l("notas")),u.push(b)}),!u.length){const v=m.length?`No se encontraron filas válidas en el CSV. Filas sin descripción: ${m.join(", ")}.`:"No se encontraron filas con datos en el CSV.";return{...V(),delimiter:e,headers:a,columns:n,missingRequired:o,missingOptional:i,detectedFields:r,skippedRows:m,error:v}}return{entries:u,filename:"",headers:a,columns:n,missingRequired:o,missingOptional:i,detectedFields:r,skippedRows:m,delimiter:e,error:null}},Fe=t=>{if(!t&&t!==0)return"";const e=t instanceof Date?t.toISOString():`${t}`.trim();if(!e)return"";const a=e.match(/^(\d{4})-(\d{2})-(\d{2})(?:$|T)/);if(a){const[,r,o,c]=a;return`${c}/${o}/${r}`}const n=new Date(e);if(!Number.isNaN(n.getTime())){const r=String(n.getUTCDate()).padStart(2,"0"),o=String(n.getUTCMonth()+1).padStart(2,"0"),c=n.getUTCFullYear();return`${r}/${o}/${c}`}return e},ie=(t={})=>{if(!t||typeof t!="object")return t;const e={...t};if(e.fecha){const a=Fe(e.fecha);a&&a!==e.fecha&&(e.fechaISO=e.fecha,e.fecha=a)}return e},Ee={default:[],info:["text-orange-400","font-semibold"],success:["text-emerald-400","font-semibold"],error:["text-red-400","font-semibold"]};function R(t,e="default"){const a=y("#status");if(!a)return;const n=["helper-text","transition-colors","duration-150"];a.className=n.join(" "),(Ee[e]||Ee.default).forEach(o=>a.classList.add(o)),a.textContent=t}function he(){const t={...L},e=document.getElementById("metaForm");if(!e)return t;try{const a=Object.fromEntries(new FormData(e));return P({...t,...a})}catch{return{...t}}}function Oe(t){if(!t)return!1;const e=a=>(a??"").toString().trim();return!!(e(t.descripcion)||e(t.fecha)||["subtotal","iva","total","notas"].some(a=>e(t[a]))||["area","naturaleza","metodoPago","categoria"].some(a=>{const n=e(t[a]),r=e(L[a]);return n&&n!==r}))}function T(){var m;const t=y("#btnEnviar");if(!t)return;const e=s.files.length>0,a=Array.isArray((m=s.csvImport)==null?void 0:m.entries)&&s.csvImport.entries.length>0&&!s.csvImport.error,n=he(),r=Oe(n),o=!!(n.descripcion&&n.descripcion.toString().trim()),c=!!(n.area&&n.area.toString().trim()),i=s.files.some(h=>!P(h.meta).area)&&!c;let u=s.sending;u||(s.intakeMode==="manual"?u=!o||!r||!c:u=!e&&!a||i),t.disabled=u,s.sending?t.textContent="Enviando…":s.intakeMode==="manual"&&!o?t.textContent="Añade la descripción":s.intakeMode==="manual"&&!c?t.textContent="Selecciona el área":s.intakeMode==="manual"&&!r?t.textContent="Completa los datos":i?t.textContent="Selecciona el área de cada archivo":!e&&a?t.textContent="Enviar metadatos CSV":e?t.textContent="Enviar":t.textContent="Añade archivos o CSV"}function rt(t){const e=(t.name||"").toLowerCase(),a=(t.type||"").toLowerCase();return e.includes("ticket")||e.includes("receipt")?"Ticket":a.includes("pdf")?"Factura":a.startsWith("image/")?"Ticket":"Factura"}function ot(t){return s.files.some(e=>e.file.name===t.name&&e.file.size===t.size)}function ae(t,e){return t.map(a=>`<option value="${a}" ${a===e?"selected":""}>${a}</option>`).join("")}function Ne(t,e=!1){const a=[];return e&&a.push(`<option value="" ${t?"":"selected"} disabled>Selecciona área</option>`),a.push(...AREA_OPTIONS.map(n=>`<option value="${n}" ${n===t?"selected":""}>${n}</option>`)),a.join("")}function Q(){const t=y("#fileList"),e=y("#fileListEmpty");if(!t)return;let a=!1;if(s.files.forEach(n=>{const r=P(n.meta);Object.entries(L).forEach(([o,c])=>{o in r||(r[o]=c)}),JSON.stringify(n.meta)!==JSON.stringify(r)&&(n.meta=r,a=!0),"tipo"in n.meta||(n.meta.tipo="Factura",a=!0)}),a&&W(),!s.files.length){t.innerHTML="",e&&(e.hidden=!1),T();return}e&&(e.hidden=!0),t.innerHTML=s.files.map(n=>`
      <article class="file-card">
        ${!!n.previewURL?`<figure class="file-card__preview"><img src="${n.previewURL||""}" alt="Vista previa" /></figure>`:""}
        <div class="file-card__body">
          <header class="file-card__header">
            <div class="file-card__title">
              <p class="file-card__name" title="${n.file.name}">${n.file.name}</p>
              <span class="file-card__meta">${n.file.type||"—"} · ${Xe(n.file.size)}</span>
            </div>
            <button class="file-card__remove" type="button" onclick="removeFile('${n.id}')" aria-label="Eliminar ${n.file.name}">✕</button>
          </header>
          <div class="file-card__grid">
            <label class="field field--compact">
              <span>Área</span>
              <select class="input" required onchange="updateFileMeta('${n.id}','area',this.value)">
                ${Ne(n.meta.area,!0)}
              </select>
            </label>
            <label class="field field--compact">
              <span>Naturaleza</span>
              <select class="input" onchange="updateFileMeta('${n.id}','naturaleza',this.value)">
                <option value="Ingreso" ${n.meta.naturaleza==="Ingreso"?"selected":""}>Ingreso</option>
                <option value="Egreso" ${n.meta.naturaleza==="Egreso"?"selected":""}>Egreso</option>
              </select>
            </label>
            <label class="field field--compact">
              <span>Método de pago</span>
              <select class="input" onchange="updateFileMeta('${n.id}','metodoPago',this.value)">
                ${ae(oe,n.meta.metodoPago)}
              </select>
            </label>
            <label class="field field--compact">
              <span>Categoría</span>
              <select class="input" onchange="updateFileMeta('${n.id}','categoria',this.value)">
                ${ae(pe,n.meta.categoria)}
              </select>
            </label>
            <label class="field field--compact">
              <span>Tipo</span>
              <select class="input" onchange="updateFileMeta('${n.id}','tipo',this.value)">
                <option value="Factura" ${n.meta.tipo==="Factura"?"selected":""}>Factura</option>
                <option value="Ticket" ${n.meta.tipo==="Ticket"?"selected":""}>Ticket</option>
              </select>
            </label>
            <label class="field field--compact" style="grid-column: 1 / -1">
              <span>Notas</span>
              <textarea rows="2" class="input" onchange="updateFileMeta('${n.id}','notas',this.value)">${n.meta.notas||""}</textarea>
            </label>
          </div>
        </div>
      </article>`).join(""),T()}const st=()=>{var r;const t=((r=s.csvImport)==null?void 0:r.columns)||{},e=Je.filter(o=>t[o]!==void 0);let a=e.length?e:Object.keys(t);a.includes("descripcion")||(a=["descripcion",...a]);const n=[];return a.forEach(o=>{n.includes(o)||n.push(o)}),n.length||n.push("descripcion"),n.slice(0,7)},it=(t,e)=>!e||typeof e!="object"?"":t==="fecha"?Fe(e.fecha||e.fechaISO||""):e[t]||"",ct=(t=[])=>{const e=st(),a=e.map(i=>`<th scope="col">${G(ge[i]||i)}</th>`).join(""),r=t.slice(0,se).map(i=>`<tr>${e.map(m=>{const h=it(m,i);return`<td>${G(h||"—")}</td>`}).join("")}</tr>`).join("")||`<tr><td colspan="${e.length}">No hay datos para mostrar.</td></tr>`,c=Math.max(t.length-se,0)>0?`<div class="csv-preview__more">Se muestran ${se} de ${t.length} registros.</div>`:"";return`
    <table>
      <thead><tr>${a}</tr></thead>
      <tbody>${r}</tbody>
    </table>
    ${c}
  `};function ne(){const t=y("#csvStatus"),e=y("#csvPreview"),a=y("#csvClear"),n=y("#csvAlerts");if(!t||!e||!a||!n)return;const{entries:r,filename:o,error:c,missingOptional:i,detectedFields:u,skippedRows:m}=s.csvImport,h=Array.isArray(r)&&r.length>0&&!c;if(n.innerHTML="",c&&(n.innerHTML+=`<div class="alert alert--error">${G(c)}</div>`),!c&&Array.isArray(i)&&i.length&&(n.innerHTML+=`<div class="alert alert--warning">Faltan columnas opcionales: ${G(le(i))}. Se utilizarán valores por defecto donde aplique.</div>`),!c&&Array.isArray(m)&&m.length&&(n.innerHTML+=`<div class="alert alert--warning">Se omitieron ${m.length} fila(s) por faltar datos obligatorios (filas: ${G(m.join(", "))}).</div>`),h){let v=`${r.length} registros importados`;o&&(v+=` de ${o}`),Array.isArray(u)&&u.length?v+=`. Campos detectados: ${le(u)}.`:v+=".",t.textContent=v,e.hidden=!1,e.innerHTML=ct(r),a.hidden=!1}else t.textContent=c?"No se pudieron procesar los datos del CSV.":"No hay CSV importado todavía.",e.hidden=!0,e.innerHTML="",a.hidden=!(o||c)}function ye(){s.csvImport=V();const t=y("#csvInput");t&&(t.value=""),ne(),T()}function Me(t){if(!(t instanceof File))return;const e=new FileReader;e.onload=()=>{try{const a=typeof e.result=="string"?e.result:new TextDecoder().decode(e.result||new Uint8Array),{rows:n,delimiter:r}=at(a),o=nt(n,r);s.csvImport={...V(),...o},s.csvImport.filename=t.name,s.csvImport.delimiter=r,s.csvImport.file=o.error?null:t}catch(a){console.error("Error procesando CSV",a),s.csvImport={...V(),error:"No se pudo procesar el CSV."}}ne(),T()},e.onerror=()=>{console.error("No se pudo leer el CSV",e.error),s.csvImport={...V(),error:"No se pudo leer el archivo CSV."},ne(),T()},e.readAsText(t,"utf-8")}window.removeFile=function(t){const e=s.files.findIndex(a=>a.id===t);if(e>-1){const a=s.files[e];a.previewURL&&URL.revokeObjectURL(a.previewURL),s.files.splice(e,1)}W(),Q()};window.updateFileMeta=function(t,e,a){const n=s.files.find(r=>r.id===t);n&&(n.meta[e]=a,W()),T()};function ce(t){console.log("addFiles ->",t==null?void 0:t.length,t);const e=he();[...t].forEach(a=>{var r;if(console.log("  candidate:",a==null?void 0:a.name,a==null?void 0:a.size,a instanceof File),!(a instanceof File)){console.warn("Descartado: no es File",a);return}if((a.name||"").toLowerCase().endsWith(".csv")||a.type==="text/csv"){Me(a);return}s.files.length>=s.MAX_FILES||STRICT_FILTERS&&ot(a)||STRICT_FILTERS&&a.size/(1024*1024)>s.MAX_MB||s.files.push({id:crypto.randomUUID(),file:a,previewURL:(r=a.type)!=null&&r.startsWith("image/")?URL.createObjectURL(a):null,meta:{...e,tipo:rt(a)}})}),W(),Q()}function de(){s.files.forEach(t=>t.previewURL&&URL.revokeObjectURL(t.previewURL)),s.files=[],W(),Q()}function W(){try{const t=s.files.map(e=>({id:e.id,meta:e.meta,file:{name:e.file.name,size:e.file.size,type:e.file.type}}));localStorage.setItem(LS_KEY,JSON.stringify(t))}catch{}}function lt(){var e,a,n,r,o,c;ut(),(e=y("#fileInput"))==null||e.addEventListener("change",i=>ce(i.target.files)),(a=y("#cameraInput"))==null||a.addEventListener("change",i=>ce(i.target.files)),(n=y("#csvInput"))==null||n.addEventListener("change",i=>{const u=i.target.files&&i.target.files[0];u&&Me(u),i.target.value=""});const t=y("#dropzone");t&&(["dragenter","dragover"].forEach(i=>t.addEventListener(i,u=>{u.preventDefault(),t.classList.add("dragover")})),["dragleave","drop"].forEach(i=>t.addEventListener(i,u=>{u.preventDefault(),t.classList.remove("dragover")})),t.addEventListener("drop",i=>ce(i.dataTransfer.files))),(r=y("#clearAll"))==null||r.addEventListener("click",de),(o=y("#csvClear"))==null||o.addEventListener("click",ye),document.querySelectorAll(".segmented-control__item").forEach(i=>{i.addEventListener("click",()=>{const u=i.closest(".segmented-control");if(!u)return;u.querySelectorAll(".segmented-control__item").forEach(h=>{h===i?(h.classList.add("is-active"),h.setAttribute("aria-selected","true")):(h.classList.remove("is-active"),h.setAttribute("aria-selected","false"))});const m=i.dataset.intakeMode;m&&we(m)})}),dt(),(c=y("#btnEnviar"))==null||c.addEventListener("click",async i=>{var $,C;if(($=i==null?void 0:i.preventDefault)==null||$.call(i),!WEBHOOK_URL){alert("Webhook no configurado.");return}const u=Array.isArray(s.csvImport.entries)&&s.csvImport.entries.length>0&&!s.csvImport.error;s.files.length||console.warn(u?"Envío sin archivos adjuntos: se enviará manifest con registros CSV.":"Envío sin archivos: se enviará solo el manifest."),console.log("ENVIANDO",s.files.length,s.files.map(d=>{var E,D,O;return{name:(E=d.file)==null?void 0:E.name,size:(D=d.file)==null?void 0:D.size,type:(O=d.file)==null?void 0:O.type,isFile:d.file instanceof File}}),u?{csvRegistros:s.csvImport.entries.length,csvArchivo:s.csvImport.filename||null}:null);const m=P(he()),h=s.files.length===0,v=!!(m.descripcion&&m.descripcion.toString().trim()),_=Oe(m);if(s.intakeMode==="files"&&!s.files.length&&!u){R("Añade al menos un archivo o importa un CSV antes de enviar.","error");return}if(s.intakeMode==="manual"){if(!v){R("Añade una descripción detallada antes de enviar.","error");return}if(!_){console.warn("Intento de envío sin datos manuales. Abortado."),R("Añade información del lote para enviar sin archivos.","error");return}if(!m.area){R("Selecciona el área del lote antes de enviar.","error");return}}const A=s.files.map(d=>P(d.meta)),I=[];let b=!1;if(A.forEach((d,E)=>{var D,O,Y;if(!d.area)if(m.area)d.area=m.area,(D=s.files[E])!=null&&D.meta&&(s.files[E].meta.area=m.area,b=!0);else{const ee=((Y=(O=s.files[E])==null?void 0:O.file)==null?void 0:Y.name)||`Archivo ${E+1}`;I.push(ee)}}),I.length){const d=I.slice(0,3).join(", "),E=I.length>3?` y ${I.length-3} más`:"";R(`Selecciona el área para ${I.length>1?"los archivos":"el archivo"} pendiente (${d}${E}).`,"error");return}if(b&&(W(),Q()),!m.area){const d=A.map(O=>O.area).filter(Boolean),D=d.length>0&&d.every(O=>O===d[0])?d[0]:"";D&&(m.area=D)}const S={version:"no-cors",enviadoEn:new Date().toISOString(),usuario:{email:localStorage.getItem("userEmail")||""},lote:ie(m),manifestOnly:h,archivos:s.files.map((d,E)=>({id:d.id,nombre:d.file.name,size:d.file.size,type:d.file.type,meta:ie(A[E])}))};u&&(S.csvImport={archivo:s.csvImport.filename||"",delimitador:s.csvImport.delimiter||",",camposDetectados:s.csvImport.detectedFields||[],columnasOpcionalesFaltantes:s.csvImport.missingOptional||[],filasOmitidas:s.csvImport.skippedRows||[],encabezados:s.csvImport.headers||[],mapeoColumnas:s.csvImport.columns||{},totalRegistros:s.csvImport.entries.length,registros:s.csvImport.entries.map((d,E)=>({indice:E+1,...ie(d)}))});const l=new FormData;l.append("manifest",new Blob([JSON.stringify(S,null,2)],{type:"application/json"}),"manifest.json"),l.append("manifestOnly",h?"1":"0");const p=(d,E)=>{if(!(d instanceof File)){console.warn("Saltado archivo no válido desde",E,d);return}l.append("files",d,d.name)};s.files.forEach(d=>p(d.file,"state")),u&&s.csvImport.file instanceof File&&l.append("csv",s.csvImport.file,s.csvImport.file.name);const g=y("#fileInput");!s.files.length&&((C=g==null?void 0:g.files)!=null&&C.length)&&(console.log("Fallback input files:",g.files.length),[...g.files].forEach(d=>p(d,"fallback")));for(const[d,E]of l.entries())console.log("FD:",d,E instanceof File?`${E.name} (${E.type}, ${E.size})`:E);s.sending=!0,T(),R("Enviando lote desde Versa Finanzas…","info");try{await fetch(WEBHOOK_URL,{method:"POST",body:l,mode:"no-cors"}),R("Envío registrado desde Versa Finanzas ✔️","success"),de(),ye();const d=y("#chkBorrado");d&&(d.checked=!1)}catch(d){console.error(d),R("No se pudo completar el envío. Inténtalo nuevamente.","error"),alert("⚠️ Error al enviar archivos")}finally{s.sending=!1,T()}}),Q(),ne(),we(s.intakeMode)}document.addEventListener("DOMContentLoaded",lt);function we(t){const e=t==="manual"?"manual":"files";s.intakeMode=e;const a=e==="manual";document.querySelectorAll('[data-intake-section="files"]').forEach(c=>{c.hidden=a});const r=y("#manualEntry");r&&(r.hidden=!a);const o=y("#clearAll");if(o&&(o.hidden=a),a)s.files.length&&de(),["#cameraInput","#fileInput","#csvInput"].forEach(c=>{const i=y(c);i&&i.setAttribute("disabled","true")}),R("Introduce los datos de la factura manualmente.","info");else{["#cameraInput","#fileInput","#csvInput"].forEach(i=>{const u=y(i);u&&u.removeAttribute("disabled")});const c=Array.isArray(s.csvImport.entries)&&s.csvImport.entries.length>0&&!s.csvImport.error;s.files.length||(c?R("CSV importado listo para enviar o complementa con archivos.","info"):R("Añade tus archivos o un CSV para comenzar.","default"))}T()}function dt(){const t=y("#lookerFrame"),e=y("#dashboardFullscreenBtn"),a=y("#dashboardFullscreenClose");if(!t||!e||!a)return;const n=document.body,r="dashboard-fullscreen-active",o=u=>{if(!(!u||typeof u.focus!="function"))try{u.focus({preventScroll:!0})}catch{u.focus()}},c=()=>{n.classList.contains(r)||(n.classList.add(r),e.setAttribute("aria-expanded","true"),a.setAttribute("aria-hidden","false"),o(a))},i=()=>{n.classList.contains(r)&&(n.classList.remove(r),e.setAttribute("aria-expanded","false"),a.setAttribute("aria-hidden","true"),document.fullscreenElement&&document.exitFullscreen&&document.exitFullscreen().catch(()=>{}),o(e))};e.setAttribute("aria-expanded","false"),e.addEventListener("click",async()=>{if(n.classList.contains(r)){i();return}if(c(),t.requestFullscreen&&window.matchMedia("(max-width: 1024px)").matches)try{await t.requestFullscreen()}catch(u){console.warn("No se pudo activar la API de pantalla completa",u)}}),a.addEventListener("click",i),document.addEventListener("keydown",u=>{u.key==="Escape"&&i()}),window.addEventListener("resize",()=>{n.classList.contains(r)&&window.innerWidth>1280&&i()}),document.addEventListener("fullscreenchange",()=>{document.fullscreenElement&&document.fullscreenElement!==t||document.fullscreenElement||i()})}function ut(){const t=y("#metaForm");if(!t||t.dataset.enhanced==="1")return;const e=(()=>{try{return Object.fromEntries(new FormData(t))}catch{return{}}})(),a=P(L),n=P(e),r=n.descripcion||a.descripcion,o=n.area||a.area,c=n.naturaleza||a.naturaleza,i=n.metodoPago||a.metodoPago,u=n.categoria||a.categoria,m=n.notas||a.notas,h=n.subtotal||a.subtotal,v=n.iva||a.iva,_=n.total||a.total,A=Ne(o,!0),I=ae(oe,i),b=ae(pe,u);t.innerHTML=`
    <div class="grid gap-3 md:grid-cols-2 text-sm">
      <div>
        <label class="font-medium flex items-center gap-1">Descripción del lote <span class="text-red-500">*</span></label>
        <textarea name="descripcion" rows="3" class="input w-full mt-1" placeholder="Ej. Facturas de mantenimiento preventivo de la flota" required>${r}</textarea>
        <p class="mt-1 text-xs helper-text">Resume el contenido del envío para acelerar la validación.</p>
      </div>
      <div>
        <label class="font-medium">Área</label>
        <select name="area" class="input w-full mt-1" required>${A}</select>
      </div>
      <div class="md:col-span-2">
        <label class="font-medium">Naturaleza</label>
        <div class="mt-1 flex flex-wrap gap-3">
          <label class="inline-flex items-center gap-2">
            <input type="radio" name="naturaleza" value="Ingreso" ${c==="Ingreso"?"checked":""}>
            <span>Ingreso</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="radio" name="naturaleza" value="Egreso" ${c!=="Ingreso"?"checked":""}>
            <span>Egreso</span>
          </label>
        </div>
      </div>
      <div>
        <label class="font-medium">Método de pago</label>
        <select name="metodoPago" class="input w-full mt-1">${I}</select>
      </div>
      <div>
        <label class="font-medium">Categoría</label>
        <select name="categoria" class="input w-full mt-1">${b}</select>
      </div>
      <div>
        <label class="font-medium">Subtotal</label>
        <div class="mt-1">
          <input name="subtotal" type="number" step="0.01" min="0" class="input w-full" value="${h}" placeholder="0.00">
        </div>
      </div>
      <div>
        <label class="font-medium">IVA</label>
        <div class="mt-1">
          <input name="iva" type="number" step="0.01" min="0" class="input w-full" value="${v}" placeholder="0.00">
        </div>
      </div>
      <div>
        <label class="font-medium">Total</label>
        <div class="mt-1">
          <input name="total" type="number" step="0.01" min="0" class="input w-full" value="${_}" placeholder="0.00">
        </div>
      </div>
      <div class="md:col-span-2">
        <label class="font-medium">Notas</label>
        <textarea name="notas" rows="3" class="input w-full mt-1" placeholder="Observaciones, centros de coste, referencias internas…">${m}</textarea>
      </div>
    </div>
  `,t.dataset.enhanced="1",t.querySelectorAll("input, select, textarea").forEach(S=>{S.addEventListener("change",()=>T()),S.addEventListener("input",()=>T())}),T()}
