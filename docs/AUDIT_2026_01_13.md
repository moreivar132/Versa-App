# RE-AUDIT T√âCNICA: PROYECTO VERSA
**Fecha:** 13 de Enero, 2026  
**Auditor:** Senior Staff Software Architect  
**Estado General:** ‚ö†Ô∏è **TRANSICI√ìN CR√çTICA / RIESGO MODERADO**

---

## 1. Executive Summary

| Pilar | Score | Estado |
|-------|-------|--------|
| 1) Arquitectura & Modularidad | 5/10 | ‚ö†Ô∏è Split-Brain (Legacy vs Modular) |
| 2) Multi-tenancy & Aislamiento | 4/10 | üö® **RIESGO CR√çTICO** (Manual Enforcement) |
| 3) Seguridad & RBAC | 6/10 | ‚úÖ JWT S√≥lido / ‚ö†Ô∏è Permisos Fragmentados |
| 4) Data Model & Integridad | 5/10 | ‚ö†Ô∏è Sin Migraciones Standard / Drift Risk |
| 5) API Design & Contratos | 5/10 | ‚ö†Ô∏è Sin Versionado / Estilos Mixtos |
| 6) Testing Strategy | 7/10 | ‚úÖ Alta Cobertura / ‚ö†Ô∏è Gaps en M√≥dulos Nuevos |
| 7) CI/CD & Releases | 6/10 | ‚úÖ Workflow B√°sico / ‚ö†Ô∏è Sin DB en CI |
| 8) Observability | 5/10 | ‚ö†Ô∏è Logger Infrautilizado |
| 9) Developer Experience | 8/10 | ‚úÖ Excelente Documentaci√≥n |
| 10) Deuda T√©cnica & Roadmap | 5/10 | ‚ö†Ô∏è Roadmap en curso, pero mucha carga legacy |
| **TOTAL (PROMEDIO)** | **5.6** | **PROGRESO POSITIVO / NO LISTO PARA ESCALADO MASIVO** |

**¬øEstado para escalar a 20+ usuarios?**  
**PARCIAL (CON ADVERTENCIA).** El sistema es funcional y tiene una base de tests envidiable, pero el aislamiento de datos depende exclusivamente de la disciplina del desarrollador (`WHERE id_tenant = $1` manual). Un solo descuido en una query nueva resultar√° en un "Data Leak" entre empresas. No se recomienda escalar sin automatizar el aislamiento o implementar RLS.

### Top 10 Riesgos

1. **CR√çTICO: Enforcement de Tenant Manual** (`backend/src/core/db/tenant-db.js`, `backend/routes/clientes.js`). El wrapper de DB no inyecta el filtro autom√°ticamente.
2. **CR√çTICO: Schema Drift** (`backend/migrations/`). Ausencia de un gestor de migraciones (Knex/Liquibase). Riesgo de desincronizaci√≥n entre entornos.
3. **ALTO: L√≥gica Distribuida (Split Brain)** (`backend/routes/` vs `backend/src/modules/`). La l√≥gica reside tanto en rutas (Legacy) como en servicios (V2).
4. **ALTO: Observabilidad Inconsistente** (`backend/index.js`). El `logger` estructurado se ignora en la mayor√≠a de los controladores en favor de `console.error`.
5. **MEDIO: Falta de Versionado de API**. No existe `/v1/` en las rutas, complicando releases que rompan contratos con m√∫ltiples frontends.
6. **MEDIO: Gaps en Tests Cr√≠ticos** (`docs/MODULES/TESTS.md`). El m√≥dulo de `contabilidad` y los CRUDs de `clientes/veh√≠culos` carecen de tests automatizados a pesar del alto volumen de tests totales.
7. **MEDIO: Gesti√≥n de Archivos Local** (`backend/src/modules/contable/api/controllers/facturas.controller.js`). Almacenamiento en `/uploads` local; fallar√° en despliegues ef√≠meros (ej: Railway sin vol√∫menes persistentes).
8. **BAJO: RBAC Fragmentado**. La validaci√≥n de permisos ocurre en middlewares gen√©ricos y a veces dentro del controlador mediante `getEffectiveTenant`.
9. **BAJO: Coexistencia de Frontends**. La duplicaci√≥n de archivos HTML (`manager-taller-*`) dificulta el mantenimiento UI masivo.
10. **BAJO: Secrets Management**. Presencia de archivos `.env` activos y scripts de actualizaci√≥n de variables que operan sobre el sistema de archivos local.

---

## 2. Deep Dive por Pilar

### 1) Arquitectura & Modularidad (5/10)
- **[PROBLEMA]** **Modular Monolith incompleto.** **[EVIDENCIA]** Coexisten `backend/controllers` y `backend/src/modules/ventas`. **[IMPACTO]** Dificulta el onboarding de nuevos devs que no saben qu√© patr√≥n seguir. **[SEVERIDAD]** MEDIA. **[RECOMENDACI√ìN]** Mover todos los controladores legacy a `src/modules` antes de escalar el equipo.
- **[PROBLEMA]** **Servicios insuficientes.** **[EVIDENCIA]** `backend/routes/clientes.js` contiene l√≥gica de negocio directamente en el router. **[IMPACTO]** L√≥gica no reutilizable y dif√≠cil de testear unitariamente. **[SEVERIDAD]** ALTO. **[RECOMENDACI√ìN]** Prohibir l√≥gica en routers.

**Qu√© se hizo bien:**
- Estructura de `src/modules/contable` sigue un patr√≥n limpio (api/application/infra).
- Separaci√≥n clara entre `core` y m√≥dulos de negocio.

### 2) Multi-tenancy & Aislamiento (4/10)
- **[PROBLEMA]** **Filtrado manual de Tenant.** **[EVIDENCIA]** `backend/src/core/db/tenant-db.js` l√≠nea 93: *"El repo debe incluir WHERE id_tenant = $X expl√≠citamente"*. **[IMPACTO]** Riesgo masivo de fuga de datos entre competidores. **[SEVERIDAD]** **CR√çTICO**. **[RECOMENDACI√ìN]** Migrar a PostgreSQL Row Level Security (RLS) o usar un Query Builder que inyecte el filtro autom√°ticamente.
- **[PROBLEMA]** **Transmisi√≥n de contexto insegura.** **[EVIDENCIA]** `backend/src/core/http/middlewares/tenant-context.js` no usa `AsyncLocalStorage` (aunque se menciona en los docs), requiere pasar el `req` por todas las capas. **[IMPACTO]** Firmas de m√©todos contaminadas con contexto. **[SEVERIDAD]** MEDIA. **[RECOMENDACI√ìN]** Implementar `AsyncLocalStorage` real en el wrapper de DB.

**Qu√© se hizo bien:**
- Existe un `tenant-db.js` wrapper que valida la existencia del contexto.
- El middleware de RBAC (`getEffectiveTenant`) resuelve correctamente jerarqu√≠as de tenant.

### 3) Seguridad & RBAC (6/10)
- **[PROBLEMA]** **Autorizaci√≥n distribuida.** **[EVIDENCIA]** `backend/routes/accessRoutes.js` gestiona roles pero los checks en rutas legacy son ad-hoc. **[IMPACTO]** Inconsistencia en permisos. **[SEVERIDAD]** MEDIA. **[RECOMENDACI√ìN]** Unificar bajo un middleware de `policy-based access control`.

**Qu√© se hizo bien:**
- JWT con normalizaci√≥n de aliases (`tenant_id` vs `id_tenant`).
- Webhook de Stripe validado correctamente antes del parser JSON.

### 4) Data Model & Integridad (5/10)
- **[PROBLEMA]** **Gesti√≥n de cambios manual.** **[EVIDENCIA]** Directorio `backend/migrations/` con scripts `.js` sueltos (`ejecutar_migracion_...`). **[IMPACTO]** Imposible garantizar que la DB del desarrollador A sea igual a la de Producci√≥n. **[SEVERIDAD]** **CR√çTICO**. **[RECOMENDACI√ìN]** Adoptar Knex, TypeORM Migrations o Flyway inmediatamente.
- **[PROBLEMA]** **Constraints insuficientes.** **[EVIDENCIA]** Tablas como `orden` no tienen `id_tenant` directo, dependen de `id_sucursal`. **[IMPACTO]** Joins costosos y riesgo de integridad si una sucursal cambia de tenant. **[SEVERIDAD]** MEDIA. **[RECOMENDACI√ìN]** Desnormalizar `id_tenant` en todas las tablas principales.

### 6) Testing Strategy (7/10)
- **[PROBLEMA]** **Gaps en √°reas cr√≠ticas de negocio.** **[EVIDENCIA]** `docs/MODULES/TESTS.md` muestra 0 tests para `contabilidad_factura` y `contabilidad_pago` recientemente creados. **[IMPACTO]** Funcionalidades financieras sin red de seguridad. **[SEVERIDAD]** ALTO. **[RECOMENDACI√ìN]** No aceptar PRs de m√≥dulos financieros sin integraci√≥n tests.

**Qu√© se hizo bien:**
- Excelente volumen de tests (221) para ser un startup.
- Cobertura s√≥lida en flujos de `Caja` y `Pagos`.

---

## 3. Comparaci√≥n con Auditor√≠a Anterior (Conversation 4a01808e)

- **Qu√© mejor√≥:**
   - **Modularizaci√≥n:** Se inici√≥ la estructura `src/modules` y se migr√≥ `ventas`.
   - **Observabilidad:** Se cre√≥ un `logger` centralizado y middleware de `requestId`.
   - **Documentaci√≥n:** Se crearon gu√≠as de arquitectura y tests muy detalladas.
- **Qu√© sigue igual:**
   - **Riesgo de Aislamiento:** El filtrado sigue siendo 100% manual en las queries SQL crudo.
   - **Ausencia de ORM/Query Builder:** Se sigue usando `pg` con strings de SQL manuales, facilitando errores humanos.
- **Qu√© empeor√≥:**
   - **Complejidad Cognitiva:** Al haber dos arquitecturas conviviendo, la dificultad para un nuevo dev ha aumentado temporalmente.

---

## 4. Roadmap Priorizado (Sin C√≥digo)

### Fase 0: Bloqueos Cr√≠ticos (48‚Äì72h)
1. **Migraci√≥n a Aislamiento Autom√°tico:** Implementar `AsyncLocalStorage` en el wrapper de DB para evitar pasar `req` manualmente.
2. **Setup de Base de Datos en CI:** Configurar servicios de Postgres en el workflow de Github Actions para dejar de depender de variables externas en tests.

### Fase 1: Base de Equipo + Estabilidad (0‚Äì2 semanas)
1. **Implementar Gestor de Migraciones:** Migrar los scripts de `backend/migrations/` a Knex o herramienta est√°ndar.
2. **Enforcement de Tests en Finanzas:** Implementar `smoke tests` para el m√≥dulo de contabilidad (facturas/pagos).
3. **Audit Log Activo:** Integrar el middleware de auditor√≠a en todas las acciones de borrado y modificaci√≥n de dinero.

### Fase 2: Modularizaci√≥n Real (2‚Äì6 semanas)
1. **Migrar Clientes y Veh√≠culos:** Mover estas rutas legacy a `src/modules` con sus respectivos servicios e integraci√≥n tests.
2. **API Versioning (v1):** Implementar prefix `/api/v1` global para preparar futuras versiones sin romper frontends antiguos.
3. **Storage Abstraction:** Migrar subida de archivos a un servicio (S3/Cloudinary) para permitir escalado horizontal.

### Fase 3: Escalado y Hardening (6‚Äì12 semanas)
1. **Postgres RLS:** Implementar Row Level Security como √∫ltima l√≠nea de defensa contra data leaks.
2. **Observabilidad Avanzada:** Integrar OpenTelemetry o al menos exportar los logs estructurados a un proveedor (Datadog/Logtail).

---

## 5. Lista de Evidencia Faltante

1. `backend/test-results.json` o similar (para verificar si los 221 tests realmente pasan en el entorno actual).
2. `railway.json` o config de despliegue (para verificar c√≥mo se manejan los secretos en CD).
3. `backend/.eslintrc.js` (para ver si hay reglas que impiden el uso de logic en controllers).
4. `sql/schema_dump.sql` (para verificar constraints FK y PK reales en la base de datos).
5. Output de `npm test` en el backend (verificaci√≥n emp√≠rica de integridad).
6. Archivo `backend/.env` (solo estructura/keys, no valores, para ver si hay inconsistencias de nombres).
7. `frontend/vite.config.js` (para ver c√≥mo se gestionan los proxies de API).
8. `backend/middleware/rbac.js` (para auditar la l√≥gica de resoluci√≥n de tenant en roles complejos).
9. Muestra de 10 l√≠neas de `backend/logs/output.log` (para verificar si el `requestId` se est√° propagando realmente).
10. `package.json` ra√≠z (para ver scripts de orquestaci√≥n backend/frontend).

---
**FIN DEL DOCUMENTO DE AUDITOR√çA**
