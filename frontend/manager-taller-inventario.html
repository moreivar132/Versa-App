<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Listado de Productos - Goversa</title>
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/guard.js"></script>
  <!-- FontAwesome para iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="manager.css">
  <link rel="stylesheet" href="styles/sucursal-selector.css">
  <style>
    /* --- VARIABLES & BASE --- */
    /* Redundant variables removed */

    /* --- SIDEBAR --- */


    /* --- SIDEBAR --- */
    /* Mantenemos el efecto Glass para consistencia visual, aunque use tu estructura */
    #sidebar {
      /* background: rgba(17, 19, 24, 0.85); */
      /* Comentado para usar tu color de fondo si lo prefieres */
      /* Si prefieres el glassmorphism premium, descomenta la linea de arriba y comenta el bg-[#111318] del HTML */
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    /* --- TABLE CONTAINER GLASS --- */
    /* --- TABLE CONTAINER GLASS --- */


    /* --- DATA TABLE STYLES --- */
    .custom-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .custom-table thead {
      --surface-border: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid var(--border-subtle);
    }

    .custom-table th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 1px;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .custom-table tbody tr {
      border-bottom: 1px solid rgba(255, 255, 255, 0.02);
      transition: all 0.2s ease;
    }

    .custom-table tbody tr:hover {
      background-color: rgba(255, 255, 255, 0.03);
    }

    .custom-table td {
      padding: 16px;
      vertical-align: middle;
      color: var(--text-primary);
    }

    /* Estilo específico para celdas */
    .cell-id {
      color: var(--text-secondary);
      font-family: monospace;
    }

    .cell-code {
      font-weight: 500;
      color: #fff;
    }

    .cell-brand {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    .cell-price {
      color: var(--price-green);
      font-weight: 700;
      font-family: monospace;
      font-size: 15px;
    }

    .stock-container {
      display: flex;
      flex-direction: column;
    }

    .stock-val {
      font-weight: 700;
      font-size: 14px;
    }

    .stock-unit {
      font-size: 10px;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    /* Action Menu Button */
    .action-btn {
      color: var(--text-secondary);
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    /* --- FILTERS BAR --- */
    .search-input {
      background: var(--input-bg);
      border: 1px solid var(--border-subtle);
      color: white;
      border-radius: 10px;
      padding: 10px 16px 10px 40px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--brand-orange);
      box-shadow: 0 0 0 2px rgba(255, 101, 43, 0.2);
    }

    /* --- PAGINATION --- */
    .pagination-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      transition: all 0.2s;
      cursor: pointer;
    }

    .pagination-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .pagination-btn.active {
      background: var(--brand-orange);
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(255, 101, 43, 0.4);
    }

    /* --- BUTTONS --- */
    .btn-primary {
      background: linear-gradient(135deg, var(--brand-orange) 0%, var(--brand-orange-dark) 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 4px 14px rgba(255, 101, 43, 0.3);
      transition: transform 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
    }

    /* Responsive Table */
    @media (max-width: 1024px) {

      .custom-table th:nth-child(2),
      .custom-table td:nth-child(2),
      .custom-table th:nth-child(4),
      .custom-table td:nth-child(4),
      .custom-table th:nth-child(6),
      .custom-table td:nth-child(6) {
        display: none;
      }
    }
  </style>
</head>

<body>

  <div class="flex h-screen w-full">

    <!-- SideNavBar (TU VERSIÓN OPTIMIZADA INTEGRADA) -->
    <aside id="sidebar"
      class="flex h-full w-64 flex-col bg-[#111318] p-4 shrink-0 transition-all duration-300 ease-in-out border-r border-[var(--surface-border)] relative z-20">
      <div class="flex h-full flex-col justify-between">
        <div class="flex flex-col gap-4">
          <!-- User Profile / Logo Area -->
          <div class="flex items-center gap-3 p-2 mb-4">
            <div class="logo-badge"
              style="padding: 8px; border-radius: 12px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
              <img src="https://i.imgur.com/Mjw4or5.png" alt="Logo" class="logo-img" style="height: 24px; width: auto;">
            </div>
            <div class="flex flex-col sidebar-text">
              <h1 class="text-white text-base font-medium leading-normal" style="font-size: 15px;">Goversa</h1>
              <p class="text-[#9da6b9] text-sm font-normal leading-normal" style="font-size: 12px;">Gestión</p>
            </div>
            <button id="toggle-sidebar" class="ml-auto text-gray-400 hover:text-white">
              <i class="fas fa-chevron-left"></i>
            </button>
          </div>

          <!-- Navigation Links -->
          <nav class="flex flex-col gap-2">
            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-inicio.html">
              <span class="icon-container"><i class="fas fa-home"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Inicio</p>
            </a>

            <!-- Taller Dropdown -->
            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('taller-submenu')">
                <span class="icon-container"><i class="fas fa-wrench"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Taller</p>
                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="taller-arrow"></i>
              </a>
              <div id="taller-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-citas.html" class="text-gray-400 hover:text-white text-sm py-1 block">Citas</a>
                <a href="manager-taller-ordenes.html"
                  class="text-gray-400 hover:text-white text-sm py-1 block">Órdenes</a>
                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Editar órdenes</a>
                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Presupuestos</a>
                <a href="manager-taller-vehiculos.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Vehículos</a>
                <a href="manager-taller-chat.html" class="text-gray-500 hover:text-white text-sm py-1 block">Chat
                  Clientes</a>
              </div>
            </div>

            <!-- Tienda Dropdown -->
            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('tienda-submenu')">
                <span class="icon-container"><i class="fas fa-shopping-cart"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Tienda</p>
                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="tienda-arrow"></i>
              </a>
              <div id="tienda-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-compras.html" class="text-gray-500 hover:text-white text-sm py-1 block">Nueva
                  Compra</a>
                <a href="manager-taller-compras-historial.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Historial Compras</a>
                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Ventas</a>
                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Productos</a>
              </div>
            </div>

            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-caja.html">
              <span class="icon-container"><i class="fas fa-cash-register"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Caja</p>
            </a>

            <!-- Cuentas Dropdown -->
            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('cuentas-submenu')">
                <span class="icon-container"><i class="fas fa-file-invoice-dollar"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Cuentas</p>
                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="cuentas-arrow"></i>
              </a>
              <div id="cuentas-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-facturas.html"
                  class="text-gray-400 hover:text-white text-sm py-1 block">Facturas</a>
                <a href="manager-taller-facturas-pendientes.html"
                  class="text-gray-400 hover:text-white text-sm py-1 block">Pendientes Facturar</a>
                <a href="manager-taller-config-facturas.html"
                  class="text-gray-400 hover:text-white text-sm py-1 block">Configuración</a>
                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Gastos</a>
              </div>
            </div>

            <a class="flex items-center gap-3 px-3 py-2 bg-[var(--brand-orange)] text-white rounded-lg transition-colors"
              href="manager-taller-inventario.html">
              <span class="icon-container"><i class="fas fa-boxes"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Inventario</p>
            </a>

            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-trabajadores.html">
              <span class="icon-container"><i class="fas fa-users-cog"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Trabajadores</p>
            </a>

            <!-- Contactos -->
            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('contactos-submenu')">
                <span class="icon-container"><i class="fas fa-address-book"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Contactos</p>
                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="contactos-arrow"></i>
              </a>
              <div id="contactos-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-clientes.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Clientes</a>
                <a href="manager-taller-proveedores.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Proveedores</a>
              </div>
            </div>
          </nav>
        </div>

        <!-- Bottom Actions -->
        <div class="flex flex-col gap-1 border-t border-[var(--surface-border)] pt-4">
          <div class="flex items-center gap-3 px-3 py-2 mb-2">
            <div
              class="w-8 h-8 rounded-full bg-[var(--brand-orange)] flex items-center justify-center text-white font-bold text-xs">
              IM
            </div>
            <div class="flex flex-col sidebar-text overflow-hidden">
              <span class="text-white text-sm font-medium truncate">Iván Moreno</span>
              <span class="text-gray-500 text-xs truncate">admin</span>
            </div>
          </div>
          <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
            href="#" data-logout>
            <span class="icon-container"><i class="fas fa-sign-out-alt"></i></span>
            <p class="text-sm font-medium leading-normal sidebar-text">Salir</p>
          </a>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
      <!-- Mobile Header -->
      <header
        class="md:hidden flex items-center justify-between p-4 bg-[#111318] border-b border-[var(--border-subtle)] z-30">
        <div class="logo-badge p-2"><img src="https://i.imgur.com/Mjw4or5.png" alt="Logo" class="h-6 w-auto"></div>
        <button id="mobile-menu-btn" class="text-white p-2"><i class="fas fa-bars fa-lg"></i></button>
      </header>

      <main class="flex-1 overflow-y-auto p-6 md:p-8 relative z-10">

        <!-- Encabezado de Página -->
        <div
          class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 border-b border-[#282e39] pb-6">
          <div>
            <h2 class="text-2xl font-bold text-white mb-1">Listado de Productos</h2>
            <p class="text-gray-400 text-sm">Gestiona todo el inventario de almacén y taller</p>
          </div>
          <div class="flex items-center gap-4">
            <button id="btn-export"
              class="btn-secondary px-4 py-2 rounded-lg border border-[var(--border-subtle)] hover:bg-white/5 text-gray-300 text-sm font-medium transition-colors">
              <i class="fas fa-file-export mr-2"></i> Exportar
            </button>
            <a href="manager-taller-inventario-nuevo.html" class="btn-primary">
              <i class="fas fa-plus"></i> Nuevo Producto
            </a>
          </div>
        </div>

        <!-- Selector de Sucursal Centrado -->
        <div class="flex justify-center mb-6">
          <div id="sucursal-selector-container"></div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <!-- Card Más Stock -->
          <div
            class="stats-card p-6 rounded-2xl border border-[var(--surface-border)] bg-[#1a1c23] relative overflow-hidden group hover:border-[var(--brand-orange)]/30 transition-all">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
              <i class="fas fa-boxes text-4xl text-[var(--brand-orange)]"></i>
            </div>
            <h3 class="text-gray-400 text-sm font-medium mb-2 uppercase tracking-wider">Mayor Stock</h3>
            <div class="flex flex-col">
              <span class="text-2xl font-bold text-white" id="stat-most-stock-val">0</span>
              <span class="text-xs text-[var(--brand-orange)] font-medium mt-1 truncate"
                id="stat-most-stock-name">-</span>
            </div>
          </div>

          <!-- Card Menos Stock -->
          <div
            class="stats-card p-6 rounded-2xl border border-[var(--surface-border)] bg-[#1a1c23] relative overflow-hidden group hover:border-red-500/30 transition-all">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
              <i class="fas fa-box-open text-4xl text-red-500"></i>
            </div>
            <h3 class="text-gray-400 text-sm font-medium mb-2 uppercase tracking-wider">Menor Stock</h3>
            <div class="flex flex-col">
              <span class="text-2xl font-bold text-white" id="stat-least-stock-val">0</span>
              <span class="text-xs text-red-400 font-medium mt-1 truncate" id="stat-least-stock-name">-</span>
            </div>
          </div>

          <!-- Card Riesgo Stock -->
          <div
            class="stats-card p-6 rounded-2xl border border-[var(--surface-border)] bg-[#1a1c23] relative overflow-hidden group hover:border-yellow-500/30 transition-all">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
              <i class="fas fa-exclamation-triangle text-4xl text-yellow-500"></i>
            </div>
            <h3 class="text-gray-400 text-sm font-medium mb-2 uppercase tracking-wider">Alerta de Stock</h3>
            <div class="flex flex-col">
              <span class="text-2xl font-bold text-white" id="stat-risk-val">0</span>
              <span class="text-xs text-yellow-500 font-medium mt-1">Productos bajo mínimo</span>
            </div>
          </div>
        </div>

        <!-- Barra de Filtros y Búsqueda -->
        <div class="flex flex-col gap-4 mb-6">
          <div class="flex flex-col md:flex-row gap-4 justify-between">
            <div class="relative group flex-1">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i
                  class="fas fa-search text-gray-500 group-focus-within:text-[var(--brand-orange)] transition-colors"></i>
              </div>
              <input type="text" id="table-search" class="search-input w-full md:w-96"
                placeholder="Buscar por nombre, código o ID...">
            </div>

            <div class="flex gap-2 text-sm overflow-x-auto pb-2 md:pb-0 scrollbar-hide">
              <select id="filter-sort"
                class="bg-[var(--input-bg)] border border-[var(--border-subtle)] text-gray-300 rounded-lg focus:ring-[var(--brand-orange)] focus:border-[var(--brand-orange)] block p-2.5 min-w-[140px]">
                <option value="">Ordenar por...</option>
                <option value="stock_asc">Menos Stock</option>
                <option value="stock_desc">Más Stock</option>
                <option value="price_asc">Precio: Menor a Mayor</option>
                <option value="price_desc">Precio: Mayor a Menor</option>
              </select>

              <select id="filter-brand"
                class="bg-[var(--input-bg)] border border-[var(--border-subtle)] text-gray-300 rounded-lg focus:ring-[var(--brand-orange)] focus:border-[var(--brand-orange)] block p-2.5 min-w-[140px]">
                <option value="">Todas las Marcas</option>
              </select>

              <select id="filter-category"
                class="bg-[var(--input-bg)] border border-[var(--border-subtle)] text-gray-300 rounded-lg focus:ring-[var(--brand-orange)] focus:border-[var(--brand-orange)] block p-2.5 min-w-[140px]">
                <option value="">Todas las Categorías</option>
              </select>

              <select id="filter-provider"
                class="bg-[var(--input-bg)] border border-[var(--border-subtle)] text-gray-300 rounded-lg focus:ring-[var(--brand-orange)] focus:border-[var(--brand-orange)] block p-2.5 min-w-[140px]">
                <option value="">Todos los Proveedores</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Tabla Glassmorphism -->
        <div class="manager-panel">
          <div class="overflow-x-auto">
            <table class="custom-table" id="products-table">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>ID</th>
                  <th>Código</th>
                  <th>Marca</th>
                  <th>Modelo</th>
                  <th>Proveedor</th>
                  <th>Stock</th>
                  <th>Precio</th>
                  <th class="w-10"></th>
                </tr>
              </thead>
              <tbody id="products-table-body">
                <!-- Loaded via JS -->
              </tbody>
            </table>
          </div>

          <!-- Pagination Footer -->
          <div
            class="px-6 py-4 border-t border-[var(--border-subtle)] flex items-center justify-between bg-[rgba(0,0,0,0.2)]">
            <span class="text-sm text-gray-500">Mostrando <span class="text-white font-medium">1-6</span> de <span
                class="text-white font-medium">1240</span> productos</span>
            <div class="flex gap-1">
              <div class="pagination-btn"><i class="fas fa-chevron-left"></i></div>
              <div class="pagination-btn active">1</div>
              <div class="pagination-btn">2</div>
              <div class="pagination-btn">3</div>
              <div class="pagination-btn">...</div>
              <div class="pagination-btn">12</div>
              <div class="pagination-btn"><i class="fas fa-chevron-right"></i></div>
            </div>
          </div>
        </div>

        <footer class="mt-10 text-center text-gray-600 text-xs pb-4">
          <p>&copy; 2025 Goversa System. Todos los derechos reservados.</p>
        </footer>

      </main>
    </div>
  </div>

  <script type="module">
    import { fetchWithAuth } from '/auth.js';
    import { initSucursalSelector, getCurrentSucursalId, SUCURSAL_STORAGE_KEY } from '/services/sucursal-selector.js';

    document.addEventListener("DOMContentLoaded", async () => {
      // Inicializar selector de sucursal
      await initSucursalSelector('sucursal-selector-container', {
        onchange: (sucursalId) => {
          loadInventory();
        }
      });

      loadFilters();
      loadInventory();

      // Search listener
      const searchInput = document.getElementById('table-search');
      const catSelect = document.getElementById('filter-category');
      const provSelect = document.getElementById('filter-provider');
      const brandSelect = document.getElementById('filter-brand');
      const sortSelect = document.getElementById('filter-sort');
      const exportBtn = document.getElementById('btn-export');

      let debounceTimeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
          loadInventory();
        }, 300);
      });

      catSelect.addEventListener('change', () => loadInventory());
      provSelect.addEventListener('change', () => loadInventory());
      brandSelect.addEventListener('change', () => loadInventory());
      sortSelect.addEventListener('change', () => loadInventory());

      exportBtn.addEventListener('click', () => {
        const q = searchInput.value;
        const cat = catSelect.value;
        const prov = provSelect.value;
        let url = `/api/inventory/export?q=${encodeURIComponent(q)}`;
        if (cat) url += `&category=${encodeURIComponent(cat)}`;
        if (prov) url += `&provider=${encodeURIComponent(prov)}`;

        // Trigger download
        // Problem: window.location doesn't send Bearer token.
        // Solution: Use fetchWithAuth to get blob, then create object URL.
        downloadExport(url);
      });
    });

    async function downloadExport(url) {
      try {
        const response = await fetchWithAuth(url);
        if (!response.ok) throw new Error('Error al exportar');
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = 'inventario.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (e) {
        console.error(e);
        alert('Error al exportar inventario');
      }
    }

    async function loadFilters() {
      try {
        // Categories
        const catRes = await fetchWithAuth('/api/inventory/categories');
        if (catRes.ok) {
          const cats = await catRes.json();
          const catSelect = document.getElementById('filter-category');
          cats.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            catSelect.appendChild(opt);
          });
        }

        // Brands (New)
        const brandRes = await fetchWithAuth('/api/inventory/brands');
        if (brandRes.ok) {
          const brands = await brandRes.json();
          const brandSelect = document.getElementById('filter-brand');
          brands.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.textContent = b;
            brandSelect.appendChild(opt);
          });
        }

        // Providers
        const provRes = await fetchWithAuth('/api/proveedores?limit=100');
        if (provRes.ok) {
          const provs = await provRes.json();
          const provSelect = document.getElementById('filter-provider');
          provs.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.nombre;
            provSelect.appendChild(opt);
          });
        }
      } catch (e) {
        console.error("Error loading filters", e);
      }
    }

    // --- Stats Loading ---
    async function loadStats() {
      try {
        let url = '/api/inventory/stats';
        const savedSucursal = localStorage.getItem(SUCURSAL_STORAGE_KEY);
        if (savedSucursal) {
          url += `?idSucursal=${savedSucursal}`;
        }

        const response = await fetchWithAuth(url);
        if (!response.ok) return;

        const stats = await response.json();

        // Update DOM
        if (stats.most_stock) {
          document.getElementById('stat-most-stock-val').textContent = stats.most_stock.stock;
          document.getElementById('stat-most-stock-name').textContent = stats.most_stock.nombre;
        } else {
          document.getElementById('stat-most-stock-name').textContent = "Sin datos";
        }

        if (stats.least_stock) {
          document.getElementById('stat-least-stock-val').textContent = stats.least_stock.stock;
          document.getElementById('stat-least-stock-name').textContent = stats.least_stock.nombre;
        } else {
          document.getElementById('stat-least-stock-name').textContent = "Sin datos";
        }

        document.getElementById('stat-risk-val').textContent = stats.risk_count;

      } catch (e) {
        console.error("Error loading stats", e);
      }
    }

    async function loadInventory() {
      // Refresh stats on load (optional but good context)
      loadStats();

      const query = document.getElementById('table-search').value;
      const category = document.getElementById('filter-category').value;
      const provider = document.getElementById('filter-provider').value;
      const brand = document.getElementById('filter-brand').value;
      const sort = document.getElementById('filter-sort').value;

      const tableBody = document.getElementById('products-table-body');
      tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">Cargando...</td></tr>';

      try {
        let url = `/api/inventory/resumen?q=${encodeURIComponent(query)}`;
        if (category) url += `&category=${encodeURIComponent(category)}`;
        if (provider) url += `&provider=${encodeURIComponent(provider)}`;
        if (brand) url += `&brand=${encodeURIComponent(brand)}`;
        if (sort) url += `&sort=${encodeURIComponent(sort)}`;

        // Agregar filtro de sucursal desde localStorage
        const savedSucursal = localStorage.getItem(SUCURSAL_STORAGE_KEY);
        if (savedSucursal) {
          url += `&idSucursal=${savedSucursal}`;
        }

        const response = await fetchWithAuth(url);
        if (!response.ok) {
          const errData = await response.json().catch(() => ({}));
          throw new Error(errData.error || 'Error cargando inventario');
        }

        const products = await response.json();
        renderTable(products);
      } catch (error) {
        console.error(error);
        tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-red-500">${error.message}</td></tr>`;
      }
    }

    function renderTable(products) {
      const tableBody = document.getElementById('products-table-body');
      tableBody.innerHTML = '';

      if (products.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">No se encontraron productos</td></tr>';
        return;
      }

      products.forEach(p => {
        const row = document.createElement('tr');
        row.innerHTML = `
                <td>
                    <div class="font-semibold text-white">${p.nombre}</div>
                </td>
                <td class="cell-id">${p.id_representative}</td>
                <td class="cell-code">${p.codigo_barras || '-'}</td>
                <td class="cell-brand">${p.marca || '-'}</td>
                <td class="text-sm text-gray-300">${p.modelo || '-'}</td>
                <td class="text-sm text-gray-400">${p.proveedor_nombre || '-'}</td>
                <td>
                    <div class="stock-container">
                        <span class="stock-val ${p.stock_minimo && Number(p.stock_total || 0) <= Number(p.stock_minimo) ? 'text-red-400' : 'text-white'}">${Number(p.stock_total || 0)} ${p.unidad_medida || 'Uds'}</span>
                        <span class="stock-unit">Stock mínimo: ${Number(p.stock_minimo || 0)}</span>
                    </div>
                </td>
                <td class="cell-price">€${parseFloat(p.precio_representativo || 0).toFixed(2)}</td>
                <td>
                    <div class="relative group action-menu-container">
                        <button class="action-btn text-gray-400 hover:text-white" onclick="toggleActionMenu(this, ${p.id_representative})">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <!-- Dropdown menu -->
                        <div id="action-menu-${p.id_representative}" class="hidden absolute right-0 mt-2 w-32 bg-[#1a1a1f] border border-[var(--border-subtle)] rounded-lg shadow-lg z-50">
                            <a href="manager-taller-inventario-nuevo.html?id=${p.id_representative}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-white/5 hover:text-white">
                                <i class="fas fa-edit mr-2"></i> Editar
                            </a>
                            <button onclick="deleteProduct(${p.id_representative})" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-white/5 hover:text-red-300">
                                <i class="fas fa-trash-alt mr-2"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </td>
            `;
        tableBody.appendChild(row);
      });

      // Update counts if needed
      const countSpan = document.querySelector('.pagination-btn.active').parentElement.previousElementSibling;
      if (countSpan) {
        countSpan.innerHTML = `Mostrando <span class="text-white font-medium">${products.length}</span> productos`;
      }
    }

    window.toggleActionMenu = function (btn, id) {
      // Close all other menus
      document.querySelectorAll('[id^="action-menu-"]').forEach(el => {
        if (el.id !== `action-menu-${id}`) el.classList.add('hidden');
      });
      const menu = document.getElementById(`action-menu-${id}`);
      menu.classList.toggle('hidden');
    }

    // Close menus when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.action-menu-container')) {
        document.querySelectorAll('[id^="action-menu-"]').forEach(el => el.classList.add('hidden'));
      }
    });

    window.deleteProduct = async function (id) {
      if (!confirm('¿Estás seguro de eliminar este producto?')) return;
      // Implement delete logic if needed, or just alert for now as user didn't explicitly ask for delete but "modificar" implies full management.
      // I'll leave it as alert for now or implement DELETE endpoint if I have time.
      alert('Funcionalidad de eliminar pendiente de implementación en backend.');
    }

    // --- Lógica del Sidebar (Requerida para los menús desplegables) ---
    window.toggleSubmenu = function (id) {
      const submenu = document.getElementById(id);
      // La lógica de tu sidebar asume IDs de flechas como "taller-arrow", "tienda-arrow"
      const arrowId = id.replace('submenu', 'arrow');
      const arrow = document.getElementById(arrowId);

      if (submenu.classList.contains('hidden')) {
        submenu.classList.remove('hidden');
        submenu.classList.add('flex');
        if (arrow) arrow.style.transform = 'rotate(180deg)';
      } else {
        submenu.classList.add('hidden');
        submenu.classList.remove('flex');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
      }
    }

    // Toggle Sidebar collapse
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggle-sidebar');
    const sidebarTexts = document.querySelectorAll('.sidebar-text');
    let isCollapsed = false;

    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        isCollapsed = !isCollapsed;
        if (isCollapsed) {
          sidebar.classList.remove('w-64');
          sidebar.classList.add('w-20');
          sidebarTexts.forEach(el => el.classList.add('hidden'));
          toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
          // Cerrar todos los submenús al colapsar
          document.querySelectorAll('[id$="-submenu"]').forEach(el => {
            el.classList.add('hidden');
            el.classList.remove('flex');
          });
        } else {
          sidebar.classList.add('w-64');
          sidebar.classList.remove('w-20');
          sidebarTexts.forEach(el => el.classList.remove('hidden'));
          toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        }
      });
    }

    // Mobile Menu
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    if (mobileMenuBtn) {
      mobileMenuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('-translate-x-full');
        sidebar.classList.toggle('absolute');
        sidebar.classList.toggle('z-50');
        sidebar.classList.toggle('h-full');
      });
    }
  </script>

  <!-- Sidebar Manager - Genera el sidebar dinámicamente -->
  <script type="module" src="./sidebar-manager.js"></script>

</body>

</html>