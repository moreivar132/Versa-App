<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Órdenes - Goversa</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- FontAwesome para iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Estilos Generales (Reutilizados) */
    :root {
      --brand-orange: #FF652B;
      --brand-orange-strong: #FF7A45;
      --surface-elevated: rgba(18, 18, 20, 0.96);
      --surface-border: rgba(255, 255, 255, 0.08);
      --surface-highlight: rgba(255, 255, 255, 0.04);
      --dark-bg: #000000;
      --surface-bg: #1a1a1a;
      --border-color: #2a2a2a;
      --input-bg: #333333;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --success-color: #28a745;
      --error-color: #dc3545;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--dark-bg);
      font-family: "Montserrat", Arial, sans-serif;
      color: var(--text-primary);
    }

    /* Estructura del formulario de órdenes */
    .order-form-container {
      background-color: var(--surface-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 40px;
      max-width: 1400px;
      /* Limit width */
      margin: 0 auto;
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      gap: 20px;
      flex-wrap: wrap;
    }

    .form-main-title {
      font-size: 28px;
      font-weight: 800;
      margin: 0;
    }

    .form-header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .form-header-actions .btn {
      padding: 10px 20px;
    }

    .form-section {
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 25px;
      padding-bottom: 25px;
    }

    .form-section:last-of-type {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .form-grid {
      display: grid;
      gap: 20px;
    }

    .grid-cols-3 {
      grid-template-columns: repeat(3, 1fr);
    }

    .grid-cols-4 {
      grid-template-columns: repeat(4, 1fr);
    }

    .grid-cols-5 {
      grid-template-columns: repeat(5, 1fr);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .form-group label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .form-input,
    .form-select,
    textarea.form-input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background-color: var(--input-bg);
      border: 1px solid #444;
      color: var(--text-primary);
      font-family: "Montserrat", Arial, sans-serif;
      font-size: 15px;
      box-sizing: border-box;
    }

    .form-input:focus,
    .form-select:focus,
    textarea.form-input:focus {
      outline: none;
      border-color: var(--brand-orange);
      box-shadow: 0 0 0 3px rgba(255, 95, 0, 0.2);
    }

    .input-group {
      display: flex;
    }

    .input-group .form-input {
      border-radius: 8px 0 0 8px;
    }

    .input-group .btn {
      border-radius: 0 8px 8px 0;
      padding: 0 15px;
      font-size: 20px;
    }

    .info-display {
      background-color: var(--input-bg);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #444;
      min-height: 47px;
      box-sizing: border-box;
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Estilos para Dropdown Buscable */
    .custom-select-container {
      position: relative;
    }

    .custom-select-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: #333333;
      border: 1px solid #444444;
      border-radius: 8px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
    }

    .custom-select-options.show {
      display: block;
    }

    .custom-select-options .option {
      padding: 12px 15px;
      cursor: pointer;
      font-size: 14px;
    }

    .custom-select-options .option:hover {
      background-color: var(--brand-orange);
    }

    /* Estilos Tabla de Items */
    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .items-table th,
    .items-table td {
      border-bottom: 1px solid #444;
      padding: 12px 8px;
      text-align: left;
      vertical-align: middle;
    }

    .items-table th {
      background: #2a2a2a;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
    }

    .items-table .form-input,
    .items-table .form-select {
      padding: 10px;
      font-size: 14px;
    }

    /* Estilos Resumen y Pago */
    .summary-payment-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
    }

    .summary-table {
      width: 100%;
    }

    .summary-table td {
      padding: 8px 0;
    }

    .summary-table tr td:first-child {
      font-weight: 600;
      color: var(--text-secondary);
    }

    .summary-table tr td:last-child {
      font-weight: 600;
      text-align: right;
    }

    .summary-table .total-row td {
      font-size: 18px;
      font-weight: 800;
      color: var(--brand-orange);
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }

    #payment-amount-input.mismatch-amount {
      color: var(--error-color) !important;
      border-color: var(--error-color);
    }

    /* --- NUEVOS ESTILOS PARA SUBIDA DE MÚLTIPLES IMÁGENES --- */
    .multi-image-upload-box {
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background-color 0.2s;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 10px;
    }

    .multi-image-upload-box:hover,
    .multi-image-upload-box.dragover {
      border-color: var(--brand-orange);
      background-color: #252525;
    }

    #previews-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 20px;
    }

    .img-preview-wrapper {
      position: relative;
      width: 120px;
      height: 120px;
    }

    .img-preview-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .remove-img-btn {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: var(--error-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      margin: -1px;
      padding: 0;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    .btn {
      background-color: var(--brand-orange);
      color: var(--text-primary);
      border: none;
      cursor: pointer;
      font-weight: 600;
      border-radius: 8px;
      padding: 12px 18px;
      font-size: 15px;
      transition: background-color 0.2s;
    }

    .btn:hover {
      background-color: #e05300;
    }

    .btn-secondary {
      background-color: var(--input-bg);
      border: 1px solid #444;
    }

    .btn-secondary:hover {
      background-color: #444;
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--border-color);
    }

    .btn-outline:hover {
      background-color: var(--border-color);
    }

    /* Toast Notification */
    #toast-notification {
      visibility: hidden;
      min-width: 250px;
      background-color: var(--success-color);
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 16px;
      position: fixed;
      z-index: 3000;
      left: 50%;
      transform: translateX(-50%);
      bottom: 30px;
      font-size: 15px;
      font-weight: 600;
      opacity: 0;
      transition: opacity 0.5s, bottom 0.5s;
    }

    #toast-notification.show {
      visibility: visible;
      opacity: 1;
      bottom: 50px;
    }

    /* --- ESTILOS PARA EL MODAL DE ÉXITO --- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.show {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      background-color: var(--surface-bg);
      padding: 40px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      width: 90%;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      transform: scale(0.95);
      transition: transform 0.3s ease;
    }

    .modal-overlay.show .modal-content {
      transform: scale(1);
    }

    .modal-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background-color: var(--success-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-icon svg {
      width: 50px;
      height: 50px;
      color: white;
    }

    .modal-content h3 {
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 15px 0;
    }

    .modal-content p {
      font-size: 16px;
      color: var(--text-secondary);
      margin: 0 0 30px 0;
    }

    .modal-actions {
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    @media (max-width: 1024px) {
      .summary-payment-grid {
        grid-template-columns: 1fr;
      }

      .grid-cols-3,
      .grid-cols-4,
      .grid-cols-5 {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .form-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .summary-payment-grid {
        gap: 24px;
      }

      .grid-cols-3,
      .grid-cols-4,
      .grid-cols-5 {
        grid-template-columns: 1fr;
      }

      .order-form-container {
        padding: 24px;
      }
    }
  </style>
</head>

<body>
  <div class="flex h-screen w-full">
    <!-- SideNavBar -->
    <aside id="sidebar"
      class="flex h-full w-64 flex-col bg-[#111318] p-4 shrink-0 transition-all duration-300 ease-in-out border-r border-[var(--surface-border)]">
      <div class="flex h-full flex-col justify-between">
        <div class="flex flex-col gap-4">
          <!-- User Profile / Logo Area -->
          <div class="flex items-center gap-3 p-2 mb-4">
            <div class="logo-badge"
              style="padding: 8px; border-radius: 12px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
              <img src="https://i.imgur.com/Mjw4or5.png" alt="Logo" class="logo-img" style="height: 24px; width: auto;">
            </div>
            <div class="flex flex-col sidebar-text">
              <h1 class="text-white text-base font-medium leading-normal" style="font-size: 15px;">Goversa</h1>
              <p class="text-[#9da6b9] text-sm font-normal leading-normal" style="font-size: 12px;">Gestión</p>
            </div>
            <button id="toggle-sidebar" class="ml-auto text-gray-400 hover:text-white">
              <i class="fas fa-chevron-left"></i>
            </button>
          </div>

          <!-- Navigation Links -->
          <nav class="flex flex-col gap-2">
            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="index.html">
              <span class="icon-container"><i class="fas fa-home"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Inicio</p>
            </a>

            <!-- Taller Dropdown -->
            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 bg-[var(--brand-orange)] text-white rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('taller-submenu')">
                <span class="icon-container"><i class="fas fa-wrench"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Taller</p>

              </a>
              <div id="taller-submenu" class="flex flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-citas.html" class="text-gray-400 hover:text-white text-sm py-1 block">Citas</a>
                <a href="manager-taller-ordenes.html" class="text-white font-semibold text-sm py-1 block">Órdenes</a>
                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Editar órdenes</a>
                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Presupuestos</a>
                <a href="manager-taller-vehiculos.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Vehículos</a>
              </div>
            </div>

            <!-- Tienda Dropdown -->
            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('tienda-submenu')">
                <span class="icon-container"><i class="fas fa-shopping-cart"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Tienda</p>

              </a>
              <div id="tienda-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Ventas</a>
                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Productos</a>
              </div>
            </div>

            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="#">
              <span class="icon-container"><i class="fas fa-cash-register"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Caja</p>
            </a>

            <!-- Cuentas Dropdown -->
            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('cuentas-submenu')">
                <span class="icon-container"><i class="fas fa-file-invoice-dollar"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Cuentas</p>

              </a>
              <div id="cuentas-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Facturas</a>
                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Gastos</a>
              </div>
            </div>

            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-inventario.html">
              <span class="icon-container"><i class="fas fa-boxes"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Inventario</p>
            </a>

            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-trabajadores.html">
              <span class="icon-container"><i class="fas fa-users-cog"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Trabajadores</p>
            </a>

            <!-- Contactos -->
            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('contactos-submenu')">
                <span class="icon-container"><i class="fas fa-address-book"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Contactos</p>

              </a>
              <div id="contactos-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-clientes.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Clientes</a>
                <a href="manager-taller-proveedores.html"
                  class="text-gray-400 hover:text-white text-sm py-1 block">Proveedores</a>
              </div>
            </div>
          </nav>
        </div>

        <!-- Bottom Actions -->
        <div class="flex flex-col gap-1 border-t border-[var(--surface-border)] pt-4">
          <div class="flex items-center gap-3 px-3 py-2 mb-2">
            <div
              class="w-8 h-8 rounded-full bg-[var(--brand-orange)] flex items-center justify-center text-white font-bold text-xs">
              IM
            </div>
            <div class="flex flex-col sidebar-text overflow-hidden">
              <span class="text-white text-sm font-medium truncate">Iván Moreno</span>
              <span class="text-gray-500 text-xs truncate">admin</span>
            </div>
          </div>
          <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
            href="login.html">
            <span class="icon-container"><i class="fas fa-sign-out-alt"></i></span>
            <p class="text-sm font-medium leading-normal sidebar-text">Salir</p>
          </a>
        </div>
      </div>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="flex-1 flex flex-col h-screen overflow-hidden bg-[var(--dark-bg)]">
      <!-- Top Mobile Header -->
      <header
        class="md:hidden flex items-center justify-between p-4 bg-[#111318] border-b border-[var(--surface-border)]">
        <div class="logo-badge p-2">
          <img src="https://i.imgur.com/Mjw4or5.png" alt="Logo" class="h-6 w-auto">
        </div>
        <button id="mobile-menu-btn" class="text-white">
          <i class="fas fa-bars"></i>
        </button>
      </header>

      <main class="flex-1 overflow-y-auto p-6">
        <form id="order-form" class="order-form-container">
          <div class="form-header">
            <h2 class="form-main-title">Orden de Reparación</h2>
            <div class="form-header-actions">
              <button type="button" class="btn btn-outline">Volver</button>
              <button type="button" class="btn btn-secondary">Cancelar</button>
              <button type="submit" class="btn">Confirmar</button>
            </div>
          </div>

          <!-- SECCIÓN DE DATOS GENERALES -->
          <div class="form-section">
            <div class="form-grid grid-cols-4">
              <div class="form-group">
                <label for="fecha-ingreso">Fecha Ingreso</label>
                <input type="text" id="fecha-ingreso" name="fecha_ingreso" class="form-input" readonly />
              </div>
              <div class="form-group">
                <label for="fecha-egreso">Fecha Egreso</label>
                <input type="datetime-local" id="fecha-egreso" name="fecha_egreso" class="form-input" />
              </div>
              <div class="form-group">
                <label for="tecnico">Técnico</label>
                <div class="custom-select-container">
                  <input type="text" id="tecnico" name="tecnico" class="form-input custom-select-input"
                    placeholder="Buscar técnico...">
                  <div class="custom-select-options" id="tecnico-options"></div>
                </div>
              </div>
              <div class="form-group">
                <label for="taller">Taller *</label>
                <select id="taller" name="taller" class="form-select" required>
                  <option value="" disabled selected>Seleccionar Taller</option>
                  <option value="CALLE EL TESORO">CALLE EL TESORO</option>
                  <option value="VAZQUEZ DE MELLA">VAZQUEZ DE MELLA</option>
                </select>
              </div>
            </div>
          </div>

          <!-- SECCIÓN DE CLIENTE Y VEHÍCULO -->
          <div class="form-section">
            <div class="form-grid grid-cols-5">
              <div class="form-group" style="grid-column: span 2;">
                <label for="buscar-cliente">Buscar Cliente</label>
                <div class="custom-select-container">
                  <div class="input-group">
                    <input type="text" id="buscar-cliente" name="cliente_nombre" class="form-input custom-select-input"
                      placeholder="Nombre, NIF o teléfono...">
                    <button type="button" id="add-client-btn" class="btn btn-secondary"
                      title="Crear nuevo cliente">+</button>
                  </div>
                  <div class="custom-select-options" id="cliente-options"></div>
                </div>
              </div>
              <div class="form-group" style="grid-column: span 1;">
                <label>NIF | Tel.</label>
                <div id="cliente-info" class="info-display"></div>
              </div>
              <div class="form-group" style="grid-column: span 1;">
                <label for="buscar-vehiculo">Buscar Vehículo</label>
                <div class="custom-select-container">
                  <div class="input-group">
                    <input type="text" id="buscar-vehiculo" name="vehiculo_desc" class="form-input custom-select-input"
                      placeholder="Matrícula...">
                    <button type="button" id="add-vehicle-btn" class="btn btn-secondary"
                      title="Crear nuevo vehículo">+</button>
                  </div>
                  <div class="custom-select-options" id="vehiculo-options"></div>
                </div>
              </div>
              <div class="form-group" style="grid-column: span 1;">
                <label>Placa</label>
                <div id="vehiculo-info" class="info-display"></div>
              </div>
            </div>
          </div>

          <!-- SECCIÓN DE DETALLES DE LA ORDEN -->
          <div class="form-section">
            <div class="form-grid grid-cols-4">
              <div class="form-group">
                <label for="concepto">Concepto</label>
                <select id="concepto" name="concepto" class="form-select">
                  <option>Reparación</option>
                  <option>Mantenimiento</option>
                  <option>Diagnóstico</option>
                </select>
              </div>
              <div class="form-group">
                <label for="combustible">Combustible</label>
                <select id="combustible" name="combustible" class="form-select">
                  <option>Bajo</option>
                  <option>1/4</option>
                  <option>1/2</option>
                  <option>3/4</option>
                  <option>Lleno</option>
                </select>
              </div>
              <div class="form-group">
                <label for="kilometraje">Kilometraje</label>
                <input type="text" id="kilometraje" name="kilometraje" class="form-input" />
              </div>
              <div class="form-group">
                <label for="nombre-inspector">Nombre Inspector</label>
                <input type="text" id="nombre-inspector" name="inspector" class="form-input" />
              </div>
              <div class="form-group">
                <label for="numero-siniestro">Número Siniestro</label>
                <input type="text" id="numero-siniestro" name="siniestro" class="form-input" />
              </div>
              <div class="form-group">
                <label for="franquicia">Franquicia</label>
                <input type="text" id="franquicia" name="franquicia" class="form-input" />
              </div>
            </div>
          </div>

          <!-- SECCIÓN DE ITEMS -->
          <div class="form-section">
            <table class="items-table">
              <thead>
                <tr>
                  <th style="width: 40%;">Item</th>
                  <th style="width: 15%;">Importe</th>
                  <th style="width: 10%;">Cantidad</th>
                  <th style="width: 15%;">Tipo</th>
                  <th style="width: 10%;">Bonif.</th>
                  <th style="width: 10%;">Subtotal</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="order-items-list">
                <!-- Filas de items aquí -->
              </tbody>
              <tfoot>
                <tr id="add-item-row">
                  <td>
                    <div class="custom-select-container">
                      <input type="text" id="new-item-name" class="form-input custom-select-input"
                        placeholder="Buscar Producto o Servicio...">
                      <div class="custom-select-options" id="product-options"></div>
                    </div>
                  </td>
                  <td><input type="number" id="new-item-price" class="form-input" placeholder="0.00"></td>
                  <td><input type="number" id="new-item-quantity" class="form-input" value="1"></td>
                  <td>
                    <select id="new-item-type" class="form-select">
                      <option value="Servicio">Servicio</option>
                      <option value="Repuesto">Repuesto</option>
                    </select>
                  </td>
                  <td><input type="number" id="new-item-bonus" class="form-input" value="0"></td>
                  <td id="new-item-subtotal">0.00€</td>
                  <td><button type="button" id="add-item-btn" class="btn">Agregar</button></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- SECCIÓN DE FOTOS DEL VEHÍCULO -->
          <div class="form-section">
            <div class="form-group">
              <label for="vehicle-images-upload">Fotos del Vehículo</label>
              <input type="file" id="vehicle-images-upload" class="visually-hidden" multiple accept="image/*">
              <label for="vehicle-images-upload" class="multi-image-upload-box">
                <span>Arrastra las fotos aquí o haz clic para seleccionar</span>
                <small>(Puedes seleccionar varios archivos a la vez)</small>
              </label>
              <div id="previews-container">
                <!-- Vistas previas de las imágenes aquí -->
              </div>
            </div>
          </div>

          <!-- SECCIÓN FINAL: RESUMEN Y OBSERVACIONES -->
          <div class="form-section">
            <div class="summary-payment-grid">
              <div>
                <div class="form-group">
                  <label for="observaciones">Observaciones</label>
                  <textarea id="observaciones" name="observaciones" rows="5" class="form-input"></textarea>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                  <label for="comentario-interno">Comentario Interno</label>
                  <textarea id="comentario-interno" name="comentario_interno" rows="5" class="form-input"></textarea>
                </div>
              </div>
              <div>
                <h4>Resumen</h4>
                <table class="summary-table">
                  <tbody>
                    <tr>
                      <td>Descuento</td>
                      <td><input type="number" id="discount-input" name="descuento" class="form-input"
                          style="text-align: right; width: 80px; display: inline-block; margin-left: auto;" value="0"> %
                      </td>
                    </tr>
                    <tr>
                      <td>Repuestos</td>
                      <td id="summary-repuestos">0.00€</td>
                    </tr>
                    <tr>
                      <td>Mano de obra</td>
                      <td id="summary-mano-obra">0.00€</td>
                    </tr>
                    <tr>
                      <td>Total Neto</td>
                      <td id="summary-neto">0.00€</td>
                    </tr>
                    <tr>
                      <td>IVA (<input type="number" id="iva-percentage" name="iva_percentage" value="21"
                          class="form-input"
                          style="width: 70px; display: inline-block; text-align: right; margin: 0 5px;">%)</td>
                      <td id="summary-iva">0.00€</td>
                    </tr>
                    <tr class="total-row">
                      <td>Total</td>
                      <td id="summary-total">0.00€</td>
                    </tr>
                  </tbody>
                </table>
                <h4 style="margin-top: 30px;">Pago</h4>
                <table class="summary-table">
                  <tbody>
                    <tr>
                      <td>Método de Pago</td>
                      <td>
                        <select id="metodo-pago" name="metodo_pago" class="form-input" style="text-align: right;">
                          <option value="Efectivo">Efectivo</option>
                          <option value="Tarjeta">Tarjeta</option>
                          <option value="Transferencia">Transferencia</option>
                        </select>
                      </td>
                    </tr>
                    <tr>
                      <td>Cuenta Corriente</td>
                      <td style="text-align: right;">
                        <input type="checkbox" id="cuenta-corriente-check" name="cuenta_corriente" value="true"
                          style="width: 18px; height: 18px; vertical-align: middle;">
                        <label for="cuenta-corriente-check" style="vertical-align: middle;"> Enviar saldo</label>
                      </td>
                    </tr>
                    <tr class="total-row">
                      <td>Total Pago</td>
                      <td style="text-align: right;">
                        <input type="number" step="0.01" id="payment-amount-input" name="pago_manual" class="form-input"
                          style="text-align: right; width: 120px; display: inline-block; font-weight: 800; color: var(--brand-orange);"
                          value="0.00"> €
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </form>
      </main>
      <div id="toast-notification"></div>

      <!-- MODAL DE ÉXITO -->
      <div id="success-modal" class="modal-overlay">
        <div class="modal-content">
          <div class="modal-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
              <path
                d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z" />
            </svg>
          </div>
          <h3>¡Éxito!</h3>
          <p>La orden de reparación ha sido registrada correctamente.</p>
          <div class="modal-actions">
            <button id="close-modal-btn" type="button" class="btn btn-secondary">Cerrar</button>
            <button id="new-order-btn" type="button" class="btn">Crear Nueva Orden</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // --- SIDEBAR LOGIC ---
    window.toggleSubmenu = function (id) {
      const submenu = document.getElementById(id);
      const arrow = document.getElementById(id.replace('submenu', 'arrow'));

      if (submenu.classList.contains('hidden')) {
        submenu.classList.remove('hidden');
        submenu.classList.add('flex');
        if (arrow) arrow.style.transform = 'rotate(180deg)';
      } else {
        submenu.classList.add('hidden');
        submenu.classList.remove('flex');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
      }
    }

    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggle-sidebar');
    const sidebarTexts = document.querySelectorAll('.sidebar-text');
    let isCollapsed = false;

    toggleBtn.addEventListener('click', () => {
      isCollapsed = !isCollapsed;
      if (isCollapsed) {
        sidebar.classList.remove('w-64');
        sidebar.classList.add('w-20');
        sidebarTexts.forEach(el => el.classList.add('hidden'));
        toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        document.querySelectorAll('[id$="-submenu"]').forEach(el => {
          el.classList.add('hidden');
          el.classList.remove('flex');
        });
      } else {
        sidebar.classList.add('w-64');
        sidebar.classList.remove('w-20');
        sidebarTexts.forEach(el => el.classList.remove('hidden'));
        toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
      }
    });

    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    mobileMenuBtn.addEventListener('click', () => {
      sidebar.classList.toggle('-translate-x-full');
      sidebar.classList.toggle('absolute');
      sidebar.classList.toggle('z-50');
      sidebar.classList.toggle('h-full');
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // --- URLs de Webhooks ---
      const MAKE_TECHNICIAN_SEARCH_URL = "https://hook.eu2.make.com/7o0cy2ftscs377jw96saxu0lh4nqkegm";
      const MAKE_CLIENT_SEARCH_URL = "https://hook.eu2.make.com/quirc89qo1imv3lwxhc5fhaj25qkhua7";
      const MAKE_VEHICLE_SEARCH_URL = "https://hook.eu2.make.com/z8b2jaicivbiuuhc819wcwlq2mw2em32";
      const MAKE_PRODUCT_SEARCH_URL = "https://hook.eu2.make.com/8xfyw4ki7ja73vtb2rwbkr3pq1kxcdx8";
      const MAKE_ORDER_SAVE_URL = "https://hook.eu2.make.com/lmx14vfoii9rzn1pmuikiheetox12dil"; // URL para guardar la orden

      const orderForm = document.getElementById('order-form');
      let orderItems = [];
      let uploadedFiles = [];

      // --- LÓGICA DE LA INTERFAZ ---
      const fechaIngresoInput = document.getElementById("fecha-ingreso");
      const now = new Date();
      fechaIngresoInput.value = now.toLocaleString("es-ES", {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      }).replace(",", "");

      // Redirección para crear vehículo
      document.getElementById('add-vehicle-btn').addEventListener('click', () => {
        window.location.href = 'crear-vehiculo.html';
      });

      // --- LÓGICA DEL MODAL ---
      const successModal = document.getElementById('success-modal');
      const closeModalBtn = document.getElementById('close-modal-btn');
      const newOrderBtn = document.getElementById('new-order-btn');

      function showSuccessModal() {
        successModal.classList.add('show');
      }

      function hideSuccessModal() {
        successModal.classList.remove('show');
      }

      function resetForm() {
        orderForm.reset();
        orderItems = [];
        uploadedFiles = [];
        renderItems();
        calculateNetTotals();
        document.getElementById('previews-container').innerHTML = '';
        document.getElementById('cliente-info').textContent = '';
        document.getElementById('vehiculo-info').textContent = '';
        fechaIngresoInput.value = new Date().toLocaleString("es-ES", {
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit'
        }).replace(",", "");
      }

      closeModalBtn.addEventListener('click', hideSuccessModal);
      newOrderBtn.addEventListener('click', () => {
        hideSuccessModal();
        resetForm();
      });


      function showToast(message, isError = false) {
        const toast = document.getElementById("toast-notification");
        toast.textContent = message;
        toast.style.backgroundColor = isError ? 'var(--error-color)' : 'var(--success-color)';
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      // --- LÓGICA DE BÚSQUEDA DINÁMICA ---
      function setupCustomSelect({ inputId, optionsId, searchUrl, onSelect, renderOption }) {
        const input = document.getElementById(inputId);
        const optionsContainer = document.getElementById(optionsId);
        let debounceTimeout;

        input.addEventListener("keyup", () => {
          clearTimeout(debounceTimeout);
          const query = input.value;
          if (query.length < 2) {
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('show');
            return;
          }
          debounceTimeout = setTimeout(() => {
            fetch(searchUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ query: query })
            })
              .then(async response => {
                const responseText = await response.text();
                if (!response.ok) {
                  throw new Error(`Error de red: ${response.status} ${response.statusText} - ${responseText}`);
                }
                return responseText;
              })
              .then(text => {
                console.log(`Respuesta recibida de ${searchUrl} para la búsqueda "${query}":`, text);

                optionsContainer.innerHTML = '';
                let data = [];
                try {
                  data = JSON.parse(text);
                } catch (e) {
                  console.error("El texto recibido no es un JSON válido. Revisa la configuración de respuesta en tu escenario de Make.com. Respuesta recibida:", text);
                  optionsContainer.innerHTML = `<div class="option" style="color: var(--error-color); white-space: normal; line-height: 1.4;"><b>Error: JSON mal formado.</b><br>Revisa la consola (F12) para ver la respuesta exacta del servidor y asegúrate de que el webhook en Make.com genera un JSON correcto.</div>`;
                  optionsContainer.classList.add('show');
                  return;
                }

                const results = Array.isArray(data) ? data : (data ? [data] : []);

                if (results.length > 0) {
                  results.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'option';
                    div.innerHTML = renderOption(item);
                    div.addEventListener('click', () => {
                      onSelect(item);
                      optionsContainer.classList.remove('show');
                    });
                    optionsContainer.appendChild(div);
                  });
                } else {
                  optionsContainer.innerHTML = `<div class="option" style="color: var(--text-secondary);">No se encontraron resultados.</div>`;
                }
                optionsContainer.classList.add('show');
              })
              .catch(error => {
                console.error('Error durante la búsqueda:', error);
                optionsContainer.innerHTML = `<div class="option" style="color: var(--error-color);">Error del servidor. Revisa la consola.</div>`;
                optionsContainer.classList.add('show');
              });
          }, 300);
        });

        document.addEventListener("click", (e) => {
          if (!input.contains(e.target) && !optionsContainer.contains(e.target)) {
            optionsContainer.classList.remove('show');
          }
        });
      }

      // Configurar buscadores
      setupCustomSelect({
        inputId: 'tecnico',
        optionsId: 'tecnico-options',
        searchUrl: MAKE_TECHNICIAN_SEARCH_URL,
        renderOption: item => item.nombre,
        onSelect: item => document.getElementById('tecnico').value = item.nombre
      });
      setupCustomSelect({
        inputId: 'buscar-cliente',
        optionsId: 'cliente-options',
        searchUrl: MAKE_CLIENT_SEARCH_URL,
        renderOption: item => `${item.nombre} <small>(${item.dni})</small>`,
        onSelect: item => {
          document.getElementById('buscar-cliente').value = item.nombre;
          document.getElementById('cliente-info').textContent = `${item.dni} | ${item.telefono}`;
        }
      });
      setupCustomSelect({
        inputId: 'buscar-vehiculo',
        optionsId: 'vehiculo-options',
        searchUrl: MAKE_VEHICLE_SEARCH_URL,
        renderOption: item => `${item.Marca} ${item.Propietario} <small>(${item.Matricula})</small>`,
        onSelect: item => {
          document.getElementById('buscar-vehiculo').value = `${item.Marca} ${item.Propietario}`;
          document.getElementById('vehiculo-info').textContent = item.Matricula;
        }
      });
      setupCustomSelect({
        inputId: 'new-item-name',
        optionsId: 'product-options',
        searchUrl: MAKE_PRODUCT_SEARCH_URL,
        renderOption: item => `${item.nombre} <small>(${parseFloat(item.precio_venta || 0).toFixed(2)}€)</small>`,
        onSelect: item => {
          document.getElementById('new-item-name').value = item.nombre;
          document.getElementById('new-item-price').value = parseFloat(item.precio_venta || 0).toFixed(2);
        }
      });


      // --- LÓGICA DE LA TABLA DE ITEMS ---
      document.getElementById('add-item-btn').addEventListener('click', () => {
        const newItem = {
          name: document.getElementById('new-item-name').value,
          price: parseFloat(document.getElementById('new-item-price').value) || 0,
          quantity: parseInt(document.getElementById('new-item-quantity').value) || 1,
          type: document.getElementById('new-item-type').value,
          bonus: parseFloat(document.getElementById('new-item-bonus').value) || 0,
        };

        if (!newItem.name || newItem.price <= 0) {
          alert("Por favor, introduce un nombre y un precio válido para el item.");
          return;
        }

        orderItems.push(newItem);
        renderItems();
        calculateNetTotals();
        clearAddItemRow();
      });

      function renderItems() {
        const itemList = document.getElementById('order-items-list');
        itemList.innerHTML = '';
        orderItems.forEach((item, index) => {
          const subtotal = (item.price * item.quantity) - item.bonus;
          const row = document.createElement('tr');
          row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price.toFixed(2)}€</td>
                    <td>${item.quantity}</td>
                    <td>${item.type}</td>
                    <td>${item.bonus.toFixed(2)}€</td>
                    <td>${subtotal.toFixed(2)}€</td>
                    <td><button type="button" class="remove-item-btn" data-index="${index}">&times;</button></td>
                `;
          itemList.appendChild(row);
        });
      }

      document.getElementById('order-items-list').addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-item-btn')) {
          const index = e.target.dataset.index;
          orderItems.splice(index, 1);
          renderItems();
          calculateNetTotals();
        }
      });

      function clearAddItemRow() {
        document.getElementById('new-item-name').value = '';
        document.getElementById('new-item-price').value = '';
        document.getElementById('new-item-quantity').value = '1';
        document.getElementById('new-item-bonus').value = '0';
        document.getElementById('new-item-name').focus();
      }

      // --- LÓGICA DE CÁLCULO Y PAGO ---
      function calculateNetTotals() {
        let totalRepuestos = 0;
        let totalManoDeObra = 0;

        orderItems.forEach(item => {
          const subtotal = (item.price * item.quantity) - item.bonus;
          if (item.type === 'Repuesto') {
            totalRepuestos += subtotal;
          } else {
            totalManoDeObra += subtotal;
          }
        });

        const descuento = parseFloat(document.getElementById('discount-input').value) || 0;
        const subtotalNeto = totalRepuestos + totalManoDeObra;
        const totalDescuento = subtotalNeto * (descuento / 100);
        const totalNeto = subtotalNeto - totalDescuento;

        document.getElementById('summary-repuestos').textContent = `${totalRepuestos.toFixed(2)}€`;
        document.getElementById('summary-mano-obra').textContent = `${totalManoDeObra.toFixed(2)}€`;
        document.getElementById('summary-neto').textContent = `${totalNeto.toFixed(2)}€`;

        updateFinalTotal();
      }

      function updateFinalTotal() {
        const totalNetoText = document.getElementById('summary-neto').textContent;
        const totalNeto = parseFloat(totalNetoText.replace('€', '')) || 0;
        const ivaPercentage = parseFloat(document.getElementById('iva-percentage').value) || 0;
        const ivaAmount = totalNeto * (ivaPercentage / 100);

        document.getElementById('summary-iva').textContent = `${ivaAmount.toFixed(2)}€`;

        const totalFinal = totalNeto + ivaAmount;

        document.getElementById('summary-total').textContent = `${totalFinal.toFixed(2)}€`;
        document.getElementById('payment-amount-input').value = totalFinal.toFixed(2);
        validatePayment();
      }

      function validatePayment() {
        const totalFinalText = document.getElementById('summary-total').textContent;
        const totalFinal = parseFloat(totalFinalText.replace('€', '')) || 0;
        const paymentInput = document.getElementById('payment-amount-input');
        const pagoManual = parseFloat(paymentInput.value) || 0;

        if (pagoManual.toFixed(2) !== totalFinal.toFixed(2) && !document.getElementById('cuenta-corriente-check').checked) {
          paymentInput.classList.add('mismatch-amount');
        } else {
          paymentInput.classList.remove('mismatch-amount');
        }
      }

      document.getElementById('discount-input').addEventListener('input', calculateNetTotals);
      document.getElementById('iva-percentage').addEventListener('input', calculateNetTotals);
      document.getElementById('payment-amount-input').addEventListener('input', validatePayment);


      const cuentaCorrienteCheck = document.getElementById('cuenta-corriente-check');
      const metodoPagoSelect = document.getElementById('metodo-pago');

      cuentaCorrienteCheck.addEventListener('change', () => {
        if (cuentaCorrienteCheck.checked) {
          metodoPagoSelect.disabled = true;
          metodoPagoSelect.style.backgroundColor = 'var(--border-color)';
        } else {
          metodoPagoSelect.disabled = false;
          metodoPagoSelect.style.backgroundColor = '';
        }
        validatePayment();
      });


      // --- LÓGICA PARA SUBIDA DE MÚLTIPLES IMÁGENES ---
      const uploadInput = document.getElementById('vehicle-images-upload');
      const dropZone = document.querySelector('.multi-image-upload-box');
      const previewsContainer = document.getElementById('previews-container');

      dropZone.addEventListener('click', () => uploadInput.click());
      dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });
      uploadInput.addEventListener('change', (e) => handleFiles(e.target.files));

      function handleFiles(files) {
        for (const file of files) {
          if (!file.type.startsWith('image/')) continue;
          if (uploadedFiles.some(f => f.file.name === file.name && f.file.size === file.size)) continue;

          const fileWithId = { file, id: Date.now() + Math.random() };
          uploadedFiles.push(fileWithId);

          const reader = new FileReader();
          reader.onload = (e) => createPreview(e.target.result, fileWithId.id);
          reader.readAsDataURL(file);
        }
        uploadInput.value = '';
      }

      function createPreview(src, id) {
        const wrapper = document.createElement('div');
        wrapper.className = 'img-preview-wrapper';
        wrapper.dataset.fileId = id;
        const img = document.createElement('img');
        img.src = src;
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-img-btn';
        removeBtn.innerHTML = '&times;';
        removeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const fileIdToRemove = parseFloat(wrapper.dataset.fileId);
          uploadedFiles = uploadedFiles.filter(f => f.id !== fileIdToRemove);
          wrapper.remove();
        });
        wrapper.appendChild(img);
        wrapper.appendChild(removeBtn);
        previewsContainer.appendChild(wrapper);
      }

      // --- LÓGICA DE ENVÍO DEL FORMULARIO ---
      orderForm.addEventListener('submit', (e) => {
        e.preventDefault();

        if (!document.getElementById('taller').value) {
          showToast('Debes seleccionar un taller.', true);
          return;
        }
        if (!document.getElementById('buscar-cliente').value) {
          showToast('Debes seleccionar un cliente.', true);
          return;
        }
        if (orderItems.length === 0) {
          showToast('Debes agregar al menos un item a la orden.', true);
          return;
        }

        const totalFinalText = document.getElementById('summary-total').textContent;
        const totalFinal = parseFloat(totalFinalText.replace('€', '')) || 0;
        const paymentInput = document.getElementById('payment-amount-input');
        const pagoManual = parseFloat(paymentInput.value) || 0;
        const isCuentaCorriente = document.getElementById('cuenta-corriente-check').checked;

        if (pagoManual.toFixed(2) !== totalFinal.toFixed(2) && !isCuentaCorriente) {
          showToast('El pago no coincide con el total. Marque "Enviar saldo" para continuar.', true);
          return;
        }

        const formData = new FormData(orderForm);

        if (isCuentaCorriente) {
          formData.set('metodo_pago', 'Cuenta Corriente');
        } else {
          formData.set('metodo_pago', document.getElementById('metodo-pago').value);
        }

        formData.append('cliente_info', document.getElementById('cliente-info').textContent);
        formData.append('vehiculo_placa', document.getElementById('vehiculo-info').textContent);
        formData.append('items', JSON.stringify(orderItems));

        formData.append('total_repuestos', document.getElementById('summary-repuestos').textContent);
        formData.append('total_mano_obra', document.getElementById('summary-mano-obra').textContent);
        formData.append('total_neto', document.getElementById('summary-neto').textContent);
        formData.append('iva_calculado', document.getElementById('summary-iva').textContent);
        formData.append('total_final', document.getElementById('summary-total').textContent);

        uploadedFiles.forEach((fileWrapper, index) => {
          formData.append(`vehiculo_imagen_${index + 1}`, fileWrapper.file);
        });

        console.log("Enviando datos de la orden a Make...");

        fetch(MAKE_ORDER_SAVE_URL, {
          method: 'POST',
          body: formData
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('La respuesta del servidor no fue OK al guardar.');
            }
            return response.text();
          })
          .then(result => {
            console.log('Respuesta de guardado:', result);
            showSuccessModal();
          })
          .catch(error => {
            console.error('Error al guardar la orden:', error);
            showToast('Hubo un error al guardar la orden.', true);
          });
      });
    });
  </script>
</body>

</html>