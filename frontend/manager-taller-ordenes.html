<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Órdenes - Goversa</title>
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="styles/sucursal-selector.css">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/guard.js"></script>

  <!-- Estilos Globales del Manager -->
  <link rel="stylesheet" href="manager.css">

  <style>
    /* 
     * Estilos específicos de manager-taller-ordenes.html
     * Las variables globales (:root) están centralizadas en manager.css
     */

    body {
      font-family: var(--font-main);
      background-color: var(--bg-deep);
      color: var(--text-primary);
      margin: 0;
    }


    /* Estilos Específicos del Formulario */
    .manager-panel {
      max-width: 1200px;
      margin: 0 auto;
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      gap: 20px;
      flex-wrap: wrap;
    }

    .form-main-title {
      font-size: 28px;
      font-weight: 800;
      margin: 0;
      color: var(--text-primary);
    }

    .form-header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .form-section {
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 25px;
      padding-bottom: 25px;
    }

    .form-section:last-of-type {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .form-grid {
      display: grid;
      gap: 20px;
    }

    .grid-cols-3 {
      grid-template-columns: repeat(3, 1fr);
    }

    .grid-cols-4 {
      grid-template-columns: repeat(4, 1fr);
    }

    .grid-cols-5 {
      grid-template-columns: repeat(5, 1fr);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .form-group label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .form-input,
    .form-select,
    textarea.form-input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      font-family: "Montserrat", Arial, sans-serif;
      font-size: 15px;
      box-sizing: border-box;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .form-input:focus,
    .form-select:focus,
    textarea.form-input:focus {
      outline: none;
      border-color: var(--brand-orange);
      box-shadow: 0 0 0 3px rgba(255, 95, 0, 0.2);
    }

    .input-group {
      display: flex;
    }

    .input-group .form-input {
      border-radius: 8px 0 0 8px;
    }

    .input-group .btn {
      border-radius: 0 8px 8px 0;
      padding: 0 15px;
      font-size: 20px;
    }

    .info-display {
      background-color: var(--input-bg);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      min-height: 47px;
      box-sizing: border-box;
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
    }

    /* Estilos para Dropdown Buscable */
    .custom-select-container {
      position: relative;
      width: 100%;
    }

    .custom-select-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: #333333;
      border: 1px solid #444444;
      border-radius: 8px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      margin-top: 5px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .custom-select-options.show {
      display: block;
    }

    .custom-select-options .option {
      padding: 12px 15px;
      cursor: pointer;
      font-size: 14px;
      border-bottom: 1px solid #444;
    }

    .custom-select-options .option:last-child {
      border-bottom: none;
    }

    .custom-select-options .option:hover {
      background-color: var(--brand-orange);
      color: white;
    }

    /* Estilos Tabla de Items */
    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .items-table th,
    .items-table td {
      border-bottom: 1px solid var(--border-color);
      padding: 12px 8px;
      text-align: left;
      vertical-align: middle;
      color: var(--text-primary);
    }

    .items-table th {
      background: #2a2a2a;
      color: var(--text-secondary);
      grid-template-columns: 1fr 1fr;
      gap: 40px;
    }

    .summary-table {
      width: 100%;
    }

    .summary-table td {
      padding: 8px 0;
      color: var(--text-primary);
    }

    .summary-table tr td:first-child {
      font-weight: 600;
      color: var(--text-secondary);
    }

    .summary-table tr td:last-child {
      font-weight: 600;
      text-align: right;
    }

    .summary-table .total-row td {
      font-size: 18px;
      font-weight: 800;
      color: var(--brand-orange);
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }

    #payment-amount-input.mismatch-amount {
      color: var(--error-color) !important;
      border-color: var(--error-color);
    }

    /* Subida de Imágenes */
    .multi-image-upload-box {
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background-color 0.2s;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 10px;
      color: var(--text-secondary);
    }

    .multi-image-upload-box:hover,
    .multi-image-upload-box.dragover {
      border-color: var(--brand-orange);
      background-color: #252525;
      color: var(--text-primary);
    }

    #previews-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 20px;
    }

    .img-preview-wrapper {
      position: relative;
      width: 120px;
      height: 120px;
    }

    .img-preview-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .remove-img-btn {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: var(--error-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }

    .remove-img-btn:hover {
      transform: scale(1.1);
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      margin: -1px;
      padding: 0;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    /* Botones */
    .btn {
      background-color: var(--brand-orange);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      border-radius: 8px;
      padding: 12px 18px;
      font-size: 15px;
      transition: background-color 0.2s;
    }

    .btn:hover {
      background-color: #e05300;
    }

    .btn-secondary {
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background-color: #444;
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }

    .btn-outline:hover {
      background-color: var(--border-color);
      color: var(--text-primary);
    }

    /* Toast Notification */
    #toast-notification {
      visibility: hidden;
      min-width: 250px;
      background-color: var(--success-color);
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 16px;
      position: fixed;
      z-index: 3000;
      left: 50%;
      transform: translateX(-50%);
      bottom: 30px;
      font-size: 15px;
      font-weight: 600;
      opacity: 0;
      transition: opacity 0.5s, bottom 0.5s;
    }

    #toast-notification.show {
      visibility: visible;
      opacity: 1;
      bottom: 50px;
    }

    /* Modal de Éxito */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.show {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      background-color: var(--surface-bg);
      padding: 40px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      width: 90%;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      transform: scale(0.95);
      transition: transform 0.3s ease;
    }

    .modal-overlay.show .modal-content {
      transform: scale(1);
    }

    .modal-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background-color: var(--success-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-icon svg {
      width: 50px;
      height: 50px;
      color: white;
    }

    .modal-content h3 {
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 15px 0;
      color: var(--text-primary);
    }

    .modal-content p {
      font-size: 16px;
      color: var(--text-secondary);
      margin: 0 0 30px 0;
    }

    .modal-actions {
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .summary-payment-grid {
        grid-template-columns: 1fr;
      }

      .grid-cols-3,
      .grid-cols-4,
      .grid-cols-5 {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .form-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .summary-payment-grid {
        gap: 24px;
      }

      .grid-cols-3,
      .grid-cols-4,
      .grid-cols-5 {
        grid-template-columns: 1fr;
      }
    }

    /* Estilos Modal Nuevo Cliente (Dark Theme) */
    .modal-content-large {
      width: 95%;
      max-width: 900px;
      background-color: #1a1d24;
      /* Darker background like the image */
      padding: 30px;
      border: 1px solid #333;
      text-align: left;
    }

    .modal-header-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
      margin-bottom: 5px;
    }

    .modal-subtitle {
      color: #888;
      font-size: 13px;
      margin-bottom: 25px;
    }

    .modal-section-title {
      color: var(--brand-orange);
      font-size: 16px;
      font-weight: 600;
      margin: 20px 0 15px 0;
      border-bottom: 1px solid #333;
      padding-bottom: 5px;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 15px;
    }

    .col-span-12 {
      grid-column: span 12;
    }

    .col-span-6 {
      grid-column: span 6;
    }

    .col-span-4 {
      grid-column: span 4;
    }

    .col-span-3 {
      grid-column: span 3;
    }

    .modal-input-group label {
      display: block;
      color: #ccc;
      font-size: 13px;
      margin-bottom: 5px;
    }

    .modal-input {
      width: 100%;
      background-color: #0b0d11;
      /* Very dark input bg */
      border: 1px solid #333;
      color: white;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
    }

    .modal-input:focus {
      border-color: var(--brand-orange);
      outline: none;
    }

    .modal-footer {
      margin-top: 30px;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      border-top: 1px solid #333;
      padding-top: 20px;
    }
  </style>
</head>

<body>
  <div class="flex h-screen w-full">
    <aside id="sidebar"
      class="flex h-full w-64 flex-col bg-[#111318] p-4 shrink-0 transition-all duration-300 ease-in-out border-r border-[var(--surface-border)]">
      <div class="flex h-full flex-col justify-between">
        <div class="flex flex-col gap-4">
          <div class="flex items-center gap-3 p-2 mb-4">
            <div class="logo-badge"
              style="padding: 8px; border-radius: 12px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
              <img src="https://i.imgur.com/Mjw4or5.png" alt="Logo" class="logo-img" style="height: 24px; width: auto;">
            </div>
            <div class="flex flex-col sidebar-text">
              <h1 class="text-white text-base font-medium leading-normal" style="font-size: 15px;">Goversa</h1>
              <p class="text-[#9da6b9] text-sm font-normal leading-normal" style="font-size: 12px;">Gestión</p>
            </div>
            <button id="toggle-sidebar" class="ml-auto text-gray-400 hover:text-white">
              <i class="fas fa-chevron-left"></i>
            </button>
          </div>

          <nav class="flex flex-col gap-2">
            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-inicio.html">
              <span class="icon-container"><i class="fas fa-home"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Inicio</p>
            </a>

            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 bg-[var(--brand-orange)] text-white rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('taller-submenu')">
                <span class="icon-container"><i class="fas fa-wrench"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Taller</p>
                <i class="fas fa-chevron-up text-xs sidebar-text transition-transform" id="taller-arrow"></i>
              </a>
              <div id="taller-submenu" class="flex flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-citas.html" class="text-gray-400 hover:text-white text-sm py-1 block">Citas</a>
                <a href="manager-taller-ordenes-lista.html"
                  class="text-white font-semibold text-sm py-1 block">Órdenes</a>
                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Editar Órdenes</a>
                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Presupuestos</a>
                <a href="manager-taller-vehiculos.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Vehículos</a>
                <a href="manager-taller-chat.html" class="text-gray-500 hover:text-white text-sm py-1 block">Chat
                  Clientes</a>
              </div>

              <!-- Tienda Dropdown -->
              <div class="nav-group">
                <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                  onclick="toggleSubmenu('tienda-submenu')">
                  <span class="icon-container"><i class="fas fa-shopping-cart"></i></span>
                  <p class="text-sm font-medium leading-normal sidebar-text flex-1">Tienda</p>
                  <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="tienda-arrow"></i>
                </a>
                <div id="tienda-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                  <a href="manager-taller-compras.html" class="text-gray-500 hover:text-white text-sm py-1 block">Nueva
                    Compra</a>
                  <a href="manager-taller-compras-historial.html"
                    class="text-gray-500 hover:text-white text-sm py-1 block">Historial Compras</a>
                  <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Ventas</a>
                  <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Productos</a>
                </div>
              </div>

              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
                href="manager-taller-caja.html">
                <span class="icon-container"><i class="fas fa-cash-register"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text">Caja</p>
              </a>

              <!-- Cuentas Dropdown -->
              <div class="nav-group">
                <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                  onclick="toggleSubmenu('cuentas-submenu')">
                  <span class="icon-container"><i class="fas fa-file-invoice-dollar"></i></span>
                  <p class="text-sm font-medium leading-normal sidebar-text flex-1">Cuentas</p>
                  <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="cuentas-arrow"></i>
                </a>
                <div id="cuentas-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                  <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Facturas</a>
                  <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Gastos</a>
                </div>
              </div>

              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
                href="manager-taller-inventario.html">
                <span class="icon-container"><i class="fas fa-boxes"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text">Inventario</p>
              </a>

              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
                href="manager-taller-trabajadores.html">
                <span class="icon-container"><i class="fas fa-users-cog"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text">Trabajadores</p>
              </a>

              <!-- Contactos -->
              <div class="nav-group">
                <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                  onclick="toggleSubmenu('contactos-submenu')">
                  <span class="icon-container"><i class="fas fa-address-book"></i></span>
                  <p class="text-sm font-medium leading-normal sidebar-text flex-1">Contactos</p>
                  <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="contactos-arrow"></i>
                </a>
                <div id="contactos-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                  <a href="manager-taller-clientes.html"
                    class="text-gray-500 hover:text-white text-sm py-1 block">Clientes</a>
                  <a href="manager-taller-proveedores.html"
                    class="text-gray-400 hover:text-white text-sm py-1 block">Proveedores</a>
                </div>
              </div>
          </nav>
        </div>

        <div class="flex flex-col gap-1 border-t border-[var(--surface-border)] pt-4">
          <div class="flex items-center gap-3 px-3 py-2 mb-2">
            <div
              class="w-8 h-8 rounded-full bg-[var(--brand-orange)] flex items-center justify-center text-white font-bold text-xs">
              IM
            </div>
            <div class="flex flex-col sidebar-text overflow-hidden">
              <span class="text-white text-sm font-medium truncate">Iván Moreno</span>
              <span class="text-gray-500 text-xs truncate">admin</span>
            </div>
          </div>
          <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
            href="#" data-logout>
            <span class="icon-container"><i class="fas fa-sign-out-alt"></i></span>
            <p class="text-sm font-medium leading-normal sidebar-text">Salir</p>
          </a>
        </div>
      </div>
    </aside>

    <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
      <header
        class="md:hidden flex items-center justify-between p-4 bg-[#111318] border-b border-[var(--surface-border)]">
        <div class="logo-badge p-2">
          <img src="https://i.imgur.com/Mjw4or5.png" alt="Logo" class="h-6 w-auto">
        </div>
        <button id="mobile-menu-btn" class="text-white">
          <i class="fas fa-bars"></i>
        </button>
      </header>

      <main class="flex-1 overflow-y-auto p-6 relative z-10">
        <!-- Selector de Sucursal Centrado -->
        <div class="flex justify-center mb-6">
          <div id="sucursal-selector-container"></div>
        </div>

        <form id="order-form" class="manager-panel">
          <input type="hidden" id="id-tecnico-hidden" name="idMecanico" />
          <input type="hidden" id="id-cliente-hidden" name="idCliente" />
          <input type="hidden" id="id-vehiculo-hidden" name="idVehiculo" />
          <input type="hidden" id="id-tipo-orden-hidden" name="idTipoOrden" />
          <input type="hidden" id="id-taller-hidden" name="idSucursal" />

          <div class="form-header">
            <h2 class="form-main-title">Orden de Reparación</h2>
            <div class="form-header-actions">
              <button type="button" class="btn btn-outline">Volver</button>
              <button type="button" class="btn btn-secondary">Cancelar</button>
              <button type="submit" class="btn">Confirmar</button>
            </div>
          </div>

          <div class="form-section">
            <div class="form-grid grid-cols-4">
              <div class="form-group">
                <label for="fecha-ingreso">Fecha Ingreso</label>
                <input type="text" id="fecha-ingreso" name="fecha_ingreso" class="form-input" readonly />
              </div>
              <div class="form-group">
                <label for="fecha-egreso">Fecha Egreso</label>
                <input type="datetime-local" id="fecha-egreso" name="fecha_egreso" class="form-input" />
              </div>
              <div class="form-group">
                <label for="tecnico-select">Técnico</label>
                <select id="tecnico-select" name="tecnico" class="form-select">
                  <option value="">Seleccionar técnico</option>
                </select>
              </div>
              <div class="form-group">
                <label for="taller">Taller *</label>
                <select id="taller" name="taller" class="form-select" required>
                  <option value="" disabled selected>Seleccionar Taller</option>
                  <option value="1">SUCURSAL PRINCIPAL</option>
                  <option value="2">SUCURSAL CENTRO</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-grid grid-cols-5">
              <div class="form-group" style="grid-column: span 2;">
                <label for="buscar-cliente">Buscar Cliente</label>
                <div class="custom-select-container">
                  <div class="input-group">
                    <input type="text" id="buscar-cliente" name="cliente_nombre" class="form-input custom-select-input"
                      placeholder="Nombre, NIF o teléfono..." autocomplete="off">
                    <button type="button" id="add-client-btn" class="btn btn-secondary"
                      title="Crear nuevo cliente">+</button>
                  </div>
                  <div class="custom-select-options" id="cliente-options"></div>
                </div>
              </div>
              <div class="form-group" style="grid-column: span 1;">
                <label>NIF | Tel.</label>
                <div id="cliente-info" class="info-display"></div>
              </div>
              <div class="form-group" style="grid-column: span 1;">
                <label for="vehiculo-select">Seleccionar Vehículo</label>

                <div class="input-group">
                  <select id="vehiculo-select" name="vehiculo_id" class="form-select" disabled>
                    <option value="" disabled selected>Seleccione un cliente primero</option>
                  </select>

                  <button type="button" id="add-vehicle-btn" class="btn btn-secondary"
                    title="Crear nuevo vehículo">+</button>
                </div>


              </div>
              <div class="form-group" style="grid-column: span 1;">
                <label>Matrícula</label>
                <div id="vehiculo-info" class="info-display"></div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-grid grid-cols-4">
              <div class="form-group">
                <label for="concepto">Concepto</label>
                <select id="concepto" name="concepto" class="form-select">
                  <option value="1">Reparación</option>
                  <option value="2">Mantenimiento</option>
                  <option value="3">Diagnóstico</option>
                </select>
              </div>
              <div class="form-group">
                <label for="combustible">Combustible</label>
                <select id="combustible" name="combustible" class="form-select">
                  <option>Bajo</option>
                  <option>1/4</option>
                  <option>1/2</option>
                  <option>3/4</option>
                  <option>Lleno</option>
                </select>
              </div>
              <div class="form-group">
                <label for="kilometraje">Kilometraje</label>
                <input type="text" id="kilometraje" name="kilometraje" class="form-input" />
              </div>
              <div class="form-group">
                <label for="nombre-inspector">Nombre Inspector</label>
                <input type="text" id="nombre-inspector" name="inspector" class="form-input" />
              </div>
              <div class="form-group">
                <label for="numero-siniestro">Número Siniestro</label>
                <input type="text" id="numero-siniestro" name="siniestro" class="form-input" />
              </div>
              <div class="form-group">
                <label for="franquicia">Franquicia</label>
                <input type="text" id="franquicia" name="franquicia" class="form-input" />
              </div>
            </div>
          </div>

          <div class="form-section">
            <table class="items-table">
              <thead>
                <tr>
                  <th style="width: 40%;">Item</th>
                  <th style="width: 15%;">Importe</th>
                  <th style="width: 10%;">Cantidad</th>
                  <th style="width: 15%;">Tipo</th>
                  <th style="width: 10%;">Bonif.</th>
                  <th style="width: 10%;">Subtotal</th>
                  <th style="width: 10%;">IVA</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="order-items-list">
              </tbody>
              <tfoot>
                <tr id="add-item-row">
                  <td>
                    <input type="hidden" id="new-item-id-hidden" />
                    <div class="custom-select-container">
                      <input type="text" id="new-item-name" class="form-input custom-select-input"
                        placeholder="Buscar Producto o Servicio..." autocomplete="off">
                      <div class="custom-select-options" id="product-options"></div>
                    </div>
                  </td>
                  <td><input type="number" id="new-item-price" class="form-input" placeholder="0.00"></td>
                  <td><input type="number" id="new-item-quantity" class="form-input" value="1"></td>
                  <td>
                    <select id="new-item-type" class="form-select">
                      <option value="PRODUCTO">Repuesto</option>
                      <option value="SERVICIO">Servicio</option>
                    </select>
                  </td>
                  <td><input type="number" id="new-item-bonus" class="form-input" value="0"></td>
                  <td id="new-item-subtotal">0.00€</td>
                  <td>
                    <select id="new-item-iva" class="form-select">
                      <option value="0">0%</option>
                      <option value="10">10%</option>
                      <option value="21" selected>21%</option>
                    </select>
                  </td>
                  <td><button type="button" id="add-item-btn" class="btn">Agregar</button></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="form-section">
            <div class="form-group">
              <label for="vehicle-images-upload">Fotos del Vehículo</label>
              <input type="file" id="vehicle-images-upload" class="visually-hidden" multiple accept="image/*">
              <label for="vehicle-images-upload" class="multi-image-upload-box">
                <span>Arrastra las fotos aquí o haz clic para seleccionar</span>
                <small>(Puedes seleccionar varios archivos a la vez)</small>
              </label>
              <div id="previews-container">
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="summary-payment-grid">
              <div>
                <div class="form-group">
                  <label for="observaciones">Observaciones</label>
                  <textarea id="observaciones" name="observaciones" rows="5" class="form-input"></textarea>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                  <label for="comentario-interno">Comentario Interno</label>
                  <textarea id="comentario-interno" name="comentario_interno" rows="5" class="form-input"></textarea>
                </div>
              </div>

              <div>
                <h4>Resumen</h4>
                <table class="summary-table">
                  <tbody>
                    <tr>
                      <td>Descuento</td>
                      <td>
                        <input type="number" id="discount-input" name="descuento" class="form-input"
                          style="text-align: right; width: 80px; display: inline-block; margin-left: auto;" value="0">
                        %
                      </td>
                    </tr>
                    <tr>
                      <td>Repuestos</td>
                      <td id="summary-repuestos">0.00€</td>
                    </tr>
                    <tr>
                      <td>Mano de obra</td>
                      <td id="summary-mano-obra">0.00€</td>
                    </tr>
                    <tr>
                      <td>Total Neto</td>
                      <td id="summary-neto">0.00€</td>
                    </tr>
                    <tr>
                      <td>Total IVA</td>


                      <td id="summary-iva">0.00€</td>
                    </tr>
                    <tr class="total-row">
                      <td>Total</td>
                      <td id="summary-total">0.00€</td>
                    </tr>
                  </tbody>
                </table>

                <h4 style="margin-top: 30px; display: flex; justify-content: space-between; align-items: center;">
                  <span>Pagos</span>
                  <span id="pagos-badge"
                    style="background: var(--brand-orange); color: white; padding: 2px 8px; border-radius: 50%; font-size: 12px; display: none;">0</span>
                </h4>

                <div id="pagos-list" style="max-height: 150px; overflow-y: auto; margin-bottom: 15px;">
                  <table class="summary-table" id="pagos-table" style="font-size: 13px;">
                    <tbody id="pagos-tbody">
                    </tbody>
                  </table>
                  <p id="pagos-empty"
                    style="color: var(--text-secondary); font-size: 13px; text-align: center; padding: 10px;">
                    No hay pagos registrados
                  </p>
                </div>

                <div
                  style="background: rgba(255,95,0,0.05); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                  <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                    <div class="form-group" style="margin-bottom: 0;">
                      <label for="nuevo-pago-metodo" style="font-size: 12px;">Método de Pago</label>
                      <select id="nuevo-pago-metodo" class="form-input" style="padding: 8px; font-size: 13px;">
                        <option value="" disabled>Cargando...</option>
                      </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                      <label for="nuevo-pago-importe" style="font-size: 12px;">Importe (€)</label>
                      <input type="number" step="0.01" min="0" id="nuevo-pago-importe" class="form-input"
                        style="padding: 8px; font-size: 13px; text-align: right;" placeholder="0.00">
                    </div>
                    <button type="button" id="btn-agregar-pago" class="btn"
                      style="padding: 8px 15px; font-size: 13px; height: 38px;">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                  <div class="form-group" style="margin-bottom: 0; margin-top: 10px;">
                    <label for="nuevo-pago-referencia" style="font-size: 12px;">Referencia (opcional)</label>
                    <input type="text" id="nuevo-pago-referencia" class="form-input"
                      style="padding: 8px; font-size: 13px;" placeholder="Nº transacción, ticket, etc.">
                  </div>
                </div>

                <div
                  style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
                  <span style="color: var(--text-secondary); font-size: 14px;">Cuenta Corriente</span>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="cuenta-corriente-check" name="cuenta_corriente" value="true"
                      style="width: 18px; height: 18px; vertical-align: middle;">
                    <label for="cuenta-corriente-check" style="vertical-align: middle; font-size: 13px;">Enviar
                      saldo</label>
                  </div>
                </div>

                <table class="summary-table" style="margin-top: 15px;">
                  <tbody>
                    <tr>
                      <td style="color: var(--text-secondary);">Total Pagado</td>
                      <td id="resumen-total-pagado"
                        style="text-align: right; color: var(--success-color); font-weight: 600;">0.00€</td>
                    </tr>
                    <tr class="total-row">
                      <td>Saldo Pendiente</td>
                      <td id="resumen-saldo-pendiente" style="text-align: right;">0.00€</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </form>
      </main>

      <div id="toast-notification"></div>

      <div id="success-modal" class="modal-overlay">
        <div class="modal-content">
          <div class="modal-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
              <path
                d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z" />
            </svg>
          </div>
          <h3>¡Orden Enviada!</h3>
          <p>La orden de reparación ha sido procesada.</p>
          <div class="modal-actions">
            <button id="close-modal-btn" type="button" class="btn btn-secondary">Cerrar</button>
            <button id="new-order-btn" type="button" class="btn">Crear Nueva</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="new-client-modal" class="modal-overlay">
    <div class="modal-content modal-content-large">
      <h2 class="modal-header-title">Registro de Nuevo Cliente</h2>
      <p class="modal-subtitle">Los campos marcados con * son obligatorios.</p>

      <form id="new-client-form">
        <div class="modal-grid">
          <div class="modal-input-group col-span-4">
            <label>Nombre Completo *</label>
            <input type="text" name="nombre" class="modal-input" placeholder="Nombre y Apellidos" required>
          </div>
          <div class="modal-input-group col-span-2">
            <label>Tipo Documento</label>
            <select name="tipo_documento" class="modal-input">
              <option value="DNI">DNI</option>
              <option value="NIE">NIE</option>
              <option value="CIF">CIF</option>
              <option value="Pasaporte">Pasaporte</option>
            </select>
          </div>
          <div class="modal-input-group col-span-3">
            <label>Documento (DNI/NIF/NIE) *</label>
            <input type="text" name="documento" class="modal-input" placeholder="Ej: 12345678Z" required>
          </div>
          <div class="modal-input-group col-span-3">
            <label>Origen del Cliente</label>
            <select name="origen_cliente" class="modal-input">
              <option value="">Seleccionar...</option>
              <option value="Google">Google</option>
              <option value="Redes Sociales">Redes Sociales</option>
              <option value="Recomendación">Recomendación</option>
              <option value="Pasante">Pasante</option>
              <option value="Otro">Otro</option>
            </select>
          </div>

          <div class="col-span-12">
            <h3 class="modal-section-title">Datos de Contacto</h3>
          </div>
          <div class="modal-input-group col-span-4">
            <label>Teléfono Principal *</label>
            <input type="text" name="telefono" class="modal-input" placeholder="+34 ..." required>
          </div>
          <div class="modal-input-group col-span-4">
            <label>Teléfono Alternativo</label>
            <input type="text" name="telefono_alternativo" class="modal-input" placeholder="Opcional">
          </div>
          <div class="modal-input-group col-span-4">
            <label>Correo Electrónico</label>
            <input type="email" name="email" class="modal-input" placeholder="cliente@ejemplo.com">
          </div>

          <div class="col-span-12">
            <h3 class="modal-section-title">Dirección</h3>
          </div>
          <div class="modal-input-group col-span-6">
            <label>Dirección</label>
            <input type="text" name="direccion" class="modal-input" placeholder="Calle, Número, Piso...">
          </div>
          <div class="modal-input-group col-span-4">
            <label>Localidad</label>
            <input type="text" name="localidad" class="modal-input">
          </div>
          <div class="modal-input-group col-span-2">
            <label>Código Postal</label>
            <input type="text" name="cp_cliente" class="modal-input" placeholder="28000">
          </div>

          <div class="col-span-12">
            <h3 class="modal-section-title">Comentarios / Observaciones</h3>
          </div>
          <div class="modal-input-group col-span-12">
            <textarea name="comentario" class="modal-input" rows="3" placeholder="Notas sobre el cliente..."></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" id="cancel-new-client-btn" class="btn btn-outline"
            style="border: none; color: #aaa;">Cancelar</button>
          <button type="submit" class="btn">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="new-vehicle-modal" class="modal-overlay">
    <div class="modal-content modal-content-large">
      <h2 class="modal-header-title">Registro de Nuevo Vehículo</h2>
      <p class="modal-subtitle">Los campos marcados con * son obligatorios.</p>

      <form id="new-vehicle-form">
        <div class="modal-grid">
          <div class="col-span-12">
            <h3 class="modal-section-title">Información del Cliente</h3>
          </div>
          <div class="modal-input-group col-span-6">
            <label>Cliente *</label>
            <div class="custom-select-container">
              <input type="text" id="new-vehicle-client-search" class="modal-input" placeholder="Buscar cliente..."
                autocomplete="off">
              <input type="hidden" name="id_cliente" id="new-vehicle-client-id">
              <div class="custom-select-options" id="new-vehicle-client-options"></div>
            </div>
          </div>
          <div class="modal-input-group col-span-6">
            <label>Sucursal *</label>
            <select name="id_sucursal" id="new-vehicle-sucursal" class="modal-input" required>
              <option value="">Seleccionar Sucursal...</option>
            </select>
          </div>

          <div class="col-span-12">
            <h3 class="modal-section-title">Datos del Vehículo</h3>
          </div>
          <div class="modal-input-group col-span-4">
            <label>Matrícula *</label>
            <input type="text" name="matricula" class="modal-input" placeholder="Ej: 1234ABC" required>
          </div>
          <div class="modal-input-group col-span-4">
            <label>Marca *</label>
            <input type="text" name="marca" class="modal-input" placeholder="Ej: Toyota" required>
          </div>
          <div class="modal-input-group col-span-4">
            <label>Modelo *</label>
            <input type="text" name="modelo" class="modal-input" placeholder="Ej: Corolla" required>
          </div>

          <div class="modal-input-group col-span-3">
            <label>Año</label>
            <input type="number" name="anio" class="modal-input" placeholder="Ej: 2020">
          </div>
          <div class="modal-input-group col-span-3">
            <label>Color</label>
            <input type="text" name="color" class="modal-input">
          </div>
          <div class="modal-input-group col-span-3">
            <label>CC</label>
            <input type="text" name="cilindrada" class="modal-input">
          </div>
          <div class="modal-input-group col-span-3">
            <label>Seguro</label>
            <input type="text" name="seguro" class="modal-input">
          </div>
          <div class="modal-input-group col-span-6">
            <label>Serial (VIN)</label>
            <input type="text" name="vin" class="modal-input" placeholder="Número de chasis">
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" id="cancel-new-vehicle-btn" class="btn btn-outline"
            style="border: none; color: #aaa;">Cancelar</button>
          <button type="submit" class="btn">Guardar Vehículo</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { loadSucursales } from './loadSucursales.js';
    import { searchTecnicos } from './services/tecnicos-service.js';
    import { searchClientes } from './services/clientes-service.js';
    import { searchVehiculos, createVehicle } from './services/vehiculos-service.js';
    import { createClient } from './services/clientes-service.js';
    import { searchInventario } from './services/inventory-service.js';
    import { createOrden, getOrdenById, updateOrden } from './services/ordenes-service.js';
    import { getImpuestos } from './services/impuestos-service.js';

    // Variable global para modo edición
    let modoEdicion = false;
    let ordenIdEdicion = null;


    // --- LÓGICA DE INTERFAZ (UI) ---
    // (Sidebar, Menús, Pestañas - Sin backend)

    // Sidebar Mobile Toggle
    window.toggleSubmenu = function (id) {
      const submenu = document.getElementById(id);
      const arrow = document.getElementById(id.replace('submenu', 'arrow'));
      if (submenu.classList.contains('hidden')) {
        submenu.classList.remove('hidden');
        submenu.classList.add('flex');
        if (arrow) arrow.style.transform = 'rotate(180deg)';
      } else {
        submenu.classList.add('hidden');
        submenu.classList.remove('flex');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
      }
    }

    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggle-sidebar');
    const sidebarTexts = document.querySelectorAll('.sidebar-text');
    let isCollapsed = false;

    toggleBtn.addEventListener('click', () => {
      isCollapsed = !isCollapsed;
      if (isCollapsed) {
        sidebar.classList.remove('w-64');
        sidebar.classList.add('w-20');
        sidebarTexts.forEach(el => el.classList.add('hidden'));
        toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        // Ocultar submenús al colapsar
        document.querySelectorAll('[id$="-submenu"]').forEach(el => {
          el.classList.add('hidden');
          el.classList.remove('flex');
        });
      } else {
        sidebar.classList.add('w-64');
        sidebar.classList.remove('w-20');
        sidebarTexts.forEach(el => el.classList.remove('hidden'));
        toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
      }
    });

    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    mobileMenuBtn.addEventListener('click', () => {
      sidebar.classList.toggle('-translate-x-full');
      sidebar.classList.toggle('absolute');
      sidebar.classList.toggle('z-50');
      sidebar.classList.toggle('h-full');
    });

    // --- LÓGICA DEL FORMULARIO ---
    document.addEventListener("DOMContentLoaded", () => {
      // Definición de showToast si no existe y exposición global
      function showToast(message, isError = false) {
        const toast = document.getElementById("toast-notification");
        toast.textContent = message;
        toast.style.backgroundColor = isError ? 'var(--error-color)' : 'var(--success-color)';
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 3000);
      }
      // Exponer globalmente para pagos-logic.js
      window.showToast = showToast;

      loadSucursales();
      loadTecnicosSelect();
      // Función para cargar impuestos en el select de IVA
      async function loadImpuestos() {
        const ivaSelect = document.getElementById('new-item-iva');
        if (!ivaSelect) return;

        try {
          const impuestos = await getImpuestos();
          ivaSelect.innerHTML = '<option value="">Seleccionar IVA</option>';
          impuestos.forEach(imp => {
            const option = document.createElement('option');
            option.value = imp.id;
            option.textContent = `${imp.nombre} (${imp.porcentaje}%)`;
            option.dataset.percentage = imp.porcentaje;
            ivaSelect.appendChild(option);
          });
        } catch (error) {
          console.error('Error cargando impuestos:', error);
        }
      }

      loadImpuestos();

      const tallerSelect = document.getElementById('taller');
      tallerSelect.addEventListener('change', () => {
        document.getElementById('id-taller-hidden').value = tallerSelect.value;
      });

      const tecnicoSelect = document.getElementById('tecnico-select');
      tecnicoSelect.addEventListener('change', () => {
        document.getElementById('id-tecnico-hidden').value = tecnicoSelect.value;
      });

      const vehiculoSelect = document.getElementById('vehiculo-select');
      vehiculoSelect.addEventListener('change', () => {
        const selectedOption = vehiculoSelect.options[vehiculoSelect.selectedIndex];
        if (selectedOption) {
          document.getElementById('id-vehiculo-hidden').value = vehiculoSelect.value;
          document.getElementById('vehiculo-info').textContent = selectedOption.dataset.matricula || '';
        }
      });

      // Fecha Inicial
      const fechaIngresoInput = document.getElementById('fecha-ingreso');
      fechaIngresoInput.value = new Date().toLocaleString("es-ES", {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      }).replace(",", "");

      // Variables Globales del Formulario
      let orderItems = [];
      let uploadedFiles = [];

      // Variable global para pagos - accesible desde pagos-logic.js
      window.orderPayments = [];

      // Elementos del DOM
      const successModal = document.getElementById('success-modal');
      const closeModalBtn = document.getElementById('close-modal-btn');
      const newOrderBtn = document.getElementById('new-order-btn');
      const orderForm = document.getElementById('order-form');

      // Mostrar/Ocultar Modal
      function showSuccessModal() { successModal.classList.add('show'); }
      function hideSuccessModal() { successModal.classList.remove('show'); }

      // --- DETECCIÓN MODO EDICIÓN ---
      const urlParams = new URLSearchParams(window.location.search);
      const ordenIdParam = urlParams.get('id');

      if (ordenIdParam) {
        modoEdicion = true;
        ordenIdEdicion = parseInt(ordenIdParam);

        // Cambiar título y texto del botón
        const mainTitle = document.querySelector('.form-main-title');
        if (mainTitle) mainTitle.textContent = `Editar Orden #${ordenIdEdicion}`;

        const submitBtn = document.querySelector('#order-form button[type="submit"]');
        if (submitBtn) submitBtn.textContent = 'Actualizar Orden';

        // Cargar datos de la orden
        cargarOrdenParaEdicion(ordenIdEdicion);
      }

      // Función para cargar orden existente
      async function cargarOrdenParaEdicion(ordenId) {
        try {
          showToast('Cargando datos de la orden...', false);
          const data = await getOrdenById(ordenId);

          if (!data.orden) {
            showToast('Orden no encontrada', true);
            return;
          }

          const orden = data.orden;
          const lineas = data.lineas || [];
          const pagos = data.pagos || [];

          // Rellenar campos de cabecera - usando verificaciones null-safe
          if (orden.id_sucursal) {
            const tallerEl = document.getElementById('taller');
            if (tallerEl) tallerEl.value = orden.id_sucursal;
            const tallerHidden = document.getElementById('id-taller-hidden');
            if (tallerHidden) tallerHidden.value = orden.id_sucursal;
          }

          if (orden.id_mecanico) {
            // Esperar a que carguen los técnicos y entonces seleccionar
            setTimeout(() => {
              const tecnicoSelect = document.getElementById('tecnico-select');
              if (tecnicoSelect) tecnicoSelect.value = orden.id_mecanico;
              const tecnicoHidden = document.getElementById('id-tecnico-hidden');
              if (tecnicoHidden) tecnicoHidden.value = orden.id_mecanico;
            }, 500);
          }

          // Cliente
          if (orden.id_cliente) {
            const clienteHidden = document.getElementById('id-cliente-hidden');
            if (clienteHidden) clienteHidden.value = orden.id_cliente;
            const buscarCliente = document.getElementById('buscar-cliente');
            if (buscarCliente) buscarCliente.value = orden.cliente_nombre || '';
          }

          // Vehículo - usar verificación null-safe
          if (orden.id_vehiculo) {
            const vehiculoHidden = document.getElementById('id-vehiculo-hidden');
            if (vehiculoHidden) vehiculoHidden.value = orden.id_vehiculo;

            const vehiculoSelect = document.getElementById('vehiculo-select');
            if (vehiculoSelect) {
              // Habilitar el select y añadir la opción del vehículo
              vehiculoSelect.disabled = false;
              const optionText = `${orden.vehiculo_marca || ''} ${orden.vehiculo_modelo || ''} - ${orden.vehiculo_matricula || ''}`.trim();
              const option = document.createElement('option');
              option.value = orden.id_vehiculo;
              option.textContent = optionText;
              option.selected = true;
              vehiculoSelect.innerHTML = '';
              vehiculoSelect.appendChild(option);
            }

            const vehiculoInfo = document.getElementById('vehiculo-info');
            if (vehiculoInfo) vehiculoInfo.textContent = orden.vehiculo_matricula || '';
          }

          // Kilometraje
          if (orden.km) {
            const kmEl = document.getElementById('kilometraje');
            if (kmEl) kmEl.value = orden.km;
          }

          // Tipo de orden (concepto)
          if (orden.id_tipo_orden) {
            setTimeout(() => {
              const conceptoEl = document.getElementById('concepto');
              if (conceptoEl) conceptoEl.value = orden.id_tipo_orden;
              const tipoOrdenHidden = document.getElementById('id-tipo-orden-hidden');
              if (tipoOrdenHidden) tipoOrdenHidden.value = orden.id_tipo_orden;
            }, 500);
          }

          // Observaciones y comentario interno (verificar si existen los elementos)
          const observacionesEl = document.getElementById('observaciones');
          if (observacionesEl && orden.descripcion) {
            observacionesEl.value = orden.descripcion;
          }
          const comentarioEl = document.getElementById('comentario-interno');
          if (comentarioEl && orden.comentario_interno) {
            comentarioEl.value = orden.comentario_interno;
          }

          // Fecha de ingreso
          if (orden.fecha_ingreso) {
            const fecha = new Date(orden.fecha_ingreso);
            const fechaIngresoEl = document.getElementById('fecha-ingreso');
            if (fechaIngresoEl) {
              fechaIngresoEl.value = fecha.toLocaleString("es-ES", {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
              }).replace(",", "");
            }
          }

          // Cargar líneas de la orden
          lineas.forEach(linea => {
            orderItems.push({
              id: linea.id, // ID de la línea para actualizaciones
              idProducto: linea.id_producto || null,
              idImpuesto: linea.id_impuesto || null,
              descripcion: linea.descripcion || linea.producto_nombre || 'Item',
              precio: parseFloat(linea.precio) || 0,
              cantidad: parseInt(linea.cantidad) || 1,
              tipoItem: linea.tipo_item || 'PRODUCTO',
              tipoItemLabel: linea.tipo_item === 'SERVICIO' ? 'Servicio' : 'Repuesto',
              descuento: parseFloat(linea.descuento) || 0,
              iva: parseFloat(linea.impuesto_porcentaje) || 0
            });
          });

          // Renderizar items y calcular totales
          renderItems();
          calculateNetTotals();

          // Cargar pagos existentes (si los hay)
          if (pagos.length > 0) {
            window.orderPayments = pagos.map(pago => ({
              idMedioPago: pago.id_medio_pago,
              codigoMedioPago: pago.medio_pago_codigo,
              nombreMedioPago: pago.medio_pago_nombre,
              importe: parseFloat(pago.importe),
              referencia: pago.referencia
            }));
            // Si existe función de renderizar pagos
            if (typeof window.renderPayments === 'function') {
              window.renderPayments();
            }
          }

          showToast('Orden cargada correctamente', false);
        } catch (error) {
          console.error('Error cargando orden:', error);
          showToast('Error al cargar la orden: ' + error.message, true);
        }
      }

      // Resetear formulario completo al crear nueva orden
      if (newOrderBtn) {
        newOrderBtn.addEventListener('click', () => {
          window.location.href = 'manager-taller-ordenes.html'; // Sin ID = nueva orden
        });
      }

      // --- LÓGICA MODAL NUEVO CLIENTE ---
      const newClientModal = document.getElementById('new-client-modal');
      const addClientBtn = document.getElementById('add-client-btn');
      const cancelNewClientBtn = document.getElementById('cancel-new-client-btn');
      const newClientForm = document.getElementById('new-client-form');

      if (addClientBtn) {
        addClientBtn.addEventListener('click', () => {
          newClientModal.classList.add('show');
        });
      }

      if (cancelNewClientBtn) {
        cancelNewClientBtn.addEventListener('click', () => {
          newClientModal.classList.remove('show');
          newClientForm.reset();
        });
      }

      if (newClientForm) {
        newClientForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(newClientForm);
          const clientData = Object.fromEntries(formData.entries());

          try {
            const result = await createClient(clientData);
            const newClient = result.cliente;

            showToast('Cliente creado exitosamente');

            // Auto-seleccionar el nuevo cliente
            document.getElementById('buscar-cliente').value = newClient.nombre;
            document.getElementById('cliente-info').textContent = `${newClient.documento || ''} | ${newClient.telefono || ''}`;
            document.getElementById('id-cliente-hidden').value = newClient.id;

            // Cerrar modal
            newClientModal.classList.remove('show');
            newClientForm.reset();
          } catch (error) {
            console.error(error);
            showToast(error.message, true);
          }
        });
      }

      async function loadTecnicosSelect() {
        const select = document.getElementById('tecnico-select');
        if (!select) return;

        select.innerHTML = '<option value="">Seleccionar técnico</option>';
        try {
          const tecnicos = await searchTecnicos('');
          tecnicos.forEach(tec => {
            const option = document.createElement('option');
            option.value = tec.id;
            option.textContent = tec.nombre;
            select.appendChild(option);
          });
        } catch (error) {
          console.error('Error cargando técnicos:', error);
          const option = document.createElement('option');
          option.textContent = 'No se pudieron cargar técnicos';
          select.appendChild(option);
        }
      }

      // --- LÓGICA DE BÚSQUEDA DINÁMICA ---
      const USE_MOCK_DATA = false; // Set to false when backend is fixed

      const MOCK_TECNICOS = [
        { id: 101, nombre: "Juan Pérez" },
        { id: 102, nombre: "Ana Gómez" },
        { id: 103, nombre: "Carlos Ruiz" }
      ];

      const MOCK_CLIENTES = [
        { id: 201, nombre: "Empresa ABC S.L.", dni: "B12345678", telefono: "600111222" },
        { id: 202, nombre: "Laura Martínez", dni: "12345678Z", telefono: "600333444" }
      ];

      const MOCK_VEHICULOS = [
        { id: 301, Marca: "Toyota", Propietario: "Corolla", Matricula: "1234-ABC" },
        { id: 302, Marca: "Ford", Propietario: "Focus", Matricula: "5678-DEF" }
      ];

      const MOCK_PRODUCTOS = [
        { id: 401, nombre: "Aceite 5W30", precio_venta: 45.50 },
        { id: 402, nombre: "Filtro de Aire", precio_venta: 15.20 },
        { id: 403, nombre: "Mano de Obra (h)", precio_venta: 50.00 },
        { id: 404, nombre: "Pastillas de Freno", precio_venta: 80.00 }
      ];

      // --- LÓGICA DE BÚSQUEDA DINÁMICA ---
      function setupCustomSelect({ inputId, optionsId, searchUrl, searchFunction, getSearchParams, onSelect, renderOption, mockData = [] }) {
        const input = document.getElementById(inputId);
        const optionsContainer = document.getElementById(optionsId);
        let debounceTimeout;

        input.addEventListener("focus", () => {
          if (inputId === 'buscar-vehiculo') {
            const clientId = document.getElementById('id-cliente-hidden').value;
            if (clientId) {
              // Trigger search manually
              input.dispatchEvent(new Event('keyup'));
            }
          }
        });

        input.addEventListener("keyup", () => {
          clearTimeout(debounceTimeout);
          const query = input.value.toLowerCase();

          if (query.length < 1) {
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('show');
            return;
          }

          debounceTimeout = setTimeout(async () => {
            if (USE_MOCK_DATA) {
              console.log(`Buscando en MOCK data para ${inputId}...`);
              const results = mockData.filter(item => {
                return Object.values(item).some(val =>
                  String(val).toLowerCase().includes(query)
                );
              });
              renderResults(results);
              return;
            }

            if (searchFunction) {
              try {
                const params = getSearchParams ? getSearchParams() : {};
                const results = await searchFunction(query, params);
                renderResults(results || []);
              } catch (error) {
                console.error('Error durante la búsqueda:', error);
                optionsContainer.innerHTML = `<div class="option" style="color: var(--error-color);">Error de conexión.</div>`;
                optionsContainer.classList.add('show');
              }
              return;
            }

            if (searchUrl) {
              fetch(searchUrl, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: query })
              })
                .then(async response => {
                  const responseText = await response.text();
                  if (!response.ok) {
                    throw new Error(`Error de red: ${response.status} ${response.statusText} - ${responseText}`);
                  }
                  return responseText;
                })
                .then(text => {
                  let data = [];
                  try {
                    data = JSON.parse(text);
                  } catch (e) {
                    console.error("Error parsing JSON:", text);
                    renderResults([]);
                    return;
                  }
                  const results = Array.isArray(data) ? data : (data ? [data] : []);
                  renderResults(results);
                })
                .catch(error => {
                  console.error('Error durante la búsqueda:', error);
                  optionsContainer.innerHTML = `<div class="option" style="color: var(--error-color);">Error de conexión.</div>`;
                  optionsContainer.classList.add('show');
                });
            }
          }, 300);
        });

        function renderResults(results) {
          optionsContainer.innerHTML = '';
          if (results.length > 0) {
            results.forEach(item => {
              const div = document.createElement('div');
              div.className = 'option';
              div.innerHTML = renderOption(item);
              div.addEventListener('click', () => {
                onSelect(item);
                optionsContainer.classList.remove('show');
              });
              optionsContainer.appendChild(div);
            });
          } else {
            optionsContainer.innerHTML = `<div class="option" style="color: var(--text-secondary);">No se encontraron resultados.</div>`;
          }
          optionsContainer.classList.add('show');
        }

        document.addEventListener("click", (e) => {
          if (!input.contains(e.target) && !optionsContainer.contains(e.target)) {
            optionsContainer.classList.remove('show');
          }
        });
      }

      // Inicializar buscadores
      setupCustomSelect({
        inputId: 'buscar-cliente',
        optionsId: 'cliente-options',
        searchFunction: searchClientes,
        renderOption: item => `${item.nombre} <small>(${item.documento || 'Sin Doc'})</small>`,
        onSelect: async (item) => {
          document.getElementById('buscar-cliente').value = item.nombre;
          document.getElementById('cliente-info').textContent = `${item.documento || ''} | ${item.telefono || ''}`;
          document.getElementById('id-cliente-hidden').value = item.id;

          // Limpiar vehículo anterior
          // Reset vehicle select
          const vehicleSelect = document.getElementById('vehiculo-select');
          vehicleSelect.innerHTML = '<option value="" disabled selected>Cargando vehículos...</option>';
          vehicleSelect.disabled = true;
          document.getElementById('vehiculo-info').textContent = '';
          document.getElementById('id-vehiculo-hidden').value = '';

          try {
            const vehicles = await searchVehiculos('', item.id);
            vehicleSelect.innerHTML = '<option value="" disabled selected>Seleccionar vehículo</option>';

            if (vehicles.length > 0) {
              vehicles.forEach(v => {
                const option = document.createElement('option');
                option.value = v.id;
                option.textContent = `${v.marca} ${v.modelo} (${v.matricula})`;
                option.dataset.matricula = v.matricula;
                vehicleSelect.appendChild(option);
              });
              vehicleSelect.disabled = false;
            } else {
              vehicleSelect.innerHTML = '<option value="" disabled selected>No hay vehículos registrados</option>';
            }
          } catch (e) {
            console.error("Error loading vehicles", e);
            vehicleSelect.innerHTML = '<option value="" disabled selected>Error al cargar</option>';
          }
        }
      });

      setupCustomSelect({
        inputId: 'new-item-name',
        optionsId: 'product-options',
        searchFunction: async (query, params) => {
          const sucursalId = params?.idSucursal || document.getElementById('taller').value;
          if (!sucursalId) {
            showToast('Selecciona un taller para buscar en el inventario', true);
            return [];
          }
          return searchInventario(query, sucursalId);
        },
        getSearchParams: () => ({ idSucursal: document.getElementById('taller').value }),
        renderOption: item => {
          const rawPrice = item.precio ?? item.precio_venta ?? item.precio_venta_bruto ?? 0;
          const price = parseFloat(rawPrice);
          const stock = parseInt(item.stock) || 0;
          return `${item.nombre} <small>(${price.toFixed(2)}€ - Stock: ${stock})</small>`;
        },
        onSelect: item => {
          const rawPrice = item.precio ?? item.precio_venta ?? item.precio_venta_bruto ?? 0;
          const price = parseFloat(rawPrice);
          const ivaId = item.id_impuesto;
          const typeSelect = document.getElementById('new-item-type');
          const inferredTypeRaw = item.tipo || item.tipo_item || (item.categoria && item.categoria.toLowerCase().includes('servicio') ? 'SERVICIO' : 'PRODUCTO');
          const inferredType = (inferredTypeRaw || '').toString().toUpperCase().includes('SERVICIO') ? 'SERVICIO' : 'PRODUCTO';

          document.getElementById('new-item-name').value = item.nombre;
          document.getElementById('new-item-price').value = price.toFixed(2);
          document.getElementById('new-item-id-hidden').value = item.id || '';

          if (ivaId) {
            const ivaSelect = document.getElementById('new-item-iva');
            if (ivaSelect && ivaSelect.querySelector(`option[value="${ivaId}"]`)) {
              ivaSelect.value = ivaId;
            }
          }

          if (inferredType) {
            typeSelect.value = inferredType;
          }
        }
      });


      // --- LÓGICA DE LA TABLA DE ITEMS ---
      document.getElementById('add-item-btn').addEventListener('click', () => {
        const name = document.getElementById('new-item-name').value;
        const price = parseFloat(document.getElementById('new-item-price').value) || 0;
        const qty = parseInt(document.getElementById('new-item-quantity').value) || 1;
        const type = document.getElementById('new-item-type').value;
        const bonus = parseFloat(document.getElementById('new-item-bonus').value) || 0;
        const id = document.getElementById('new-item-id-hidden').value;
        const ivaSelect = document.getElementById('new-item-iva');
        const selectedOption = ivaSelect.options[ivaSelect.selectedIndex];
        const ivaPercentage = parseFloat(selectedOption?.dataset.percentage) || 0;
        const ivaId = selectedOption?.value || null;

        if (!name || price < 0) {
          showToast("Selecciona un item y precio válido.", true);
          return;
        }

        const normalizedType = (type || '').toUpperCase() === 'SERVICIO' ? 'SERVICIO' : 'PRODUCTO';
        const displayType = normalizedType === 'SERVICIO' ? 'Servicio' : 'Repuesto';

        orderItems.push({
          idProducto: id || null,
          idImpuesto: ivaId,
          descripcion: name,
          precio: price,
          cantidad: qty,
          tipoItem: normalizedType,
          tipoItemLabel: displayType,
          descuento: bonus,
          iva: ivaPercentage
        });
        renderItems();
        calculateNetTotals();

        // Limpiar inputs de "Agregar Item"
        document.getElementById('new-item-name').value = '';
        document.getElementById('new-item-price').value = '';
        document.getElementById('new-item-quantity').value = '1';
        document.getElementById('new-item-bonus').value = '0';
        document.getElementById('new-item-id-hidden').value = '';
        document.getElementById('new-item-iva').value = '21';
        delete document.getElementById('new-item-id-hidden').dataset.iva;
      });

      function renderItems() {
        const tbody = document.getElementById('order-items-list');
        tbody.innerHTML = '';
        orderItems.forEach((item, index) => {
          const subtotal = (item.precio * item.cantidad) - (item.descuento || 0);

          // Badges para Tipo
          const typeLabel = item.tipoItemLabel || (item.tipoItem === 'SERVICIO' ? 'Servicio' : 'Repuesto');
          let typeBadge = '';
          if (item.tipoItem === 'PRODUCTO') {
            typeBadge = '<span class="px-2 py-1 rounded text-xs font-semibold bg-blue-900 text-blue-200 border border-blue-700">Repuesto</span>';
          } else if (item.tipoItem === 'SERVICIO') {
            typeBadge = '<span class="px-2 py-1 rounded text-xs font-semibold bg-orange-900 text-orange-200 border border-orange-700">Servicio</span>';
          } else {
            typeBadge = `<span class="px-2 py-1 rounded text-xs font-semibold bg-gray-800 text-gray-300 border border-gray-600">${typeLabel}</span>`;
          }

          // Icono de Inventario
          const isProduct = item.idProducto ? '<span class="text-green-500 mr-1" title="Producto de inventario">📦</span>' : '<span class="text-gray-500 mr-1" title="Item libre">📝</span>';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${isProduct} ${item.descripcion}</td>
            <td>${item.precio.toFixed(2)}€</td>
            <td>${item.cantidad}</td>
            <td>${typeBadge}</td>
            <td>${(item.descuento || 0).toFixed(2)}€</td>
            <td>${subtotal.toFixed(2)}€</td>
            <td>${item.iva}%</td>
            <td><button type="button" class="remove-item-btn text-red-500 hover:text-red-400 font-bold" data-index="${index}">&times;</button></td>
          `;
          tbody.appendChild(tr);
        });
      }

      document.getElementById('order-items-list').addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-item-btn') || e.target.closest('.remove-item-btn')) {
          const btn = e.target.classList.contains('remove-item-btn') ? e.target : e.target.closest('.remove-item-btn');
          orderItems.splice(btn.dataset.index, 1);
          renderItems();
          calculateNetTotals();
        }
      });

      // --- CÁLCULOS FINANCIEROS ---
      function calculateNetTotals() {
        let totalRepuestos = 0, totalMano = 0, totalIva = 0;
        const descuentoPct = parseFloat(document.getElementById('discount-input').value) || 0;
        const globalDiscountFactor = 1 - (descuentoPct / 100);

        orderItems.forEach(item => {
          const base = (item.precio * item.cantidad) - (item.descuento || 0);
          const baseConDescuento = base * globalDiscountFactor;
          const ivaLinea = baseConDescuento * ((item.iva || 0) / 100);

          if (item.tipoItem === 'PRODUCTO') totalRepuestos += baseConDescuento;
          else totalMano += baseConDescuento;

          totalIva += ivaLinea;
        });

        const subtotal = totalRepuestos + totalMano;
        const neto = subtotal;
        const ivaMonto = totalIva;
        const total = neto + ivaMonto;

        // Actualizar UI
        document.getElementById('summary-repuestos').textContent = totalRepuestos.toFixed(2) + '€';
        document.getElementById('summary-mano-obra').textContent = totalMano.toFixed(2) + '€';
        document.getElementById('summary-neto').textContent = neto.toFixed(2) + '€';
        document.getElementById('summary-iva').textContent = ivaMonto.toFixed(2) + '€';
        document.getElementById('summary-total').textContent = total.toFixed(2) + '€';

        // Actualizar resumen de pagos (de pagos-logic.js)
        if (typeof updatePaymentSummary === 'function') updatePaymentSummary(total);
      }

      // Event Listeners para cálculos
      document.getElementById('discount-input').addEventListener('input', calculateNetTotals);

      // Nota: La gestiu00f3n de pagos estu00e1 en pagos-logic.js

      // --- SUBIDA DE IMÁGENES (FRONTEND) ---
      const uploadInput = document.getElementById('vehicle-images-upload');
      const dropZone = document.querySelector('.multi-image-upload-box');
      const previewsContainer = document.getElementById('previews-container');

      dropZone.addEventListener('click', () => uploadInput.click());
      dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });
      uploadInput.addEventListener('change', (e) => handleFiles(e.target.files));

      function handleFiles(files) {
        Array.from(files).forEach(file => {
          if (!file.type.startsWith('image/')) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'img-preview-wrapper';
            wrapper.innerHTML = `<img src="${e.target.result}"><button type="button" class="remove-img-btn">&times;</button>`;
            wrapper.querySelector('button').addEventListener('click', () => {
              wrapper.remove();
            });
            previewsContainer.appendChild(wrapper);
          };
          reader.readAsDataURL(file);
        });
      }

      // --- SUBMIT DEL FORMULARIO (LIMPIO PARA BACKEND) ---
      orderForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Asignar manualmente los valores de los selects si no se han seteado por cambio
        const idTaller = document.getElementById('taller').value;
        document.getElementById('id-taller-hidden').value = idTaller;

        const idTipoOrden = document.getElementById('concepto').value;
        document.getElementById('id-tipo-orden-hidden').value = idTipoOrden;

        const idCliente = document.getElementById('id-cliente-hidden').value;
        const idVehiculo = document.getElementById('id-vehiculo-hidden').value;

        if (!idTaller) {
          showToast('Debes seleccionar un taller.', true);
          return;
        }
        if (!idCliente) {
          showToast('Debes seleccionar un cliente.', true);
          return;
        }
        if (orderItems.length === 0) {
          showToast('Debes agregar al menos un item a la orden.', true);
          return;
        }

        const kmValue = document.getElementById('kilometraje').value;
        const kmNumber = kmValue !== '' ? Number(kmValue) : 0;

        if (Number.isNaN(kmNumber) || kmNumber < 0) {
          return showToast('Kilometraje inválido', true);
        }

        const lineasPayload = orderItems.map(item => ({
          id: item.id || null, // ID de línea existente para actualizaciones
          idProducto: item.idProducto,
          idImpuesto: item.idImpuesto,
          descripcion: item.descripcion,
          cantidad: item.cantidad,
          precio: item.precio,
          descuento: item.descuento || 0,
          iva: item.iva || 0,
          tipoItem: (item.tipoItem || '').toUpperCase() || 'PRODUCTO'
        }));

        // RECOPILACIÓN DE DATOS (LISTO PARA API)
        const payload = {
          idSucursal: Number(document.getElementById('taller').value),
          idCliente: Number(document.getElementById('id-cliente-hidden').value),
          idVehiculo: Number(document.getElementById('id-vehiculo-hidden').value),
          idMecanico: Number(document.getElementById('id-tecnico-hidden').value),
          idTipoOrden: Number(document.getElementById('concepto').value || document.getElementById('id-tipo-orden-hidden').value),
          km: kmNumber,
          concepto: document.getElementById('concepto').selectedOptions[0]?.textContent || '',
          descripcion: document.getElementById('observaciones').value || '',
          comentarioInterno: document.getElementById('comentario-interno').value || '',
          lineas: lineasPayload,
          pagos: (window.orderPayments || []).map(p => ({
            idMedioPago: p.idMedioPago,
            codigoMedioPago: p.codigoMedioPago,
            importe: p.importe,
            referencia: p.referencia || null,
            idCaja: p.idCaja || 1
          }))
        };

        console.log("Payload JSON de la Orden:", payload);

        try {
          let response;
          if (modoEdicion && ordenIdEdicion) {
            // MODO EDICIÓN - Actualizar orden existente
            response = await updateOrden(ordenIdEdicion, payload);
            console.log("--- ORDEN ACTUALIZADA ---", response);
            showToast('Orden actualizada con éxito');
          } else {
            // MODO CREACIÓN - Crear nueva orden
            response = await createOrden(payload);
            console.log("--- ORDEN CREADA ---", response);
            showToast('Orden creada con éxito');
          }
          showSuccessModal();
        } catch (error) {
          console.error('Error al guardar orden', error);
          showToast(error.message || 'No se pudo guardar la orden', true);
        }
      });

      // --- LÓGICA MODAL NUEVO VEHÍCULO ---
      const newVehicleModal = document.getElementById('new-vehicle-modal');
      const addVehicleBtn = document.getElementById('add-vehicle-btn');
      const cancelNewVehicleBtn = document.getElementById('cancel-new-vehicle-btn');
      const newVehicleForm = document.getElementById('new-vehicle-form');

      if (addVehicleBtn) {
        addVehicleBtn.addEventListener('click', () => {
          newVehicleModal.classList.add('show');

          // Pre-seleccionar cliente si ya está seleccionado en el formulario principal
          const currentClientId = document.getElementById('id-cliente-hidden').value;
          const currentClientName = document.getElementById('buscar-cliente').value;

          if (currentClientId) {
            document.getElementById('new-vehicle-client-id').value = currentClientId;
            document.getElementById('new-vehicle-client-search').value = currentClientName;
          }

          // Cargar sucursales si no están cargadas
          const sucursalSelect = document.getElementById('new-vehicle-sucursal');
          const mainSucursalSelect = document.getElementById('taller');
          if (sucursalSelect.options.length <= 1 && mainSucursalSelect.options.length > 1) {
            Array.from(mainSucursalSelect.options).forEach(opt => {
              if (opt.value) {
                const newOpt = document.createElement('option');
                newOpt.value = opt.value;
                newOpt.textContent = opt.textContent;
                sucursalSelect.appendChild(newOpt);
              }
            });
          }
        });
      }

      if (cancelNewVehicleBtn) {
        cancelNewVehicleBtn.addEventListener('click', () => {
          newVehicleModal.classList.remove('show');
          newVehicleForm.reset();
        });
      }

      // Buscador de clientes dentro del modal de vehículo
      setupCustomSelect({
        inputId: 'new-vehicle-client-search',
        optionsId: 'new-vehicle-client-options',
        searchFunction: searchClientes,
        renderOption: item => `${item.nombre} <small>(${item.documento || 'Sin Doc'})</small>`,
        onSelect: item => {
          document.getElementById('new-vehicle-client-search').value = item.nombre;
          document.getElementById('new-vehicle-client-id').value = item.id;
        }
      });

      if (newVehicleForm) {
        newVehicleForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(newVehicleForm);
          const rawData = Object.fromEntries(formData.entries());
          const vehicleData = { ...rawData, year: rawData.anio, serial: rawData.vin, cc: rawData.cilindrada };

          if (!vehicleData.id_cliente) {
            showToast('Debes seleccionar un cliente para el vehículo', true);
            return;
          }

          try {
            const result = await createVehicle(vehicleData);
            const newVehicle = result;

            showToast('Vehículo creado exitosamente');

            // Añadir el nuevo vehículo al select y seleccionarlo
            const vehicleSelect = document.getElementById('vehiculo-select');

            // Si el select estaba deshabilitado o vacío, limpiarlo
            if (vehicleSelect.disabled || vehicleSelect.options[0].disabled) {
              vehicleSelect.innerHTML = '';
              vehicleSelect.disabled = false;
            }

            const option = document.createElement('option');
            option.value = newVehicle.id;
            option.textContent = `${newVehicle.marca} ${newVehicle.modelo} (${newVehicle.matricula})`;
            option.dataset.matricula = newVehicle.matricula;
            option.selected = true;
            vehicleSelect.appendChild(option);

            // Actualizar info visual
            document.getElementById('vehiculo-info').textContent = newVehicle.matricula;
            document.getElementById('id-vehiculo-hidden').value = newVehicle.id;

            // Cerrar modal
            newVehicleModal.classList.remove('show');
            newVehicleForm.reset();

          } catch (error) {
            console.error(error);
            showToast(error.message, true);
          }
        });
      }

    });
  </script>
  <script src="pagos-logic.js"></script>

  <script type="module">
    import { initSucursalSelector, getCurrentSucursalId } from './services/sucursal-selector.js';

    // Inicializar selector de sucursal
    (async () => {
      const sucursalId = await initSucursalSelector('sucursal-selector-container', {
        onchange: (sucursalId) => {
          // Actualizar el selector de taller en el formulario
          const tallerSelect = document.getElementById('taller');
          if (tallerSelect && sucursalId) {
            tallerSelect.value = sucursalId;
            tallerSelect.dispatchEvent(new Event('change'));
          }
        }
      });

      // Pre-seleccionar el taller si hay sucursal guardada
      if (sucursalId) {
        const tallerSelect = document.getElementById('taller');
        if (tallerSelect) {
          // Esperar a que se carguen las opciones
          setTimeout(() => {
            tallerSelect.value = sucursalId;
            tallerSelect.dispatchEvent(new Event('change'));
          }, 500);
        }
      }
    })();
  </script>

  <!-- Sidebar Manager - Genera el sidebar dinámicamente -->
  <script src="sidebar-manager.js"></script>
</body>

</html>