<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Órdenes - Goversa</title>
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
    rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="manager.css">
  <script src="/guard.js"></script>

  <style>
    /* Specific overrides for this complex form */
    .form-section {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-subtle);
    }

    .form-section-title {
      color: var(--brand-orange);
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border-subtle);
      padding-bottom: 8px;
    }

    /* Custom Select Styles */
    .custom-select-container {
      position: relative;
    }

    .custom-select-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #1e242d;
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 50;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      margin-top: 5px;
    }

    .custom-select-options.show {
      display: block;
    }

    .custom-select-options .option {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: #ccc;
      font-size: 14px;
    }

    .custom-select-options .option:hover {
      background: var(--brand-orange);
      color: white;
    }

    /* Image Upload */
    .multi-image-upload-box {
      border: 2px dashed var(--border-subtle);
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      color: var(--text-secondary);
    }

    .multi-image-upload-box:hover,
    .multi-image-upload-box.dragover {
      border-color: var(--brand-orange);
      background: rgba(255, 95, 0, 0.05);
      color: white;
    }

    .img-preview-wrapper {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border-subtle);
    }

    .img-preview-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .remove-img-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      border: none;
      cursor: pointer;
    }

    /* Summary Table */
    .summary-table td {
      padding: 8px 0;
      color: var(--text-primary);
    }

    .summary-table tr td:first-child {
      color: var(--text-secondary);
    }

    .summary-table tr td:last-child {
      text-align: right;
      font-weight: 600;
    }

    .summary-table .total-row td {
      border-top: 1px solid var(--border-subtle);
      padding-top: 15px;
      font-size: 18px;
      color: var(--brand-orange);
      font-weight: 800;
    }

    /* Items Table overrides */
    .items-table th {
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    .items-table tfoot td {
      padding-top: 15px;
      border-top: 1px solid var(--border-subtle);
    }
  </style>
</head>

<body class="bg-[#0b0d11] text-white font-[Montserrat] overflow-hidden">

  <div class="flex h-screen w-full">

    <!-- SIDEBAR -->
    <aside id="sidebar"
      class="flex h-full w-64 flex-col bg-[#111318] p-4 shrink-0 transition-all duration-300 ease-in-out border-r border-[#282e39]">
      <div class="flex h-full flex-col justify-between">
        <div class="flex flex-col gap-4">
          <div class="flex items-center gap-3 p-2 mb-4">
            <div class="logo-badge flex items-center justify-center w-10 h-10 rounded-xl bg-[#282e39]">
              <img src="https://i.imgur.com/Mjw4or5.png" alt="Logo" class="h-6 w-auto">
            </div>
            <div class="flex flex-col sidebar-text">
              <h1 class="text-white text-base font-medium">Goversa</h1>
              <p class="text-[#9da6b9] text-xs">Gestión</p>
            </div>
            <button id="toggle-sidebar" class="ml-auto text-gray-400 hover:text-white">
              <i class="fas fa-chevron-left"></i>
            </button>
          </div>

          <nav class="flex flex-col gap-2">
            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-inicio.html">
              <span class="icon-container"><i class="fas fa-home"></i></span>
              <p class="text-sm font-medium sidebar-text">Inicio</p>
            </a>

            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 bg-[var(--brand-orange)] text-white rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('taller-submenu')">
                <span class="icon-container"><i class="fas fa-wrench"></i></span>
                <p class="text-sm font-medium sidebar-text flex-1">Taller</p>
                <i class="fas fa-chevron-up text-xs sidebar-text transition-transform" id="taller-arrow"></i>
              </a>
              <div id="taller-submenu" class="flex flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-citas.html" class="text-gray-400 hover:text-white text-sm py-1 block">Citas</a>
                <a href="manager-taller-ordenes-lista.html"
                  class="text-white font-semibold text-sm py-1 block">Órdenes</a>
                <a href="manager-taller-vehiculos.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Vehículos</a>
              </div>
            </div>

            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('tienda-submenu')">
                <span class="icon-container"><i class="fas fa-shopping-cart"></i></span>
                <p class="text-sm font-medium sidebar-text flex-1">Tienda</p>
                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="tienda-arrow"></i>
              </a>
              <div id="tienda-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-compras.html" class="text-gray-500 hover:text-white text-sm py-1 block">Nueva
                  Compra</a>
                <a href="manager-taller-compras-historial.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Historial Compras</a>
              </div>
            </div>

            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('cuentas-submenu')">
                <span class="icon-container"><i class="fas fa-file-invoice-dollar"></i></span>
                <p class="text-sm font-medium sidebar-text flex-1">Cuentas</p>
                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="cuentas-arrow"></i>
              </a>
              <div id="cuentas-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-facturas.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Facturas</a>
                <a href="manager-taller-facturas-pendientes.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Pendientes Facturar</a>
                <a href="manager-taller-config-facturas.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Configuración</a>
              </div>
            </div>
          </nav>
        </div>

        <div class="flex flex-col gap-1 border-t border-[#282e39] pt-4">
          <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
            href="#" data-logout>
            <span class="icon-container"><i class="fas fa-sign-out-alt"></i></span>
            <p class="text-sm font-medium sidebar-text">Salir</p>
          </a>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
      <header class="md:hidden flex items-center justify-between p-4 bg-[#111318] border-b border-[#282e39]">
        <div class="logo-badge p-2">
          <img src="https://i.imgur.com/Mjw4or5.png" alt="Logo" class="h-6 w-auto">
        </div>
        <button id="mobile-menu-btn" class="text-white"><i class="fas fa-bars"></i></button>
      </header>

      <main class="flex-1 overflow-y-auto p-6 bg-[#0b0d11]">
        <form id="order-form" class="max-w-6xl mx-auto">
          <!-- Config inputs hidden -->
          <input type="hidden" id="id-tecnico-hidden" name="idMecanico" />
          <input type="hidden" id="id-cliente-hidden" name="idCliente" />
          <input type="hidden" id="id-vehiculo-hidden" name="idVehiculo" />
          <input type="hidden" id="id-tipo-orden-hidden" name="idTipoOrden" />
          <input type="hidden" id="id-taller-hidden" name="idSucursal" />

          <!-- Header Actions -->
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
              <h2 class="text-3xl font-extrabold text-white form-main-title">Orden de Reparación</h2>
              <p class="text-[#9da6b9]">Crea o edita una orden de trabajo</p>
            </div>
            <div class="flex gap-3">
              <button type="button"
                class="px-4 py-2 rounded-lg border border-[#282e39] text-[#9da6b9] hover:text-white hover:bg-[#282e39] transition-colors"
                onclick="history.back()">Volver</button>
              <button type="submit"
                class="px-6 py-2 rounded-lg bg-[var(--brand-orange)] text-white font-bold hover:bg-[#e05300] shadow-lg shadow-orange-900/20 transition-all transform hover:-translate-y-0.5">
                <i class="fas fa-save mr-2"></i> Confirmar
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Columna Izquierda (Datos Principales) -->
            <div class="lg:col-span-2 space-y-6">

              <!-- 1. Datos Generales -->
              <div class="form-section">
                <h3 class="form-section-title">Datos Generales</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs text-[#9da6b9] mb-1">Fecha Ingreso</label>
                    <input type="text" id="fecha-ingreso" name="fecha_ingreso" class="form-input bg-[#111318]"
                      readonly />
                  </div>
                  <div>
                    <label class="block text-xs text-[#9da6b9] mb-1">Fecha Egreso (Estimada)</label>
                    <input type="datetime-local" id="fecha-egreso" name="fecha_egreso" class="form-input" />
                  </div>
                  <div>
                    <label class="block text-xs text-[#9da6b9] mb-1">Taller *</label>
                    <select id="taller" name="taller" class="form-select" required>
                      <option value="" disabled selected>Seleccionar Taller</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs text-[#9da6b9] mb-1">Técnico Asignado</label>
                    <select id="tecnico-select" name="tecnico" class="form-select">
                      <option value="">Seleccionar técnico</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- 2. Cliente y Vehículo -->
              <div class="form-section">
                <h3 class="form-section-title">Cliente y Vehículo</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <!-- Cliente -->
                  <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                      <label class="block text-xs text-[#9da6b9] mb-1">Buscar Cliente</label>
                      <div class="custom-select-container flex gap-2">
                        <input type="text" id="buscar-cliente" name="cliente_nombre" class="form-input"
                          placeholder="Nombre, NIF o teléfono..." autocomplete="off">
                        <button type="button" id="add-client-btn"
                          class="px-3 py-2 bg-[#282e39] text-white rounded-lg hover:bg-[#343b47]">+</button>
                        <div class="custom-select-options" id="cliente-options"></div>
                      </div>
                    </div>
                    <div>
                      <label class="block text-xs text-[#9da6b9] mb-1">Info Cliente</label>
                      <div id="cliente-info"
                        class="p-2.5 bg-[#111318] border border-[#282e39] rounded-lg text-sm text-[#9da6b9] min-h-[42px] flex items-center">
                        -</div>
                    </div>
                  </div>

                  <!-- Vehículo -->
                  <div class="md:col-span-2 pt-2 border-t border-[#282e39]">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div class="md:col-span-2">
                        <label class="block text-xs text-[#9da6b9] mb-1">Seleccionar Vehículo</label>
                        <div class="flex gap-2">
                          <select id="vehiculo-select" name="vehiculo_id" class="form-select" disabled>
                            <option value="" disabled selected>Seleccione cliente primero</option>
                          </select>
                          <button type="button" id="add-vehicle-btn"
                            class="px-3 py-2 bg-[#282e39] text-white rounded-lg hover:bg-[#343b47]">+</button>
                        </div>
                      </div>
                      <div>
                        <label class="block text-xs text-[#9da6b9] mb-1">Matrícula</label>
                        <div id="vehiculo-info"
                          class="p-2.5 bg-[#111318] border border-[#282e39] rounded-lg text-sm text-white font-mono min-h-[42px] flex items-center">
                          -</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 3. Detalles Orden -->
              <div class="form-section">
                <h3 class="form-section-title">Detalles del Servicio</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div>
                    <label class="block text-xs text-[#9da6b9] mb-1">Concepto</label>
                    <select id="concepto" class="form-select">
                      <option value="1">Reparación</option>
                      <option value="2">Mantenimiento</option>
                      <option value="3">Diagnóstico</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs text-[#9da6b9] mb-1">Combustible</label>
                    <select id="combustible" class="form-select">
                      <option>Bajo</option>
                      <option>1/4</option>
                      <option>1/2</option>
                      <option>3/4</option>
                      <option>Lleno</option>
                    </select>
                  </div>
                  <div class="col-span-2">
                    <label class="block text-xs text-[#9da6b9] mb-1">Kilometraje Actual</label>
                    <input type="number" id="kilometraje" class="form-input" placeholder="0">
                  </div>
                </div>
              </div>

              <!-- 4. Items Table -->
              <div class="form-section overflow-hidden">
                <h3 class="form-section-title flex justify-between items-center">
                  Lineas de Orden
                  <span class="text-xs font-normal text-gray-500 lowercase">Productos y Servicios</span>
                </h3>
                <div class="overflow-x-auto">
                  <table class="items-table w-full text-left">
                    <thead>
                      <tr>
                        <th class="p-2 text-[#9da6b9]">Item / Descripción</th>
                        <th class="p-2 text-[#9da6b9] w-24">Precio</th>
                        <th class="p-2 text-[#9da6b9] w-16">Cant.</th>
                        <th class="p-2 text-[#9da6b9] w-28">Tipo</th>
                        <th class="p-2 text-[#9da6b9] w-16">Dto.€</th>
                        <th class="p-2 text-[#9da6b9] w-24">Total</th>
                        <th class="p-2 text-[#9da6b9] w-10"></th>
                      </tr>
                    </thead>
                    <tbody id="order-items-list" class="text-sm">
                      <!-- Items renders here -->
                    </tbody>
                    <tfoot>
                      <tr class="bg-[#111318]/50">
                        <td class="p-2">
                          <input type="hidden" id="new-item-id-hidden" />
                          <div class="custom-select-container">
                            <input type="text" id="new-item-name" class="form-input text-sm"
                              placeholder="Buscar item..." autocomplete="off">
                            <div class="custom-select-options" id="product-options"></div>
                          </div>
                        </td>
                        <td class="p-2"><input type="number" id="new-item-price" class="form-input text-sm"
                            placeholder="0.00"></td>
                        <td class="p-2"><input type="number" id="new-item-quantity" class="form-input text-sm"
                            value="1"></td>
                        <td class="p-2">
                          <select id="new-item-type" class="form-select text-sm py-2 px-1">
                            <option value="PRODUCTO">Repuesto</option>
                            <option value="SERVICIO">Servicio</option>
                          </select>
                        </td>
                        <td class="p-2"><input type="number" id="new-item-bonus" class="form-input text-sm" value="0">
                        </td>
                        <td class="p-2 text-gray-400 text-sm flex items-center h-full pt-4" id="new-item-subtotal">0.00€
                        </td>
                        <td class="p-2">
                          <button type="button" id="add-item-btn"
                            class="w-8 h-8 rounded bg-[var(--brand-orange)] text-white hover:bg-[#e05300] flex items-center justify-center">
                            <i class="fas fa-plus"></i>
                          </button>
                          <!-- Hidden IVA select for logic compatibility -->
                          <select id="new-item-iva" class="hidden">
                            <option value="21" data-percentage="21" selected>21%</option>
                          </select>
                        </td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>

              <!-- 5. Images -->
              <div class="form-section">
                <h3 class="form-section-title">Documentación Visual</h3>
                <input type="file" id="vehicle-images-upload" class="hidden" multiple accept="image/*">
                <div class="multi-image-upload-box" onclick="document.getElementById('vehicle-images-upload').click()">
                  <i class="fas fa-cloud-upload-alt text-4xl mb-2 text-[#9da6b9]"></i>
                  <p class="text-sm font-medium">Click o arrastra fotos aquí</p>
                </div>
                <div id="previews-container" class="flex flex-wrap gap-3 mt-4"></div>
              </div>

            </div>

            <!-- Columna Derecha (Resumen y Pagos) -->
            <div class="space-y-6">

              <div class="form-section sticky top-4">
                <h3 class="form-section-title">Resumen Económico</h3>

                <div class="space-y-3 mb-6">
                  <div>
                    <label class="block text-xs text-[#9da6b9] mb-1">Observaciones</label>
                    <textarea id="observaciones" class="form-input text-sm" rows="3"></textarea>
                  </div>
                  <div>
                    <label class="block text-xs text-[#9da6b9] mb-1">Nota Interna</label>
                    <textarea id="comentario-interno" class="form-input text-sm bg-[#1a1d24]" rows="2"></textarea>
                  </div>
                </div>

                <table class="summary-table w-full text-sm">
                  <tr>
                    <td>Total Repuestos</td>
                    <td id="summary-repuestos">0.00€</td>
                  </tr>
                  <tr>
                    <td>Total Mano de Obra</td>
                    <td id="summary-mano-obra">0.00€</td>
                  </tr>
                  <tr class="border-t border-[#282e39]">
                    <td class="pt-2">Subtotal</td>
                    <td class="pt-2 font-bold text-white" id="summary-neto">0.00€</td>
                  </tr>
                  <tr>
                    <td>IVA (21%)</td>
                    <td id="summary-iva">0.00€</td>
                  </tr>
                  <tr>
                    <td class="py-2">
                      <div class="flex items-center gap-2">
                        <span>Descuento Global</span>
                        <input type="number" id="discount-input"
                          class="w-16 bg-[#111318] border border-[#282e39] rounded px-1 py-0.5 text-right text-xs"
                          value="0">
                        <span>%</span>
                      </div>
                    </td>
                    <td class="text-red-400">-0.00€</td>
                  </tr>
                  <tr class="total-row">
                    <td class="text-lg">TOTAL</td>
                    <td class="text-lg" id="summary-total">0.00€</td>
                  </tr>
                </table>

                <!-- Pagos Rápidos -->
                <div class="mt-6 pt-6 border-t border-[#282e39]">
                  <h4 class="text-sm font-bold text-white mb-3">Registrar Pago Anticipado</h4>
                  <div class="bg-[#111318] p-3 rounded-lg border border-[#282e39] space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                      <select id="nuevo-pago-metodo" class="form-select text-xs">
                        <!-- Cargado por JS -->
                      </select>
                      <input type="number" id="nuevo-pago-importe" class="form-input text-xs" placeholder="Importe €">
                    </div>
                    <input type="text" id="nuevo-pago-referencia" class="form-input text-xs"
                      placeholder="Referencia (opcional)">
                    <button type="button" id="btn-agregar-pago"
                      class="w-full py-2 bg-[#282e39] hover:bg-[#343b47] text-white text-xs font-bold rounded transition-colors">
                      <i class="fas fa-plus mr-1"></i> Agregar Pago
                    </button>
                  </div>

                  <div id="pagos-list" class="mt-3 space-y-2">
                    <table class="w-full text-xs" id="pagos-table">
                      <tbody id="pagos-tbody"></tbody>
                    </table>
                  </div>
                  <div class="flex justify-between items-center mt-3 pt-2 border-t border-[#282e39] text-sm">
                    <span class="text-[#9da6b9]">Pagado:</span>
                    <span class="text-green-400 font-bold" id="resumen-total-pagado">0.00€</span>
                  </div>
                  <div class="flex justify-between items-center text-sm">
                    <span class="text-[#9da6b9]">Pendiente:</span>
                    <span class="text-red-400 font-bold" id="resumen-saldo-pendiente">0.00€</span>
                  </div>
                </div>

              </div>

            </div>
          </div>
        </form>
      </main>
    </div>
  </div>

  <!-- MODALS -->
  <!-- Success Modal -->
  <div id="success-modal"
    class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="bg-[#1e242d] p-8 rounded-2xl max-w-sm w-full text-center border border-[#282e39] shadow-2xl">
      <div class="w-20 h-20 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-check text-4xl text-green-500"></i>
      </div>
      <h3 class="text-2xl font-bold text-white mb-2">¡Orden Guardada!</h3>
      <p class="text-[#9da6b9] mb-8">La operación se ha realizado con éxito.</p>
      <div class="flex gap-3">
        <button id="close-modal-btn"
          class="flex-1 py-3 bg-[#282e39] text-white rounded-xl hover:bg-[#343b47]">Cerrar</button>
        <button id="new-order-btn"
          class="flex-1 py-3 bg-[var(--brand-orange)] text-white rounded-xl hover:bg-[#e05300]">Nueva</button>
      </div>
    </div>
  </div>

  <!-- New Client Modal -->
  <div id="new-client-modal"
    class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="bg-[#1e242d] p-6 rounded-xl max-w-2xl w-full border border-[#282e39] max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl font-bold text-white mb-4 border-b border-[#282e39] pb-2">Nuevo Cliente</h2>
      <form id="new-client-form" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="block text-xs text-[#9da6b9]">Nombre Completo *</label>
            <input type="text" name="nombre" class="form-input" required>
          </div>
          <div>
            <label class="block text-xs text-[#9da6b9]">Documento (DNI/NIE) *</label>
            <input type="text" name="documento" class="form-input" required>
          </div>
          <div>
            <label class="block text-xs text-[#9da6b9]">Teléfono *</label>
            <input type="text" name="telefono" class="form-input" required>
          </div>
          <div>
            <label class="block text-xs text-[#9da6b9]">Email</label>
            <input type="email" name="email" class="form-input">
          </div>
          <div class="col-span-2">
            <label class="block text-xs text-[#9da6b9]">Dirección</label>
            <input type="text" name="direccion" class="form-input">
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t border-[#282e39]">
          <button type="button" id="cancel-new-client-btn"
            class="px-4 py-2 text-[#9da6b9] hover:text-white">Cancelar</button>
          <button type="submit"
            class="px-6 py-2 bg-[var(--brand-orange)] text-white rounded-lg hover:bg-[#e05300]">Guardar Cliente</button>
        </div>
      </form>
    </div>
  </div>

  <!-- New Vehicle Modal -->
  <div id="new-vehicle-modal"
    class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="bg-[#1e242d] p-6 rounded-xl max-w-2xl w-full border border-[#282e39]">
      <h2 class="text-xl font-bold text-white mb-4 border-b border-[#282e39] pb-2">Nuevo Vehículo</h2>
      <form id="new-vehicle-form" class="space-y-4">
        <!-- Hidden fields populated by JS -->
        <input type="hidden" name="id_cliente" id="new-vehicle-client-id">

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs text-[#9da6b9]">Cliente</label>
            <input type="text" id="new-vehicle-client-search" class="form-input bg-[#111318]" readonly>
          </div>
          <div>
            <label class="block text-xs text-[#9da6b9]">Sucursal</label>
            <select name="id_sucursal" id="new-vehicle-sucursal" class="form-select" required></select>
          </div>
          <div>
            <label class="block text-xs text-[#9da6b9]">Marca *</label>
            <input type="text" name="marca" class="form-input" required>
          </div>
          <div>
            <label class="block text-xs text-[#9da6b9]">Modelo *</label>
            <input type="text" name="modelo" class="form-input" required>
          </div>
          <div>
            <label class="block text-xs text-[#9da6b9]">Matrícula *</label>
            <input type="text" name="matricula" class="form-input" required>
          </div>
          <div>
            <label class="block text-xs text-[#9da6b9]">Año</label>
            <input type="number" name="anio" class="form-input">
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t border-[#282e39]">
          <button type="button" id="cancel-new-vehicle-btn"
            class="px-4 py-2 text-[#9da6b9] hover:text-white">Cancelar</button>
          <button type="submit"
            class="px-6 py-2 bg-[var(--brand-orange)] text-white rounded-lg hover:bg-[#e05300]">Guardar
            Vehículo</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast-notification"
    class="fixed bottom-5 right-5 z-[100] bg-[#1e242d] text-white px-6 py-4 rounded-xl shadow-2xl border border-[#282e39] flex items-center gap-3 transform translate-y-20 opacity-0 transition-all duration-300">
    <span id="toast-message">Notificación</span>
  </div>

  <script type="module">
    import { loadSucursales } from './loadSucursales.js';
    import { searchTecnicos } from './services/tecnicos-service.js';
    import { searchClientes, createClient } from './services/clientes-service.js';
    import { searchVehiculos, createVehicle } from './services/vehiculos-service.js';
    import { searchInventario } from './services/inventory-service.js';
    import { createOrden, getOrdenById, updateOrden } from './services/ordenes-service.js';
    import { getImpuestos } from './services/impuestos-service.js';
    import { fetchWithAuth } from './auth.js'; // Needed?

    let modoEdicion = false;
    let ordenIdEdicion = null;
    let orderItems = [];
    window.orderPayments = []; // Global for pagos-logic.js compatibility

    // --- UI Logic ---
    window.toggleSubmenu = function (id) {
      const submenu = document.getElementById(id);
      const arrow = document.getElementById(id.replace('submenu', 'arrow'));
      if (submenu.classList.contains('hidden')) {
        submenu.classList.remove('hidden');
        submenu.classList.add('flex');
        if (arrow) arrow.style.transform = 'rotate(180deg)';
      } else {
        submenu.classList.add('hidden');
        submenu.classList.remove('flex');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
      }
    }

    document.getElementById('mobile-menu-btn').addEventListener('click', () => {
      const sb = document.getElementById('sidebar');
      sb.classList.toggle('-translate-x-full');
      sb.classList.toggle('absolute');
      sb.classList.toggle('z-50');
      sb.classList.toggle('h-full');
    });

    document.addEventListener("DOMContentLoaded", () => {
      // Toast Helper
      window.showToast = function (message, isError = false) {
        const toast = document.getElementById('toast-notification');
        toast.innerHTML = `
                    <i class="fas fa-${isError ? 'exclamation-circle text-red-500' : 'check-circle text-green-500'} text-xl"></i>
                    <span class="font-medium">${message}</span>
                 `;
        toast.style.borderLeft = isError ? '4px solid #ef4444' : '4px solid #22c55e';
        toast.classList.remove('translate-y-20', 'opacity-0');
        setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
      }

      // Init Loaders
      loadSucursales();

      async function initTecnicos() {
        const sel = document.getElementById('tecnico-select');
        try {
          const data = await searchTecnicos('');
          data.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.id;
            opt.textContent = t.nombre;
            sel.appendChild(opt);
          });
        } catch (e) { console.error(e); }
      }
      initTecnicos();

      // Inputs Sync
      document.getElementById('taller').addEventListener('change', e => document.getElementById('id-taller-hidden').value = e.target.value);
      document.getElementById('tecnico-select').addEventListener('change', e => document.getElementById('id-tecnico-hidden').value = e.target.value);

      // Date
      const today = new Date().toLocaleString("es-ES", { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
      document.getElementById('fecha-ingreso').value = today;

      // --- Autocomplete Logic ---
      function setupAutocomplete(inputId, optionsId, searchFn, onSelect, renderItem) {
        const input = document.getElementById(inputId);
        const optsBox = document.getElementById(optionsId);
        let timer;

        input.addEventListener('input', () => {
          clearTimeout(timer);
          if (input.value.length < 2) { optsBox.classList.remove('show'); return; }
          timer = setTimeout(async () => {
            try {
              const results = await searchFn(input.value); // Adapt if fn needs different params
              optsBox.innerHTML = '';
              if (results && results.length) {
                results.forEach(item => {
                  const div = document.createElement('div');
                  div.className = 'option';
                  div.innerHTML = renderItem(item);
                  div.onclick = () => { onSelect(item); optsBox.classList.remove('show'); };
                  optsBox.appendChild(div);
                });
                optsBox.classList.add('show');
              } else {
                optsBox.classList.remove('show');
              }
            } catch (e) { console.error(e); }
          }, 300);
        });

        document.addEventListener('click', e => {
          if (!input.contains(e.target) && !optsBox.contains(e.target)) optsBox.classList.remove('show');
        });
      }

      // Client Search
      setupAutocomplete(
        'buscar-cliente', 'cliente-options',
        searchClientes,
        (client) => {
          document.getElementById('buscar-cliente').value = client.nombre;
          document.getElementById('id-cliente-hidden').value = client.id;
          document.getElementById('cliente-info').textContent = `${client.documento || 'Sin ID'} | ${client.telefono || ''}`;
          // Reset vehicle
          const vSel = document.getElementById('vehiculo-select');
          vSel.innerHTML = '<option value="" disabled selected>Cargando...</option>';
          vSel.disabled = true;
          document.getElementById('vehiculo-info').textContent = '-';
          document.getElementById('id-vehiculo-hidden').value = '';

          // Load Vehicles
          searchVehiculos('', client.id).then(vehs => {
            vSel.innerHTML = '<option value="" disabled selected>Seleccionar vehículo</option>';
            if (vehs.length) {
              vSel.disabled = false;
              vehs.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.id;
                opt.textContent = `${v.marca} ${v.modelo}`;
                opt.dataset.matricula = v.matricula;
                vSel.appendChild(opt);
              });
            } else {
              vSel.innerHTML = '<option disabled>Sin vehículos</option>';
            }
          });
        },
        item => `<span class="font-bold">${item.nombre}</span> <span class="text-xs text-gray-400">(${item.documento})</span>`
      );

      // Vehicle Select Change
      document.getElementById('vehiculo-select').addEventListener('change', function () {
        const opt = this.options[this.selectedIndex];
        if (opt) {
          document.getElementById('id-vehiculo-hidden').value = this.value;
          document.getElementById('vehiculo-info').textContent = opt.dataset.matricula;
        }
      });

      // Product Search
      setupAutocomplete(
        'new-item-name', 'product-options',
        (q) => {
          const sid = document.getElementById('taller').value;
          if (!sid) { showToast('Selecciona un taller primero', true); return []; }
          return searchInventario(q, sid);
        },
        (prod) => {
          document.getElementById('new-item-name').value = prod.nombre;
          document.getElementById('new-item-price').value = prod.precio_venta || prod.precio || 0;
          document.getElementById('new-item-id-hidden').value = prod.id;
          const type = (prod.tipo || '').toUpperCase().includes('SERVICIO') ? 'SERVICIO' : 'PRODUCTO';
          document.getElementById('new-item-type').value = type;
        },
        item => `<div>${item.nombre}</div><div class="text-xs text-[var(--brand-orange)]">${Number(item.precio_venta || item.precio).toFixed(2)}€ - Stock: ${item.stock || 0}</div>`
      );

      // --- Items Table Logic ---
      document.getElementById('add-item-btn').addEventListener('click', () => {
        const name = document.getElementById('new-item-name').value;
        const price = parseFloat(document.getElementById('new-item-price').value);
        const qty = parseFloat(document.getElementById('new-item-quantity').value);
        const type = document.getElementById('new-item-type').value;
        const bonus = parseFloat(document.getElementById('new-item-bonus').value) || 0;
        const id = document.getElementById('new-item-id-hidden').value;

        if (!name || isNaN(price) || isNaN(qty)) return showToast('Datos de item inválidos', true);

        orderItems.push({
          idProducto: id || null,
          descripcion: name,
          precio: price,
          cantidad: qty,
          tipoItem: type,
          descuento: bonus,
          iva: 21 // Default fixed for now as hidden select
        });

        renderItems();
        // clear inputs
        document.getElementById('new-item-name').value = '';
        document.getElementById('new-item-price').value = '';
        document.getElementById('new-item-quantity').value = '1';
        document.getElementById('new-item-id-hidden').value = '';
      });

      window.removeItem = function (idx) {
        orderItems.splice(idx, 1);
        renderItems();
      }

      function renderItems() {
        const tbody = document.getElementById('order-items-list');
        tbody.innerHTML = '';
        let totalNeto = 0;
        let totalIva = 0;
        let totalMano = 0;
        let totalRep = 0;

        orderItems.forEach((item, idx) => {
          const subtotal = (item.precio * item.cantidad) - (item.descuento || 0);
          const ivaAmt = subtotal * 0.21;

          if (item.tipoItem === 'SERVICIO') totalMano += subtotal;
          else totalRep += subtotal;
          totalNeto += subtotal;
          totalIva += ivaAmt;

          const tr = document.createElement('tr');
          tr.className = 'border-t border-[#282e39] hover:bg-[#282e39]/30';
          tr.innerHTML = `
                        <td class="p-2">
                             <div class="font-medium text-white">${item.descripcion}</div>
                             ${item.idProducto ? '<span class="text-[10px] text-green-500 bg-green-900/20 px-1 rounded">Inventario</span>' : ''}
                        </td>
                        <td class="p-2">${item.precio.toFixed(2)}€</td>
                        <td class="p-2">${item.cantidad}</td>
                        <td class="p-2"><span class="text-xs px-2 py-0.5 rounded ${item.tipoItem === 'SERVICIO' ? 'bg-blue-900 text-blue-200' : 'bg-orange-900 text-orange-200'}">${item.tipoItem === 'SERVICIO' ? 'Servicio' : 'Repuesto'}</span></td>
                        <td class="p-2">${item.descuento.toFixed(2)}€</td>
                        <td class="p-2 font-bold">${subtotal.toFixed(2)}€</td>
                        <td class="p-2 text-right"><button onclick="removeItem(${idx})" class="text-red-500 hover:text-red-300"><i class="fas fa-times"></i></button></td>
                    `;
          tbody.appendChild(tr);
        });

        // Update Summary
        document.getElementById('summary-repuestos').textContent = totalRep.toFixed(2) + '€';
        document.getElementById('summary-mano-obra').textContent = totalMano.toFixed(2) + '€';
        document.getElementById('summary-neto').textContent = totalNeto.toFixed(2) + '€';
        document.getElementById('summary-iva').textContent = totalIva.toFixed(2) + '€';

        const discountPct = parseFloat(document.getElementById('discount-input').value) || 0;
        const totalGross = totalNeto + totalIva;
        const discountAmt = totalGross * (discountPct / 100);
        const finalTotal = totalGross - discountAmt;

        document.getElementById('summary-total').textContent = finalTotal.toFixed(2) + '€';

        // Update logic in pagos-logic.js if exists
        if (window.updatePaymentSummary) window.updatePaymentSummary(finalTotal);
      }

      document.getElementById('discount-input').addEventListener('input', renderItems);

      // --- Load for Editing ---
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('id')) {
        modoEdicion = true;
        ordenIdEdicion = urlParams.get('id');
        loadOrden(ordenIdEdicion);
      }

      async function loadOrden(id) {
        try {
          const data = await getOrdenById(id);
          if (!data || !data.orden) throw new Error('Orden no encontrada');
          const o = data.orden;

          // Fill logic
          document.getElementById('taller').value = o.id_sucursal;
          document.getElementById('id-taller-hidden').value = o.id_sucursal;
          setTimeout(() => document.getElementById('tecnico-select').value = o.id_mecanico, 1000); // Wait for load

          document.getElementById('buscar-cliente').value = o.cliente_nombre || '';
          document.getElementById('id-cliente-hidden').value = o.id_cliente;

          document.getElementById('vehiculo-info').textContent = o.vehiculo_matricula || '-';
          document.getElementById('id-vehiculo-hidden').value = o.id_vehiculo;

          document.getElementById('kilometraje').value = o.km;
          document.getElementById('concepto').value = o.id_tipo_orden || 1;
          document.getElementById('observaciones').value = o.descripcion || '';

          // Lines
          orderItems = (data.lineas || []).map(l => ({
            id: l.id,
            idProducto: l.id_producto,
            descripcion: l.descripcion,
            precio: parseFloat(l.precio),
            cantidad: parseFloat(l.cantidad),
            tipoItem: l.tipo_item,
            descuento: parseFloat(l.descuento || 0)
          }));
          renderItems();

          // Payments
          if (data.pagos) {
            window.orderPayments = data.pagos.map(p => ({
              idMedioPago: p.id_medio_pago,
              importe: parseFloat(p.importe),
              referencia: p.referencia,
              nombreMedioPago: p.medio_pago_nombre
            }));
            if (window.renderPayments) window.renderPayments();
          }

        } catch (e) {
          showToast('Error cargando orden: ' + e.message, true);
        }
      }

      // --- Form Submit ---
      document.getElementById('order-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const payload = {
          idSucursal: document.getElementById('id-taller-hidden').value,
          idCliente: document.getElementById('id-cliente-hidden').value,
          idVehiculo: document.getElementById('id-vehiculo-hidden').value,
          idMecanico: document.getElementById('id-tecnico-hidden').value,
          idTipoOrden: document.getElementById('concepto').value,
          km: document.getElementById('kilometraje').value,
          descripcion: document.getElementById('observaciones').value,
          lineas: orderItems,
          pagos: window.orderPayments
        };

        if (!payload.idSucursal || !payload.idCliente || !orderItems.length) return showToast('Faltan datos obligatorios', true);

        try {
          if (modoEdicion) await updateOrden(ordenIdEdicion, payload);
          else await createOrden(payload);
          document.getElementById('success-modal').classList.remove('hidden');
        } catch (err) {
          showToast('Error al guardar: ' + err.message, true);
        }
      });

      // --- Modals Logic ---
      document.getElementById('add-client-btn').onclick = () => document.getElementById('new-client-modal').classList.remove('hidden');
      document.getElementById('cancel-new-client-btn').onclick = () => document.getElementById('new-client-modal').classList.add('hidden');

      document.getElementById('add-vehicle-btn').onclick = () => {
        document.getElementById('new-vehicle-modal').classList.remove('hidden');
        document.getElementById('new-vehicle-client-search').value = document.getElementById('buscar-cliente').value;
        document.getElementById('new-vehicle-client-id').value = document.getElementById('id-cliente-hidden').value;

        // Copy taller options
        const tSrc = document.getElementById('taller');
        const tDst = document.getElementById('new-vehicle-sucursal');
        tDst.innerHTML = tSrc.innerHTML;
        tDst.value = tSrc.value;
      };
      document.getElementById('cancel-new-vehicle-btn').onclick = () => document.getElementById('new-vehicle-modal').classList.add('hidden');

      document.getElementById('close-modal-btn').onclick = () => document.getElementById('success-modal').classList.add('hidden');
      document.getElementById('new-order-btn').onclick = () => window.location.href = 'manager-taller-ordenes.html';

      // New Client Submit
      document.getElementById('new-client-form').addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        try {
          const res = await createClient(Object.fromEntries(formData));
          document.getElementById('new-client-modal').classList.add('hidden');
          // auto select logic handled if complex, for now simple toast
          showToast('Cliente creado');
          // Could auto-fill parent inputs here
        } catch (err) { showToast(err.message, true); }
      });

      // New Vehicle Submit
      document.getElementById('new-vehicle-form').addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        try {
          const res = await createVehicle(Object.fromEntries(formData));
          document.getElementById('new-vehicle-modal').classList.add('hidden');
          showToast('Vehículo creado');
          // Auto select
          const sel = document.getElementById('vehiculo-select');
          sel.disabled = false;
          const opt = document.createElement('option');
          opt.value = res.id;
          opt.textContent = `${res.marca} ${res.modelo}`;
          opt.dataset.matricula = res.matricula;
          opt.selected = true;
          sel.appendChild(opt);
          sel.dispatchEvent(new Event('change'));
        } catch (err) { showToast(err.message, true); }
      });
    });
  </script>
  <script src="pagos-logic.js"></script>
</body>

</html>