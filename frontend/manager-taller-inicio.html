<!DOCTYPE html>
<html lang="es" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inicio - Goversa Taller Manager</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="assets/favicon.png">

  <!-- Google Fonts - Preconnect -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
    rel="stylesheet" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <!-- Guard.js - Autenticación -->
  <script src="/guard.js"></script>

  <!-- Estilos Globales del Manager -->
  <link rel="stylesheet" href="manager.css">
  <link rel="stylesheet" href="styles/sucursal-selector.css">

  <style>
    /* 
     * Estilos específicos de manager-taller-inicio.html
     * Las variables globales (:root) están centralizadas en manager.css
     */

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      vertical-align: middle;
    }


    /* Scrollbar personalizada para coincidir con el diseño */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #111318;
    }

    ::-webkit-scrollbar-thumb {
      background: #282e39;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #ff5f00;
    }

    /* Fix para opciones del select de sucursales */
    #sucursal-select option {
      background-color: #111318;
      color: white;
      padding: 8px;
    }

    /* Tooltip styles */
    .tooltip-container {
      position: relative;
      display: inline-flex;
      align-items: center;
    }

    .tooltip-trigger {
      color: #6b7280;
      cursor: help;
      transition: color 0.15s;
    }

    .tooltip-trigger:hover {
      color: #9da6b9;
    }

    .tooltip-content {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: #1e2028;
      border: 1px solid #2d3240;
      border-radius: 8px;
      padding: 10px 12px;
      width: max-content;
      max-width: 280px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      transition: opacity 0.15s, visibility 0.15s;
    }

    .tooltip-content::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: #2d3240;
    }

    .tooltip-container:hover .tooltip-content {
      visibility: visible;
      opacity: 1;
    }

    .tooltip-text {
      font-size: 12px;
      font-weight: 400;
      color: #d1d5db;
      line-height: 1.5;
    }
  </style>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            brand: {
              orange: "#ff5f00",
              dark: "#0b0d11",
              surface: "#111318",
              border: "#282e39",
              input: "#1a1d24",
              text: "#ffffff",
              muted: "#9da6b9"
            }
          },
          fontFamily: {
            main: ["Montserrat", "sans-serif"]
          },
        },
      },
    }
  </script>
</head>

<body class="bg-[#0b0d11] font-[Montserrat] text-white">

  <!-- PAGE LOADER -->
  <div id="page-loader" class="page-loader-overlay">
    <div class="loader-logo">
      <img src="assets/versa-v-logo.png" alt="Versa Logo">
    </div>
    <div class="loader-wrapper">
      <div class="circle"></div>
      <div class="circle"></div>
      <div class="circle"></div>
      <div class="shadow"></div>
      <div class="shadow"></div>
      <div class="shadow"></div>
    </div>
    <p class="loader-text">Cargando datos...</p>
  </div>

  <div class="flex h-screen w-full">

    <aside id="sidebar"
      class="flex h-full w-64 flex-col bg-[#111318] p-4 shrink-0 transition-all duration-300 ease-in-out border-r border-[var(--surface-border)]">
      <div class="flex h-full flex-col justify-between">
        <div class="flex flex-col gap-4">
          <div class="flex items-center gap-3 p-2 mb-4">
            <div class="logo-badge"
              style="padding: 8px; border-radius: 12px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
              <img src="https://i.imgur.com/Mjw4or5.png" alt="Logo" class="logo-img" style="height: 24px; width: auto;">
            </div>
            <div class="flex flex-col sidebar-text">
              <h1 class="text-white text-base font-medium leading-normal" style="font-size: 15px;">Goversa</h1>
              <p class="text-[#9da6b9] text-sm font-normal leading-normal" style="font-size: 12px;">Gestión</p>
            </div>
            <button id="toggle-sidebar" class="ml-auto text-gray-400 hover:text-white">
              <i class="fas fa-chevron-left"></i>
            </button>
          </div>

          <nav class="flex flex-col gap-2">
            <a class="flex items-center gap-3 px-3 py-2 bg-[#282e39] text-white rounded-lg transition-colors border-l-2 border-[var(--brand-orange)]"
              href="#">
              <span class="icon-container"><i class="fas fa-home text-[var(--brand-orange)]"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Inicio</p>
            </a>

            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('taller-submenu')">
                <span class="icon-container"><i class="fas fa-wrench"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Taller</p>
                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="taller-arrow"></i>
              </a>
              <div id="taller-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-citas.html" class="text-gray-500 hover:text-white text-sm py-1 block">Citas</a>
                <a href="manager-taller-ordenes-lista.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Órdenes</a>
                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Presupuestos</a>
                <a href="manager-taller-vehiculos.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Vehículos</a>
              </div>
            </div>

            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('tienda-submenu')">
                <span class="icon-container"><i class="fas fa-shopping-cart"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Tienda</p>
                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="tienda-arrow"></i>
              </a>
              <div id="tienda-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-compras.html" class="text-gray-500 hover:text-white text-sm py-1 block">Nueva
                  Compra</a>
                <a href="manager-taller-compras-historial.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Historial Compras</a>
              </div>
            </div>

            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-caja.html">
              <span class="icon-container"><i class="fas fa-cash-register"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Caja</p>
            </a>

            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-inventario.html">
              <span class="icon-container"><i class="fas fa-boxes"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Inventario</p>
            </a>

            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-trabajadores.html">
              <span class="icon-container"><i class="fas fa-users-cog"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Trabajadores</p>
            </a>

            <!-- Contactos (Submenu) -->
            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('contactos-submenu')">
                <span class="icon-container"><i class="fas fa-address-book"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Contactos</p>
                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="contactos-arrow"></i>
              </a>
              <div id="contactos-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-clientes.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Clientes</a>
                <a href="manager-taller-proveedores.html"
                  class="text-gray-400 hover:text-white text-sm py-1 block">Proveedores</a>
              </div>
            </div>

            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-marketplace.html">
              <span class="icon-container"><i class="fas fa-store"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Marketplace</p>
            </a>

            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-fidelizacion.html">
              <span class="icon-container"><i class="fas fa-gift"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Fidelización</p>
            </a>

            <!-- Marketing Automations -->
            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('marketing-submenu')">
                <span class="icon-container"><i class="fas fa-bullhorn"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Marketing</p>
                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="marketing-arrow"></i>
              </a>
              <div id="marketing-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="manager-marketing-email.html" class="text-gray-400 hover:text-white text-sm py-1 block">Email
                  Automations</a>
              </div>
            </div>

            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-configuracion.html">
              <span class="icon-container"><i class="fas fa-cog"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Configuración</p>
            </a>
          </nav>
        </div>

        <div class="flex flex-col gap-1 border-t border-[var(--brand-orange)] pt-4">
          <div class="flex items-center gap-3 px-3 py-2 mb-2">
            <div
              class="w-8 h-8 rounded-full bg-[var(--brand-orange)] flex items-center justify-center text-white font-bold text-xs">
              IM</div>
            <div class="flex flex-col sidebar-text overflow-hidden">
              <span class="text-white text-sm font-medium truncate">Iván Moreno</span>
              <span class="text-gray-500 text-xs truncate">admin</span>
            </div>
          </div>
          <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
            href="#" data-logout>
            <span class="icon-container"><i class="fas fa-sign-out-alt"></i></span>
            <p class="text-sm font-medium leading-normal sidebar-text">Salir</p>
          </a>
        </div>
      </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-[#0b0d11]">
      <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">

        <header class="md:hidden flex items-center justify-between mb-6 pb-4 border-b border-[#282e39]">
          <div class="logo-badge">
            <img src="https://i.imgur.com/Mjw4or5.png" alt="Logo" class="h-6 w-auto">
          </div>
          <button id="mobile-menu-btn" class="text-white"><i class="fas fa-bars"></i></button>
        </header>

        <header class="mb-8 flex flex-wrap items-center justify-between gap-4">
          <div class="flex-1">
            <div class="flex flex-col gap-1">
              <h1 class="text-2xl font-bold tracking-tight text-white">Resumen General</h1>
              <p class="text-[#9da6b9] text-sm font-normal">Bienvenido, Manager. Aquí tienes un resumen de la actividad
                de hoy.</p>
            </div>
          </div>
          <div class="flex w-full items-center gap-4 sm:w-auto">
            <!-- Selector de Rango de Tiempo con Quick Picks + Calendario -->
            <div class="flex items-center gap-2">
              <select id="time-range-select" onchange="cambiarRangoTiempo(this.value)"
                class="appearance-none h-10 rounded-lg border border-[#282e39] bg-[#1a1d24] pl-4 pr-10 text-white text-sm focus:border-[var(--brand-orange)] focus:ring-1 focus:ring-[var(--brand-orange)] cursor-pointer hover:bg-[#282e39] transition-colors">
                <option value="today">Hoy</option>
                <option value="week">Esta Semana</option>
                <option value="month" selected>Este Mes</option>
                <option value="quarter">Este Trimestre</option>
                <option value="year">Este Año</option>
                <option value="custom">Personalizado</option>
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-[#9da6b9]"
                style="position: relative;">
                <i class="fas fa-calendar-alt text-xs"></i>
              </div>
            </div>

            <!-- Selector de Rango Personalizado (Oculto por defecto) -->
            <div id="custom-date-range"
              class="hidden flex items-center gap-2 bg-[#1a1d24] border border-[#282e39] rounded-lg px-3 py-1.5">
              <input type="date" id="date-from"
                class="bg-transparent border-none text-white text-sm focus:outline-none w-28 cursor-pointer"
                onchange="aplicarRangoPersonalizado()">
              <span class="text-[#9da6b9]">→</span>
              <input type="date" id="date-to"
                class="bg-transparent border-none text-white text-sm focus:outline-none w-28 cursor-pointer"
                onchange="aplicarRangoPersonalizado()">
            </div>

            <!-- Botón de Notificaciones con Panel Desplegable -->
            <div class="relative" id="notifications-container">
              <button id="notifications-btn"
                class="relative rounded-lg p-2 text-[#9da6b9] hover:bg-[#282e39] hover:text-white transition-colors">
                <span class="material-symbols-outlined">notifications</span>
                <span id="notification-badge"
                  class="absolute right-1.5 top-1.5 flex h-2.5 w-2.5 items-center justify-center hidden">
                  <span
                    class="absolute inline-flex h-full w-full animate-ping rounded-full bg-[var(--brand-orange)] opacity-75"></span>
                  <span class="relative inline-flex h-2 w-2 rounded-full bg-[var(--brand-orange)]"></span>
                </span>
              </button>

              <!-- Panel de Notificaciones -->
              <div id="notifications-panel"
                class="hidden absolute right-0 top-full mt-2 w-80 max-h-96 overflow-y-auto bg-[#111318] border border-[#282e39] rounded-xl shadow-2xl z-50">
                <div class="p-4 border-b border-[#282e39] flex items-center justify-between">
                  <h3 class="text-white font-bold text-sm flex items-center gap-2">
                    <span class="material-symbols-outlined text-[var(--brand-orange)] text-lg">notifications</span>
                    Notificaciones
                  </h3>
                  <button onclick="marcarTodasLeidas()"
                    class="text-xs text-[#9da6b9] hover:text-white transition-colors">
                    Marcar todas leídas
                  </button>
                </div>
                <div id="notifications-list" class="divide-y divide-[#282e39]">
                  <div class="p-4 text-center text-[#9da6b9] text-sm">
                    <i class="far fa-bell-slash mr-2"></i>
                    No hay notificaciones nuevas
                  </div>
                </div>
              </div>
            </div>
            <a href="manager-taller-ordenes.html"
              class="flex h-10 cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg bg-[var(--brand-orange)] px-4 text-sm font-bold text-white shadow-lg shadow-orange-900/20 hover:bg-[#e05300] transition-colors">
              <span class="material-symbols-outlined" style="font-size: 20px;">add_circle</span>
              <span class="truncate">Nueva Orden</span>
            </a>
          </div>
        </header>

        <!-- Selector de Sucursal Estandarizado -->
        <div class="sucursal-selector-wrapper">
          <div id="sucursal-selector-container"></div>
        </div>

        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-8">

          <!-- INGRESOS -->
          <div
            class="flex flex-col gap-2 rounded-xl border border-[#282e39] bg-[#111318] p-6 hover:border-green-500 transition-colors group relative overflow-hidden">
            <div class="absolute right-0 top-0 h-full w-1 bg-green-500 opacity-20"></div>
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-[#9da6b9] uppercase tracking-wider">Ingresos</p>
              <span class="material-symbols-outlined text-green-500 bg-green-500/10 p-2 rounded-lg">payments</span>
            </div>
            <div class="flex items-baseline gap-2 mt-2">
              <p id="stat-ingresos"
                class="text-3xl font-bold tracking-tight text-white group-hover:text-green-400 transition-colors">€0.00
              </p>
            </div>
          </div>

          <!-- EGRESOS -->
          <div
            class="flex flex-col gap-2 rounded-xl border border-[#282e39] bg-[#111318] p-6 hover:border-red-500 transition-colors group relative overflow-hidden">
            <div class="absolute right-0 top-0 h-full w-1 bg-red-500 opacity-20"></div>
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-[#9da6b9] uppercase tracking-wider">Egresos</p>
              <span class="material-symbols-outlined text-red-500 bg-red-500/10 p-2 rounded-lg">shopping_cart</span>
            </div>
            <div class="flex items-baseline gap-2 mt-2">
              <p id="stat-egresos"
                class="text-3xl font-bold tracking-tight text-white group-hover:text-red-400 transition-colors">€0.00
              </p>
            </div>
          </div>

          <!-- BENEFICIO -->
          <div
            class="flex flex-col gap-2 rounded-xl border border-[#282e39] bg-[#111318] p-6 hover:border-[var(--brand-orange)] transition-colors group relative overflow-hidden">
            <div class="absolute right-0 top-0 h-full w-1 bg-[var(--brand-orange)] opacity-20"></div>
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-[#9da6b9] uppercase tracking-wider">Beneficio</p>
              <span
                class="material-symbols-outlined text-[var(--brand-orange)] bg-[rgba(255,95,0,0.1)] p-2 rounded-lg">account_balance_wallet</span>
            </div>
            <div class="flex items-baseline gap-2 mt-2">
              <p id="stat-beneficio"
                class="text-3xl font-bold tracking-tight text-white group-hover:text-[var(--brand-orange)] transition-colors">
                €0.00</p>
            </div>
          </div>

          <!-- MARGEN -->
          <div
            class="flex flex-col gap-2 rounded-xl border border-[#282e39] bg-[#111318] p-6 hover:border-blue-500 transition-colors group relative overflow-hidden">
            <div class="absolute right-0 top-0 h-full w-1 bg-blue-500 opacity-20"></div>
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-[#9da6b9] uppercase tracking-wider">Margen Global</p>
              <span class="material-symbols-outlined text-blue-500 bg-blue-500/10 p-2 rounded-lg">percent</span>
            </div>
            <div class="flex items-baseline gap-2 mt-2">
              <p id="stat-margen"
                class="text-3xl font-bold tracking-tight text-white group-hover:text-blue-400 transition-colors">0%</p>
            </div>
          </div>
        </div>

        <!-- INGRESOS POR ORIGEN (Marketplace vs CRM) -->
        <div id="income-ledger-section" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 mb-8">

          <!-- INGRESOS MARKETPLACE -->
          <div id="card-marketplace"
            class="flex flex-col gap-2 rounded-xl border border-[#282e39] bg-[#111318] p-6 hover:border-cyan-500 transition-colors group relative overflow-hidden cursor-pointer"
            onclick="window.location='manager-taller-marketplace.html'">
            <div class="absolute right-0 top-0 h-full w-1 bg-gradient-to-b from-cyan-500 to-teal-500 opacity-40"></div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <p class="text-sm font-medium text-[#9da6b9] uppercase tracking-wider">Marketplace</p>
                <span class="text-xs bg-cyan-500/20 text-cyan-400 px-2 py-0.5 rounded-full font-medium">Online</span>
              </div>
              <span class="material-symbols-outlined text-cyan-500 bg-cyan-500/10 p-2 rounded-lg">storefront</span>
            </div>
            <div class="flex items-baseline gap-2 mt-2">
              <p id="stat-ingresos-marketplace"
                class="text-3xl font-bold tracking-tight text-white group-hover:text-cyan-400 transition-colors">€0.00
              </p>
            </div>
            <p id="stat-marketplace-eventos" class="text-xs text-[#9da6b9] mt-1">
              <span class="text-cyan-400">0</span> reservas pagadas
            </p>
          </div>

          <!-- INGRESOS CRM -->
          <div id="card-crm"
            class="flex flex-col gap-2 rounded-xl border border-[#282e39] bg-[#111318] p-6 hover:border-amber-500 transition-colors group relative overflow-hidden cursor-pointer"
            onclick="window.location='manager-taller-caja.html'">
            <div class="absolute right-0 top-0 h-full w-1 bg-gradient-to-b from-amber-500 to-orange-500 opacity-40">
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <p class="text-sm font-medium text-[#9da6b9] uppercase tracking-wider">CRM Taller</p>
                <span
                  class="text-xs bg-amber-500/20 text-amber-400 px-2 py-0.5 rounded-full font-medium">Presencial</span>
              </div>
              <span class="material-symbols-outlined text-amber-500 bg-amber-500/10 p-2 rounded-lg">point_of_sale</span>
            </div>
            <div class="flex items-baseline gap-2 mt-2">
              <p id="stat-ingresos-crm"
                class="text-3xl font-bold tracking-tight text-white group-hover:text-amber-400 transition-colors">€0.00
              </p>
            </div>
            <p id="stat-crm-eventos" class="text-xs text-[#9da6b9] mt-1">
              <span class="text-amber-400">0</span> ventas/órdenes procesadas
            </p>
          </div>

          <!-- TOTAL LEDGER -->
          <div
            class="flex flex-col gap-2 rounded-xl border border-dashed border-[#282e39] bg-[#0f1116] p-6 hover:border-green-500/50 transition-colors group relative overflow-hidden">
            <div class="absolute right-0 top-0 h-full w-1 bg-gradient-to-b from-green-500 to-emerald-500 opacity-20">
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <p class="text-sm font-medium text-[#9da6b9] uppercase tracking-wider">Total Ledger</p>
                <span class="tooltip-container">
                  <span class="material-symbols-outlined text-[14px] tooltip-trigger cursor-help">info</span>
                  <span class="tooltip-content">
                    <span class="tooltip-text">
                      Suma de ingresos confirmados desde el <strong>ledger centralizado</strong>.<br><br>
                      <span class="text-cyan-400">Marketplace</span> = Pagos online vía Stripe<br>
                      <span class="text-amber-400">CRM</span> = Ventas y órdenes del taller
                    </span>
                  </span>
                </span>
              </div>
              <span
                class="material-symbols-outlined text-green-500 bg-green-500/10 p-2 rounded-lg">account_balance</span>
            </div>
            <div class="flex items-baseline gap-2 mt-2">
              <p id="stat-ingresos-ledger-total"
                class="text-3xl font-bold tracking-tight text-white group-hover:text-green-400 transition-colors">€0.00
              </p>
            </div>
            <div class="flex items-center gap-4 mt-2 text-xs">
              <span class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-cyan-500"></span>
                <span id="pct-marketplace" class="text-[#9da6b9]">0%</span>
              </span>
              <span class="flex items-center gap-1">
                <span class="w-2 h-2 rounded-full bg-amber-500"></span>
                <span id="pct-crm" class="text-[#9da6b9]">0%</span>
              </span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-6">

          <!-- Cliente TOP -->
          <div
            class="flex flex-col gap-2 rounded-xl border border-[#282e39] bg-[#111318] p-6 hover:border-purple-500 transition-colors group">
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-[#9da6b9] uppercase">Cliente Top</p>
              <span class="material-symbols-outlined text-purple-500 bg-purple-500/10 p-2 rounded-lg">star</span>
            </div>
            <div class="mt-2">
              <p id="stat-cliente-top"
                class="text-lg font-bold tracking-tight text-white group-hover:text-purple-400 transition-colors truncate">
                -
              </p>
              <p id="stat-cliente-top-sub" class="text-xs text-[#9da6b9] mt-1">Sin datos</p>
            </div>
          </div>

          <!-- Ticket Medio -->
          <div
            class="flex flex-col gap-2 rounded-xl border border-[#282e39] bg-[#111318] p-6 hover:border-yellow-500 transition-colors group cursor-pointer"
            id="ticket-medio-card">
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-[#9da6b9] uppercase">Ticket Medio</p>
              <span
                class="material-symbols-outlined text-yellow-500 bg-yellow-500/10 p-2 rounded-lg">receipt_long</span>
            </div>
            <div class="flex items-center gap-2 mt-2">
              <p id="stat-ticket-medio"
                class="text-3xl font-bold tracking-tight text-white group-hover:text-yellow-400 transition-colors">-</p>
            </div>
          </div>

          <!-- Listas x Entregar -->
          <div
            class="flex flex-col gap-2 rounded-xl border border-[#282e39] bg-[#111318] p-6 hover:border-indigo-500 transition-colors group cursor-pointer"
            onclick="window.location='manager-taller-ordenes-lista.html?estado=COMPLETADA'">
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-[#9da6b9] uppercase">Listas x Entregar</p>
              <span
                class="material-symbols-outlined text-indigo-500 bg-indigo-500/10 p-2 rounded-lg">local_shipping</span>
            </div>
            <div class="flex items-center gap-2 mt-2">
              <p id="stat-listas-entregar"
                class="text-3xl font-bold tracking-tight text-white group-hover:text-indigo-400 transition-colors">-</p>
            </div>
          </div>

          <!-- Stock Bajo -->
          <div
            class="flex flex-col gap-2 rounded-xl border border-[#282e39] bg-[#111318] p-6 hover:border-red-500 transition-colors group cursor-pointer"
            onclick="window.location='manager-taller-inventario.html?stock_bajo=1'">
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-[#9da6b9] uppercase">Stock Bajo</p>
              <span class="material-symbols-outlined text-red-500 bg-red-500/10 p-2 rounded-lg">warning</span>
            </div>
            <div class="flex items-center gap-2 mt-2">
              <p id="stat-stock-bajo"
                class="text-3xl font-bold tracking-tight text-white group-hover:text-red-400 transition-colors">-</p>
            </div>
          </div>

        </div>

        <div class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-3">

          <div class="overflow-hidden rounded-xl border border-[#282e39] bg-[#111318] lg:col-span-2 shadow-sm">
            <div class="border-b border-[#282e39] p-5 flex justify-between items-center">
              <h3 class="text-base font-bold text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-[var(--brand-orange)]">assignment</span>
                Últimas Órdenes
              </h3>
              <a href="manager-taller-ordenes-lista.html"
                class="text-xs text-[#9da6b9] hover:text-white transition-colors">Ver todas</a>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-[#282e39]">
                <thead class="bg-[#1c1f27]">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider text-[#9da6b9]"
                      scope="col">#</th>
                    <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider text-[#9da6b9]"
                      scope="col">Cliente</th>
                    <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider text-[#9da6b9]"
                      scope="col">Vehículo</th>
                    <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider text-[#9da6b9]"
                      scope="col">Estado</th>
                    <th class="relative px-6 py-3" scope="col"><span class="sr-only">Acción</span></th>
                  </tr>
                </thead>
                <tbody id="ultimas-ordenes-tbody" class="divide-y divide-[#282e39] bg-[#111318]">
                  <tr>
                    <td colspan="5" class="px-6 py-4 text-center text-[#9da6b9]">Cargando...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>


          <div class="rounded-xl border border-[#282e39] bg-[#111318] p-6 shadow-sm flex flex-col justify-between">
            <h3 class="mb-6 text-base font-bold text-white flex items-center gap-2">
              <span class="material-symbols-outlined text-[var(--brand-orange)]">bar_chart</span>
              <span class="flex items-center gap-1">
                Rendimiento Semanal
                <span class="tooltip-container">
                  <span class="material-symbols-outlined text-[14px] tooltip-trigger cursor-help">info</span>
                  <span class="tooltip-content">
                    <span class="tooltip-text">
                      Muestra los <strong style="color: #22c55e;">pagos realmente cobrados</strong> cada día de la
                      semana actual.<br><br>
                      <span style="color: #9da6b9;">No incluye facturación pendiente de cobro, solo dinero efectivamente
                        recibido.</span>
                    </span>
                  </span>
                </span>
              </span>
            </h3>
            <div class="flex h-64 items-end justify-between gap-2" id="chart-semanal">
              <!-- Las barras se generan dinámicamente desde JS -->
              <div class="flex items-center justify-center w-full h-full text-[#9da6b9] text-sm">
                <i class="fas fa-spinner fa-spin mr-2"></i> Cargando...
              </div>
            </div>
            <div class="mt-4 pt-4 border-t border-[#282e39] flex justify-between items-center">
              <span class="text-xs text-[#9da6b9] uppercase">Total Semanal</span>
              <span id="total-semanal" class="text-lg font-bold text-green-400">€0.00</span>
            </div>
          </div>

        </div>
      </div>
    </main>
  </div>

  <!-- Modal Histórico Ticket Medio -->
  <div id="ticket-medio-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4"
    style="background: rgba(0,0,0,0.8);">
    <div
      class="bg-[#111318] rounded-2xl border border-[#282e39] w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
      <!-- Header del Modal -->
      <div class="flex items-center justify-between p-6 border-b border-[#282e39]">
        <div class="flex items-center gap-3">
          <span class="material-symbols-outlined text-purple-500 bg-purple-500/10 p-2 rounded-lg">receipt_long</span>
          <div>
            <h2 class="text-xl font-bold text-white">Ticket Medio Mensual</h2>
            <p class="text-sm text-[#9da6b9]">Histórico de los últimos 12 meses</p>
          </div>
        </div>
        <button onclick="cerrarModalTicketMedio()"
          class="text-[#9da6b9] hover:text-white transition-colors p-2 hover:bg-[#282e39] rounded-lg">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <!-- Contenido del Modal -->
      <div class="flex-1 overflow-y-auto p-6">
        <!-- Gráfico de Barras -->
        <div class="bg-[#0b0d11] rounded-xl p-6 border border-[#282e39] mb-6">
          <h3 class="text-base font-bold text-white mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-purple-400">bar_chart</span>
            Evolución del Ticket Medio
          </h3>
          <div id="historico-chart" class="h-64 flex items-end justify-between gap-2">
            <!-- Barras se generan dinámicamente -->
            <div class="flex items-center justify-center w-full h-full text-[#9da6b9] text-sm">
              <i class="fas fa-spinner fa-spin mr-2"></i> Cargando...
            </div>
          </div>
        </div>

        <!-- Tabla de Datos -->
        <div class="bg-[#0b0d11] rounded-xl border border-[#282e39] overflow-hidden">
          <h3 class="text-base font-bold text-white p-4 border-b border-[#282e39] flex items-center gap-2">
            <span class="material-symbols-outlined text-purple-400">table_chart</span>
            Detalle por Mes
          </h3>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-[#1a1d24]">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider text-[#9da6b9]">Mes</th>
                  <th class="px-6 py-3 text-right text-xs font-bold uppercase tracking-wider text-[#9da6b9]">Órdenes
                    Cerradas</th>
                  <th class="px-6 py-3 text-right text-xs font-bold uppercase tracking-wider text-[#9da6b9]">Facturación
                    Total</th>
                  <th class="px-6 py-3 text-right text-xs font-bold uppercase tracking-wider text-[#9da6b9]">Ticket
                    Medio</th>
                </tr>
              </thead>
              <tbody id="historico-tabla-body" class="divide-y divide-[#282e39]">
                <tr>
                  <td colspan="4" class="px-6 py-4 text-center text-[#9da6b9]">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.toggleSubmenu = function (id) {
      const submenu = document.getElementById(id);
      const arrow = document.getElementById(id.replace('submenu', 'arrow'));
      if (submenu.classList.contains('hidden')) {
        submenu.classList.remove('hidden');
        submenu.classList.add('flex');
        if (arrow) arrow.style.transform = 'rotate(180deg)';
      } else {
        submenu.classList.add('hidden');
        submenu.classList.remove('flex');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
      }
    }

    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggle-sidebar');
    const sidebarTexts = document.querySelectorAll('.sidebar-text');
    let isCollapsed = false;

    toggleBtn.addEventListener('click', () => {
      isCollapsed = !isCollapsed;
      if (isCollapsed) {
        sidebar.classList.remove('w-64');
        sidebar.classList.add('w-20');
        sidebarTexts.forEach(el => el.classList.add('hidden'));
        toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        document.querySelectorAll('[id$="-submenu"]').forEach(el => {
          el.classList.add('hidden');
          el.classList.remove('flex');
        });
      } else {
        sidebar.classList.add('w-64');
        sidebar.classList.remove('w-20');
        sidebarTexts.forEach(el => el.classList.remove('hidden'));
        toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
      }
    });

    // Mobile Menu Logic
    document.getElementById('mobile-menu-btn').addEventListener('click', () => {
      sidebar.classList.toggle('-translate-x-full');
      sidebar.classList.toggle('absolute');
      sidebar.classList.toggle('z-50');
      sidebar.classList.toggle('h-full');
    });
  </script>

  <script type="module">
    import { getOrdenes } from '/services/ordenes-service.js';
    import { getVentas } from '/services/ventas-service.js';
    import { requireAuth, clearSession, redirectToLogin, fetchWithAuth, getCurrentUser } from '/auth.js';
    import { initSucursalSelector, getCurrentSucursalId } from '/services/sucursal-selector.js';

    // Logout logic
    // Logout logic - Event Delegation
    document.addEventListener('click', (e) => {
      const logoutLink = e.target.closest('#logout-btn') || e.target.closest('[data-logout]');
      if (logoutLink) {
        e.preventDefault();
        clearSession();
        redirectToLogin();
      }
    });

    // --- UTILS FECHAS ---
    function getDatesForRange(range) {
      const now = new Date();
      let start = new Date(now);
      let end = new Date(now);

      // Reset hours to encompass full days
      start.setHours(0, 0, 0, 0);
      end.setHours(23, 59, 59, 999);

      switch (range) {
        case 'today':
          // Start and end are already today
          break;
        case 'week':
          // Monday of current week
          const day = now.getDay() || 7; // Get current day number, make Sunday (0) -> 7
          if (day !== 1) start.setHours(-24 * (day - 1));
          break;
        case 'month':
          start.setDate(1);
          break;
        case 'quarter':
          const quarter = Math.floor(now.getMonth() / 3);
          start.setMonth(quarter * 3);
          start.setDate(1);
          break;
        case 'year':
          start.setMonth(0);
          start.setDate(1);
          break;
        case 'custom':
          // Usar las fechas personalizadas si existen
          if (customDateFrom && customDateTo) {
            start = new Date(customDateFrom);
            end = new Date(customDateTo);
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);
          }
          break;
      }
      return { start, end };
    }

    // --- CARGA DE DATOS ---
    // Variables globales para rango personalizado
    let customDateFrom = null;
    let customDateTo = null;

    window.cambiarRangoTiempo = function (range) {
      const customRangeEl = document.getElementById('custom-date-range');

      if (range === 'custom') {
        // Mostrar selector de fechas personalizado
        customRangeEl.classList.remove('hidden');
        customRangeEl.classList.add('flex');

        // Establecer valores por defecto (último mes)
        const now = new Date();
        const monthAgo = new Date(now);
        monthAgo.setMonth(monthAgo.getMonth() - 1);

        const dateFromEl = document.getElementById('date-from');
        const dateToEl = document.getElementById('date-to');

        if (!dateFromEl.value) dateFromEl.value = monthAgo.toISOString().split('T')[0];
        if (!dateToEl.value) dateToEl.value = now.toISOString().split('T')[0];

        // Cargar con las fechas personalizadas
        aplicarRangoPersonalizado();
      } else {
        // Ocultar selector personalizado
        customRangeEl.classList.add('hidden');
        customRangeEl.classList.remove('flex');
        cargarDashboard(range);
      }
    }

    window.aplicarRangoPersonalizado = function () {
      const dateFromEl = document.getElementById('date-from');
      const dateToEl = document.getElementById('date-to');

      if (dateFromEl.value && dateToEl.value) {
        customDateFrom = new Date(dateFromEl.value);
        customDateTo = new Date(dateToEl.value);
        customDateTo.setHours(23, 59, 59, 999);

        cargarDashboard('custom');
      }
    }

    // --- NOTIFICACIONES ---
    window.notificaciones = [];

    async function cargarNotificaciones() {
      try {
        const notificationsList = [];

        // 1. Stock bajo
        const invResponse = await fetchWithAuth('/api/inventory/resumen');
        if (invResponse.ok) {
          const productos = await invResponse.json();
          const stockBajo = productos.filter(p =>
            p.stock_minimo && Number(p.stock_total || 0) <= Number(p.stock_minimo)
          );
          if (stockBajo.length > 0) {
            notificationsList.push({
              type: 'warning',
              icon: 'warning',
              title: 'Stock Bajo',
              message: `${stockBajo.length} producto(s) con stock bajo mínimo`,
              link: 'manager-taller-inventario.html?stock_bajo=1',
              time: 'Ahora'
            });
          }
        }

        // 2. Órdenes pendientes de entregar
        const { getOrdenes } = await import('/services/ordenes-service.js');
        const listasResponse = await getOrdenes({ estado: 'COMPLETADA' });
        const listasCount = listasResponse.ordenes ? listasResponse.ordenes.length : 0;
        if (listasCount > 0) {
          notificationsList.push({
            type: 'info',
            icon: 'local_shipping',
            title: 'Órdenes Listas',
            message: `${listasCount} orden(es) lista(s) para entregar`,
            link: 'manager-taller-ordenes-lista.html?estado=COMPLETADA',
            time: 'Ahora'
          });
        }

        // 3. Citas pendientes hoy
        const citasResponse = await fetchWithAuth('/api/citas?fecha=' + new Date().toISOString().split('T')[0]);
        if (citasResponse.ok) {
          const citas = await citasResponse.json();
          const citasPendientes = citas.filter(c => c.estado === 'pendiente' || c.estado === 'confirmada');
          if (citasPendientes.length > 0) {
            notificationsList.push({
              type: 'info',
              icon: 'event',
              title: 'Citas Hoy',
              message: `${citasPendientes.length} cita(s) programada(s) para hoy`,
              link: 'manager-taller-citas.html',
              time: 'Hoy'
            });
          }
        }

        window.notificaciones = notificationsList;
        renderNotificaciones();

      } catch (error) {
        console.warn('Error cargando notificaciones:', error);
      }
    }

    function renderNotificaciones() {
      const listEl = document.getElementById('notifications-list');
      const badgeEl = document.getElementById('notification-badge');

      if (window.notificaciones.length === 0) {
        listEl.innerHTML = `
          <div class="p-4 text-center text-[#9da6b9] text-sm">
            <i class="far fa-bell-slash mr-2"></i>
            No hay notificaciones nuevas
          </div>
        `;
        badgeEl.classList.add('hidden');
        return;
      }

      badgeEl.classList.remove('hidden');

      listEl.innerHTML = window.notificaciones.map((n, idx) => {
        const iconColor = n.type === 'warning' ? 'text-yellow-500' :
          n.type === 'error' ? 'text-red-500' : 'text-cyan-500';
        const bgColor = n.type === 'warning' ? 'bg-yellow-500/10' :
          n.type === 'error' ? 'bg-red-500/10' : 'bg-cyan-500/10';

        return `
          <a href="${n.link}" class="block p-4 hover:bg-[#1a1d24] transition-colors cursor-pointer">
            <div class="flex items-start gap-3">
              <span class="material-symbols-outlined ${iconColor} ${bgColor} p-2 rounded-lg text-lg">${n.icon}</span>
              <div class="flex-1">
                <p class="text-white text-sm font-medium">${n.title}</p>
                <p class="text-[#9da6b9] text-xs mt-0.5">${n.message}</p>
                <p class="text-[#6b7280] text-xs mt-1">${n.time}</p>
              </div>
            </div>
          </a>
        `;
      }).join('');
    }

    window.marcarTodasLeidas = function () {
      window.notificaciones = [];
      renderNotificaciones();
    }

    // Toggle panel de notificaciones
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('notifications-btn');
      const panel = document.getElementById('notifications-panel');

      if (btn && panel) {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          panel.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
          if (!panel.contains(e.target) && !btn.contains(e.target)) {
            panel.classList.add('hidden');
          }
        });
      }
    });

    // Cargar estadísticas del dashboard
    // Función global para ocultar el loader
    function hidePageLoader() {
      const loader = document.getElementById('page-loader');
      if (loader) {
        loader.classList.add('hidden');
      }
    }

    // Función global para mostrar el loader
    function showPageLoader() {
      const loader = document.getElementById('page-loader');
      if (loader) {
        loader.classList.remove('hidden');
      }
    }

    async function cargarDashboard(range = 'month') {
      try {
        const user = await requireAuth();
        if (!user) {
          hidePageLoader();
          return;
        }

        // Actualizar UI Header
        updateUserHeader(user);

        // Calcular fechas
        const { start, end } = getDatesForRange(range);
        const isoStart = start.toISOString();
        const isoEnd = end.toISOString();

        // 1. Cargar Órdenes (Filtradas por fecha y sucursal activa)
        const sucursalId = getCurrentSucursalId() || '';

        // Fetch orders
        const ordenesResponse = await getOrdenes({
          sucursal: sucursalId,
          fechaDesde: isoStart,
          fechaHasta: isoEnd,
          limit: 1000 // Fetch enough to calculate stats
        });
        const ordenes = ordenesResponse.ordenes || [];

        // 2. Cargar Ventas (Filtradas por fecha)
        let ventas = [];
        try {
          const ventasResponse = await getVentas({
            idSucursal: sucursalId,
            fechaDesde: start.toISOString().split('T')[0],
            fechaHasta: end.toISOString().split('T')[0] + 'T23:59:59',
            limit: 500
          });
          ventas = ventasResponse.ventas || [];
        } catch (e) { console.warn("Error loading ventas", e); }

        // 3. Cargar Compras (Egresos) - Filtradas por fecha
        let compras = [];
        try {
          const comprasResponse = await fetchWithAuth(`/api/compras?limit=500`);
          if (comprasResponse.ok) {
            const allCompras = await comprasResponse.json();
            compras = allCompras.filter(c => {
              const d = new Date(c.fecha_emision);
              // Corregido: usar id_sucursal en lugar de sucursal_id
              return d >= start && d <= end && (!sucursalId || c.id_sucursal == sucursalId);
            });
            console.log(`📊 Egresos: ${compras.length} compras encontradas en el período`);
          }
        } catch (e) { console.warn("Error loading compras", e); }


        // --- CALCULAR METRICAS ---

        // A. Ingresos = Órdenes + Ventas
        // Órdenes: Sum of total_neto of valid orders in period.
        // Ventas: Sum of total_neto of sales in period.
        const validOrders = ordenes.filter(o => o.estado_codigo !== 'CANCELADA' && o.estado_codigo !== 'PRESUPUESTO');
        const ingresosOrdenes = validOrders.reduce((sum, o) => sum + parseFloat(o.total_neto || 0), 0);

        // Ventas: filtrar solo las activas (no anuladas)
        const validVentas = ventas.filter(v => v.estado !== 'ANULADA');
        const ingresosVentas = validVentas.reduce((sum, v) => sum + parseFloat(v.total_neto || 0), 0);

        // Total Ingresos = Órdenes + Ventas
        const ingresos = ingresosOrdenes + ingresosVentas;

        // B. Egresos
        const egresos = compras.reduce((sum, c) => sum + parseFloat(c.total || 0), 0);

        // C. Beneficio
        const beneficio = ingresos - egresos;

        // D. Margen
        const margen = ingresos > 0 ? ((beneficio / ingresos) * 100) : 0;

        // E. Cliente Top
        const clientesMap = {};
        validOrders.forEach(o => {
          if (!o.cliente_nombre) return;
          if (!clientesMap[o.cliente_nombre]) clientesMap[o.cliente_nombre] = { count: 0, total: 0 };
          clientesMap[o.cliente_nombre].count++;
          clientesMap[o.cliente_nombre].total += parseFloat(o.total_neto || 0);
        });
        let topClienteStr = "-";
        let topClienteSub = "Sin datos";

        let bestClient = null;
        let maxFichas = 0;

        Object.entries(clientesMap).forEach(([name, data]) => {
          if (data.count > maxFichas) {
            maxFichas = data.count;
            bestClient = { name, ...data };
          }
        });

        if (bestClient) {
          topClienteStr = bestClient.name;
          topClienteSub = `${bestClient.count} órdenes · €${bestClient.total.toFixed(0)}`;
        }

        // F. Ticket Medio (de validOrders + validVentas)
        const totalTransacciones = validOrders.length + validVentas.length;
        const ticketMedio = totalTransacciones > 0 ? (ingresos / totalTransacciones) : 0;

        // G. Listas x Entregar (global status, not date dependent usually, but let's keep it global or filter?)
        // Usually "Listas por entregar" is CURRENT state, regardless of date filter.
        // But for consistency let's fetch ALL ACTIVE orders for "Por Entregar" count? 
        // Or just use the fetched ones? If I filter by "This Month", I might miss an order from last month that is still "Completada".
        // Better to separate "Stock/Active" metrics (Current State) from "Financial" metrics (Time ranged).
        // I will keep logic for active distinct if possible, or accept approximation.
        // For accurate "Active" counts, we really need a separate fetch without date limit, or just trust the API returns active ones if we don't filter?
        // Let's rely on the fact that `cargarEstadisticas` previously fetched EVERYTHING.
        // To avoid double fetching, I'll assume `getOrdenes` without date filters for "Active" counts if range is small, 
        // OR just make a lightweight call for specific counts.
        // User wants "Dashboard Metrics".
        // I will do a separate lightweight fetch for "Status Counts" if possible, or just reuse the main list if range is "Year" or "Month" (likely covers most active).
        // Let's do a separate call for "Active stuff" to be accurate.
        let activasCount = '-';
        let listasCount = '-';

        // Background fetch for current status (independent of time filter)
        getOrdenes({ sucursal: sucursalId, limit: 1 }).then(res => {
          // This endpoint returns metatada? The mock/service returns { ordenes, total }.
          // The service `getOrdenes` filters by params. 
          // To get "Active" count efficiently without downloading all DB, we need a specific endpoint or just fetch open ones.
          // I'll fetch "Estado != Entregar"
        });

        // For now, I will calculate "Active" from the fetched list IF the range is broad, 
        // otherwise I might show "-" or fetch separately.
        // Actually, previous code fetched ALL orders (no limit, or default limit). Service default limit?
        // Ordenes service default: seems to pass params directly. DB likely defaults to some limit or all.
        // I'll stick to calculating from the fetched batch for now to avoid complexity, 
        // but for "Orders Active" filtering by date is wrong (an active order could be from last year).
        // I will Fetch "Active" separately.

        const activeOrdersResponse = await getOrdenes({ sucursal: sucursalId, estado: 'EN_PROGRESO' }); // Example
        // Better: Fetch all non-final statuses?
        // Let's just fetch recent 1000 orders and filter status, likely covers it.
        // For "Listas x Entregar" (Completada):
        const listasResponse = await getOrdenes({ sucursal: sucursalId, estado: 'COMPLETADA' });
        listasCount = listasResponse.ordenes ? listasResponse.ordenes.length : 0;


        // Update UI
        safeText('stat-ingresos', formatCurrency(ingresos));
        safeText('stat-egresos', formatCurrency(egresos));
        safeText('stat-beneficio', formatCurrency(beneficio));

        const margenEl = document.getElementById('stat-margen');
        if (margenEl) {
          margenEl.textContent = margen.toFixed(1) + '%';
          margenEl.className = `text-3xl font-bold tracking-tight transition-colors ${margen >= 0 ? 'text-blue-400' : 'text-red-400'}`;
        }

        safeText('stat-cliente-top', topClienteStr);
        safeText('stat-cliente-top-sub', topClienteSub);

        safeText('stat-ticket-medio', formatCurrency(ticketMedio));
        safeText('stat-listas-entregar', listasCount);


        // Stock Bajo (Existing logic)
        updateStockBajo();

        // Render Ultimas Ordenes (From the fetched batch)
        renderUltimasOrdenes(ordenes.slice(0, 5));

        // Graficos (Rendimiento Semanal - keep it for 'Week' view or always?)
        // User asked for specific metrics. I will keep "Rendimiento Semanal" at bottom but maybe update it?
        // The existing chart is "Pagos Reales".
        cargarRendimientoSemanal();

        // Cargar Income Ledger (Marketplace vs CRM)
        cargarIncomeLedger(range);

        // ✅ Ocultar el loader cuando todo esté cargado
        hidePageLoader();

      } catch (error) {
        console.error('Error cargando dashboard:', error);
        // También ocultar el loader en caso de error para que la página sea usable
        hidePageLoader();
      }
    }

    function safeText(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    function formatCurrency(val) {
      return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(val);
    }

    function updateUserHeader(user) {
      const userNameEl = document.querySelector('.sidebar-text .text-white.truncate');
      const userRoleEl = document.querySelector('.sidebar-text .text-gray-500.truncate');
      const userInitialsEl = document.querySelector('.w-8.h-8.rounded-full');
      if (userNameEl && user.nombre) userNameEl.textContent = user.nombre;
      if (userRoleEl && user.rol) userRoleEl.textContent = user.rol;
      if (userInitialsEl && user.nombre) userInitialsEl.textContent = user.nombre.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    }

    async function updateStockBajo() {
      try {
        const invResponse = await fetchWithAuth('/api/inventory/resumen');
        if (invResponse.ok) {
          const productos = await invResponse.json();
          const stockBajo = productos.filter(p =>
            p.stock_minimo && Number(p.stock_total || 0) <= Number(p.stock_minimo)
          ).length;
          safeText('stat-stock-bajo', stockBajo);
        }
      } catch (e) { console.warn('No se pudo cargar stock bajo'); }
    }

    // Cargar datos del Income Ledger (Marketplace vs CRM)
    async function cargarIncomeLedger(range = 'month') {
      try {
        // Mapear range a period del API
        const periodMap = {
          'today': 'today',
          'week': 'week',
          'month': 'month',
          'quarter': 'month', // API no tiene quarter, usar month
          'year': 'year'
        };
        const period = periodMap[range] || 'month';

        // Obtener ID de la sucursal seleccionada
        const sucursalSelect = document.getElementById('sucursal-select');
        const sucursalId = sucursalSelect ? sucursalSelect.value : '';

        // Llamar al API de income-events
        const url = `/api/income-events/summary?period=${period}${sucursalId ? `&idSucursal=${sucursalId}` : ''}`;
        const response = await fetchWithAuth(url);

        if (!response.ok) {
          // Si el usuario no tiene acceso (plan sin marketplace), ocultar la sección
          if (response.status === 403) {
            const section = document.getElementById('income-ledger-section');
            if (section) section.style.display = 'none';
            return;
          }
          throw new Error('Error fetching income ledger');
        }

        const data = await response.json();
        const totals = data.totals || {};
        const porOrigen = totals.por_origen || {};

        // Calcular valores
        const ingresoMarketplace = porOrigen.marketplace || 0;
        const ingresoCRM = porOrigen.crm || 0;
        const totalLedger = totals.total_general || 0;

        // Calcular eventos por tipo (de breakdown si existe)
        const breakdown = data.breakdown || [];
        const marketplaceBreakdown = breakdown.find(b => b.origen === 'marketplace');
        const crmBreakdown = breakdown.find(b => b.origen === 'crm');

        const eventosMarketplace = marketplaceBreakdown ? parseInt(marketplaceBreakdown.num_eventos) : 0;
        const eventosCRM = crmBreakdown ? parseInt(crmBreakdown.num_eventos) : 0;

        // Calcular porcentajes
        const pctMarketplace = totalLedger > 0 ? ((ingresoMarketplace / totalLedger) * 100).toFixed(0) : 0;
        const pctCRM = totalLedger > 0 ? ((ingresoCRM / totalLedger) * 100).toFixed(0) : 0;

        // Actualizar el DOM
        safeText('stat-ingresos-marketplace', formatCurrency(ingresoMarketplace));
        safeText('stat-ingresos-crm', formatCurrency(ingresoCRM));
        safeText('stat-ingresos-ledger-total', formatCurrency(totalLedger));
        safeText('pct-marketplace', `${pctMarketplace}%`);
        safeText('pct-crm', `${pctCRM}%`);

        // Actualizar textos de eventos
        const marketplaceEventosEl = document.getElementById('stat-marketplace-eventos');
        if (marketplaceEventosEl) {
          marketplaceEventosEl.innerHTML = `<span class="text-cyan-400">${eventosMarketplace}</span> reservas pagadas`;
        }

        const crmEventosEl = document.getElementById('stat-crm-eventos');
        if (crmEventosEl) {
          crmEventosEl.innerHTML = `<span class="text-amber-400">${eventosCRM}</span> ventas/órdenes procesadas`;
        }

        // Mostrar la sección si estaba oculta
        const section = document.getElementById('income-ledger-section');
        if (section) section.style.display = '';

        console.log('📊 Income Ledger cargado:', { marketplace: ingresoMarketplace, crm: ingresoCRM, total: totalLedger });

      } catch (error) {
        console.warn('Error cargando income ledger:', error.message);
        // No ocultar la sección, solo mostrar valores por defecto
      }
    }

    // Initialize
    cargarDashboard('month'); // Load default
    cargarNotificaciones(); // Load notifications


    // Cargar estados personalizados desde localStorage
    let estadosPersonalizados = {};
    function cargarEstadosPersonalizados() {
      try {
        const stored = localStorage.getItem('config_estados_orden');
        if (stored) {
          const estados = JSON.parse(stored);
          estadosPersonalizados = {};
          estados.forEach(e => {
            estadosPersonalizados[e.codigo] = {
              nombre: e.nombre,
              color: e.color
            };
          });
        }
      } catch (error) {
        console.error('Error cargando estados personalizados:', error);
      }
    }

    // Obtener color del estado (usa personalizados si existen)
    function getEstadoColor(codigo) {
      if (estadosPersonalizados[codigo] && estadosPersonalizados[codigo].color) {
        return estadosPersonalizados[codigo].color;
      }
      // Colores por defecto
      if (codigo === 'EN_PROGRESO') return '#60a5fa';
      if (codigo === 'RECAMBIO') return '#f97316';
      if (codigo === 'COMPLETADA') return '#22c55e';
      if (codigo === 'ENTREGADA') return '#a855f7';
      return '#eab308'; // Amarillo para ABIERTA y otros
    }

    // Obtener nombre del estado (usa personalizados si existen)
    function getEstadoNombre(codigo, nombreDefault) {
      if (estadosPersonalizados[codigo] && estadosPersonalizados[codigo].nombre) {
        return estadosPersonalizados[codigo].nombre;
      }
      return nombreDefault || codigo;
    }

    // Cargar estados personalizados al inicio
    cargarEstadosPersonalizados();

    function renderUltimasOrdenes(ordenes) {
      const tbody = document.getElementById('ultimas-ordenes-tbody');

      if (!ordenes || ordenes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-[#9da6b9]">No hay órdenes recientes</td></tr>';
        return;
      }

      tbody.innerHTML = ordenes.map(orden => {
        // Obtener color personalizado del estado
        const estadoColor = getEstadoColor(orden.estado_codigo);
        const estadoNombre = getEstadoNombre(orden.estado_codigo, orden.estado_nombre);

        // Aplicar estilos inline con el color personalizado
        const estadoStyle = `background-color: ${estadoColor}15; color: ${estadoColor}; border-color: ${estadoColor}40;`;

        return `
          <tr class="hover:bg-[#1a1d24] transition-colors">
            <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-white">#${orden.id}</td>
            <td class="whitespace-nowrap px-6 py-4 text-sm text-[#9da6b9]">${orden.cliente_nombre || '-'}</td>
            <td class="whitespace-nowrap px-6 py-4 text-sm text-[#9da6b9]">${orden.vehiculo_marca || ''} ${orden.vehiculo_modelo || ''}</td>
            <td class="whitespace-nowrap px-6 py-4 text-sm text-[#9da6b9]">
              <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset" style="${estadoStyle}">${estadoNombre}</span>
            </td>
            <td class="whitespace-nowrap px-6 py-4 text-right text-sm font-medium">
              <a class="text-[var(--brand-orange)] hover:text-[#e05300]" href="manager-taller-ordenes.html?id=${orden.id}">Ver</a>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Cargar y renderizar gráfico de rendimiento semanal (pagos reales cobrados)
    async function cargarRendimientoSemanal() {
      const chartContainer = document.getElementById('chart-semanal');
      const totalSemanalEl = document.getElementById('total-semanal');

      // Obtener sucursal seleccionada
      const sucursalSelect = document.getElementById('sucursal-select');
      const sucursalId = sucursalSelect ? sucursalSelect.value : '';
      const url = sucursalId
        ? `/api/ordenpago/estadisticas/semanal?sucursal=${sucursalId}`
        : '/api/ordenpago/estadisticas/semanal';

      try {
        const response = await fetchWithAuth(url);
        if (!response.ok) throw new Error('Error al cargar estadísticas');

        const data = await response.json();
        const pagosPorDia = data.pagosPorDia || [0, 0, 0, 0, 0, 0, 0];
        const totalSemanal = data.totalSemanal || 0;

        renderGraficoSemanal(pagosPorDia, totalSemanal);
      } catch (error) {
        console.warn('Error cargando rendimiento semanal:', error);
        // Mostrar mensaje de error en el gráfico
        chartContainer.innerHTML = `
          <div class="flex items-center justify-center w-full h-full text-[#9da6b9] text-sm">
            <i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i> No se pudo cargar
          </div>
        `;
        totalSemanalEl.textContent = '€0.00';
      }
    }

    // Renderizar gráfico con los datos
    function renderGraficoSemanal(pagosPorDia, totalSemanal) {
      const chartContainer = document.getElementById('chart-semanal');
      const totalSemanalEl = document.getElementById('total-semanal');

      const diasLabels = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
      const diasNombres = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];

      // Encontrar el máximo para escalar las barras
      const maxPago = Math.max(...pagosPorDia, 1);

      // Determinar el día actual (lunes=0, domingo=6)
      const hoy = new Date();
      const diaSemana = hoy.getDay();
      const diaActualIdx = diaSemana === 0 ? 6 : diaSemana - 1;

      // Renderizar barras
      chartContainer.innerHTML = pagosPorDia.map((pago, idx) => {
        const porcentaje = (pago / maxPago) * 100;
        const altura = Math.max(porcentaje, 5); // mínimo 5% para que se vea
        const esHoy = idx === diaActualIdx;

        const barClass = esHoy
          ? "bg-[var(--brand-orange)] shadow-[0_0_15px_rgba(255,95,0,0.3)]"
          : "bg-[#282e39] hover:bg-[var(--brand-orange)] transition-all duration-300";
        const textClass = esHoy ? "text-xs font-bold text-white" : "text-xs text-[#9da6b9]";

        return `
          <div class="flex h-full flex-col items-center gap-1 w-full group">
            <span class="text-[10px] text-green-400 opacity-0 group-hover:opacity-100 transition-opacity font-medium">
              €${pago.toFixed(0)}
            </span>
            <div class="flex-1 flex flex-col-reverse w-full">
              <div class="w-full max-w-[28px] mx-auto rounded-t ${barClass}" 
                   style="height: ${altura}%;" 
                   title="${diasNombres[idx]}: €${pago.toFixed(2)} cobrado">
              </div>
            </div>
            <span class="${textClass}">${diasLabels[idx]}</span>
          </div>
        `;
      }).join('');

      // Mostrar total semanal
      totalSemanalEl.textContent = `€${totalSemanal.toFixed(2)}`;
    }

    // Cargar y mostrar Ticket Medio Mensual
    async function cargarTicketMedio() {
      const ticketMedioEl = document.getElementById('stat-ticket-medio');
      const variacionEl = document.getElementById('ticket-medio-variacion');
      const subtextoEl = document.getElementById('ticket-medio-subtexto');

      if (!ticketMedioEl) return;

      try {
        // Obtener sucursal seleccionada
        const sucursalSelect = document.getElementById('sucursal-select');
        const sucursalId = sucursalSelect ? sucursalSelect.value : '';
        const url = sucursalId
          ? `/api/ordenpago/estadisticas/ticket-medio?sucursal=${sucursalId}`
          : '/api/ordenpago/estadisticas/ticket-medio';

        const response = await fetchWithAuth(url);
        if (!response.ok) throw new Error('Error al cargar ticket medio');

        const data = await response.json();

        if (data.success) {
          const { mesActual, variacion } = data;

          // Mostrar ticket medio
          if (mesActual.ordenesCerradas > 0) {
            ticketMedioEl.textContent = `€${mesActual.ticketMedio.toFixed(2)}`;
          } else {
            ticketMedioEl.textContent = '—';
          }

          // Mostrar variación con flecha
          if (variacion.porcentaje !== 0 && mesActual.ordenesCerradas > 0) {
            const isPositive = variacion.tendencia === 'up';
            const arrow = isPositive ? '↑' : '↓';
            const colorClass = isPositive ? 'text-green-400' : 'text-red-400';
            variacionEl.innerHTML = `
              <span class="${colorClass}">${arrow} ${Math.abs(variacion.porcentaje).toFixed(1)}%</span>
            `;
          } else {
            variacionEl.innerHTML = '';
          }

          // Actualizar subtexto
          subtextoEl.textContent = `${mesActual.ordenesCerradas} órdenes cerradas · ${mesActual.nombre}`;
        }
      } catch (error) {
        console.warn('Error cargando ticket medio:', error);
        ticketMedioEl.textContent = '—';
        variacionEl.innerHTML = '';
        subtextoEl.textContent = 'Error al cargar';
      }
    }

    // Abrir modal de histórico de ticket medio
    function abrirModalTicketMedio() {
      const modal = document.getElementById('ticket-medio-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      cargarHistoricoTicketMedio();
    }

    // Cerrar modal
    window.cerrarModalTicketMedio = function () {
      const modal = document.getElementById('ticket-medio-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // Cargar datos históricos
    async function cargarHistoricoTicketMedio() {
      const chartContainer = document.getElementById('historico-chart');
      const tablaBody = document.getElementById('historico-tabla-body');

      try {
        // Obtener sucursal seleccionada
        const sucursalSelect = document.getElementById('sucursal-select');
        const sucursalId = sucursalSelect ? sucursalSelect.value : '';
        const url = sucursalId
          ? `/api/ordenpago/estadisticas/ticket-medio/historico?sucursal=${sucursalId}&meses=12`
          : '/api/ordenpago/estadisticas/ticket-medio/historico?meses=12';

        const response = await fetchWithAuth(url);
        if (!response.ok) throw new Error('Error al cargar histórico');

        const data = await response.json();

        if (data.success && data.historico) {
          renderHistoricoChart(data.historico);
          renderHistoricoTabla(data.historico);
        } else {
          throw new Error('Sin datos');
        }
      } catch (error) {
        console.warn('Error cargando histórico ticket medio:', error);
        chartContainer.innerHTML = `
          <div class="flex items-center justify-center w-full h-full text-[#9da6b9] text-sm">
            <i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i> No hay datos disponibles
          </div>
        `;
        tablaBody.innerHTML = `
          <tr>
            <td colspan="4" class="px-6 py-4 text-center text-[#9da6b9]">No hay datos disponibles</td>
          </tr>
        `;
      }
    }

    // Renderizar gráfico de barras del histórico
    function renderHistoricoChart(historico) {
      const chartContainer = document.getElementById('historico-chart');

      if (!historico || historico.length === 0) {
        chartContainer.innerHTML = `
          <div class="flex items-center justify-center w-full h-full text-[#9da6b9] text-sm">
            No hay datos para mostrar
          </div>
        `;
        return;
      }

      // Encontrar el máximo para escalar (solo de meses con datos)
      const maxTicket = Math.max(...historico.map(h => h.ticketMedio), 1);

      chartContainer.innerHTML = historico.map((item, idx) => {
        const esUltimo = idx === historico.length - 1;
        const sinDatos = item.ordenesCerradas === 0;

        let altura, barClass, valorMostrar;

        if (sinDatos) {
          // Mes sin datos: barra mínima con patrón diferente
          altura = 3;
          barClass = "bg-[#1a1d24] border border-dashed border-[#3a4050]";
          valorMostrar = "—";
        } else {
          const porcentaje = (item.ticketMedio / maxTicket) * 100;
          altura = Math.max(porcentaje, 8);
          barClass = esUltimo
            ? "bg-purple-500 shadow-[0_0_15px_rgba(168,85,247,0.3)]"
            : "bg-[#282e39] hover:bg-purple-500 transition-all duration-300";
          valorMostrar = `€${item.ticketMedio.toFixed(0)}`;
        }

        const labelClass = sinDatos
          ? "text-[10px] text-[#555] whitespace-nowrap"
          : "text-[10px] text-[#9da6b9] whitespace-nowrap";

        return `
          <div class="flex h-full flex-col items-center gap-1 flex-1 group cursor-pointer" 
               title="${item.mes}: ${sinDatos ? 'Sin datos' : `€${item.ticketMedio.toFixed(2)} (${item.ordenesCerradas} órdenes)`}">
            <span class="text-[10px] ${sinDatos ? 'text-[#555]' : 'text-purple-400'} opacity-0 group-hover:opacity-100 transition-opacity font-medium whitespace-nowrap">
              ${valorMostrar}
            </span>
            <div class="flex-1 flex flex-col-reverse w-full">
              <div class="w-full max-w-[40px] mx-auto rounded-t ${barClass}" style="height: ${altura}%;"></div>
            </div>
            <span class="${labelClass}">${item.mes.split(' ')[0]}</span>
          </div>
        `;
      }).join('');
    }

    // Renderizar tabla del histórico
    function renderHistoricoTabla(historico) {
      const tablaBody = document.getElementById('historico-tabla-body');

      if (!historico || historico.length === 0) {
        tablaBody.innerHTML = `
          <tr>
            <td colspan="4" class="px-6 py-4 text-center text-[#9da6b9]">No hay datos disponibles</td>
          </tr>
        `;
        return;
      }

      // Mostrar de más reciente a más antiguo
      const historicoOrdenado = [...historico].reverse();

      tablaBody.innerHTML = historicoOrdenado.map((item, idx) => {
        const esActual = idx === 0;
        const sinDatos = item.ordenesCerradas === 0;

        let rowClass, textClass, ticketClass, badge;

        if (esActual) {
          rowClass = 'bg-purple-500/5';
          textClass = 'text-white';
          ticketClass = 'text-purple-400 font-bold';
          badge = '<span class="ml-2 text-xs bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded">Actual</span>';
        } else if (sinDatos) {
          rowClass = 'bg-[#0a0b0d]';
          textClass = 'text-[#555]';
          ticketClass = 'text-[#555]';
          badge = '<span class="ml-2 text-xs bg-[#1a1d24] text-[#555] px-2 py-0.5 rounded">Sin actividad</span>';
        } else {
          rowClass = 'hover:bg-[#1a1d24]';
          textClass = 'text-[#9da6b9]';
          ticketClass = 'text-white';
          badge = '';
        }

        return `
          <tr class="${rowClass} transition-colors">
            <td class="px-6 py-4 text-sm ${sinDatos && !esActual ? 'text-[#555]' : 'text-white'} font-medium">
              ${item.mes}
              ${badge}
            </td>
            <td class="px-6 py-4 text-sm text-right ${textClass}">${item.ordenesCerradas}</td>
            <td class="px-6 py-4 text-sm text-right ${textClass}">${sinDatos ? '—' : `€${item.facturacionTotal.toFixed(2)}`}</td>
            <td class="px-6 py-4 text-sm text-right ${ticketClass}">${sinDatos ? '—' : `€${item.ticketMedio.toFixed(2)}`}</td>
          </tr>
        `;
      }).join('');
    }

    // Agregar evento click a la card de ticket medio
    document.addEventListener('DOMContentLoaded', () => {
      const ticketCard = document.getElementById('ticket-medio-card');
      if (ticketCard) {
        ticketCard.addEventListener('click', abrirModalTicketMedio);
      }

      // Cerrar modal al hacer clic fuera
      const modal = document.getElementById('ticket-medio-modal');
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            cerrarModalTicketMedio();
          }
        });
      }
    });

    // Inicializar selector de sucursal estándar
    (async () => {
      const sucursalId = await initSucursalSelector('sucursal-selector-container', {
        onchange: async () => {
          // Recargar dashboard cuando cambia la sucursal
          const range = document.getElementById('time-range-select')?.value || 'month';
          await cargarDashboard(range);
        }
      });

      // Cargar dashboard inicial
      const range = document.getElementById('time-range-select')?.value || 'month';
      await cargarDashboard(range);
    })();

  </script>

  <!-- Sidebar Manager - Genera el sidebar dinámicamente -->
  <script type="module" src="./sidebar-manager.js"></script>
</body>

</html>