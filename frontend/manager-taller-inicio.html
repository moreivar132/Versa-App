<!DOCTYPE html>
<html lang="es" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inicio - Goversa Taller Manager</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="/guard.js"></script>

  <style>
    :root {
      --brand-orange: #ff5f00;
      --surface-border: #282e39;
    }

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      vertical-align: middle;
    }

    /* Scrollbar personalizada para coincidir con el diseño */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #111318;
    }

    ::-webkit-scrollbar-thumb {
      background: #282e39;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #ff5f00;
    }

    /* Fix para opciones del select de sucursales */
    #sucursal-select option {
      background-color: #111318;
      color: white;
      padding: 8px;
    }

    /* Tooltip styles */
    .tooltip-container {
      position: relative;
      display: inline-flex;
      align-items: center;
    }

    .tooltip-trigger {
      color: #6b7280;
      cursor: help;
      transition: color 0.15s;
    }

    .tooltip-trigger:hover {
      color: #9da6b9;
    }

    .tooltip-content {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: #1e2028;
      border: 1px solid #2d3240;
      border-radius: 8px;
      padding: 10px 12px;
      width: max-content;
      max-width: 280px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      transition: opacity 0.15s, visibility 0.15s;
    }

    .tooltip-content::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: #2d3240;
    }

    .tooltip-container:hover .tooltip-content {
      visibility: visible;
      opacity: 1;
    }

    .tooltip-text {
      font-size: 12px;
      font-weight: 400;
      color: #d1d5db;
      line-height: 1.5;
    }
  </style>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            brand: {
              orange: "#ff5f00",
              dark: "#0b0d11",
              surface: "#111318",
              border: "#282e39",
              input: "#1a1d24",
              text: "#ffffff",
              muted: "#9da6b9"
            }
          },
          fontFamily: {
            main: ["Montserrat", "sans-serif"]
          },
        },
      },
    }
  </script>
</head>

<body class="bg-[#0b0d11] font-[Montserrat] text-white">
  <div class="flex h-screen w-full">

    <aside id="sidebar"
      class="flex h-full w-64 flex-col bg-[#111318] p-4 shrink-0 transition-all duration-300 ease-in-out border-r border-[var(--surface-border)]">
      <div class="flex h-full flex-col justify-between">
        <div class="flex flex-col gap-4">
          <div class="flex items-center gap-3 p-2 mb-4">
            <div class="logo-badge"
              style="padding: 8px; border-radius: 12px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
              <img src="https://i.imgur.com/Mjw4or5.png" alt="Logo" class="logo-img" style="height: 24px; width: auto;">
            </div>
            <div class="flex flex-col sidebar-text">
              <h1 class="text-white text-base font-medium leading-normal" style="font-size: 15px;">Goversa</h1>
              <p class="text-[#9da6b9] text-sm font-normal leading-normal" style="font-size: 12px;">Gestión</p>
            </div>
            <button id="toggle-sidebar" class="ml-auto text-gray-400 hover:text-white">
              <i class="fas fa-chevron-left"></i>
            </button>
          </div>

          <nav class="flex flex-col gap-2">
            <a class="flex items-center gap-3 px-3 py-2 bg-[#282e39] text-white rounded-lg transition-colors border-l-2 border-[var(--brand-orange)]"
              href="#">
              <span class="icon-container"><i class="fas fa-home text-[var(--brand-orange)]"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Inicio</p>
            </a>

            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('taller-submenu')">
                <span class="icon-container"><i class="fas fa-wrench"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Taller</p>
                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="taller-arrow"></i>
              </a>
              <div id="taller-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-citas.html" class="text-gray-500 hover:text-white text-sm py-1 block">Citas</a>
                <a href="manager-taller-ordenes-lista.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Órdenes</a>
                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Presupuestos</a>
                <a href="manager-taller-vehiculos.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Vehículos</a>
              </div>
            </div>

            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('tienda-submenu')">
                <span class="icon-container"><i class="fas fa-shopping-cart"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Tienda</p>
                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="tienda-arrow"></i>
              </a>
              <div id="tienda-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-compras.html" class="text-gray-500 hover:text-white text-sm py-1 block">Nueva
                  Compra</a>
                <a href="manager-taller-compras-historial.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Historial Compras</a>
              </div>
            </div>

            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-caja.html">
              <span class="icon-container"><i class="fas fa-cash-register"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Caja</p>
            </a>

            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-inventario.html">
              <span class="icon-container"><i class="fas fa-boxes"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Inventario</p>
            </a>

            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
              href="manager-taller-trabajadores.html">
              <span class="icon-container"><i class="fas fa-users-cog"></i></span>
              <p class="text-sm font-medium leading-normal sidebar-text">Trabajadores</p>
            </a>

            <div class="nav-group">
              <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                onclick="toggleSubmenu('contactos-submenu')">
                <span class="icon-container"><i class="fas fa-address-book"></i></span>
                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Contactos</p>
                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="contactos-arrow"></i>
              </a>
              <div id="contactos-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                <a href="manager-taller-clientes.html"
                  class="text-gray-500 hover:text-white text-sm py-1 block">Clientes</a>
                <a href="manager-taller-proveedores.html"
                  class="text-gray-400 hover:text-white text-sm py-1 block">Proveedores</a>
              </div>
            </div>
          </nav>
        </div>

        <div class="flex flex-col gap-1 border-t border-[var(--brand-orange)] pt-4">
          <div class="flex items-center gap-3 px-3 py-2 mb-2">
            <div
              class="w-8 h-8 rounded-full bg-[var(--brand-orange)] flex items-center justify-center text-white font-bold text-xs">
              IM</div>
            <div class="flex flex-col sidebar-text overflow-hidden">
              <span class="text-white text-sm font-medium truncate">Iván Moreno</span>
              <span class="text-gray-500 text-xs truncate">admin</span>
            </div>
          </div>
          <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
            href="#" data-logout>
            <span class="icon-container"><i class="fas fa-sign-out-alt"></i></span>
            <p class="text-sm font-medium leading-normal sidebar-text">Salir</p>
          </a>
        </div>
      </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-[#0b0d11]">
      <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">

        <header class="md:hidden flex items-center justify-between mb-6 pb-4 border-b border-[#282e39]">
          <div class="logo-badge">
            <img src="https://i.imgur.com/Mjw4or5.png" alt="Logo" class="h-6 w-auto">
          </div>
          <button id="mobile-menu-btn" class="text-white"><i class="fas fa-bars"></i></button>
        </header>

        <header class="mb-8 flex flex-wrap items-center justify-between gap-4">
          <div class="flex-1">
            <div class="flex flex-col gap-1">
              <h1 class="text-2xl font-bold tracking-tight text-white">Resumen General</h1>
              <p class="text-[#9da6b9] text-sm font-normal">Bienvenido, Manager. Aquí tienes un resumen de la actividad
                de hoy.</p>
            </div>
          </div>
          <div class="flex w-full items-center gap-4 sm:w-auto">
            <label class="flex-1 sm:flex-none sm:w-64">
              <div class="relative flex w-full items-stretch">
                <span
                  class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#9da6b9]">search</span>
                <input
                  class="h-10 w-full min-w-0 flex-1 rounded-lg border border-[#282e39] bg-[#1a1d24] pl-10 text-white placeholder:text-[#9da6b9] focus:border-[var(--brand-orange)] focus:ring-1 focus:ring-[var(--brand-orange)] text-sm"
                  placeholder="Buscar órdenes, clientes..." />
              </div>
            </label>
            <div class="flex items-center gap-2">
              <button
                class="relative rounded-lg p-2 text-[#9da6b9] hover:bg-[#282e39] hover:text-white transition-colors">
                <span class="material-symbols-outlined">notifications</span>
                <span class="absolute right-1.5 top-1.5 flex h-2.5 w-2.5 items-center justify-center">
                  <span
                    class="absolute inline-flex h-full w-full animate-ping rounded-full bg-[var(--brand-orange)] opacity-75"></span>
                  <span class="relative inline-flex h-2 w-2 rounded-full bg-[var(--brand-orange)]"></span>
                </span>
              </button>
            </div>
            <a href="manager-taller-ordenes.html"
              class="flex h-10 cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg bg-[var(--brand-orange)] px-4 text-sm font-bold text-white shadow-lg shadow-orange-900/20 hover:bg-[#e05300] transition-colors">
              <span class="material-symbols-outlined" style="font-size: 20px;">add_circle</span>
              <span class="truncate">Nueva Orden</span>
            </a>
          </div>
        </header>

        <!-- Sucursal Selector - Centrado -->
        <div class="flex justify-center mb-6">
          <div id="sucursal-container"
            class="flex items-center gap-2 bg-[#111318] px-4 py-2 rounded-xl border border-[#282e39]">
            <span class="material-symbols-outlined text-[var(--brand-orange)]">store</span>
            <span class="text-white font-medium text-sm">Cargando...</span>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-5">
          <div
            class="flex flex-col gap-2 rounded-xl border border-[#282e39] bg-[#111318] p-6 hover:border-[var(--brand-orange)] transition-colors group cursor-pointer"
            onclick="window.location='manager-taller-ordenes-lista.html'">
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-[#9da6b9] uppercase">Órdenes Activas</p>
              <span class="material-symbols-outlined text-amber-500 bg-amber-500/10 p-2 rounded-lg">build_circle</span>
            </div>
            <p id="stat-ordenes-activas"
              class="text-3xl font-bold tracking-tight text-white group-hover:text-[var(--brand-orange)] transition-colors">
              -</p>
          </div>
          <div
            class="flex flex-col gap-2 rounded-xl border border-[#282e39] bg-[#111318] p-6 hover:border-[var(--brand-orange)] transition-colors group">
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-[#9da6b9] uppercase">Ingresos del Día</p>
              <span class="material-symbols-outlined text-green-500 bg-green-500/10 p-2 rounded-lg">payments</span>
            </div>
            <p id="stat-ingresos-dia"
              class="text-3xl font-bold tracking-tight text-white group-hover:text-green-400 transition-colors">-</p>
          </div>

          <!-- Ticket Medio Mensual -->
          <div
            class="flex flex-col gap-2 rounded-xl border border-[#282e39] bg-[#111318] p-6 hover:border-purple-500 transition-colors group cursor-pointer"
            id="ticket-medio-card">
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-[#9da6b9] uppercase flex items-center gap-1">
                Ticket Medio (Mes)
                <span class="tooltip-container">
                  <span class="material-symbols-outlined text-[12px] tooltip-trigger cursor-help">info</span>
                  <span class="tooltip-content" style="width: 260px;">
                    <span class="tooltip-text">
                      Importe medio por orden cerrada y entregada en el mes actual.<br><br>
                      <span style="color: #9da6b9;">Se calcula según la fecha de cierre de la orden, aunque se haya
                        abierto en otro mes.</span><br><br>
                      <span style="color: #9da6b9;">No depende de si la orden está pagada o pendiente.</span>
                    </span>
                  </span>
                </span>
              </p>
              <span
                class="material-symbols-outlined text-purple-500 bg-purple-500/10 p-2 rounded-lg">receipt_long</span>
            </div>
            <div class="flex items-baseline gap-2">
              <p id="stat-ticket-medio"
                class="text-3xl font-bold tracking-tight text-white group-hover:text-purple-400 transition-colors">-</p>
              <span id="ticket-medio-variacion" class="text-sm font-medium flex items-center gap-0.5">
                <!-- Se llena dinámicamente -->
              </span>
            </div>
            <p id="ticket-medio-subtexto" class="text-xs text-[#6b7280]">Órdenes cerradas · Mes actual</p>
          </div>

          <div
            class="flex flex-col gap-2 rounded-xl border border-[#282e39] bg-[#111318] p-6 hover:border-[var(--brand-orange)] transition-colors group cursor-pointer"
            onclick="window.location='manager-taller-ordenes-lista.html?estado=COMPLETADA'">
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-[#9da6b9] uppercase">Listas x Entregar</p>
              <span class="material-symbols-outlined text-blue-500 bg-blue-500/10 p-2 rounded-lg">local_shipping</span>
            </div>
            <p id="stat-listas-entregar"
              class="text-3xl font-bold tracking-tight text-white group-hover:text-blue-400 transition-colors">-</p>
          </div>
          <div
            class="flex flex-col gap-2 rounded-xl border border-[#282e39] bg-[#111318] p-6 hover:border-[var(--brand-orange)] transition-colors group cursor-pointer"
            onclick="window.location='manager-taller-inventario.html?stock_bajo=1'">
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-[#9da6b9] uppercase">Stock Bajo</p>
              <span class="material-symbols-outlined text-red-500 bg-red-500/10 p-2 rounded-lg">warning</span>
            </div>
            <p id="stat-stock-bajo"
              class="text-3xl font-bold tracking-tight text-white group-hover:text-red-400 transition-colors">-</p>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-3">

          <div class="overflow-hidden rounded-xl border border-[#282e39] bg-[#111318] lg:col-span-2 shadow-sm">
            <div class="border-b border-[#282e39] p-5 flex justify-between items-center">
              <h3 class="text-base font-bold text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-[var(--brand-orange)]">assignment</span>
                Últimas Órdenes
              </h3>
              <a href="manager-taller-ordenes-lista.html"
                class="text-xs text-[#9da6b9] hover:text-white transition-colors">Ver todas</a>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-[#282e39]">
                <thead class="bg-[#1c1f27]">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider text-[#9da6b9]"
                      scope="col">#</th>
                    <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider text-[#9da6b9]"
                      scope="col">Cliente</th>
                    <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider text-[#9da6b9]"
                      scope="col">Vehículo</th>
                    <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider text-[#9da6b9]"
                      scope="col">Estado</th>
                    <th class="relative px-6 py-3" scope="col"><span class="sr-only">Acción</span></th>
                  </tr>
                </thead>
                <tbody id="ultimas-ordenes-tbody" class="divide-y divide-[#282e39] bg-[#111318]">
                  <tr>
                    <td colspan="5" class="px-6 py-4 text-center text-[#9da6b9]">Cargando...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>


          <div class="rounded-xl border border-[#282e39] bg-[#111318] p-6 shadow-sm flex flex-col justify-between">
            <h3 class="mb-6 text-base font-bold text-white flex items-center gap-2">
              <span class="material-symbols-outlined text-[var(--brand-orange)]">bar_chart</span>
              <span class="flex items-center gap-1">
                Rendimiento Semanal
                <span class="tooltip-container">
                  <span class="material-symbols-outlined text-[14px] tooltip-trigger cursor-help">info</span>
                  <span class="tooltip-content">
                    <span class="tooltip-text">
                      Muestra los <strong style="color: #22c55e;">pagos realmente cobrados</strong> cada día de la
                      semana actual.<br><br>
                      <span style="color: #9da6b9;">No incluye facturación pendiente de cobro, solo dinero efectivamente
                        recibido.</span>
                    </span>
                  </span>
                </span>
              </span>
            </h3>
            <div class="flex h-64 items-end justify-between gap-2" id="chart-semanal">
              <!-- Las barras se generan dinámicamente desde JS -->
              <div class="flex items-center justify-center w-full h-full text-[#9da6b9] text-sm">
                <i class="fas fa-spinner fa-spin mr-2"></i> Cargando...
              </div>
            </div>
            <div class="mt-4 pt-4 border-t border-[#282e39] flex justify-between items-center">
              <span class="text-xs text-[#9da6b9] uppercase">Total Semanal</span>
              <span id="total-semanal" class="text-lg font-bold text-green-400">€0.00</span>
            </div>
          </div>

        </div>
      </div>
    </main>
  </div>

  <!-- Modal Histórico Ticket Medio -->
  <div id="ticket-medio-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4"
    style="background: rgba(0,0,0,0.8);">
    <div
      class="bg-[#111318] rounded-2xl border border-[#282e39] w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
      <!-- Header del Modal -->
      <div class="flex items-center justify-between p-6 border-b border-[#282e39]">
        <div class="flex items-center gap-3">
          <span class="material-symbols-outlined text-purple-500 bg-purple-500/10 p-2 rounded-lg">receipt_long</span>
          <div>
            <h2 class="text-xl font-bold text-white">Ticket Medio Mensual</h2>
            <p class="text-sm text-[#9da6b9]">Histórico de los últimos 12 meses</p>
          </div>
        </div>
        <button onclick="cerrarModalTicketMedio()"
          class="text-[#9da6b9] hover:text-white transition-colors p-2 hover:bg-[#282e39] rounded-lg">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <!-- Contenido del Modal -->
      <div class="flex-1 overflow-y-auto p-6">
        <!-- Gráfico de Barras -->
        <div class="bg-[#0b0d11] rounded-xl p-6 border border-[#282e39] mb-6">
          <h3 class="text-base font-bold text-white mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-purple-400">bar_chart</span>
            Evolución del Ticket Medio
          </h3>
          <div id="historico-chart" class="h-64 flex items-end justify-between gap-2">
            <!-- Barras se generan dinámicamente -->
            <div class="flex items-center justify-center w-full h-full text-[#9da6b9] text-sm">
              <i class="fas fa-spinner fa-spin mr-2"></i> Cargando...
            </div>
          </div>
        </div>

        <!-- Tabla de Datos -->
        <div class="bg-[#0b0d11] rounded-xl border border-[#282e39] overflow-hidden">
          <h3 class="text-base font-bold text-white p-4 border-b border-[#282e39] flex items-center gap-2">
            <span class="material-symbols-outlined text-purple-400">table_chart</span>
            Detalle por Mes
          </h3>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-[#1a1d24]">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider text-[#9da6b9]">Mes</th>
                  <th class="px-6 py-3 text-right text-xs font-bold uppercase tracking-wider text-[#9da6b9]">Órdenes
                    Cerradas</th>
                  <th class="px-6 py-3 text-right text-xs font-bold uppercase tracking-wider text-[#9da6b9]">Facturación
                    Total</th>
                  <th class="px-6 py-3 text-right text-xs font-bold uppercase tracking-wider text-[#9da6b9]">Ticket
                    Medio</th>
                </tr>
              </thead>
              <tbody id="historico-tabla-body" class="divide-y divide-[#282e39]">
                <tr>
                  <td colspan="4" class="px-6 py-4 text-center text-[#9da6b9]">Cargando...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.toggleSubmenu = function (id) {
      const submenu = document.getElementById(id);
      const arrow = document.getElementById(id.replace('submenu', 'arrow'));
      if (submenu.classList.contains('hidden')) {
        submenu.classList.remove('hidden');
        submenu.classList.add('flex');
        if (arrow) arrow.style.transform = 'rotate(180deg)';
      } else {
        submenu.classList.add('hidden');
        submenu.classList.remove('flex');
        if (arrow) arrow.style.transform = 'rotate(0deg)';
      }
    }

    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggle-sidebar');
    const sidebarTexts = document.querySelectorAll('.sidebar-text');
    let isCollapsed = false;

    toggleBtn.addEventListener('click', () => {
      isCollapsed = !isCollapsed;
      if (isCollapsed) {
        sidebar.classList.remove('w-64');
        sidebar.classList.add('w-20');
        sidebarTexts.forEach(el => el.classList.add('hidden'));
        toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        document.querySelectorAll('[id$="-submenu"]').forEach(el => {
          el.classList.add('hidden');
          el.classList.remove('flex');
        });
      } else {
        sidebar.classList.add('w-64');
        sidebar.classList.remove('w-20');
        sidebarTexts.forEach(el => el.classList.remove('hidden'));
        toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
      }
    });

    // Mobile Menu Logic
    document.getElementById('mobile-menu-btn').addEventListener('click', () => {
      sidebar.classList.toggle('-translate-x-full');
      sidebar.classList.toggle('absolute');
      sidebar.classList.toggle('z-50');
      sidebar.classList.toggle('h-full');
    });
  </script>

  <script type="module">
    import { getOrdenes } from './services/ordenes-service.js';
    import { requireAuth, clearSession, redirectToLogin, fetchWithAuth, getCurrentUser } from './auth.js';

    // Logout logic
    document.querySelector('[data-logout]')?.addEventListener('click', (e) => {
      e.preventDefault();
      clearSession();
      redirectToLogin();
    });

    // Cargar estadísticas del dashboard
    async function cargarEstadisticas() {
      try {
        const user = await requireAuth();
        if (!user) return;

        // Actualizar nombre del usuario en el sidebar
        const userNameEl = document.querySelector('.sidebar-text .text-white.truncate');
        const userRoleEl = document.querySelector('.sidebar-text .text-gray-500.truncate');
        const userInitialsEl = document.querySelector('.w-8.h-8.rounded-full');

        if (userNameEl && user.nombre) {
          userNameEl.textContent = user.nombre;
        }
        if (userRoleEl && user.rol) {
          userRoleEl.textContent = user.rol;
        }
        if (userInitialsEl && user.nombre) {
          const initials = user.nombre.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
          userInitialsEl.textContent = initials;
        }

        // Cargar órdenes para obtener conteos (filtrar por sucursal si está seleccionada)
        const sucursalSelect = document.getElementById('sucursal-select');
        const sucursalId = sucursalSelect ? sucursalSelect.value : '';
        const response = await getOrdenes(sucursalId ? { sucursal: sucursalId } : {});
        const ordenes = response.ordenes || [];

        // Calcular estadísticas - misma lógica que en lista de órdenes
        // Activa = NO es (ENTREGADA + PAGADO) y NO es CANCELADA ni PRESUPUESTO
        const ordenesActivas = ordenes.filter(o => {
          const esEntregadaYPagada = o.estado_codigo === 'ENTREGADA' && o.estado_pago === 'PAGADO';
          const esCancelada = o.estado_codigo === 'CANCELADA';
          const esPresupuesto = o.estado_codigo === 'PRESUPUESTO';
          return !esEntregadaYPagada && !esCancelada && !esPresupuesto;
        }).length;

        const listasEntregar = ordenes.filter(o =>
          o.estado_codigo === 'COMPLETADA'
        ).length;

        // Actualizar UI
        document.getElementById('stat-ordenes-activas').textContent = ordenesActivas;
        document.getElementById('stat-listas-entregar').textContent = listasEntregar;

        // Calcular ingresos del día (basado en pagos de hoy, no en fecha de orden)
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        const ingresosHoy = ordenes
          .filter(o => new Date(o.fecha_ingreso) >= hoy)
          .reduce((sum, o) => sum + parseFloat(o.total_neto || 0), 0);
        document.getElementById('stat-ingresos-dia').textContent = `€${ingresosHoy.toFixed(2)}`;

        // Cargar productos con stock bajo
        try {
          const invResponse = await fetchWithAuth('/api/inventory/resumen');
          if (invResponse.ok) {
            const productos = await invResponse.json();
            const stockBajo = productos.filter(p =>
              p.stock_minimo && Number(p.stock_total || 0) <= Number(p.stock_minimo)
            ).length;
            document.getElementById('stat-stock-bajo').textContent = stockBajo;
          } else {
            document.getElementById('stat-stock-bajo').textContent = '0';
          }
        } catch (e) {
          console.warn('No se pudo cargar stock bajo:', e);
          document.getElementById('stat-stock-bajo').textContent = '0';
        }

        // Renderizar últimas órdenes
        renderUltimasOrdenes(ordenes.slice(0, 5));

        // Cargar y renderizar gráfico de rendimiento semanal (pagos reales)
        await cargarRendimientoSemanal();

        // Cargar ticket medio mensual
        await cargarTicketMedio();

      } catch (error) {
        console.error('Error cargando estadísticas:', error);
        document.getElementById('stat-ordenes-activas').textContent = '-';
        document.getElementById('stat-ingresos-dia').textContent = '-';
        document.getElementById('stat-listas-entregar').textContent = '-';
        document.getElementById('stat-stock-bajo').textContent = '-';
      }
    }

    function renderUltimasOrdenes(ordenes) {
      const tbody = document.getElementById('ultimas-ordenes-tbody');

      if (!ordenes || ordenes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-[#9da6b9]">No hay órdenes recientes</td></tr>';
        return;
      }

      tbody.innerHTML = ordenes.map(orden => {
        // Determinar colores del estado
        let estadoClass = 'bg-yellow-400/10 text-yellow-400 ring-yellow-400/20';
        if (orden.estado_codigo === 'EN_PROGRESO' || orden.estado_codigo === 'RECAMBIO') {
          estadoClass = 'bg-blue-400/10 text-blue-400 ring-blue-400/20';
        } else if (orden.estado_codigo === 'COMPLETADA') {
          estadoClass = 'bg-green-400/10 text-green-400 ring-green-400/20';
        } else if (orden.estado_codigo === 'ENTREGADA') {
          estadoClass = 'bg-purple-400/10 text-purple-400 ring-purple-400/20';
        }

        return `
          <tr class="hover:bg-[#1a1d24] transition-colors">
            <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-white">#${orden.id}</td>
            <td class="whitespace-nowrap px-6 py-4 text-sm text-[#9da6b9]">${orden.cliente_nombre || '-'}</td>
            <td class="whitespace-nowrap px-6 py-4 text-sm text-[#9da6b9]">${orden.vehiculo_marca || ''} ${orden.vehiculo_modelo || ''}</td>
            <td class="whitespace-nowrap px-6 py-4 text-sm text-[#9da6b9]">
              <span class="inline-flex items-center rounded-md ${estadoClass} px-2 py-1 text-xs font-medium ring-1 ring-inset">${orden.estado_nombre || 'Abierta'}</span>
            </td>
            <td class="whitespace-nowrap px-6 py-4 text-right text-sm font-medium">
              <a class="text-[var(--brand-orange)] hover:text-[#e05300]" href="manager-taller-ordenes.html?id=${orden.id}">Ver</a>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Cargar y renderizar gráfico de rendimiento semanal (pagos reales cobrados)
    async function cargarRendimientoSemanal() {
      const chartContainer = document.getElementById('chart-semanal');
      const totalSemanalEl = document.getElementById('total-semanal');

      // Obtener sucursal seleccionada
      const sucursalSelect = document.getElementById('sucursal-select');
      const sucursalId = sucursalSelect ? sucursalSelect.value : '';
      const url = sucursalId
        ? `/api/ordenpago/estadisticas/semanal?sucursal=${sucursalId}`
        : '/api/ordenpago/estadisticas/semanal';

      try {
        const response = await fetchWithAuth(url);
        if (!response.ok) throw new Error('Error al cargar estadísticas');

        const data = await response.json();
        const pagosPorDia = data.pagosPorDia || [0, 0, 0, 0, 0, 0, 0];
        const totalSemanal = data.totalSemanal || 0;

        renderGraficoSemanal(pagosPorDia, totalSemanal);
      } catch (error) {
        console.warn('Error cargando rendimiento semanal:', error);
        // Mostrar mensaje de error en el gráfico
        chartContainer.innerHTML = `
          <div class="flex items-center justify-center w-full h-full text-[#9da6b9] text-sm">
            <i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i> No se pudo cargar
          </div>
        `;
        totalSemanalEl.textContent = '€0.00';
      }
    }

    // Renderizar gráfico con los datos
    function renderGraficoSemanal(pagosPorDia, totalSemanal) {
      const chartContainer = document.getElementById('chart-semanal');
      const totalSemanalEl = document.getElementById('total-semanal');

      const diasLabels = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
      const diasNombres = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];

      // Encontrar el máximo para escalar las barras
      const maxPago = Math.max(...pagosPorDia, 1);

      // Determinar el día actual (lunes=0, domingo=6)
      const hoy = new Date();
      const diaSemana = hoy.getDay();
      const diaActualIdx = diaSemana === 0 ? 6 : diaSemana - 1;

      // Renderizar barras
      chartContainer.innerHTML = pagosPorDia.map((pago, idx) => {
        const porcentaje = (pago / maxPago) * 100;
        const altura = Math.max(porcentaje, 5); // mínimo 5% para que se vea
        const esHoy = idx === diaActualIdx;

        const barClass = esHoy
          ? "bg-[var(--brand-orange)] shadow-[0_0_15px_rgba(255,95,0,0.3)]"
          : "bg-[#282e39] hover:bg-[var(--brand-orange)] transition-all duration-300";
        const textClass = esHoy ? "text-xs font-bold text-white" : "text-xs text-[#9da6b9]";

        return `
          <div class="flex h-full flex-col items-center gap-1 w-full group">
            <span class="text-[10px] text-green-400 opacity-0 group-hover:opacity-100 transition-opacity font-medium">
              €${pago.toFixed(0)}
            </span>
            <div class="flex-1 flex flex-col-reverse w-full">
              <div class="w-full max-w-[28px] mx-auto rounded-t ${barClass}" 
                   style="height: ${altura}%;" 
                   title="${diasNombres[idx]}: €${pago.toFixed(2)} cobrado">
              </div>
            </div>
            <span class="${textClass}">${diasLabels[idx]}</span>
          </div>
        `;
      }).join('');

      // Mostrar total semanal
      totalSemanalEl.textContent = `€${totalSemanal.toFixed(2)}`;
    }

    // Cargar y mostrar Ticket Medio Mensual
    async function cargarTicketMedio() {
      const ticketMedioEl = document.getElementById('stat-ticket-medio');
      const variacionEl = document.getElementById('ticket-medio-variacion');
      const subtextoEl = document.getElementById('ticket-medio-subtexto');

      if (!ticketMedioEl) return;

      try {
        // Obtener sucursal seleccionada
        const sucursalSelect = document.getElementById('sucursal-select');
        const sucursalId = sucursalSelect ? sucursalSelect.value : '';
        const url = sucursalId
          ? `/api/ordenpago/estadisticas/ticket-medio?sucursal=${sucursalId}`
          : '/api/ordenpago/estadisticas/ticket-medio';

        const response = await fetchWithAuth(url);
        if (!response.ok) throw new Error('Error al cargar ticket medio');

        const data = await response.json();

        if (data.success) {
          const { mesActual, variacion } = data;

          // Mostrar ticket medio
          if (mesActual.ordenesCerradas > 0) {
            ticketMedioEl.textContent = `€${mesActual.ticketMedio.toFixed(2)}`;
          } else {
            ticketMedioEl.textContent = '—';
          }

          // Mostrar variación con flecha
          if (variacion.porcentaje !== 0 && mesActual.ordenesCerradas > 0) {
            const isPositive = variacion.tendencia === 'up';
            const arrow = isPositive ? '↑' : '↓';
            const colorClass = isPositive ? 'text-green-400' : 'text-red-400';
            variacionEl.innerHTML = `
              <span class="${colorClass}">${arrow} ${Math.abs(variacion.porcentaje).toFixed(1)}%</span>
            `;
          } else {
            variacionEl.innerHTML = '';
          }

          // Actualizar subtexto
          subtextoEl.textContent = `${mesActual.ordenesCerradas} órdenes cerradas · ${mesActual.nombre}`;
        }
      } catch (error) {
        console.warn('Error cargando ticket medio:', error);
        ticketMedioEl.textContent = '—';
        variacionEl.innerHTML = '';
        subtextoEl.textContent = 'Error al cargar';
      }
    }

    // Abrir modal de histórico de ticket medio
    function abrirModalTicketMedio() {
      const modal = document.getElementById('ticket-medio-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      cargarHistoricoTicketMedio();
    }

    // Cerrar modal
    window.cerrarModalTicketMedio = function () {
      const modal = document.getElementById('ticket-medio-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // Cargar datos históricos
    async function cargarHistoricoTicketMedio() {
      const chartContainer = document.getElementById('historico-chart');
      const tablaBody = document.getElementById('historico-tabla-body');

      try {
        // Obtener sucursal seleccionada
        const sucursalSelect = document.getElementById('sucursal-select');
        const sucursalId = sucursalSelect ? sucursalSelect.value : '';
        const url = sucursalId
          ? `/api/ordenpago/estadisticas/ticket-medio/historico?sucursal=${sucursalId}&meses=12`
          : '/api/ordenpago/estadisticas/ticket-medio/historico?meses=12';

        const response = await fetchWithAuth(url);
        if (!response.ok) throw new Error('Error al cargar histórico');

        const data = await response.json();

        if (data.success && data.historico) {
          renderHistoricoChart(data.historico);
          renderHistoricoTabla(data.historico);
        } else {
          throw new Error('Sin datos');
        }
      } catch (error) {
        console.warn('Error cargando histórico ticket medio:', error);
        chartContainer.innerHTML = `
          <div class="flex items-center justify-center w-full h-full text-[#9da6b9] text-sm">
            <i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i> No hay datos disponibles
          </div>
        `;
        tablaBody.innerHTML = `
          <tr>
            <td colspan="4" class="px-6 py-4 text-center text-[#9da6b9]">No hay datos disponibles</td>
          </tr>
        `;
      }
    }

    // Renderizar gráfico de barras del histórico
    function renderHistoricoChart(historico) {
      const chartContainer = document.getElementById('historico-chart');

      if (!historico || historico.length === 0) {
        chartContainer.innerHTML = `
          <div class="flex items-center justify-center w-full h-full text-[#9da6b9] text-sm">
            No hay datos para mostrar
          </div>
        `;
        return;
      }

      // Encontrar el máximo para escalar (solo de meses con datos)
      const maxTicket = Math.max(...historico.map(h => h.ticketMedio), 1);

      chartContainer.innerHTML = historico.map((item, idx) => {
        const esUltimo = idx === historico.length - 1;
        const sinDatos = item.ordenesCerradas === 0;

        let altura, barClass, valorMostrar;

        if (sinDatos) {
          // Mes sin datos: barra mínima con patrón diferente
          altura = 3;
          barClass = "bg-[#1a1d24] border border-dashed border-[#3a4050]";
          valorMostrar = "—";
        } else {
          const porcentaje = (item.ticketMedio / maxTicket) * 100;
          altura = Math.max(porcentaje, 8);
          barClass = esUltimo
            ? "bg-purple-500 shadow-[0_0_15px_rgba(168,85,247,0.3)]"
            : "bg-[#282e39] hover:bg-purple-500 transition-all duration-300";
          valorMostrar = `€${item.ticketMedio.toFixed(0)}`;
        }

        const labelClass = sinDatos
          ? "text-[10px] text-[#555] whitespace-nowrap"
          : "text-[10px] text-[#9da6b9] whitespace-nowrap";

        return `
          <div class="flex h-full flex-col items-center gap-1 flex-1 group cursor-pointer" 
               title="${item.mes}: ${sinDatos ? 'Sin datos' : `€${item.ticketMedio.toFixed(2)} (${item.ordenesCerradas} órdenes)`}">
            <span class="text-[10px] ${sinDatos ? 'text-[#555]' : 'text-purple-400'} opacity-0 group-hover:opacity-100 transition-opacity font-medium whitespace-nowrap">
              ${valorMostrar}
            </span>
            <div class="flex-1 flex flex-col-reverse w-full">
              <div class="w-full max-w-[40px] mx-auto rounded-t ${barClass}" style="height: ${altura}%;"></div>
            </div>
            <span class="${labelClass}">${item.mes.split(' ')[0]}</span>
          </div>
        `;
      }).join('');
    }

    // Renderizar tabla del histórico
    function renderHistoricoTabla(historico) {
      const tablaBody = document.getElementById('historico-tabla-body');

      if (!historico || historico.length === 0) {
        tablaBody.innerHTML = `
          <tr>
            <td colspan="4" class="px-6 py-4 text-center text-[#9da6b9]">No hay datos disponibles</td>
          </tr>
        `;
        return;
      }

      // Mostrar de más reciente a más antiguo
      const historicoOrdenado = [...historico].reverse();

      tablaBody.innerHTML = historicoOrdenado.map((item, idx) => {
        const esActual = idx === 0;
        const sinDatos = item.ordenesCerradas === 0;

        let rowClass, textClass, ticketClass, badge;

        if (esActual) {
          rowClass = 'bg-purple-500/5';
          textClass = 'text-white';
          ticketClass = 'text-purple-400 font-bold';
          badge = '<span class="ml-2 text-xs bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded">Actual</span>';
        } else if (sinDatos) {
          rowClass = 'bg-[#0a0b0d]';
          textClass = 'text-[#555]';
          ticketClass = 'text-[#555]';
          badge = '<span class="ml-2 text-xs bg-[#1a1d24] text-[#555] px-2 py-0.5 rounded">Sin actividad</span>';
        } else {
          rowClass = 'hover:bg-[#1a1d24]';
          textClass = 'text-[#9da6b9]';
          ticketClass = 'text-white';
          badge = '';
        }

        return `
          <tr class="${rowClass} transition-colors">
            <td class="px-6 py-4 text-sm ${sinDatos && !esActual ? 'text-[#555]' : 'text-white'} font-medium">
              ${item.mes}
              ${badge}
            </td>
            <td class="px-6 py-4 text-sm text-right ${textClass}">${item.ordenesCerradas}</td>
            <td class="px-6 py-4 text-sm text-right ${textClass}">${sinDatos ? '—' : `€${item.facturacionTotal.toFixed(2)}`}</td>
            <td class="px-6 py-4 text-sm text-right ${ticketClass}">${sinDatos ? '—' : `€${item.ticketMedio.toFixed(2)}`}</td>
          </tr>
        `;
      }).join('');
    }

    // Agregar evento click a la card de ticket medio
    document.addEventListener('DOMContentLoaded', () => {
      const ticketCard = document.getElementById('ticket-medio-card');
      if (ticketCard) {
        ticketCard.addEventListener('click', abrirModalTicketMedio);
      }

      // Cerrar modal al hacer clic fuera
      const modal = document.getElementById('ticket-medio-modal');
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            cerrarModalTicketMedio();
          }
        });
      }
    });

    // Constante para la clave de localStorage
    const SUCURSAL_STORAGE_KEY = 'versa_selected_sucursal';

    // Cargar sucursales y mostrar en selector
    async function loadSucursales() {
      try {
        const response = await fetchWithAuth('/api/caja/sucursales');
        if (!response.ok) throw new Error('Error cargando sucursales');
        const data = await response.json();

        const sucursalContainer = document.getElementById('sucursal-container');
        if (!sucursalContainer) return;

        if (data.puede_seleccionar && data.sucursales.length > 1) {
          // Verificar si hay una selección guardada en localStorage
          const savedSucursal = localStorage.getItem(SUCURSAL_STORAGE_KEY);
          // Usar la guardada si existe y es válida, sino usar la actual del backend
          const selectedSucursalId = savedSucursal && data.sucursales.some(s => s.id == savedSucursal)
            ? savedSucursal
            : data.sucursal_actual;

          // Usuario puede seleccionar entre múltiples sucursales
          const options = data.sucursales.map(s => {
            const label = s.tenant_nombre ? `${s.tenant_nombre} - ${s.nombre}` : s.nombre;
            return `<option value="${s.id}"${s.id == selectedSucursalId ? ' selected' : ''}>${label}</option>`;
          }).join('');

          sucursalContainer.innerHTML = `
            <span class="material-symbols-outlined text-[var(--brand-orange)]">store</span>
            <select id="sucursal-select" class="bg-transparent text-white text-sm font-medium border-none focus:outline-none cursor-pointer">
              ${options}
            </select>
          `;

          // Agregar event listener para cambio de sucursal
          setTimeout(() => {
            const select = document.getElementById('sucursal-select');
            if (select) {
              select.addEventListener('change', () => {
                // Guardar selección en localStorage para persistencia
                localStorage.setItem(SUCURSAL_STORAGE_KEY, select.value);
                // Recargar estadísticas cuando cambia la sucursal
                cargarEstadisticas();
              });
            }
          }, 0);
        } else {
          // Solo una sucursal - mostrar label
          const sucursal = data.sucursales.find(s => s.id == data.sucursal_actual) || data.sucursales[0];
          const label = sucursal ? (sucursal.tenant_nombre ? `${sucursal.tenant_nombre} - ${sucursal.nombre}` : sucursal.nombre) : 'Sin sucursal';
          sucursalContainer.innerHTML = `
            <span class="material-symbols-outlined text-[var(--brand-orange)]">store</span>
            <span class="text-white font-medium text-sm">${label}</span>
          `;
          // Si solo hay una sucursal, guardarla también
          if (sucursal) {
            localStorage.setItem(SUCURSAL_STORAGE_KEY, sucursal.id);
          }
        }
      } catch (error) {
        console.warn('Error loading sucursales:', error);
        const sucursalContainer = document.getElementById('sucursal-container');
        if (sucursalContainer) {
          sucursalContainer.innerHTML = `
            <span class="material-symbols-outlined text-[var(--brand-orange)]">store</span>
            <span class="text-[#9da6b9] font-medium text-sm">Sin sucursal</span>
          `;
        }
      }
    }

    // Cargar al inicio
    loadSucursales();
    cargarEstadisticas();
  </script>
</body>

</html>