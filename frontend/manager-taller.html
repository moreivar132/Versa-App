<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Vehículos - Goversa</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/guard.js"></script>
    <!-- FontAwesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Material Symbols (Iconos) -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <style>
        /* Estilos Generales Unificados */
        :root {
            --brand-orange: #FF652B;
            --brand-orange-strong: #FF7A45;
            --brand-orange-dark: #e05300;
            --surface-elevated: rgba(18, 18, 20, 0.96);
            --surface-border: rgba(255, 255, 255, 0.08);
            --surface-highlight: rgba(255, 255, 255, 0.04);
            --dark-bg: #000000;
            --surface-bg: #1a1a1a;
            --border-color: #2a2a2a;
            --input-bg: #333333;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --success-color: #28a745;
            --error-color: #dc3545;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--dark-bg);
            font-family: 'Montserrat', Arial, sans-serif;
            color: var(--text-primary);
        }

        /* Estilos específicos del formulario de vehículos (adaptados) */
        .form-container h2,
        .search-container h2 {
            font-size: 28px;
            font-weight: 800;
            margin-top: 0;
            margin-bottom: 25px;
        }

        .form-label {
            font-family: 'Montserrat', Arial, sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: #A0A0A0;
            display: block;
            margin-bottom: 16px;
        }

        .form-label .required {
            color: var(--brand-orange);
        }

        .form-input,
        .form-select,
        .search-input {
            width: 100%;
            padding: 12px;
            margin-top: 6px;
            border-radius: 8px;
            background-color: #333333;
            border: 1px solid #444444;
            color: #FFFFFF;
            font-family: 'Montserrat', Arial, sans-serif;
            font-size: 16px;
            box-sizing: border-box;
        }

        .form-input:focus,
        .form-select:focus,
        .search-input:focus {
            outline: none;
            border-color: var(--brand-orange);
            box-shadow: 0 0 0 3px rgba(255, 101, 43, 0.25);
        }

        .submit-button,
        .search-button {
            width: 100%;
            font-size: 16px;
            font-family: 'Montserrat', Arial, sans-serif;
            font-weight: bold;
            color: #ffffff;
            text-decoration: none;
            border-radius: 8px;
            padding: 16px 25px;
            border: 1px solid #FF5F00;
            background-color: #FF5F00;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 10px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .search-form {
            display: flex;
            gap: 10px;
        }

        .search-input {
            flex-grow: 1;
            margin: 0;
        }

        .search-button {
            width: auto;
            margin: 0;
        }

        .card {
            background-color: #1A1A1A;
            border: 1px solid #2A2A2A;
            border-radius: 12px;
            padding: 25px;
        }

        .main-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0 20px;
        }

        @media (max-width: 900px) {
            .main-panel {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Custom Select Styles */
        .custom-select-container {
            position: relative;
        }

        .custom-select-options {
            display: none;
            position: absolute;
            top: calc(100% - 10px);
            left: 0;
            right: 0;
            background-color: #333333;
            border: 1px solid #444444;
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
        }

        .custom-select-options.show {
            display: block;
        }

        .custom-select-options .option,
        .custom-select-options .option-group {
            padding: 12px 15px;
            cursor: pointer;
            font-size: 16px;
        }

        .custom-select-options .option:hover {
            background-color: #FF5F00;
        }

        .custom-select-options .option-group {
            font-weight: bold;
            color: #A0A0A0;
            cursor: default;
            border-top: 1px solid #444444;
            margin-top: 5px;
            padding-top: 10px;
        }
    </style>
</head>

<body>

    <div class="flex h-screen w-full">
        <!-- SideNavBar -->
        <aside id="sidebar"
            class="flex h-full w-64 flex-col bg-[#111318] p-4 shrink-0 transition-all duration-300 ease-in-out border-r border-[var(--surface-border)]">
            <div class="flex h-full flex-col justify-between">
                <div class="flex flex-col gap-4">
                    <!-- User Profile / Logo Area -->
                    <div class="flex items-center gap-3 p-2 mb-4">
                        <div class="logo-badge"
                            style="padding: 8px; border-radius: 12px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                            <img src="https://i.imgur.com/Mjw4or5.png" alt="Logo" class="logo-img"
                                style="height: 24px; width: auto;">
                        </div>
                        <div class="flex flex-col sidebar-text">
                            <h1 class="text-white text-base font-medium leading-normal" style="font-size: 15px;">
                                Goversa</h1>
                            <p class="text-[#9da6b9] text-sm font-normal leading-normal" style="font-size: 12px;">
                                Gestión</p>
                        </div>
                        <button id="toggle-sidebar" class="ml-auto text-gray-400 hover:text-white">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </div>

                    <!-- Navigation Links -->
                    <nav class="flex flex-col gap-2">
                        <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
                            href="manager-taller-inicio.html">
                            <span class="icon-container"><i class="fas fa-home"></i></span>
                            <p class="text-sm font-medium leading-normal sidebar-text">Inicio</p>
                        </a>

                        <!-- Taller Dropdown (Active) -->
                        <div class="nav-group">
                            <a class="flex items-center gap-3 px-3 py-2 bg-[var(--brand-orange)] text-white rounded-lg transition-colors cursor-pointer"
                                onclick="toggleSubmenu('taller-submenu')">
                                <span class="icon-container"><i class="fas fa-wrench"></i></span>
                                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Taller</p>
                                <i class="fas fa-chevron-up text-xs sidebar-text transition-transform"
                                    id="taller-arrow"></i>
                            </a>
                            <div id="taller-submenu" class="flex flex-col pl-9 gap-1 mt-1">
                                <a href="manager-taller-citas.html"
                                    class="text-gray-400 hover:text-white text-sm py-1 block">Citas</a>
                                <a href="manager-taller-ordenes.html"
                                    class="text-gray-400 hover:text-white text-sm py-1 block">Órdenes</a>
                                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Editar
                                    órdenes</a>
                                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Presupuestos</a>
                                <a href="manager-taller-vehiculos.html"
                                    class="text-gray-500 hover:text-white text-sm py-1 block">Vehículos</a>
                                <a href="manager-taller-chat.html"
                                    class="text-gray-500 hover:text-white text-sm py-1 block">Chat Clientes</a>
                            </div>
                        </div>

                        <!-- Tienda Dropdown -->
                        <div class="nav-group">
                            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                                onclick="toggleSubmenu('tienda-submenu')">
                                <span class="icon-container"><i class="fas fa-shopping-cart"></i></span>
                                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Tienda</p>
                                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform"
                                    id="tienda-arrow"></i>
                            </a>
                            <div id="tienda-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                                <a href="manager-taller-compras.html"
                                    class="text-gray-500 hover:text-white text-sm py-1 block">Nueva Compra</a>
                                <a href="manager-taller-compras-historial.html"
                                    class="text-gray-500 hover:text-white text-sm py-1 block">Historial Compras</a>
                                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Ventas</a>
                                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Productos</a>
                            </div>
                        </div>

                        <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
                            href="#">
                            <span class="icon-container"><i class="fas fa-cash-register"></i></span>
                            <p class="text-sm font-medium leading-normal sidebar-text">Caja</p>
                        </a>

                        <!-- Cuentas Dropdown -->
                        <div class="nav-group">
                            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                                onclick="toggleSubmenu('cuentas-submenu')">
                                <span class="icon-container"><i class="fas fa-file-invoice-dollar"></i></span>
                                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Cuentas</p>
                                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform"
                                    id="cuentas-arrow"></i>
                            </a>
                            <div id="cuentas-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Facturas</a>
                                <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Gastos</a>
                            </div>
                        </div>

                        <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
                            href="manager-taller-inventario.html">
                            <span class="icon-container"><i class="fas fa-boxes"></i></span>
                            <p class="text-sm font-medium leading-normal sidebar-text">Inventario</p>
                        </a>

                        <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
                            href="manager-taller-trabajadores.html">
                            <span class="icon-container"><i class="fas fa-users-cog"></i></span>
                            <p class="text-sm font-medium leading-normal sidebar-text">Trabajadores</p>
                        </a>

                        <!-- Contactos -->
                        <div class="nav-group">
                            <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
                                onclick="toggleSubmenu('contactos-submenu')">
                                <span class="icon-container"><i class="fas fa-address-book"></i></span>
                                <p class="text-sm font-medium leading-normal sidebar-text flex-1">Contactos</p>
                                <i class="fas fa-chevron-down text-xs sidebar-text transition-transform"
                                    id="contactos-arrow"></i>
                            </a>
                            <div id="contactos-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
                                <a href="manager-taller-clientes.html"
                                    class="text-gray-500 hover:text-white text-sm py-1 block">Clientes</a>
                                <a href="manager-taller-proveedores.html"
                                    class="text-gray-500 hover:text-white text-sm py-1 block">Proveedores</a>
                            </div>
                        </div>
                    </nav>
                </div>

                <!-- Bottom Actions -->
                <div class="flex flex-col gap-1 border-t border-[var(--brand-orange)] pt-4">
                    <div class="flex items-center gap-3 px-3 py-2 mb-2">
                        <div
                            class="w-8 h-8 rounded-full bg-[var(--brand-orange)] flex items-center justify-center text-white font-bold text-xs">
                            IM
                        </div>
                        <div class="flex flex-col sidebar-text overflow-hidden">
                            <span class="text-white text-sm font-medium truncate">Iván Moreno</span>
                            <span class="text-gray-500 text-xs truncate">admin</span>
                        </div>
                    </div>
                    <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
                        href="#" data-logout>
                        <span class="icon-container"><i class="fas fa-sign-out-alt"></i></span>
                        <p class="text-sm font-medium leading-normal sidebar-text">Salir</p>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="flex-1 flex flex-col h-screen overflow-hidden bg-[var(--dark-bg)]">
            <!-- Top Mobile Header -->
            <header
                class="md:hidden flex items-center justify-between p-4 bg-[#111318] border-b border-[var(--surface-border)]">
                <div class="logo-badge p-2">
                    <img src="https://i.imgur.com/Mjw4or5.png" alt="Logo" class="h-6 w-auto">
                </div>
                <button id="mobile-menu-btn" class="text-white">
                    <i class="fas fa-bars"></i>
                </button>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <div class="max-w-7xl mx-auto">
                    <!-- PANEL PRINCIPAL CON FORMULARIO Y BUSCADOR -->
                    <div id="vehicles-panel" class="main-panel">

                        <!-- COLUMNA IZQUIERDA: FORMULARIO DE REGISTRO DE VEHÍCULOS -->
                        <div class="card form-container">
                            <h2>Registrar Nuevo Vehículo</h2>
                            <form id="vehicle-form" novalidate>
                                <div class="form-grid">
                                    <label for="placa" class="form-label">Placa <span class="required">*</span>
                                        <input type="text" id="placa" name="placa" class="form-input" required>
                                    </label>
                                    <label for="ano" class="form-label">Año
                                        <input type="number" id="ano" name="ano" class="form-input">
                                    </label>

                                    <!-- CAMPO DE MARCA MODIFICADO -->
                                    <label for="marca" class="form-label">Marca
                                        <div class="custom-select-container">
                                            <input type="text" name="marca" class="form-input custom-select-input"
                                                id="marca" placeholder="Buscar o escribir marca...">
                                            <div class="custom-select-options" id="marca-options">
                                                <!-- Se rellena dinámicamente con JavaScript -->
                                            </div>
                                        </div>
                                    </label>

                                    <label for="chasis" class="form-label">Nº Chasis
                                        <input type="text" id="chasis" name="chasis" class="form-input">
                                    </label>
                                    <label for="modelo" class="form-label">Modelo
                                        <input type="text" id="modelo" name="modelo" class="form-input">
                                    </label>
                                    <label for="cc" class="form-label">CC
                                        <input type="text" id="cc" name="cc" class="form-input">
                                    </label>
                                    <label for="tipo" class="form-label">Tipo
                                        <select id="tipo" name="tipo" class="form-select">
                                            <option value="">Seleccionar...</option>
                                            <option value="Coche">Coche</option>
                                            <option value="Moto">Moto</option>
                                            <option value="Furgoneta">Furgoneta</option>
                                            <option value="Camion">Camión</option>
                                        </select>
                                    </label>
                                    <label for="seguro" class="form-label">Seguro
                                        <input type="text" id="seguro" name="seguro" class="form-input">
                                    </label>
                                    <label for="color" class="form-label full-width">Color
                                        <select id="color" name="color" class="form-select">
                                            <option value="">Seleccionar...</option>
                                            <option value="Negro">Negro</option>
                                            <option value="Blanco">Blanco</option>
                                            <option value="Gris">Gris</option>
                                            <option value="Rojo">Rojo</option>
                                            <option value="Azul">Azul</option>
                                        </select>
                                    </label>
                                </div>
                                <button type="submit" id="submit-button" class="submit-button full-width">Registrar
                                    Vehículo</button>
                            </form>
                            <p id="form-status" style="text-align: center; margin-top: 20px;"></p>
                        </div>

                        <!-- COLUMNA DERECHA: BUSCADOR Y RESULTADOS -->
                        <div class="card search-container">
                            <h2>Buscar Vehículo</h2>
                            <form id="search-form">
                                <div class="search-form">
                                    <input type="search" id="search-input" placeholder="Buscar por matrícula, chasis..."
                                        class="search-input">
                                    <button type="submit" id="search-button" class="search-button">Buscar</button>
                                </div>
                            </form>
                            <div id="search-results-info" style="text-align:center; margin-top:20px;"></div>
                            <div id="search-results"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- FOOTER -->
    class="text-gray-500 hover:text-white text-sm py-1 block">Vehículos</a>
    </div>
    </div>

    <!-- Tienda Dropdown -->
    <div class="nav-group">
        <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
            onclick="toggleSubmenu('tienda-submenu')">
            <span class="icon-container"><i class="fas fa-shopping-cart"></i></span>
            <p class="text-sm font-medium leading-normal sidebar-text flex-1">Tienda</p>
            <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="tienda-arrow"></i>
        </a>
        <div id="tienda-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
            <a href="manager-taller-compras.html" class="text-gray-500 hover:text-white text-sm py-1 block">Nueva
                Compra</a>
            <a href="manager-taller-compras-historial.html"
                class="text-gray-500 hover:text-white text-sm py-1 block">Historial Compras</a>
            <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Ventas</a>
            <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Productos</a>
        </div>
    </div>

    <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
        href="#">
        <span class="icon-container"><i class="fas fa-cash-register"></i></span>
        <p class="text-sm font-medium leading-normal sidebar-text">Caja</p>
    </a>

    <!-- Cuentas Dropdown -->
    <div class="nav-group">
        <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
            onclick="toggleSubmenu('cuentas-submenu')">
            <span class="icon-container"><i class="fas fa-file-invoice-dollar"></i></span>
            <p class="text-sm font-medium leading-normal sidebar-text flex-1">Cuentas</p>
            <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="cuentas-arrow"></i>
        </a>
        <div id="cuentas-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
            <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Facturas</a>
            <a href="#" class="text-gray-500 hover:text-white text-sm py-1 block">Gastos</a>
        </div>
    </div>

    <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
        href="manager-taller-inventario.html">
        <span class="icon-container"><i class="fas fa-boxes"></i></span>
        <p class="text-sm font-medium leading-normal sidebar-text">Inventario</p>
    </a>

    <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
        href="manager-taller-trabajadores.html">
        <span class="icon-container"><i class="fas fa-users-cog"></i></span>
        <p class="text-sm font-medium leading-normal sidebar-text">Trabajadores</p>
    </a>

    <!-- Contactos -->
    <div class="nav-group">
        <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors cursor-pointer"
            onclick="toggleSubmenu('contactos-submenu')">
            <span class="icon-container"><i class="fas fa-address-book"></i></span>
            <p class="text-sm font-medium leading-normal sidebar-text flex-1">Contactos</p>
            <i class="fas fa-chevron-down text-xs sidebar-text transition-transform" id="contactos-arrow"></i>
        </a>
        <div id="contactos-submenu" class="hidden flex-col pl-9 gap-1 mt-1">
            <a href="manager-taller-clientes.html"
                class="text-gray-500 hover:text-white text-sm py-1 block">Clientes</a>
            <a href="manager-taller-proveedores.html"
                class="text-gray-500 hover:text-white text-sm py-1 block">Proveedores</a>
        </div>
    </div>
    </nav>
    </div>

    <!-- Bottom Actions -->
    <div class="flex flex-col gap-1 border-t border-[var(--brand-orange)] pt-4">
        <div class="flex items-center gap-3 px-3 py-2 mb-2">
            <div
                class="w-8 h-8 rounded-full bg-[var(--brand-orange)] flex items-center justify-center text-white font-bold text-xs">
                IM
            </div>
            <div class="flex flex-col sidebar-text overflow-hidden">
                <span class="text-white text-sm font-medium truncate">Iván Moreno</span>
                <span class="text-gray-500 text-xs truncate">admin</span>
            </div>
        </div>
        <a class="flex items-center gap-3 px-3 py-2 text-gray-400 hover:text-white hover:bg-[#282e39] rounded-lg transition-colors"
            href="#" data-logout>
            <span class="icon-container"><i class="fas fa-sign-out-alt"></i></span>
            <p class="text-sm font-medium leading-normal sidebar-text">Salir</p>
        </a>
    </div>
    </div>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="flex-1 flex flex-col h-screen overflow-hidden bg-[var(--dark-bg)]">
        <!-- Top Mobile Header -->
        <header
            class="md:hidden flex items-center justify-between p-4 bg-[#111318] border-b border-[var(--surface-border)]">
            <div class="logo-badge p-2">
                <img src="https://i.imgur.com/Mjw4or5.png" alt="Logo" class="h-6 w-auto">
            </div>
            <button id="mobile-menu-btn" class="text-white">
                <i class="fas fa-bars"></i>
            </button>
        </header>

        <main class="flex-1 overflow-y-auto p-6">
            <div class="max-w-7xl mx-auto">
                <!-- PANEL PRINCIPAL CON FORMULARIO Y BUSCADOR -->
                <div id="vehicles-panel" class="main-panel">

                    <!-- COLUMNA IZQUIERDA: FORMULARIO DE REGISTRO DE VEHÍCULOS -->
                    <div class="card form-container">
                        <h2>Registrar Nuevo Vehículo</h2>
                        <form id="vehicle-form" novalidate>
                            <div class="form-grid">
                                <label for="placa" class="form-label">Placa <span class="required">*</span>
                                    <input type="text" id="placa" name="placa" class="form-input" required>
                                </label>
                                <label for="ano" class="form-label">Año
                                    <input type="number" id="ano" name="ano" class="form-input">
                                </label>

                                <!-- CAMPO DE MARCA MODIFICADO -->
                                <label for="marca" class="form-label">Marca
                                    <div class="custom-select-container">
                                        <input type="text" name="marca" class="form-input custom-select-input"
                                            id="marca" placeholder="Buscar o escribir marca...">
                                        <div class="custom-select-options" id="marca-options">
                                            <!-- Se rellena dinámicamente con JavaScript -->
                                        </div>
                                    </div>
                                </label>

                                <label for="chasis" class="form-label">Nº Chasis
                                    <input type="text" id="chasis" name="chasis" class="form-input">
                                </label>
                                <label for="modelo" class="form-label">Modelo
                                    <input type="text" id="modelo" name="modelo" class="form-input">
                                </label>
                                <label for="cc" class="form-label">CC
                                    <input type="text" id="cc" name="cc" class="form-input">
                                </label>
                                <label for="tipo" class="form-label">Tipo
                                    <select id="tipo" name="tipo" class="form-select">
                                        <option value="">Seleccionar...</option>
                                        <option value="Coche">Coche</option>
                                        <option value="Moto">Moto</option>
                                        <option value="Furgoneta">Furgoneta</option>
                                        <option value="Camion">Camión</option>
                                    </select>
                                </label>
                                <label for="seguro" class="form-label">Seguro
                                    <input type="text" id="seguro" name="seguro" class="form-input">
                                </label>
                                <label for="color" class="form-label full-width">Color
                                    <select id="color" name="color" class="form-select">
                                        <option value="">Seleccionar...</option>
                                        <option value="Negro">Negro</option>
                                        <option value="Blanco">Blanco</option>
                                        <option value="Gris">Gris</option>
                                        <option value="Rojo">Rojo</option>
                                        <option value="Azul">Azul</option>
                                    </select>
                                </label>
                            </div>
                            <button type="submit" id="submit-button" class="submit-button full-width">Registrar
                                Vehículo</button>
                        </form>
                        <p id="form-status" style="text-align: center; margin-top: 20px;"></p>
                    </div>

                    <!-- COLUMNA DERECHA: BUSCADOR Y RESULTADOS -->
                    <div class="card search-container">
                        <h2>Buscar Vehículo</h2>
                        <form id="search-form">
                            <div class="search-form">
                                <input type="search" id="search-input" placeholder="Buscar por matrícula, chasis..."
                                    class="search-input">
                                <button type="submit" id="search-button" class="search-button">Buscar</button>
                            </div>
                        </form>
                        <div id="search-results-info" style="text-align:center; margin-top:20px;"></div>
                        <div id="search-results"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    </div>

    <!-- FOOTER -->
    <footer>
        <p>&copy; 2025 Goversa Mobility S.L. Todos los derechos reservados.</p>
    </footer>
    </div>

    <script type="module">
        import { fetchWithAuth } from './auth.js';

        // --- SIDEBAR LOGIC ---
        window.toggleSubmenu = function (id) {
            const submenu = document.getElementById(id);
            const arrow = document.getElementById(id.replace('submenu', 'arrow'));

            if (submenu.classList.contains('hidden')) {
                submenu.classList.remove('hidden');
                submenu.classList.add('flex');
                if (arrow) arrow.style.transform = 'rotate(180deg)';
            } else {
                submenu.classList.add('hidden');
                submenu.classList.remove('flex');
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            }
        }

        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggle-sidebar');
        const sidebarTexts = document.querySelectorAll('.sidebar-text');
        let isCollapsed = false;

        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                isCollapsed = !isCollapsed;
                if (isCollapsed) {
                    sidebar.classList.remove('w-64');
                    sidebar.classList.add('w-20');
                    sidebarTexts.forEach(el => el.classList.add('hidden'));
                    toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    document.querySelectorAll('[id$="-submenu"]').forEach(el => {
                        el.classList.add('hidden');
                        el.classList.remove('flex');
                    });
                } else {
                    sidebar.classList.add('w-64');
                    sidebar.classList.remove('w-20');
                    sidebarTexts.forEach(el => el.classList.remove('hidden'));
                    toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                }
            });
        }

        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebar.classList.toggle('absolute');
                sidebar.classList.toggle('z-50');
                sidebar.classList.toggle('h-full');
            });
        }

        // Expand Taller submenu by default
        document.addEventListener("DOMContentLoaded", () => {
            toggleSubmenu('taller-submenu');
        });

        // --- URLs PARA VEHÍCULOS ---
        const VEHICLE_REGISTER_API_URL = '/api/vehiculos';
        const MAKE_VEHICLE_SEARCH_WEBHOOK_URL = 'https://hook.eu2.make.com/z8b2jaicivbiuuhc819wcwlq2mw2em32';

        // --- NUEVA LÓGICA PARA DROPDOWN BUSCABLE ---
        const vehicleBrands = [
            { type: 'group', label: 'Coches' },
            "Volkswagen", "Skoda", "Seat", "Cupra", "Audi", "BMW", "Mercedes-Benz", "Peugeot", "Renault", "Dacia", "Citroën", "Opel", "Fiat", "Ford", "Toyota", "Hyundai", "Kia", "Tesla", "Mazda", "Nissan", "Volvo", "BYD", "MG", "Lynk & Co", "NIO", "XPeng", "Zeekr", "GWM ORA", "Aiways", "Chery",
            { type: 'group', label: 'Motos y Scooters' },
            "Honda", "Yamaha", "Kawasaki", "Suzuki", "KTM", "Ducati", "Triumph", "Harley-Davidson", "BMW Motorrad", "Piaggio", "Vespa", "Aprilia", "Moto Guzzi", "MV Agusta", "Royal Enfield", "Benelli", "Keeway", "Zontes", "CFMoto", "Voge", "SYM", "KYMCO", "NIU", "Silence", "Super Soco", "Yadea", "Horwin", "Sunra", "Lifan", "Wottan", "Mash", "Brixton", "Fantic", "SWM", "Rieju", "GasGas", "Husqvarna", "Beta", "Sherco", "Montesa", "Derbi", "Italjet", "Peugeot Motocycles", "Malaguti", "Ebroh", "Torrot", "Colove", "Sur-Ron", "Oset", "Zero Motorcycles", "Energica", "Arc Vector", "Segway", "Dayun", "Loncin", "QJ Motor", "Aeon", "UM Motorcycles", "Hero MotoCorp", "TVS Motor", "Bajaj", "Taro", "Hanway", "MITT", "CF-EV", "Efun", "LVNENG", "Sunra Robo", "Okinawa", "ZEEHO (CFMoto EV)", "Stark Future", "Cake"
        ];

        function setupCustomSelect(inputId, optionsId, data) {
            const input = document.getElementById(inputId);
            const optionsContainer = document.getElementById(optionsId);

            data.forEach(item => {
                const div = document.createElement('div');
                if (typeof item === 'object' && item.type === 'group') {
                    div.className = 'option-group';
                    div.textContent = item.label;
                } else {
                    div.className = 'option';
                    div.textContent = item;
                    div.dataset.value = item;

                    div.addEventListener('click', () => {
                        input.value = div.dataset.value;
                        optionsContainer.classList.remove('show');
                    });
                }
                optionsContainer.appendChild(div);
            });

            input.addEventListener('focus', () => optionsContainer.classList.add('show'));

            input.addEventListener('keyup', () => {
                const filter = input.value.toLowerCase();
                const options = optionsContainer.getElementsByClassName('option');
                for (let i = 0; i < options.length; i++) {
                    const txtValue = options[i].textContent || options[i].innerText;
                    options[i].style.display = txtValue.toLowerCase().indexOf(filter) > -1 ? "" : "none";
                }
            });

            document.addEventListener('click', (event) => {
                if (!input.contains(event.target) && !optionsContainer.contains(event.target)) {
                    optionsContainer.classList.remove('show');
                }
            });
        }

        // Inicializar el dropdown personalizado
        document.addEventListener('DOMContentLoaded', () => {
            setupCustomSelect('marca', 'marca-options', vehicleBrands);
        });

        // --- LÓGICA PARA REGISTRAR VEHÍCULOS ---
        const registerForm = document.getElementById('vehicle-form');
        const submitButton = document.getElementById('submit-button');
        const formStatus = document.getElementById('form-status');

        registerForm.addEventListener('submit', function (event) {
            event.preventDefault();

            formStatus.textContent = 'Registrando vehículo...';
            formStatus.style.color = '#A0A0A0';
            submitButton.disabled = true;

            const formData = new FormData(registerForm);
            const data = {};
            formData.forEach((value, key) => { data[key] = value; });

            fetchWithAuth(VEHICLE_REGISTER_API_URL, {
                method: 'POST',
                body: JSON.stringify(data),
            })
                .then(async response => {
                    const contentType = response.headers.get('content-type') || '';
                    const isJson = contentType.includes('application/json');
                    const payload = isJson ? await response.json() : await response.text();

                    if (!response.ok || (isJson && payload && payload.ok === false)) {
                        const errorMessage = isJson && payload && payload.error
                            ? payload.error
                            : 'La respuesta del servidor no fue exitosa.';
                        throw new Error(errorMessage);
                    }

                    return payload;
                })
                .then(() => {
                    formStatus.textContent = '¡Vehículo registrado con éxito!';
                    formStatus.style.color = '#28a745';
                    registerForm.reset();
                    setTimeout(() => { formStatus.textContent = ''; }, 3000);
                })
                .catch(error => {
                    console.error('Error al enviar el formulario:', error);
                    formStatus.textContent = error.message || 'Hubo un error al registrar. Inténtalo de nuevo.';
                    formStatus.style.color = '#dc3545';
                })
                .finally(() => {
                    submitButton.disabled = false;
                });
        });

        // --- LÓGICA PARA BUSCAR VEHÍCULOS ---
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchResultsContainer = document.getElementById('search-results');
        const searchResultsInfo = document.getElementById('search-results-info');

        searchForm.addEventListener('submit', function (event) {
            event.preventDefault();
            const query = searchInput.value.trim();
            if (!query) {
                searchResultsInfo.textContent = 'Por favor, introduce un término de búsqueda.';
                return;
            }

            searchResultsInfo.textContent = 'Buscando...';
            searchButton.disabled = true;
            searchResultsContainer.innerHTML = '';

            const urlWithQuery = `${MAKE_VEHICLE_SEARCH_WEBHOOK_URL}?query=${encodeURIComponent(query)}`;

            fetch(urlWithQuery)
                .then(response => {
                    if (!response.ok) throw new Error('Error en la respuesta del servidor.');
                    return response.text();
                })
                .then(text => {
                    if (!text || text.trim() === 'Accepted') {
                        displayVehicleSearchResults([]);
                        return;
                    }
                    try {
                        const results = JSON.parse(text);
                        displayVehicleSearchResults(results);
                    } catch (parseError) {
                        console.error('Error al buscar: Error al procesar la respuesta del servidor.', parseError);
                        searchResultsInfo.textContent = 'La respuesta del servidor no tuvo un formato válido.';
                        searchResultsInfo.style.color = '#dc3545';
                    }
                })
                .catch(error => {
                    console.error('Error al buscar:', error);
                    searchResultsInfo.textContent = 'Error al realizar la búsqueda.';
                    searchResultsInfo.style.color = '#dc3545';
                })
                .finally(() => {
                    searchButton.disabled = false;
                });
        });

        function displayVehicleSearchResults(results) {
            const resultsArray = Array.isArray(results) ? results : [results];

            if (resultsArray.length === 0) {
                searchResultsInfo.textContent = 'No se encontraron vehículos.';
                searchResultsInfo.style.color = '#A0A0A0';
                return;
            }

            searchResultsInfo.textContent = `Se encontraron ${resultsArray.length} resultados.`;
            searchResultsInfo.style.color = '#28a745';

            resultsArray.forEach(vehicle => {
                // CORRECCIÓN: Usar las claves con Mayúscula como las envía Make.
                if (!vehicle || !vehicle.Matricula) return;

                const listItem = document.createElement('div');
                listItem.className = 'search-result-item';

                listItem.innerHTML = `
                    <div class="vehicle-avatar">${vehicle.Matricula}</div>
                    <div class="vehicle-info">
                        <div class="name">${vehicle.Marca || ''} ${vehicle.Modelo || ''}</div>
                        <div class="detail">
                            <div><strong>Matrícula:</strong> ${vehicle.Matricula || 'N/A'}</div>
                            <div><strong>Marca:</strong> ${vehicle.Marca || 'N/A'}</div>
                            <div><strong>Año:</strong> ${vehicle.Año || 'N/A'}</div>
                        </div>
                    </div>
                `;
                searchResultsContainer.appendChild(listItem);
            });
        }
    </script>
</body>

</html>