<!DOCTYPE html>
<html class="dark" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Copiloto IA - Chat | FinSaaS</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#46ec13",
                        "background-light": "#f6f8f6",
                        "background-dark": "#142210",
                        "surface-dark": "#1a2c15",
                        "surface-dark-light": "#25381e",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"],
                    },
                },
            },
        }
    </script>

    <link href="/src/verticals/finsaas/layout/FinSaaSLayout.css" rel="stylesheet" />
    <style>
        /* Scrollbar */
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(70, 236, 19, 0.3);
            border-radius: 10px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        /* User bubble - right side, light green */
        .bubble-user {
            background: #d4f5c7;
            color: #142210;
            border-radius: 18px 18px 4px 18px;
            max-width: 75%;
        }

        /* AI bubble - left side, dark green */
        .bubble-ai {
            background: #1f3319;
            border: 1px solid rgba(70, 236, 19, 0.2);
            color: #e0e0e0;
            border-radius: 18px 18px 18px 4px;
            max-width: 85%;
        }

        /* Evidence panel */
        .evidence-box {
            background: rgba(70, 236, 19, 0.08);
            border: 1px solid rgba(70, 236, 19, 0.25);
            border-left: 4px solid #46ec13;
        }
    </style>
</head>

<body class="font-display bg-background-dark text-white antialiased overflow-hidden">
    <div id="app-shell" class="flex h-screen w-full overflow-hidden">
        <div class="max-w-4xl mx-auto flex flex-col w-full px-4 h-full py-6">

            <!-- Header -->
            <div class="flex items-center justify-between mb-4 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <button onclick="window.location.href='copiloto-resumen.html'"
                        class="p-2 hover:bg-surface-dark-light rounded-full transition-all">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </button>
                    <div>
                        <h1 class="text-xl font-extrabold tracking-tight">Copiloto IA</h1>
                        <p class="text-xs text-gray-500">Asesor Contable Inteligente</p>
                    </div>
                </div>

                <div class="flex items-center gap-2 bg-surface-dark border border-[#25381e] rounded-xl px-3 py-2">
                    <span class="material-symbols-outlined text-gray-400 text-[16px]">business</span>
                    <select id="empresa-selector"
                        class="bg-transparent text-sm font-bold focus:outline-none text-white min-w-[120px]">
                        <option value="">Cargando...</option>
                    </select>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-[#25381e] mb-4 flex-shrink-0">
                <a href="copiloto-resumen.html"
                    class="px-4 py-2 text-sm text-gray-500 hover:text-white transition-colors">Resumen</a>
                <a href="#" class="px-4 py-2 text-sm font-bold border-b-2 border-primary text-primary">Chat</a>
            </div>

            <!-- Chat Container -->
            <div
                class="flex-1 flex flex-col min-h-0 bg-surface-dark border border-[#25381e] rounded-2xl overflow-hidden">

                <!-- Messages -->
                <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 chat-container">

                    <!-- Welcome Message -->
                    <div class="flex justify-start">
                        <div class="bubble-ai p-4">
                            <p class="text-sm leading-relaxed">Hola, soy tu Copiloto Contable. Estoy conectado a tus
                                datos reales para ayudarte a entender tus finanzas. Â¿En quÃ© puedo ayudarte hoy?</p>
                            <div class="mt-3 flex flex-wrap gap-2" id="suggested-questions">
                                <button
                                    class="suggestion-btn px-3 py-1 bg-background-dark rounded-full text-xs font-medium border border-primary/30 hover:bg-primary hover:text-black transition-all">Â¿En
                                    quÃ© estoy gastando mÃ¡s?</button>
                                <button
                                    class="suggestion-btn px-3 py-1 bg-background-dark rounded-full text-xs font-medium border border-primary/30 hover:bg-primary hover:text-black transition-all">Â¿CÃ³mo
                                    va mi IVA este trimestre?</button>
                                <button
                                    class="suggestion-btn px-3 py-1 bg-background-dark rounded-full text-xs font-medium border border-primary/30 hover:bg-primary hover:text-black transition-all">Â¿Tengo
                                    anomalÃ­as este mes?</button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Input Area -->
                <div class="p-3 bg-surface-dark-light/50 border-t border-[#25381e] flex-shrink-0">
                    <div
                        class="flex gap-2 bg-surface-dark border border-primary/20 p-2 rounded-xl focus-within:border-primary transition-all">
                        <input type="text" id="chat-input" placeholder="Haz una pregunta sobre tu empresa..."
                            class="flex-1 bg-transparent border-none focus:ring-0 text-sm py-2 px-2 text-white placeholder-gray-500" />
                        <button id="send-btn"
                            class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center text-black hover:scale-105 active:scale-95 transition-all">
                            <span class="material-symbols-outlined">send</span>
                        </button>
                    </div>
                    <p class="text-[10px] text-center mt-2 text-gray-500">Toda respuesta se basa en datos reales de tu
                        empresa.</p>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { requireAuth, getToken, buildApiUrl } from '/auth.js';
        import { FinSaaSLayout } from '/src/verticals/finsaas/layout/FinSaaSLayout.js';

        let currentEmpresaId = localStorage.getItem('finsaas_current_empresa');
        let currentSessionId = null;

        async function init() {
            await requireAuth();
            const layout = new FinSaaSLayout('app-shell');
            layout.init();

            await loadEmpresas();
            setupEventListeners();

            const prefilled = localStorage.getItem('copilot_prefilled_question');
            if (prefilled) {
                localStorage.removeItem('copilot_prefilled_question');
                document.getElementById('chat-input').value = prefilled;
                sendMessage();
            }
        }

        async function loadEmpresas() {
            try {
                const res = await fetch(buildApiUrl('/api/contabilidad/empresas'), {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const { data } = await res.json();
                const select = document.getElementById('empresa-selector');
                select.innerHTML = '';

                data.items.forEach(emp => {
                    const opt = document.createElement('option');
                    opt.value = emp.id;
                    opt.textContent = emp.nombre_legal || emp.nombre_comercial;
                    if (emp.id == currentEmpresaId) opt.selected = true;
                    select.appendChild(opt);
                });

                if (!currentEmpresaId && data.items.length > 0) {
                    currentEmpresaId = data.items[0].id;
                    localStorage.setItem('finsaas_current_empresa', currentEmpresaId);
                }
            } catch (e) { console.error('Error cargando empresas:', e); }
        }

        function setupEventListeners() {
            document.getElementById('send-btn').onclick = sendMessage;
            document.getElementById('chat-input').onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };

            document.querySelectorAll('.suggestion-btn').forEach(btn => {
                btn.onclick = () => {
                    document.getElementById('chat-input').value = btn.innerText;
                    sendMessage();
                }
            });

            document.getElementById('empresa-selector').addEventListener('change', (e) => {
                currentEmpresaId = e.target.value;
                localStorage.setItem('finsaas_current_empresa', currentEmpresaId);
                location.reload();
            });
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            appendMessage('user', message);
            input.value = '';

            const loadingEl = appendMessage('ai', '<span class="animate-pulse text-primary">Analizando datos...</span>');

            try {
                const now = new Date();
                const year = now.getFullYear();

                const res = await fetch(buildApiUrl('/api/contabilidad/copiloto/chat'), {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Content-Type': 'application/json',
                        'X-Empresa-Id': currentEmpresaId
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        message: message,
                        periodo_inicio: `${year}-01-01`,
                        periodo_fin: `${year}-12-31`
                    })
                });

                const response = await res.json();

                if (!res.ok) {
                    throw new Error(response.error || 'Error del servidor');
                }

                currentSessionId = response.data.session_id;
                updateMessage(loadingEl, response.data.content, response.data.evidence);

            } catch (e) {
                console.error(e);
                loadingEl.querySelector('.bubble-ai').innerHTML = `<p class="text-sm text-red-400"><strong>Error:</strong> ${e.message}</p>`;
            }
        }

        function appendMessage(role, content) {
            const history = document.getElementById('chat-history');
            const wrapper = document.createElement('div');
            wrapper.className = role === 'user' ? 'flex justify-end' : 'flex justify-start';

            const bubble = document.createElement('div');
            bubble.className = role === 'user' ? 'bubble-user p-3' : 'bubble-ai p-4';
            bubble.innerHTML = `<p class="text-sm leading-relaxed">${content}</p>`;

            wrapper.appendChild(bubble);
            history.appendChild(wrapper);
            history.scrollTop = history.scrollHeight;
            return wrapper;
        }

        function updateMessage(wrapper, content, evidence) {
            const bubble = wrapper.querySelector('.bubble-ai');
            if (!bubble) return;

            // Simple formatting: newlines to <br>, bold **text**
            let html = content
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-primary">$1</strong>')
                .replace(/\n/g, '<br/>');

            bubble.innerHTML = `<div class="text-sm leading-relaxed">${html}</div>`;

            if (evidence && evidence.empresa) {
                const evidenceHtml = `
                    <div class="mt-4 p-3 rounded-lg evidence-box">
                        <p class="text-[10px] font-bold text-primary uppercase mb-2">ðŸ“Š Datos consultados</p>
                        <ul class="text-[11px] space-y-1 text-gray-400">
                            <li>â€¢ Empresa: ${evidence.empresa.nombre}</li>
                            <li>â€¢ Periodo: ${evidence.periodo.inicio} a ${evidence.periodo.fin}</li>
                            ${(evidence.tools_used || []).map(t => `<li class="text-primary/60">â€¢ ${t.tool}</li>`).join('')}
                        </ul>
                    </div>
                `;
                bubble.innerHTML += evidenceHtml;
            }

            const history = document.getElementById('chat-history');
            history.scrollTop = history.scrollHeight;
        }

        init();
    </script>
</body>

</html>