<!DOCTYPE html>
<html class="dark" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Empresas | FinSaaS</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#46ec13",
                        "background-light": "#f6f8f6",
                        "background-dark": "#142210",
                        "surface-dark": "#1a2c15",
                        "surface-dark-light": "#25381e",
                        "brand-orange": "#46ec13",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"],
                        "main": ["Manrope", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>

    <link href="/src/verticals/finsaas/layout/FinSaaSLayout.css" rel="stylesheet" />

    <style>
        .glass-table th {
            font-weight: 600;
            color: #9ca3af;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #1f2937;
        }

        .glass-table td {
            padding: 1rem;
            border-bottom: 1px solid #1f2937;
            font-size: 0.875rem;
        }

        .dark .glass-table th {
            border-bottom-color: #25381e;
            color: #9ca3af;
        }

        .dark .glass-table td {
            border-bottom-color: #25381e;
            color: #e5e7eb;
        }

        .status-badge {
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .status-true {
            background: rgba(74, 222, 128, 0.15);
            color: #4ade80;
            border: 1px solid rgba(74, 222, 128, 0.2);
        }

        .status-false {
            background: rgba(248, 113, 113, 0.15);
            color: #f87171;
            border: 1px solid rgba(248, 113, 113, 0.2);
        }

        /* Modal Overrides */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }

        .form-input {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            color: #111827;
        }

        .dark .form-input {
            background: #1a2c15;
            border-color: #25381e;
            color: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #46ec13;
            box-shadow: 0 0 0 1px #46ec13;
        }

        .form-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
            display: block;
        }

        .dark .form-label {
            color: #9ca3af;
        }
    </style>
</head>

<body
    class="font-display bg-background-light dark:bg-background-dark text-slate-900 dark:text-white antialiased overflow-hidden">

    <div id="app-shell" class="flex h-screen w-full overflow-hidden">

        <div class="max-w-7xl mx-auto flex flex-col gap-6 pb-10 h-full">

            <!-- Title & Actions -->
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-extrabold tracking-tight text-slate-900 dark:text-white">Mis Empresas</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">Gestiona las entidades fiscales de tu cuenta.</p>
                </div>
                <div>
                    <button onclick="openModal('create')"
                        class="px-4 py-2 bg-primary text-background-dark font-bold rounded-lg hover:brightness-110 transition-all shadow-[0_0_15px_rgba(70,236,19,0.3)] flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">add</span> Nueva Empresa
                    </button>
                </div>
            </div>

            <!-- Table Container -->
            <div
                class="flex-1 bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-xl shadow-sm flex flex-col overflow-hidden">
                <div class="overflow-auto flex-1">
                    <table class="w-full glass-table text-left border-collapse">
                        <thead class="bg-gray-50 dark:bg-surface-dark-light sticky top-0 z-10">
                            <tr>
                                <th>Nombre Legal</th>
                                <th>NIF / CIF</th>
                                <th>Email</th>
                                <th>Ciudad</th>
                                <th>Régimen</th>
                                <th>Estado</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="empresas-list" class="divide-y divide-gray-200 dark:divide-[#25381e]">
                            <tr>
                                <td colspan="7" class="p-8 text-center text-gray-500">Cargando empresas...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div
                    class="border-t border-gray-200 dark:border-[#25381e] p-4 flex justify-between items-center bg-gray-50 dark:bg-surface-dark-light/50">
                    <p class="text-xs text-gray-500">Total: <span id="total-count">0</span> empresas</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal -->
    <div id="empresa-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-overlay">
        <div
            class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-[#25381e]">
                <h2 id="modal-title" class="text-xl font-bold text-slate-900 dark:text-white">Nueva Empresa</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-red-500 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="overflow-y-auto p-6">
                <form id="empresa-form" onsubmit="saveEmpresa(event)">
                    <input type="hidden" id="e-id">

                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="form-label">Nombre Legal *</label>
                            <input type="text" id="e-nombre" class="form-input" required
                                placeholder="Ej. Mi Negocio S.L.">
                        </div>
                        <div>
                            <label class="form-label">Nombre Comercial</label>
                            <input type="text" id="e-nombre-comercial" class="form-input" placeholder="Ej. Mi Negocio">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="form-label">NIF / CIF *</label>
                            <input type="text" id="e-nif" class="form-input" required placeholder="B12345678"
                                style="text-transform: uppercase;">
                        </div>
                        <div>
                            <label class="form-label">Email *</label>
                            <input type="email" id="e-email" class="form-input" required
                                placeholder="contacto@empresa.com">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="form-label">Dirección Fiscal</label>
                            <input type="text" id="e-direccion" class="form-input" placeholder="Calle Principal, 1">
                        </div>
                        <div>
                            <label class="form-label">Teléfono</label>
                            <input type="tel" id="e-telefono" class="form-input" placeholder="+34 600 123 456">
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="form-label">C. Postal</label>
                            <input type="text" id="e-cp" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">Ciudad</label>
                            <input type="text" id="e-ciudad" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">Provincia</label>
                            <input type="text" id="e-provincia" class="form-input">
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="form-label">País</label>
                            <input type="text" id="e-pais" class="form-input" value="ES">
                        </div>
                        <div>
                            <label class="form-label">Moneda</label>
                            <select id="e-moneda" class="form-input">
                                <option value="EUR">EUR (€)</option>
                                <option value="USD">USD ($)</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">IVA Defecto %</label>
                            <input type="number" id="e-iva" class="form-input" value="21">
                        </div>
                    </div>

                    <div
                        class="bg-gray-50 dark:bg-surface-dark-light rounded-lg p-4 mb-6 border border-gray-200 dark:border-[#25381e]">
                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-4">Configuración Fiscal</h4>
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="form-label">Régimen</label>
                                <select id="e-regimen" class="form-input">
                                    <option value="GENERAL">General</option>
                                    <option value="SIMPLIFICADO">Simplificado</option>
                                    <option value="RECARGO">Recargo de Eq.</option>
                                </select>
                            </div>
                            <div class="flex items-center pt-6">
                                <label class="flex items-center gap-3 cursor-pointer select-none">
                                    <input type="checkbox" id="e-activo"
                                        class="form-checkbox h-5 w-5 text-primary rounded border-gray-300 dark:border-gray-600 focus:ring-primary">
                                    <span class="text-sm font-medium text-slate-700 dark:text-gray-300">Empresa
                                        Activa</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div
                class="p-6 border-t border-gray-200 dark:border-[#25381e] flex justify-end gap-3 bg-gray-50 dark:bg-surface-dark-light/30">
                <button type="button" onclick="closeModal()"
                    class="px-4 py-2 text-gray-500 hover:text-slate-900 dark:hover:text-white font-medium">Cancelar</button>
                <button
                    onclick="document.getElementById('empresa-form').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}))"
                    class="px-6 py-2 bg-primary text-background-dark font-bold rounded-lg hover:brightness-110 shadow-lg shadow-primary/20">Guardar</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { logout, getSession, requireAuth, getToken } from '/auth.js';
        import { FinSaaSLayout } from '/src/verticals/finsaas/layout/FinSaaSLayout.js';

        window.logout = logout;
        const API_BASE = '';
        let session = getSession(); // Initialize session properly

        function getAuthHeaders() {
            const token = session?.token || getToken();
            return { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
        }

        async function apiGet(endpoint) {
            console.log('[FinSaaS] API GET:', endpoint);
            const res = await fetch(API_BASE + endpoint, { headers: getAuthHeaders() });
            if (!res.ok) {
                console.error('[FinSaaS] API Error:', res.status);
                throw new Error('API Error ' + res.status);
            }
            return res.json();
        }


        async function apiPost(endpoint, data) {
            const res = await fetch(API_BASE + endpoint, { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(data) });
            return res.json();
        }

        async function apiPatch(endpoint, data) {
            const res = await fetch(API_BASE + endpoint, { method: 'PATCH', headers: getAuthHeaders(), body: JSON.stringify(data) });
            return res.json();
        }

        async function apiDelete(endpoint) {
            const res = await fetch(API_BASE + endpoint, { method: 'DELETE', headers: getAuthHeaders() });
            return res.ok;
        }

        async function loadEmpresas() {
            try {
                console.log('[FinSaaS] Loading empresas...');
                const res = await apiGet('/api/contabilidad/empresas');
                console.log('[FinSaaS] API Response:', res);

                const items = res.data?.items || res.items || res.data || [];
                const tbody = document.getElementById('empresas-list');

                if (!Array.isArray(items) || items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-500">No tienes empresas registradas</td></tr>';
                } else {
                    tbody.innerHTML = items.map(e => `
                        <tr class="cursor-pointer hover:bg-gray-50 dark:hover:bg-surface-dark-light/50 transition-colors group" onclick="editEmpresa(${e.id})">
                            <td class="font-bold text-slate-900 dark:text-white">${e.nombre_legal || e.nombre || 'Sin nombre'}</td>
                            <td class="text-gray-500 dark:text-gray-400 font-mono text-xs">${e.nif_cif || '-'}</td>
                            <td class="text-gray-500 dark:text-gray-400 text-xs">${e.email || '-'}</td>
                            <td class="text-gray-500 dark:text-gray-400">${e.ciudad || '-'}</td>
                            <td class="text-gray-500 dark:text-gray-400 text-xs">${e.regimen || 'GENERAL'}</td>
                            <td><span class="status-badge status-${e.activo}">${e.activo ? 'ACTIVA' : 'INACTIVA'}</span></td>
                            <td class="text-right">
                                <button onclick="event.stopPropagation(); deleteEmpresa(${e.id})" class="text-gray-400 hover:text-red-500 transition-colors">
                                    <span class="material-symbols-outlined text-[18px]">delete</span>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
                document.getElementById('total-count').textContent = Array.isArray(items) ? items.length : 0;
            } catch (e) {
                console.error('[FinSaaS] Error loading empresas:', e);
                document.getElementById('empresas-list').innerHTML = '<tr><td colspan="7" class="p-8 text-center text-red-500">Error al cargar empresas: ' + e.message + '</td></tr>';
            }
        }


        window.openModal = function (mode) {
            const modal = document.getElementById('empresa-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            if (mode === 'create') {
                document.getElementById('modal-title').textContent = 'Nueva Empresa';
                document.getElementById('empresa-form').reset();
                document.getElementById('e-id').value = '';
                document.getElementById('e-pais').value = 'ES';
                document.getElementById('e-moneda').value = 'EUR';
                document.getElementById('e-iva').value = '21';
                document.getElementById('e-activo').checked = true;
            }
        };

        window.closeModal = function () {
            const modal = document.getElementById('empresa-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        window.saveEmpresa = async function (e) {
            e.preventDefault();
            const data = {
                nombre_legal: document.getElementById('e-nombre').value,
                nombre_comercial: document.getElementById('e-nombre-comercial').value,
                nif_cif: document.getElementById('e-nif').value.toUpperCase(),
                email: document.getElementById('e-email').value,
                telefono: document.getElementById('e-telefono').value,
                direccion: document.getElementById('e-direccion').value,
                codigo_postal: document.getElementById('e-cp').value,
                ciudad: document.getElementById('e-ciudad').value,
                provincia: document.getElementById('e-provincia').value,
                pais: document.getElementById('e-pais').value,
                moneda: document.getElementById('e-moneda').value,
                iva_defecto: parseFloat(document.getElementById('e-iva').value) || 21,
                regimen: document.getElementById('e-regimen').value,
                activo: document.getElementById('e-activo').checked
            };
            const id = document.getElementById('e-id').value;
            try {
                let res;
                if (id) res = await apiPatch(`/api/contabilidad/empresas/${id}`, data);
                else res = await apiPost('/api/contabilidad/empresas', data);

                if (res.ok || res.id) {
                    closeModal();
                    loadEmpresas();
                } else alert('Error: ' + (res.error || 'Desconocido'));
            } catch (e) { alert('Error: ' + e.message); }
        };

        window.editEmpresa = async function (id) {
            try {
                const res = await apiGet(`/api/contabilidad/empresas/${id}`);
                const e = res.data || res;
                if (e) {
                    document.getElementById('e-id').value = e.id;
                    document.getElementById('e-nombre').value = e.nombre_legal || e.nombre || '';
                    document.getElementById('e-nombre-comercial').value = e.nombre_comercial || '';
                    document.getElementById('e-nif').value = e.nif_cif || '';
                    document.getElementById('e-email').value = e.email || '';
                    document.getElementById('e-telefono').value = e.telefono || '';
                    document.getElementById('e-direccion').value = e.direccion || '';
                    document.getElementById('e-cp').value = e.codigo_postal || '';
                    document.getElementById('e-ciudad').value = e.ciudad || '';
                    document.getElementById('e-provincia').value = e.provincia || '';
                    document.getElementById('e-pais').value = e.pais || 'ES';
                    document.getElementById('e-moneda').value = e.moneda || 'EUR';
                    document.getElementById('e-iva').value = e.iva_defecto || 21;
                    document.getElementById('e-regimen').value = e.regimen || 'GENERAL';
                    document.getElementById('e-activo').checked = e.activo !== false;

                    document.getElementById('modal-title').textContent = 'Editar Empresa';
                    document.getElementById('empresa-modal').classList.remove('hidden');
                    document.getElementById('empresa-modal').classList.add('flex');
                }
            } catch (e) { }
        };

        window.deleteEmpresa = async function (id) {
            if (!confirm('¿Eliminar empresa?')) return;
            try {
                if (await apiDelete(`/api/contabilidad/empresas/${id}`)) loadEmpresas();
                else alert('Error al eliminar');
            } catch (e) { alert('Error: ' + e.message); }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await requireAuth();
            const layout = new FinSaaSLayout('app-shell');
            layout.init();
            loadEmpresas();
        });

    </script>
</body>

</html>