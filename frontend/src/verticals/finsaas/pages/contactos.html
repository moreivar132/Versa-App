<!DOCTYPE html>
<html class="dark" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Contactos | FinSaaS</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#46ec13",
                        "background-light": "#f6f8f6",
                        "background-dark": "#142210",
                        "surface-dark": "#1a2c15",
                        "surface-dark-light": "#25381e",
                        "brand-orange": "#46ec13",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"],
                        "main": ["Manrope", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>

    <link href="/src/verticals/finsaas/layout/FinSaaSLayout.css" rel="stylesheet" />

    <style>
        .glass-table th {
            font-weight: 600;
            color: #9ca3af;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #1f2937;
        }

        .glass-table td {
            padding: 1rem;
            border-bottom: 1px solid #1f2937;
            font-size: 0.875rem;
        }

        .dark .glass-table th {
            border-bottom-color: #25381e;
            color: #9ca3af;
        }

        .dark .glass-table td {
            border-bottom-color: #25381e;
            color: #e5e7eb;
        }

        .type-badge {
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .type-CLIENTE {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .type-PROVEEDOR {
            background: rgba(249, 115, 22, 0.15);
            color: #fb923c;
            border: 1px solid rgba(249, 115, 22, 0.2);
        }

        .type-AMBOS {
            background: rgba(168, 85, 247, 0.15);
            color: #c084fc;
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        /* Modal Overrides */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }

        .form-input {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            color: #111827;
        }

        .dark .form-input {
            background: #1a2c15;
            border-color: #25381e;
            color: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #46ec13;
            box-shadow: 0 0 0 1px #46ec13;
        }

        .form-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
            display: block;
        }

        .dark .form-label {
            color: #9ca3af;
        }
    </style>
</head>

<body
    class="font-display bg-background-light dark:bg-background-dark text-slate-900 dark:text-white antialiased overflow-hidden">

    <div id="app-shell" class="flex h-screen w-full overflow-hidden">

        <div class="max-w-7xl mx-auto flex flex-col gap-6 pb-10 h-full">

            <!-- Title & Actions -->
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-extrabold tracking-tight text-slate-900 dark:text-white">Contactos</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">Gestiona clientes y proveedores fiscales.</p>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Total Badge -->
                    <div
                        class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-lg px-4 py-2 flex flex-col items-center">
                        <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Total</p>
                        <p id="stats-total" class="text-xl font-bold text-slate-900 dark:text-white">0</p>
                    </div>

                    <button onclick="openModal('create')"
                        class="px-4 py-2 bg-primary text-background-dark font-bold rounded-lg hover:brightness-110 transition-all shadow-lg shadow-primary/20 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">add</span> Nuevo Contacto
                    </button>
                </div>
            </div>

            <!-- Table Container -->
            <div
                class="flex-1 bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-xl shadow-sm flex flex-col overflow-hidden">

                <!-- Filters -->
                <div class="p-4 border-b border-gray-200 dark:border-[#25381e] flex flex-wrap items-center gap-4">
                    <!-- Empresa Selector -->
                    <!-- Global Selector in Topbar handles this now -->

                    <div class="h-6 w-px bg-gray-200 dark:bg-[#25381e]"></div>

                    <div class="relative flex-1 min-w-[200px]">
                        <span
                            class="absolute left-3 top-1/2 -translate-y-1/2 material-symbols-outlined text-gray-400 text-[18px]">search</span>
                        <input type="text" id="search-input" placeholder="Buscar contacto..."
                            class="w-full pl-9 pr-4 py-2 bg-gray-50 dark:bg-surface-dark-light border border-gray-200 dark:border-transparent rounded-lg text-sm focus:ring-1 focus:ring-primary focus:outline-none">
                    </div>

                    <select id="filter-tipo"
                        class="bg-gray-50 dark:bg-surface-dark-light border border-gray-200 dark:border-transparent text-slate-700 dark:text-white text-sm rounded-lg px-3 py-2 focus:outline-none">
                        <option value="">Todos los tipos</option>
                        <option value="CLIENTE">Clientes</option>
                        <option value="PROVEEDOR">Proveedores</option>
                        <option value="AMBOS">Ambos</option>
                    </select>
                </div>

                <div class="overflow-auto flex-1">
                    <table class="w-full glass-table text-left border-collapse">
                        <thead class="bg-gray-50 dark:bg-surface-dark-light sticky top-0 z-10">
                            <tr>
                                <th>Nombre Fiscal</th>
                                <th>NIF / CIF</th>
                                <th>Tipo</th>
                                <th>Empresa</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="contacts-list" class="divide-y divide-gray-200 dark:divide-[#25381e]">
                            <tr>
                                <td colspan="7" class="p-8 text-center text-gray-500">Cargando contactos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div
                    class="border-t border-gray-200 dark:border-[#25381e] p-4 flex justify-between items-center bg-gray-50 dark:bg-surface-dark-light/50">
                    <p class="text-xs text-gray-500">Mostrando <span id="showing-count">0</span> de <span
                            id="total-count">0</span></p>
                    <div class="flex gap-2">
                        <button id="btn-prev"
                            class="px-3 py-1 bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded text-xs hover:bg-gray-50 dark:hover:bg-surface-dark-light disabled:opacity-50">Anterior</button>
                        <button id="btn-next"
                            class="px-3 py-1 bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded text-xs hover:bg-gray-50 dark:hover:bg-surface-dark-light disabled:opacity-50">Siguiente</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal -->
    <div id="contact-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-overlay">
        <div
            class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-[#25381e]">
                <h2 id="modal-title" class="text-xl font-bold text-slate-900 dark:text-white">Nuevo Contacto</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-red-500 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="overflow-y-auto p-6">
                <form id="contact-form" onsubmit="saveContact(event)">
                    <input type="hidden" id="c-id">

                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div class="col-span-1">
                            <label class="form-label">Tipo de Contacto *</label>
                            <select id="c-tipo" class="form-input" required>
                                <option value="CLIENTE">Cliente</option>
                                <option value="PROVEEDOR">Proveedor</option>
                                <option value="AMBOS">Ambos</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="form-label">Empresa *</label>
                            <select id="c-empresa" class="form-input" required>
                                <option value="">Seleccionar empresa...</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div class="col-span-1">
                            <label class="form-label">NIF / CIF *</label>
                            <input type="text" id="c-nif" class="form-input" required placeholder="B12345678"
                                style="text-transform: uppercase;">
                        </div>

                        <div class="mb-6">
                            <label class="form-label">Nombre Fiscal (Razón Social) *</label>
                            <input type="text" id="c-nombre" class="form-input" required placeholder="Ej. Empresa S.L.">
                        </div>

                        <div class="grid grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="form-label">Email</label>
                                <input type="email" id="c-email" class="form-input" placeholder="contacto@empresa.com">
                            </div>
                            <div>
                                <label class="form-label">Teléfono</label>
                                <input type="tel" id="c-telefono" class="form-input" placeholder="+34 600 000 000">
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="col-span-2">
                                <label class="form-label">Dirección</label>
                                <input type="text" id="c-direccion" class="form-input" placeholder="Calle Ejemplo, 123">
                            </div>
                            <div>
                                <label class="form-label">C. Postal</label>
                                <input type="text" id="c-cp" class="form-input" placeholder="28000">
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="form-label">Ciudad</label>
                                <input type="text" id="c-ciudad" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Provincia</label>
                                <input type="text" id="c-provincia" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">País</label>
                                <input type="text" id="c-pais" class="form-input" value="ES">
                            </div>
                        </div>

                        <div
                            class="bg-gray-50 dark:bg-surface-dark-light rounded-lg p-4 mb-6 border border-gray-200 dark:border-[#25381e]">
                            <h4 class="text-xs font-bold text-gray-500 uppercase mb-4">Datos Financieros</h4>
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <label class="form-label">IBAN</label>
                                    <input type="text" id="c-iban" class="form-input font-mono"
                                        placeholder="ES00 0000 0000 00 0000000000">
                                </div>
                                <div>
                                    <label class="form-label">Condiciones de Pago</label>
                                    <input type="text" id="c-condiciones" class="form-input"
                                        placeholder="Ej. 30 días vto factura">
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="form-label">Notas</label>
                            <textarea id="c-notas" class="form-input" rows="2"
                                placeholder="Observaciones privadas..."></textarea>
                        </div>
                </form>
            </div>

            <div
                class="p-6 border-t border-gray-200 dark:border-[#25381e] flex justify-end gap-3 bg-gray-50 dark:bg-surface-dark-light/30">
                <button type="button" onclick="closeModal()"
                    class="px-4 py-2 text-gray-500 hover:text-slate-900 dark:hover:text-white font-medium">Cancelar</button>
                <button
                    onclick="document.getElementById('contact-form').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}))"
                    class="px-6 py-2 bg-primary text-background-dark font-bold rounded-lg hover:brightness-110 shadow-lg shadow-primary/20">Guardar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { logout, getSession, requireAuth, getToken, buildApiUrl } from '/auth.js';
        import { FinSaaSLayout } from '/src/verticals/finsaas/layout/FinSaaSLayout.js';

        window.logout = logout;
        let session = getSession(); // Initialize session properly
        let currentPage = 0;
        const PAGE_SIZE = 20;
        let currentEmpresaId = null;

        function getAuthHeaders() {
            const token = session?.token || getToken();
            const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
            if (currentEmpresaId) headers['X-Empresa-Id'] = currentEmpresaId;
            return headers;
        }

        async function apiGet(endpoint) {
            console.log('[FinSaaS] API GET:', endpoint);
            const res = await fetch(buildApiUrl(endpoint), { headers: getAuthHeaders() });
            if (!res.ok) {
                console.error('[FinSaaS] API Error:', res.status);
                throw new Error('API Error ' + res.status);
            }
            return res.json();
        }


        async function apiPost(endpoint, data) {
            const res = await fetch(buildApiUrl(endpoint), { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(data) });
            return res.json();
        }

        async function apiPatch(endpoint, data) {
            const res = await fetch(buildApiUrl(endpoint), { method: 'PATCH', headers: getAuthHeaders(), body: JSON.stringify(data) });
            return res.json();
        }

        function debounce(fn, ms) { let timer; return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), ms); }; }

        async function loadEmpresas() {
            currentEmpresaId = localStorage.getItem('finsaas_current_empresa') || localStorage.getItem('filsaas_current_empresa');
            loadContactos(0);
        }

        async function loadContactos(page = 0) {
            const tipo = document.getElementById('filter-tipo').value;
            const search = document.getElementById('search-input').value;
            let url = `/api/contabilidad/contactos?limit=${PAGE_SIZE}&offset=${page * PAGE_SIZE}`;
            if (tipo) url += `&tipo=${tipo}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;

            try {
                const res = await apiGet(url);
                const tbody = document.getElementById('contacts-list');
                const list = res.data || res;
                let items = [];
                let total = 0;
                if (Array.isArray(list)) { items = list; total = list.length; } else if (list.items) { items = list.items; total = list.total; }

                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-500">No se encontraron contactos</td></tr>';
                } else {
                    tbody.innerHTML = items.map(c => `
                        <tr class="cursor-pointer hover:bg-gray-50 dark:hover:bg-surface-dark-light/50 transition-colors group" onclick="editContact(${c.id})">
                            <td class="font-bold text-slate-900 dark:text-white">${c.nombre}</td>
                            <td class="text-gray-500 dark:text-gray-400 font-mono text-xs">${c.nif_cif}</td>
                            <td><span class="type-badge type-${c.tipo}">${c.tipo}</span></td>
                            <td class="text-gray-500 dark:text-gray-400 text-xs">${c.empresa_nombre || '-'}</td>
                            <td class="text-gray-500 dark:text-gray-400 text-sm">${c.email || '-'}</td>
                            <td class="text-gray-500 dark:text-gray-400 text-sm">${c.telefono || '-'}</td>
                            <td class="text-right">
                                <button onclick="event.stopPropagation(); deleteContact(${c.id})" class="text-gray-400 hover:text-red-500 transition-colors">
                                    <span class="material-symbols-outlined text-[18px]">delete</span>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
                document.getElementById('stats-total').textContent = total;
                document.getElementById('showing-count').textContent = items.length;
                document.getElementById('total-count').textContent = total;
                document.getElementById('btn-prev').disabled = page === 0;
                document.getElementById('btn-next').disabled = (page + 1) * PAGE_SIZE >= total;
                currentPage = page;
            } catch (e) { }
        }

        window.openModal = async function (mode) {
            const modal = document.getElementById('contact-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Populate empresa selector
            const empresaSelect = document.getElementById('c-empresa');
            try {
                const res = await apiGet('/api/contabilidad/empresas');
                empresaSelect.innerHTML = '';
                if (res.data && res.data.items && res.data.items.length > 0) {
                    res.data.items.forEach(emp => {
                        const opt = document.createElement('option');
                        opt.value = emp.id;
                        opt.textContent = emp.nombre_legal || emp.nombre_comercial;
                        empresaSelect.appendChild(opt);
                    });
                    // Default to first or currentEmpresaId
                    if (currentEmpresaId) empresaSelect.value = currentEmpresaId;
                } else {
                    empresaSelect.innerHTML = '<option value="">No hay empresas - Crear una primero</option>';
                }
            } catch (e) { console.error('Error loading empresas for modal:', e); }

            if (mode === 'create') {
                document.getElementById('modal-title').textContent = 'Nuevo Contacto';
                document.getElementById('contact-form').reset();
                document.getElementById('c-id').value = '';
                document.getElementById('c-pais').value = 'ES';
                // Reset empresa selector to current selection
                if (currentEmpresaId) empresaSelect.value = currentEmpresaId;
            }
        };
        window.closeModal = function () {
            const modal = document.getElementById('contact-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        window.saveContact = async function (e) {
            e.preventDefault();
            const data = {
                tipo: document.getElementById('c-tipo').value,
                nif_cif: document.getElementById('c-nif').value.toUpperCase(),
                nombre: document.getElementById('c-nombre').value,
                email: document.getElementById('c-email').value,
                telefono: document.getElementById('c-telefono').value,
                direccion: document.getElementById('c-direccion').value,
                codigo_postal: document.getElementById('c-cp').value,
                ciudad: document.getElementById('c-ciudad').value,
                provincia: document.getElementById('c-provincia').value,
                pais: document.getElementById('c-pais').value,
                condiciones_pago: document.getElementById('c-condiciones').value,
                iban: document.getElementById('c-iban').value,
                notas: document.getElementById('c-notas').value,
                id_empresa: document.getElementById('c-empresa').value || currentEmpresaId
            };
            const id = document.getElementById('c-id').value;
            try {
                let res;
                if (id) res = await apiPatch(`/api/contabilidad/contactos/${id}`, data);
                else res = await apiPost('/api/contabilidad/contactos', data);

                if (res.ok || res.id) {
                    closeModal();
                    loadContactos(currentPage);
                } else alert('Error: ' + (res.error || 'Desconocido'));
            } catch (e) { alert('Error: ' + e.message); }
        };

        window.editContact = async function (id) {
            try {
                // First open modal to populate empresa selector
                await openModal('edit');

                const res = await apiGet(`/api/contabilidad/contactos/${id}`);
                const c = res.data || res;
                if (c) {
                    document.getElementById('c-id').value = c.id;
                    document.getElementById('c-tipo').value = c.tipo;
                    document.getElementById('c-nif').value = c.nif_cif || '';
                    document.getElementById('c-nombre').value = c.nombre;
                    document.getElementById('c-email').value = c.email || '';
                    document.getElementById('c-telefono').value = c.telefono || '';
                    document.getElementById('c-direccion').value = c.direccion || '';
                    document.getElementById('c-cp').value = c.codigo_postal || '';
                    document.getElementById('c-ciudad').value = c.ciudad || '';
                    document.getElementById('c-provincia').value = c.provincia || '';
                    document.getElementById('c-pais').value = c.pais || 'ES';
                    document.getElementById('c-condiciones').value = c.condiciones_pago || '';
                    document.getElementById('c-iban').value = c.iban || '';
                    document.getElementById('c-notas').value = c.notas || '';
                    // Set empresa
                    if (c.id_empresa) document.getElementById('c-empresa').value = c.id_empresa;

                    document.getElementById('modal-title').textContent = 'Editar Contacto';
                }
            } catch (e) { console.error('Error loading contact:', e); }
        };

        window.deleteContact = async function (id) {
            if (!confirm('¿Eliminar contacto?')) return;
            try {
                if (await fetch(buildApiUrl(`/api/contabilidad/contactos/${id}`), { method: 'DELETE', headers: getAuthHeaders() }).then(r => r.ok)) loadContactos(currentPage);
            } catch (e) { }
        };

        async function init() {
            await requireAuth();
            const layout = new FinSaaSLayout('app-shell');
            layout.init();
            loadEmpresas();

            document.getElementById('filter-tipo').addEventListener('change', () => loadContactos(0));
            document.getElementById('search-input').addEventListener('input', debounce(() => loadContactos(0), 300));
            document.getElementById('btn-prev').addEventListener('click', () => loadContactos(currentPage - 1));
            document.getElementById('btn-next').addEventListener('click', () => loadContactos(currentPage + 1));
        }

        init();

    </script>
</body>

</html>