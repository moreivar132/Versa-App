<!DOCTYPE html>
<html class="dark" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Permisos y Roles | FinSaaS</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#46ec13",
                        "background-light": "#f6f8f6",
                        "background-dark": "#142210",
                        "surface-dark": "#1a2c15",
                        "surface-dark-light": "#25381e",
                        "brand-orange": "#46ec13",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"],
                        "main": ["Manrope", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>

    <link href="/src/verticals/finsaas/layout/FinSaaSLayout.css" rel="stylesheet" />
</head>

<body
    class="font-display bg-background-light dark:bg-background-dark text-slate-900 dark:text-white antialiased overflow-hidden">

    <div id="app-shell" class="flex h-screen w-full overflow-hidden">

        <div class="h-full flex flex-col p-6 w-full max-w-6xl mx-auto">

            <!-- Page Header -->
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8">
                <div>
                    <h1
                        class="text-3xl font-extrabold tracking-tight text-slate-900 dark:text-white flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary">admin_panel_settings</span>
                        Permisos y Roles
                    </h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">Gestiona los accesos y roles de los usuarios de tu
                        organización</p>
                </div>
            </div>

            <!-- Users List -->
            <div
                class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-2xl p-6 shadow-sm flex-1 overflow-hidden flex flex-col">

                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">group</span>
                        Usuarios del Tenant
                    </h2>
                    <button onclick="loadUsers()"
                        class="p-2 text-gray-500 hover:text-slate-900 dark:hover:text-white bg-gray-50 dark:bg-surface-dark-light rounded-lg transition-colors"
                        title="Recargar">
                        <span class="material-symbols-outlined">refresh</span>
                    </button>
                </div>

                <div class="overflow-x-auto flex-1">
                    <table class="w-full text-sm">
                        <thead
                            class="bg-gray-50 dark:bg-surface-dark-light border-b border-gray-200 dark:border-[#25381e] text-gray-500 text-xs uppercase sticky top-0 z-10">
                            <tr>
                                <th class="px-6 py-4 text-left font-bold">Usuario</th>
                                <th class="px-6 py-4 text-left font-bold">Rol Actual</th>
                                <th class="px-6 py-4 text-left font-bold">Empresas Asignadas</th>
                                <th class="px-6 py-4 text-center font-bold">Estado</th>
                                <th class="px-6 py-4 text-right font-bold">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-gray-100 dark:divide-[#25381e]">
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                    <span
                                        class="material-symbols-outlined text-4xl mb-2 block animate-spin">progress_activity</span>
                                    Cargando usuarios...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeModal()"></div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg bg-white dark:bg-surface-dark rounded-xl shadow-2xl border border-gray-200 dark:border-[#25381e] flex flex-col max-h-[90vh]">

            <div class="p-6 border-b border-gray-200 dark:border-[#25381e] flex items-center justify-between">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">manage_accounts</span>
                    Editar Accesos
                </h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="p-6 overflow-y-auto">
                <input type="hidden" id="edit-user-id">

                <div class="mb-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center text-primary font-bold text-xl"
                            id="edit-user-avatar">
                            US
                        </div>
                        <div>
                            <h3 class="font-bold text-lg" id="edit-user-name">Usuario</h3>
                            <p class="text-gray-500 text-sm" id="edit-user-email">email@ejemplo.com</p>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Rol del
                        Usuario</label>
                    <select id="edit-role-select"
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-surface-dark-light border border-gray-200 dark:border-[#25381e] rounded-xl outline-none focus:ring-2 focus:ring-primary transition-all">
                        <!-- Populated via JS -->
                    </select>
                    <p class="text-xs text-gray-500 mt-2">
                        <span class="font-bold">Nota:</span> ADMIN tiene acceso total a todo el tenant.
                    </p>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Acceso a
                        Empresas</label>
                    <div class="bg-gray-50 dark:bg-surface-dark-light border border-gray-200 dark:border-[#25381e] rounded-xl p-4 max-h-48 overflow-y-auto space-y-2"
                        id="edit-empresas-list">
                        <!-- Checkboxes populated via JS -->
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        Selecciona las empresas que este usuario puede ver y gestionar.
                    </p>
                </div>
            </div>

            <div
                class="p-6 border-t border-gray-200 dark:border-[#25381e] flex justify-end gap-3 bg-gray-50 dark:bg-surface-dark-light/30 rounded-b-xl">
                <button onclick="closeModal()"
                    class="px-5 py-2.5 text-gray-500 hover:text-gray-700 font-medium transition-colors">
                    Cancelar
                </button>
                <button onclick="saveUserAccess()"
                    class="px-6 py-2.5 bg-primary text-background-dark font-bold rounded-xl hover:brightness-110 shadow-lg shadow-primary/20 transition-all">
                    Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { getSession, requireAuth, getToken, fetchWithAuth } from '/auth.js';
        import { FinSaaSLayout } from '/src/verticals/finsaas/layout/FinSaaSLayout.js';

        let availableRoles = [];
        let availableEmpresas = [];
        let usersData = [];

        async function init() {
            const layout = new FinSaaSLayout('app-shell');
            layout.init();

            const session = await requireAuth();

            // Guard: Check Permission
            if (!layout.hasPermission('finsaas.rbac.manage', layout.getUserPermissions())) {
                document.body.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-screen bg-background-light dark:bg-background-dark">
                        <div class="text-center p-8 bg-white dark:bg-surface-dark rounded-2xl shadow-xl border border-gray-200 dark:border-[#25381e] max-w-md mx-4">
                            <div class="w-20 h-20 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-6">
                                <span class="material-symbols-outlined text-4xl text-red-500">lock</span>
                            </div>
                            <h1 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">Acceso Restringido</h1>
                            <p class="text-gray-500 dark:text-gray-400 mb-6">Esta sección es exclusiva para administradores.</p>
                            <a href="dashboard.html" class="inline-flex items-center justify-center px-6 py-3 bg-primary text-background-dark font-bold rounded-xl transition-transform hover:scale-105">
                                <span class="material-symbols-outlined mr-2">arrow_back</span>
                                Volver al Dashboard
                            </a>
                        </div>
                    </div>
                `;
                return;
            }

            // Load initial data
            await Promise.all([loadRoles(), loadEmpresas()]);
            loadUsers();
        }

        async function loadRoles() {
            try {
                const res = await fetchWithAuth('/api/finsaas/admin/rbac/roles');
                const data = await res.json();
                if (data.ok) availableRoles = data.roles;
            } catch (e) {
                console.error('Error loading roles', e);
            }
        }

        async function loadEmpresas() {
            try {
                const res = await fetchWithAuth('/api/finsaas/admin/rbac/empresas');
                const data = await res.json();
                if (data.ok) availableEmpresas = data.empresas;
            } catch (e) {
                console.error('Error loading empresas', e);
            }
        }

        window.loadUsers = async function () {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                        <span class="material-symbols-outlined text-4xl mb-2 block animate-spin">progress_activity</span>
                        Cargando usuarios...
                    </td>
                </tr>
            `;

            try {
                const res = await fetchWithAuth('/api/finsaas/admin/rbac/users');
                const data = await res.json();

                if (data.ok) {
                    usersData = data.users;
                    renderUsers(data.users);
                } else {
                    throw new Error(data.error);
                }
            } catch (e) {
                console.error('Error loading users', e);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-red-500">
                            <span class="material-symbols-outlined text-4xl mb-2 block">error</span>
                            Error al cargar usuarios: ${e.message}
                        </td>
                    </tr>
                `;
            }
        };

        function renderUsers(users) {
            const tbody = document.getElementById('users-table-body');

            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">No hay usuarios en este tenant.</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = users.map(user => {
                const roleName = user.roles && user.roles.length > 0 ? user.roles[0].nombre : 'Sin Rol';
                const initials = user.nombre.substring(0, 2).toUpperCase();
                const empresasCount = user.empresas ? user.empresas.length : 0;

                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-surface-dark-light transition-colors group">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center font-bold text-sm">
                                    ${initials}
                                </div>
                                <div>
                                    <div class="font-bold text-slate-900 dark:text-white">${user.nombre}</div>
                                    <div class="text-xs text-gray-500">${user.email}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 bg-gray-100 dark:bg-surface-dark-light rounded-full text-xs font-bold text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-[#25381e]">
                                ${roleName}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-sm text-gray-600 dark:text-gray-400">
                                ${empresasCount === 0 ? 'Ninguna' : empresasCount + ' empresa(s)'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium ${user.activo ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                <span class="w-1.5 h-1.5 rounded-full ${user.activo ? 'bg-green-500' : 'bg-red-500'}"></span>
                                ${user.activo ? 'Activo' : 'Inactivo'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="openEditModal(${user.id})" class="px-3 py-1.5 text-sm font-medium text-primary hover:bg-primary/10 rounded-lg transition-colors">
                                Editar Acceso
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        window.openEditModal = function (userId) {
            const user = usersData.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-user-name').textContent = user.nombre;
            document.getElementById('edit-user-email').textContent = user.email;
            document.getElementById('edit-user-avatar').textContent = user.nombre.substring(0, 2).toUpperCase();

            // Populate Roles
            const roleSelect = document.getElementById('edit-role-select');
            roleSelect.innerHTML = availableRoles.map(role => `
                <option value="${role.id}">${role.nombre}</option>
            `).join('');

            // Select current role
            if (user.roles && user.roles.length > 0) {
                roleSelect.value = user.roles[0].id;
            }

            // Populate Empresas
            const empresasList = document.getElementById('edit-empresas-list');
            const userEmpresaIds = new Set((user.empresas || []).map(e => e.id));

            if (availableEmpresas.length === 0) {
                empresasList.innerHTML = '<p class="text-sm text-gray-500 italic p-2">No hay empresas disponibles</p>';
            } else {
                empresasList.innerHTML = availableEmpresas.map(emp => `
                    <label class="flex items-center gap-3 p-2 hover:bg-gray-100 dark:hover:bg-surface-dark rounded cursor-pointer transition-colors">
                        <input type="checkbox" 
                            name="empresa_access" 
                            value="${emp.id}" 
                            class="w-4 h-4 text-primary rounded border-gray-300 focus:ring-primary"
                            ${userEmpresaIds.has(emp.id) ? 'checked' : ''}>
                        <span class="text-sm text-gray-700 dark:text-gray-300">${emp.nombre}</span>
                    </label>
                `).join('');
            }

            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.closeModal = function () {
            document.getElementById('edit-modal').classList.add('hidden');
        };

        window.saveUserAccess = async function () {
            const userId = document.getElementById('edit-user-id').value;
            const roleId = document.getElementById('edit-role-select').value;

            const empresaCheckboxes = document.querySelectorAll('input[name="empresa_access"]:checked');
            const empresaIds = Array.from(empresaCheckboxes).map(cb => parseInt(cb.value));

            const btn = document.querySelector('#edit-modal button:last-child');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin inline-block">⏳</span> Guardando...';

            try {
                const res = await fetchWithAuth(`/api/finsaas/admin/rbac/users/${userId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        roleId: parseInt(roleId),
                        empresaIds
                    })
                });

                const data = await res.json();

                if (data.ok) {
                    closeModal();
                    loadUsers();
                    // Show success toast?
                    alert('Accesos actualizados correctamente');
                } else {
                    alert(data.error || 'Error al guardar cambios');
                }
            } catch (e) {
                console.error('Error saving access', e);
                alert('Error al conectar con el servidor');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>