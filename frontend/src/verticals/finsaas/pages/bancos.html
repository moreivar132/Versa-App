<!DOCTYPE html>
<html class="dark" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Bancos | FinSaaS</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#46ec13",
                        "background-light": "#f6f8f6",
                        "background-dark": "#142210",
                        "surface-dark": "#1a2c15",
                        "surface-dark-light": "#25381e",
                        "brand-orange": "#46ec13",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"],
                        "main": ["Manrope", "sans-serif"]
                    },
                },
            },
        }
    </script>

    <link href="/src/verticals/finsaas/layout/FinSaaSLayout.css" rel="stylesheet" />

    <style>
        .glass-table th {
            font-weight: 600;
            color: #9ca3af;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #1f2937;
        }

        .glass-table td {
            padding: 1rem;
            border-bottom: 1px solid #1f2937;
            font-size: 0.875rem;
        }

        .dark .glass-table th {
            border-bottom-color: #25381e;
            color: #9ca3af;
        }

        .dark .glass-table td {
            border-bottom-color: #25381e;
            color: #e5e7eb;
        }

        .text-in {
            color: #4ade80;
        }

        .text-out {
            color: #f87171;
        }

        .bg-in {
            background-color: #4ade80;
        }

        .bg-out {
            background-color: #f87171;
        }

        .account-card-gradient {
            background: linear-gradient(135deg, rgba(70, 236, 19, 0.05) 0%, rgba(70, 236, 19, 0) 100%);
        }
    </style>
</head>

<body
    class="font-display bg-background-light dark:bg-background-dark text-slate-900 dark:text-white antialiased overflow-hidden">

    <div id="app-shell" class="flex h-screen w-full overflow-hidden bg-background-light dark:bg-background-dark">
        <!-- Main Content Area (Layout.js will inject sidebar here, so we need a container) -->
        <div class="flex-1 flex flex-col h-full overflow-hidden p-8">
            <div class="flex flex-col gap-8 h-full">

                <!-- Title & Header -->
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h1 class="text-3xl font-extrabold tracking-tight text-slate-900 dark:text-white">Bancos &
                            Conciliación</h1>
                        <p class="text-gray-500 dark:text-gray-400 mt-1">Gestiona tus movimientos bancarios y
                            conciliaciones.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="btn-ai-insights"
                            class="px-4 py-2 bg-slate-800 text-primary border border-primary/30 font-bold rounded-lg hover:bg-slate-700 transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined text-[18px]">psychology</span> Insights IA
                        </button>
                        <a href="/src/verticals/finsaas/pages/import-banking.html"
                            class="px-4 py-2 bg-primary text-background-dark font-bold rounded-lg hover:brightness-110 transition-all shadow-[0_0_15px_rgba(70,236,19,0.3)] flex items-center gap-2">
                            <span class="material-symbols-outlined text-[18px]">cloud_upload</span> Importar Extracto
                        </a>
                    </div>
                </div>

                <!-- Account Cards Row -->
                <div id="account-cards" class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Cards injected here -->
                </div>

                <!-- Main Section: Table & Toolbar -->
                <div
                    class="flex-1 bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-2xl shadow-sm flex flex-col overflow-hidden">

                    <!-- Table Toolbar -->
                    <div
                        class="p-4 border-b border-gray-200 dark:border-[#25381e] bg-gray-50/50 dark:bg-surface-dark-light/30 flex items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-bold uppercase text-gray-500 tracking-wider">Filtrar por
                                cuenta:</span>
                            <select id="filter-account"
                                class="bg-white dark:bg-surface-dark-light border border-gray-200 dark:border-[#25381e] rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all min-w-[200px]">
                                <option value="">Todas las cuentas</option>
                            </select>
                        </div>

                        <div class="hidden md:flex items-center gap-4 text-xs text-gray-400">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-in"></span> Ingresos
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-out"></span> Gastos
                            </div>
                        </div>
                    </div>

                    <!-- Table Body -->
                    <div class="flex-1 overflow-auto">
                        <table class="w-full glass-table text-left border-collapse">
                            <thead class="bg-gray-50 dark:bg-surface-dark-light sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="w-32">Fecha</th>
                                    <th>Descripción / Concepto</th>
                                    <th>Cuenta</th>
                                    <th class="text-right">Importe</th>
                                    <th class="w-32">Estado</th>
                                    <th class="w-20"></th>
                                </tr>
                            </thead>
                            <tbody id="bank-list" class="divide-y divide-gray-100 dark:divide-[#25381e]">
                                <tr>
                                    <td colspan="6" class="p-12 text-center text-gray-500">
                                        <div class="flex flex-col items-center gap-3">
                                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary">
                                            </div>
                                            <span>Sincronizando movimientos...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div
                        class="p-4 border-t border-gray-200 dark:border-[#25381e] flex justify-between items-center bg-gray-50 dark:bg-surface-dark-light/50">
                        <p class="text-sm text-gray-500">Mostrando <span id="showing-count"
                                class="font-bold text-slate-900 dark:text-white">0</span> de <span id="total-count"
                                class="font-bold text-slate-900 dark:text-white">0</span> movimientos</p>
                        <div class="flex gap-2">
                            <button id="btn-prev"
                                class="px-4 py-2 bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-surface-dark-light disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2">
                                <span class="material-symbols-outlined text-[18px]">chevron_left</span> Anterior
                            </button>
                            <button id="btn-next"
                                class="px-4 py-2 bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-surface-dark-light disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2">
                                Siguiente <span class="material-symbols-outlined text-[18px]">chevron_right</span>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>


        <!-- AI Analysis Modal -->
        <div id="ai-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4"
            style="background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);">
            <div
                class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-xl shadow-2xl w-full max-w-3xl max-h-[85vh] flex flex-col overflow-hidden">

                <div
                    class="p-6 border-b border-gray-200 dark:border-[#25381e] flex justify-between items-center bg-gradient-to-r from-surface-dark-light to-surface-dark">
                    <div>
                        <h2 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">psychology</span> Análisis Inteligente
                            de
                            Tesorería
                        </h2>
                        <p class="text-sm text-gray-500 mt-1">Análisis basado en tus últimos movimientos bancarios.</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="openNewCategoryModal()"
                            class="text-xs font-bold text-primary flex items-center gap-1 hover:brightness-110">
                            <span class="material-symbols-outlined text-[16px]">add_circle</span> Nueva Categoría
                        </button>
                        <button onclick="closeAiModal()" class="text-gray-400 hover:text-red-500 transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                </div>

                <div id="ai-content" class="flex-1 overflow-y-auto p-6 space-y-6">
                    <!-- AI Content injected here -->
                    <div class="flex flex-col items-center justify-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"></div>
                        <p class="text-gray-500">La IA está analizando tus movimientos financieros...</p>
                    </div>
                </div>

                <div
                    class="p-4 border-t border-gray-200 dark:border-[#25381e] flex justify-end bg-white dark:bg-surface-dark">
                    <button onclick="closeAiModal()"
                        class="px-6 py-2 bg-primary text-background-dark font-bold rounded-lg hover:brightness-110 shadow-lg shadow-primary/20">
                        Entendido
                    </button>
                </div>
            </div>
        </div>

        <!-- New Category Modal -->
        <div id="category-modal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4"
            style="background: rgba(0,0,0,0.5);">
            <div
                class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-xl shadow-2xl w-full max-w-md p-6">
                <h3 class="text-lg font-bold mb-4">Nueva Categoría Contable</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Nombre</label>
                        <input type="text" id="cat-name"
                            class="w-full bg-gray-50 dark:bg-surface-dark-light border border-gray-200 dark:border-[#25381e] rounded-lg px-3 py-2 text-sm focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Tipo</label>
                        <select id="cat-tipo"
                            class="w-full bg-gray-50 dark:bg-surface-dark-light border border-gray-200 dark:border-[#25381e] rounded-lg px-3 py-2 text-sm focus:outline-none">
                            <option value="GASTO">Gasto</option>
                            <option value="INGRESO">Ingreso</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Descripción (Opcional)</label>
                        <textarea id="cat-desc"
                            class="w-full bg-gray-50 dark:bg-surface-dark-light border border-gray-200 dark:border-[#25381e] rounded-lg px-3 py-2 text-sm focus:outline-none h-20"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="closeNewCategoryModal()"
                        class="px-4 py-2 text-gray-400 font-medium">Cancelar</button>
                    <button onclick="saveNewCategory()"
                        class="px-6 py-2 bg-primary text-background-dark font-bold rounded-lg hover:brightness-110">Crear
                        Categoría</button>
                </div>
            </div>
        </div>

        <!-- Reconcile Modal -->
        <div id="reconcile-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4"
            style="background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);">
            <div
                class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">

                <div
                    class="p-6 border-b border-gray-200 dark:border-[#25381e] flex justify-between items-center bg-gray-50 dark:bg-surface-dark-light">
                    <div>
                        <h2 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">link</span> Conciliar Movimiento
                        </h2>
                        <p class="text-sm text-gray-500 mt-1">Selecciona las facturas que corresponden a este
                            movimiento.
                        </p>
                    </div>
                    <button onclick="closeReconcileModal()" class="text-gray-400 hover:text-red-500 transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div class="flex flex-1 overflow-hidden">
                    <!-- Left: Transaction Info -->
                    <div
                        class="w-1/3 p-6 bg-gray-50 dark:bg-surface-dark-light/30 border-r border-gray-200 dark:border-[#25381e] overflow-y-auto">
                        <h3 class="text-xs font-bold uppercase text-gray-500 mb-4">Detalle del Banco</h3>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs text-gray-500">Fecha</label>
                                <p id="rec-tx-date" class="font-mono text-sm font-bold text-slate-900 dark:text-white">-
                                </p>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500">Concepto</label>
                                <p id="rec-tx-desc" class="text-sm text-slate-900 dark:text-white font-medium">-</p>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500">Importe</label>
                                <p id="rec-tx-amount" class="text-2xl font-bold font-mono">-</p>
                            </div>
                            <div class="pt-4 border-t border-gray-200 dark:border-[#25381e]">
                                <label class="block text-xs text-gray-500 mb-1">Total Asignado</label>
                                <p id="rec-total-assigned" class="text-lg font-bold text-blue-500">0,00 €</p>
                                <p id="rec-remaining" class="text-xs text-gray-400 mt-1">Restante: 0,00 €</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Invoice Selection -->
                    <div class="w-2/3 flex flex-col">
                        <div class="p-4 border-b border-gray-200 dark:border-[#25381e] flex items-center gap-2">
                            <div class="relative flex-1">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-[18px]">search</span>
                                <input type="text" id="inv-search" placeholder="Buscar factura (Nº, Cliente...)"
                                    class="w-full bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-lg pl-10 pr-3 py-2 text-sm focus:outline-none">
                            </div>
                            <div
                                class="flex items-center gap-2 px-3 py-2 bg-gray-50 dark:bg-surface-dark-light rounded-lg border border-gray-200 dark:border-[#25381e]">
                                <input type="checkbox" id="inv-show-all"
                                    class="w-4 h-4 text-primary rounded border-gray-300 focus:ring-primary">
                                <label for="inv-show-all" class="text-xs text-gray-400 cursor-pointer select-none">Ver
                                    todas</label>
                            </div>
                        </div>

                        <div class="flex-1 overflow-auto p-0">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-50 dark:bg-surface-dark-light sticky top-0 z-10">
                                    <tr>
                                        <th class="p-3 text-xs font-bold text-gray-500 uppercase w-10">
                                            <!-- Checkbox header if needed -->
                                        </th>
                                        <th class="p-3 text-xs font-bold text-gray-500 uppercase">Fecha</th>
                                        <th class="p-3 text-xs font-bold text-gray-500 uppercase">Nº / Tercero</th>
                                        <th class="p-3 text-xs font-bold text-gray-500 uppercase text-right">Total</th>
                                        <th class="p-3 text-xs font-bold text-gray-500 uppercase text-right">Pendiente
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="invoice-list" class="divide-y divide-gray-200 dark:divide-[#25381e]">
                                    <!-- Invoices here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div
                    class="p-4 border-t border-gray-200 dark:border-[#25381e] flex justify-end gap-3 bg-white dark:bg-surface-dark">
                    <button onclick="closeReconcileModal()"
                        class="px-4 py-2 text-gray-500 hover:text-slate-900 dark:hover:text-white font-medium">Cancelar</button>
                    <button onclick="confirmReconcile()" id="btn-confirm-rec" disabled
                        class="px-6 py-2 bg-primary text-background-dark font-bold rounded-lg hover:brightness-110 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-primary/20 flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">link</span> Confirmar Conciliación
                    </button>
                </div>
            </div>
        </div>

        <script type="module">
            import { logout, getSession, requireAuth, buildApiUrl } from '/auth.js';
            import { FinSaaSLayout } from '/src/verticals/finsaas/layout/FinSaaSLayout.js';

            window.logout = logout;
            let session = null;
            let currentEmpresaId = null;
            let currentPage = 0;
            let currentTransactions = [];
            const PAGE_SIZE = 50;

            function getAuthHeaders() {
                if (!session) session = JSON.parse(localStorage.getItem('versa_session_v1') || 'null');
                const headers = { 'Authorization': `Bearer ${session?.token}`, 'Content-Type': 'application/json' };
                if (currentEmpresaId) headers['X-Empresa-Id'] = currentEmpresaId;
                return headers;
            }

            async function apiGet(endpoint) {
                const res = await fetch(buildApiUrl(endpoint), { headers: getAuthHeaders() });
                if (!res.ok) throw new Error('API Error');
                return res.json();
            }

            async function apiPost(endpoint, data) {
                const res = await fetch(buildApiUrl(endpoint), { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(data) });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'API Error');
                }
                return res.json();
            }

            const formatCurrency = (val, cur = 'EUR') => new Intl.NumberFormat('es-ES', { style: 'currency', currency: cur }).format(val || 0);
            const formatDate = (d) => d ? new Date(d).toLocaleDateString('es-ES') : '-';

            async function loadEmpresas() {
                currentEmpresaId = localStorage.getItem('finsaas_current_empresa') || localStorage.getItem('filsaas_current_empresa');
                if (currentEmpresaId) {
                    loadAccounts();
                } else {
                    setTimeout(() => {
                        currentEmpresaId = localStorage.getItem('finsaas_current_empresa');
                        if (currentEmpresaId) loadAccounts();
                    }, 500);
                }
            }

            async function loadAccounts() {
                try {
                    let url = '/api/open-banking/accounts';
                    if (currentEmpresaId) url += `?id_empresa=${currentEmpresaId}`;

                    const res = await apiGet(url);
                    const accounts = res.accounts || [];

                    renderAccountCards(accounts);
                    renderAccountFilter(accounts);
                    loadMovimientos(0);

                } catch (e) { console.error('Error loading accounts:', e); }
            }

            function renderAccountCards(accounts) {
                const container = document.getElementById('account-cards');
                container.innerHTML = '';

                if (accounts.length === 0) {
                    container.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-4 border border-dashed border-gray-700 rounded-xl">No hay cuentas bancarias asociadas</div>';
                    return;
                }

                accounts.forEach(acc => {
                    const card = document.createElement('div');
                    card.className = "bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-xl p-5 shadow-sm flex flex-col justify-between hover:border-primary/50 hover:shadow-lg hover:shadow-primary/5 transition-all cursor-default group account-card-gradient";
                    card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 rounded-lg bg-primary/10 group-hover:bg-primary/20 transition-colors">
                             <span class="material-symbols-outlined text-primary">account_balance</span>
                        </div>
                        <span class="text-[10px] font-bold px-2 py-1 rounded bg-gray-100 dark:bg-surface-dark-light text-gray-500 uppercase tracking-wider">${acc.source}</span>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-900 dark:text-white group-hover:text-primary transition-colors">${acc.display_name}</h3>
                        <p class="text-[10px] text-gray-400 font-mono mt-1 opacity-70">${acc.iban_masked || 'IBAN no disponible'}</p>
                        <div class="mt-4 flex flex-col">
                            <span class="text-[10px] text-gray-500 uppercase font-bold tracking-widest">Saldo Actual</span>
                            <div class="text-2xl font-bold font-mono text-slate-900 dark:text-white mt-1">
                                ${formatCurrency(acc.balance || 0, acc.currency)} 
                            </div>
                        </div>
                    </div>
                `;
                    container.appendChild(card);
                });
            }

            function renderAccountFilter(accounts) {
                const select = document.getElementById('filter-account');
                select.innerHTML = '<option value="">Todas las cuentas</option>';
                accounts.forEach(acc => {
                    const opt = document.createElement('option');
                    opt.value = acc.id;
                    opt.textContent = acc.display_name;
                    select.appendChild(opt);
                });
                select.onchange = () => loadMovimientos(0);
            }

            async function loadMovimientos(page = 0) {
                const tbody = document.getElementById('bank-list');
                const accountId = document.getElementById('filter-account').value;

                try {
                    let url = `/api/open-banking/transactions?limit=${PAGE_SIZE}&offset=${page * PAGE_SIZE}`;
                    if (accountId) url += `&account_id=${accountId}`;
                    if (currentEmpresaId) url += `&id_empresa=${currentEmpresaId}`;

                    const res = await apiGet(url);

                    if (!res.transactions || res.transactions.length === 0) {
                        currentTransactions = [];
                        tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500">No hay movimientos bancarios</td></tr>';
                    } else {
                        currentTransactions = res.transactions;
                        tbody.innerHTML = res.transactions.map(t => {
                            const isIncome = t.amount >= 0;
                            const isReconciled = t.status === 'RECONCILED';
                            return `
                            <tr class="hover:bg-gray-50 dark:hover:bg-surface-dark-light/50 transition-colors">
                                <td class="text-gray-500 dark:text-gray-400 text-sm font-mono">${formatDate(t.booking_date)}</td>
                                <td class="font-medium text-slate-900 dark:text-white">${t.description || '-'}</td>
                                <td class="text-xs text-gray-400">...${t.bank_account_id ? t.bank_account_id.substr(-4) : '????'}</td>
                                <td class="text-right font-mono font-bold ${isIncome ? 'text-in' : 'text-out'}">${formatCurrency(t.amount, t.currency)}</td>
                                <td>
                                    ${isReconciled
                                    ? '<span class="px-2 py-1 rounded text-xs font-bold bg-green-500/10 text-green-500 flex items-center w-fit gap-1"><span class="material-symbols-outlined text-[14px]">check_circle</span> CONCILIADO</span>'
                                    : '<span class="px-2 py-1 rounded text-xs font-bold bg-yellow-500/10 text-yellow-500">PENDIENTE</span>'}
                                </td>
                                <td class="text-right">
                                    ${!isReconciled ? `
                                    <button onclick="window.openReconcileModal('${t.id}')" class="text-gray-400 hover:text-primary transition-colors bg-gray-100 dark:bg-surface-dark-light p-2 rounded-lg" title="Conciliar">
                                        <span class="material-symbols-outlined text-[18px]">link</span>
                                    </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `;
                        }).join('');
                    }

                    document.getElementById('showing-count').textContent = res.transactions?.length || 0;
                    document.getElementById('total-count').textContent = res.total || 0;
                    document.getElementById('btn-prev').disabled = page === 0;
                    document.getElementById('btn-next').disabled = !res.hasMore;
                    currentPage = page;
                } catch (e) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-red-500">Error cargando movimientos</td></tr>';
                    console.error('Error loading bank transactions:', e);
                }
            }

            // ================================================================
            // RECONCILIATION LOGIC
            // ================================================================

            let currentTransactionForReconcile = null;
            let selectedInvoices = new Set();
            let currentInvoices = [];

            window.openReconcileModal = async function (txId) {
                try {
                    const tx = currentTransactions.find(t => t.id === txId);
                    if (!tx) return;

                    currentTransactionForReconcile = tx;
                    selectedInvoices.clear();

                    const modal = document.getElementById('reconcile-modal');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');

                    document.getElementById('rec-tx-date').textContent = formatDate(tx.booking_date);
                    document.getElementById('rec-tx-desc').textContent = tx.description;
                    document.getElementById('rec-tx-amount').textContent = formatCurrency(tx.amount, tx.currency);
                    document.getElementById('rec-tx-amount').className = `text-2xl font-bold font-mono ${tx.amount >= 0 ? 'text-in' : 'text-out'}`;

                    updateReconcileTotals();
                    await loadPendingInvoices(tx);

                } catch (e) { console.error(e); alert('Error abriendo conciliación'); }
            };

            window.closeReconcileModal = function () {
                document.getElementById('reconcile-modal').classList.add('hidden');
                document.getElementById('reconcile-modal').classList.remove('flex');
                currentTransactionForReconcile = null;
            };

            async function loadPendingInvoices(tx) {
                const tbody = document.getElementById('invoice-list');
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Cargando facturas...</td></tr>';

                try {
                    const tipo = tx.amount < 0 ? 'GASTO' : 'INGRESO';
                    const search = document.getElementById('inv-search').value;
                    const showAll = document.getElementById('inv-show-all').checked;

                    let url = `/api/contabilidad/facturas?idEmpresa=${currentEmpresaId}&limit=50`;
                    if (!showAll) url += `&estado=PENDIENTE&tipo=${tipo}`;
                    if (search) url += `&search=${encodeURIComponent(search)}`;

                    const res = await apiGet(url);
                    currentInvoices = res.items || res.data || [];

                    if (currentInvoices.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">No hay facturas ${showAll ? '' : 'pendientes'} de este tipo</td></tr>`;
                        return;
                    }

                    tbody.innerHTML = currentInvoices.map(inv => {
                        const isSelected = selectedInvoices.has(inv.id);
                        const pending = parseFloat(inv.total) - parseFloat(inv.total_pagado || 0);

                        return `
                        <tr class="hover:bg-gray-50 dark:hover:bg-surface-dark-light/50 transition-colors cursor-pointer" onclick="window.toggleInvoice('${inv.id}')">
                             <td class="p-3">
                                <input type="checkbox" ${isSelected ? 'checked' : ''} class="w-4 h-4 text-primary rounded border-gray-300 focus:ring-primary pointer-events-none">
                             </td>
                             <td class="p-3 text-sm text-gray-500">${formatDate(inv.fecha_emision)}</td>
                             <td class="p-3">
                                 <div class="font-bold text-sm text-slate-900 dark:text-white">${inv.numero_factura}</div>
                                 <div class="text-xs text-gray-500">${inv.contacto_nombre || 'Sin contacto'}</div>
                             </td>
                             <td class="p-3 text-right text-sm font-mono">${formatCurrency(inv.total)}</td>
                             <td class="p-3 text-right text-sm font-mono text-orange-500 font-bold">${formatCurrency(pending)}</td>
                        </tr>
                    `;
                    }).join('');

                } catch (e) {
                    console.error(e);
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">Error cargando facturas</td></tr>';
                }
            }

            window.toggleInvoice = function (id) {
                if (selectedInvoices.has(id)) selectedInvoices.delete(id);
                else selectedInvoices.add(id);

                loadPendingInvoices(currentTransactionForReconcile);
                updateReconcileTotals();
            };

            function updateReconcileTotals() {
                let totalAssigned = 0;
                selectedInvoices.forEach(id => {
                    const inv = currentInvoices.find(i => i.id == id);
                    if (inv) totalAssigned += parseFloat(inv.total);
                });

                document.getElementById('rec-total-assigned').textContent = formatCurrency(totalAssigned);

                const txTotal = Math.abs(currentTransactionForReconcile?.amount || 0);
                const remaining = txTotal - totalAssigned;

                const remEl = document.getElementById('rec-remaining');
                remEl.textContent = `Diferencia: ${formatCurrency(remaining)}`;
                remEl.className = Math.abs(remaining) < 0.01 ? 'text-green-500 font-bold mt-1' : 'text-red-500 font-bold mt-1';

                document.getElementById('btn-confirm-rec').disabled = selectedInvoices.size === 0;
            }

            window.confirmReconcile = async function () {
                if (!currentTransactionForReconcile) return;
                const txId = currentTransactionForReconcile.id;
                const invoiceIds = Array.from(selectedInvoices);

                try {
                    await apiPost(`/api/open-banking/transactions/${txId}/reconcile`, { invoices: invoiceIds });
                    alert('Conciliación completada');
                    closeReconcileModal();
                    loadMovimientos(currentPage);
                } catch (e) {
                    alert('Error al conciliar: ' + e.message);
                }
            };

            async function init() {
                await requireAuth();
                const layout = new FinSaaSLayout('app-shell');
                layout.init();
                await loadEmpresas();

                document.getElementById('btn-prev').addEventListener('click', () => loadMovimientos(currentPage - 1));
                document.getElementById('btn-next').addEventListener('click', () => loadMovimientos(currentPage + 1));

                let debounceTimer;
                document.getElementById('inv-search').addEventListener('input', (e) => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        if (currentTransactionForReconcile) loadPendingInvoices(currentTransactionForReconcile);
                    }, 300);
                });
                document.getElementById('inv-show-all').addEventListener('change', () => {
                    if (currentTransactionForReconcile) loadPendingInvoices(currentTransactionForReconcile);
                });

                document.getElementById('btn-ai-insights').addEventListener('click', runAiAnalysis);
            }

            // ================================================================
            // AI ANALYSIS LOGIC
            // ================================================================

            async function runAiAnalysis() {
                if (currentTransactions.length === 0) {
                    alert('No hay movimientos cargados para analizar.');
                    return;
                }

                const modal = document.getElementById('ai-modal');
                const content = document.getElementById('ai-content');

                modal.classList.remove('hidden');
                modal.classList.add('flex');

                content.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"></div>
                    <p class="text-gray-500">Consultando con el experto contable IA...</p>
                </div>
            `;

                try {
                    const res = await apiPost('/api/open-banking/transactions/analyze', { transactions: currentTransactions });
                    const ai = res.analysis;

                    content.innerHTML = `
                    <!-- Resumen -->
                    <div class="bg-primary/5 border border-primary/20 rounded-xl p-5">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-xs font-bold uppercase text-primary flex items-center gap-1">
                                <span class="material-symbols-outlined text-[16px]">verified_user</span> Informe del Experto Contable
                            </h3>
                            <span class="text-[10px] bg-primary/20 text-primary px-2 py-0.5 rounded-full font-bold">ANÁLISIS ESTRATÉGICO</span>
                        </div>
                        <p class="text-sm dark:text-gray-200 leading-relaxed font-medium italic">"${ai.resumen_ejecutivo}"</p>
                    </div>

                    <!-- Análisis de Categorías -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xs font-bold uppercase text-gray-500 flex items-center gap-1">
                                <span class="material-symbols-outlined text-[16px]">pie_chart</span> Distribución y Por qué del Gasto
                            </h3>
                            <a href="/src/verticals/finsaas/pages/configuracion.html" class="text-[10px] text-primary hover:underline flex items-center gap-1">
                                <span class="material-symbols-outlined text-[12px]">add_circle</span> Gestionar Categorías
                            </a>
                        </div>
                        <div class="grid grid-cols-1 gap-3">
                            ${ai.analisis_categorias.map(cat => `
                                <div class="bg-surface-dark-light/40 border border-[#25381e] rounded-xl p-4 flex flex-col md:flex-row gap-4 items-start md:items-center">
                                    <div class="min-w-[120px]">
                                        <div class="text-xs font-bold text-white">${cat.categoria}</div>
                                        <div class="text-lg font-mono font-bold text-primary mt-1">${formatCurrency(cat.total)}</div>
                                        <div class="text-[10px] text-gray-500">${cat.porcentaje} del total analizado</div>
                                    </div>
                                    <div class="flex-1 text-xs text-gray-400 border-l border-[#25381e] pl-4 leading-relaxed">
                                        <span class="text-primary font-bold">Comentario del experto:</span> ${cat.comentario_experto}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Alertas y Consejos -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-red-500/5 border border-red-500/10 rounded-xl p-4 space-y-3">
                            <h3 class="text-xs font-bold uppercase text-red-400 flex items-center gap-1">
                                <span class="material-symbols-outlined text-[16px]">report_problem</span> Riesgos & Anomalías
                            </h3>
                            <ul class="space-y-2">
                                ${ai.alertas.map(a => `<li class="text-[11px] flex items-start gap-2 text-gray-300"><span class="text-red-400 mt-0.5">•</span> ${a}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="bg-green-500/5 border border-green-500/10 rounded-xl p-4 space-y-3">
                            <h3 class="text-xs font-bold uppercase text-green-400 flex items-center gap-1">
                                <span class="material-symbols-outlined text-[16px]">auto_awesome</span> Consejos CFO
                            </h3>
                            <ul class="space-y-2">
                                ${ai.consejos_estrategicos.map(c => `<li class="text-[11px] flex items-start gap-2 text-gray-300"><span class="text-green-400 mt-0.5">•</span> ${c}</li>`).join('')}
                            </ul>
                        </div>
                    </div>

                    <!-- Sugerencias Contables -->
                    <div class="space-y-3">
                        <h3 class="text-xs font-bold uppercase text-gray-500 flex items-center gap-1">
                            <span class="material-symbols-outlined text-[16px]">account_tree</span> Sugerencias de Asiento
                        </h3>
                        <div class="bg-surface-dark-light/50 border border-[#25381e] rounded-xl overflow-hidden text-[10px]">
                            <table class="w-full text-left">
                                <thead class="bg-[#25381e]">
                                    <tr>
                                        <th class="p-2">Movimiento</th>
                                        <th class="p-2">Cuenta/Categoría</th>
                                        <th class="p-2">Razón Técnica</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${ai.sugerencias_contables.map(s => `
                                        <tr class="border-t border-[#25381e]">
                                            <td class="p-2 font-medium">${s.descripcion}</td>
                                            <td class="p-2 whitespace-nowrap"><span class="bg-primary/20 text-primary px-2 py-0.5 rounded">${s.categoria_sugerida}</span></td>
                                            <td class="p-2 text-gray-400">${s.razon_contable}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Deducibles -->
                    <div class="bg-blue-500/5 border border-blue-500/20 rounded-xl p-4 flex gap-4 items-center">
                        <div class="p-3 bg-blue-500/10 rounded-full">
                            <span class="material-symbols-outlined text-blue-400">receipt_long</span>
                        </div>
                        <div>
                            <h3 class="text-xs font-bold uppercase text-blue-400 flex items-center gap-1">
                                Plan de Optimización Fiscal
                            </h3>
                            <p class="text-[11px] dark:text-gray-300 mt-1">${ai.plan_accion_deducibles}</p>
                        </div>
                    </div>
                `;

                } catch (e) {
                    console.error(e);
                    content.innerHTML = `
                    <div class="bg-red-500/10 border border-red-500/20 rounded-xl p-8 text-center">
                        <span class="material-symbols-outlined text-red-500 text-4xl mb-4">error</span>
                        <p class="text-white font-bold">Error al generar insights</p>
                        <p class="text-gray-400 text-sm mt-2">${e.message}</p>
                    </div>
                `;
                }
            }

            window.closeAiModal = function () {
                document.getElementById('ai-modal').classList.add('hidden');
                document.getElementById('ai-modal').classList.remove('flex');
            };

            window.openNewCategoryModal = function () {
                document.getElementById('category-modal').classList.remove('hidden');
                document.getElementById('category-modal').classList.add('flex');
            };

            window.closeNewCategoryModal = function () {
                document.getElementById('category-modal').classList.add('hidden');
                document.getElementById('category-modal').classList.remove('flex');
            };

            window.saveNewCategory = async function () {
                const nombre = document.getElementById('cat-name').value;
                const tipo = document.getElementById('cat-tipo').value;
                const descripcion = document.getElementById('cat-desc').value;

                if (!nombre) return alert('El nombre es obligatorio');

                try {
                    await apiPost('/api/contabilidad/categorias', {
                        nombre,
                        tipo,
                        descripcion,
                        codigo: nombre.substring(0, 3).toUpperCase() + Math.floor(Math.random() * 1000), // Código temporal
                        id_empresa: currentEmpresaId
                    });
                    alert('Categoría creada con éxito');
                    closeNewCategoryModal();
                } catch (e) {
                    alert('Error al crear categoría: ' + e.message);
                }
            };

            init();

        </script>
</body>

</html>