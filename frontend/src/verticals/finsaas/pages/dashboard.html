<!DOCTYPE html>
<html class="dark" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Dashboard | FinSaaS</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#46ec13",
                        "background-light": "#f6f8f6",
                        "background-dark": "#142210",
                        "surface-dark": "#1a2c15",
                        "surface-dark-light": "#25381e",
                        "brand-orange": "#46ec13",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"],
                        "main": ["Manrope", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>

    <link href="/src/verticals/finsaas/layout/FinSaaSLayout.css" rel="stylesheet" />

    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body
    class="font-display bg-background-light dark:bg-background-dark text-slate-900 dark:text-white antialiased overflow-hidden">

    <div id="app-shell" class="flex h-screen w-full overflow-hidden">

        <div class="max-w-7xl mx-auto flex flex-col gap-6 pb-10 w-full">

            <!-- Welcome Header -->
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-extrabold tracking-tight text-slate-900 dark:text-white">Panel de Control
                    </h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1" id="welcome-message">Cargando resumen de
                        actividad...</p>
                </div>
                <div
                    class="flex items-center gap-2 bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-xl px-4 py-2 shadow-sm">
                    <span class="material-symbols-outlined text-gray-500 text-[18px]">business</span>
                    <select id="empresa-selector"
                        class="bg-transparent text-sm font-bold text-slate-700 dark:text-white focus:outline-none min-w-[150px]">
                        <option value="">Cargando empresas...</option>
                    </select>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div
                    class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] p-6 rounded-2xl shadow-sm group hover:border-primary/50 transition-all">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-2 bg-green-500/10 rounded-lg">
                            <span class="material-symbols-outlined text-green-500">trending_up</span>
                        </div>
                        <span
                            class="text-xs font-bold text-green-500 bg-green-500/10 px-2 py-1 rounded-full">+12.5%</span>
                    </div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Ingresos (Mes)</p>
                    <h3 class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="stat-ingresos">-- €</h3>
                </div>

                <div
                    class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] p-6 rounded-2xl shadow-sm group hover:border-primary/50 transition-all">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-2 bg-red-500/10 rounded-lg">
                            <span class="material-symbols-outlined text-red-500">payments</span>
                        </div>
                        <span class="text-xs font-bold text-red-500 bg-red-500/10 px-2 py-1 rounded-full">+3.2%</span>
                    </div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Gastos (Mes)</p>
                    <h3 class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="stat-gastos">-- €</h3>
                </div>

                <div
                    class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] p-6 rounded-2xl shadow-sm group hover:border-primary/50 transition-all">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-2 bg-blue-500/10 rounded-lg">
                            <span class="material-symbols-outlined text-blue-500">account_balance</span>
                        </div>
                        <span class="text-xs font-bold text-blue-500 bg-blue-500/10 px-2 py-1 rounded-full">OK</span>
                    </div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Resultado</p>
                    <h3 class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="stat-resultado">-- €</h3>
                </div>

                <div
                    class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] p-6 rounded-2xl shadow-sm group hover:border-primary/50 transition-all">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-2 bg-yellow-500/10 rounded-lg">
                            <span class="material-symbols-outlined text-yellow-500">pending_actions</span>
                        </div>
                        <span
                            class="text-xs font-bold text-yellow-500 bg-yellow-500/10 px-2 py-1 rounded-full text-center"
                            id="stat-alerts-count">4
                            Alertas</span>
                    </div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">IVA Estimado</p>
                    <h3 class="text-2xl font-bold text-slate-900 dark:text-white mt-1" id="stat-iva">-- €</h3>
                </div>
            </div>

            <!-- Charts & Lists Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1 min-h-0">
                <!-- Main Chart Area -->
                <div
                    class="lg:col-span-2 bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-2xl p-6 flex flex-col shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg">Evolución Financiera</h3>
                        <div class="flex gap-2">
                            <span class="text-xs text-slate-400">Últimos 6 meses</span>
                        </div>
                    </div>
                    <div class="flex-1 relative min-h-[300px]">
                        <canvas id="evolutionChart"></canvas>
                        <div id="chart-loader"
                            class="absolute inset-0 flex items-center justify-center bg-surface-dark/50 rounded-xl z-20">
                            <div class="text-center">
                                <span
                                    class="material-symbols-outlined text-4xl text-primary animate-spin mb-2">refresh</span>
                                <p class="text-xs text-gray-400">Cargando gráfico...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Banking Section -->
                <div
                    class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-2xl p-6 flex flex-col shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg">Conexión Bancaria</h3>
                        <span class="material-symbols-outlined text-gray-400">account_balance</span>
                    </div>

                    <div id="banking-status" class="flex-1 flex flex-col items-center justify-center text-center py-4">
                        <div
                            class="size-16 bg-gray-100 dark:bg-surface-dark-light rounded-full flex items-center justify-center mb-4">
                            <span class="material-symbols-outlined text-3xl text-gray-400">account_balance_wallet</span>
                        </div>
                        <p class="text-sm text-gray-500 mb-6">Conecta tus cuentas bancarias para sincronizar
                            transacciones automáticamente.</p>
                        <button onclick="linkBank()"
                            class="w-full px-4 py-2 bg-[#46ec13] text-background-dark font-bold rounded-xl hover:brightness-110 shadow-lg shadow-primary/20 transition-all flex items-center justify-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-[20px]">link</span> Conectar Banco
                        </button>
                        <button onclick="window.location.href='/src/verticals/finsaas/pages/import-banking.html'"
                            class="w-full px-4 py-2 bg-transparent border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-xl hover:bg-gray-50 dark:hover:bg-surface-dark-light transition-all">
                            Importar CSV/Excel (Manual)
                        </button>
                    </div>

                    <div id="banking-active" class="hidden flex-1 flex flex-col gap-4">
                        <div
                            class="flex items-center justify-between p-3 rounded-xl bg-green-500/10 border border-green-500/20">
                            <div class="flex items-center gap-3">
                                <span class="material-symbols-outlined text-green-500">check_circle</span>
                                <div>
                                    <p class="text-xs font-bold text-green-500 uppercase tracking-wider">Conectado</p>
                                    <p id="bank-name" class="text-sm font-bold text-slate-900 dark:text-white">TrueLayer
                                        Sandbox</p>
                                </div>
                            </div>
                            <button onclick="syncBank()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                                <span class="material-symbols-outlined text-xs">sync</span>
                            </button>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Última sincronización</span>
                                <span class="text-slate-900 dark:text-white font-medium" id="last-sync">Hoy,
                                    10:24</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-gray-500">Cuentas vinculadas</span>
                                <span class="text-slate-900 dark:text-white font-medium" id="linked-accounts">2</span>
                            </div>
                        </div>
                        <button onclick="location.href='/manager-taller-banking.html'"
                            class="w-full py-2 bg-gray-100 dark:bg-surface-dark-light text-xs font-bold rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 transition-all">Ver
                            detalle bancario</button>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div
                    class="bg-white dark:bg-surface-dark border border-gray-200 dark:border-[#25381e] rounded-2xl p-6 flex flex-col shadow-sm">
                    <h3 class="font-bold text-lg mb-6">Actividad Reciente</h3>
                    <div class="space-y-4 overflow-y-auto pr-2" id="recent-activity-list">
                        <p class="text-center text-gray-500 text-sm py-8">Cargando actividad...</p>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <script type="module">
        import { logout, getSession, requireAuth, getToken, buildApiUrl } from '/auth.js';
        import { FinSaaSLayout } from '/src/verticals/finsaas/layout/FinSaaSLayout.js';

        window.logout = logout;
        let session = getSession(); // Initialize session properly
        let currentEmpresaId = null;

        function formatCurrency(val) {
            return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(val || 0);
        }

        function getAuthHeaders() {
            const token = session?.token || getToken();
            const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
            if (currentEmpresaId) headers['X-Empresa-Id'] = currentEmpresaId;
            return headers;
        }

        async function apiGet(endpoint) {
            const url = buildApiUrl(endpoint);
            console.log('[FinSaaS] API GET:', url);
            const res = await fetch(url, { headers: getAuthHeaders() });
            if (!res.ok) {
                console.error('[FinSaaS] API Error:', res.status);
                throw new Error('API Error ' + res.status);
            }
            return res.json();
        }


        async function loadEmpresas() {
            try {
                const res = await apiGet('/api/contabilidad/empresas');
                const select = document.getElementById('empresa-selector');
                select.innerHTML = '';
                if (res.data && res.data.items && res.data.items.length > 0) {
                    res.data.items.forEach(emp => {
                        const opt = document.createElement('option');
                        opt.value = emp.id;
                        opt.textContent = emp.nombre_legal || emp.nombre_comercial || 'Sin nombre';
                        select.appendChild(opt);
                    });

                    const stored = localStorage.getItem('finsaas_current_empresa');
                    if (stored && res.data.items.find(e => e.id == stored)) {
                        currentEmpresaId = stored;
                        select.value = stored;
                    } else if (res.data.items.length > 0) {
                        currentEmpresaId = res.data.items[0].id;
                        select.value = currentEmpresaId;
                        localStorage.setItem('finsaas_current_empresa', currentEmpresaId);
                    }

                    // Only load dashboard if we have a valid empresa
                    if (currentEmpresaId) {
                        loadDashboardStats();
                    }

                    select.addEventListener('change', (e) => {
                        currentEmpresaId = e.target.value;
                        if (currentEmpresaId) {
                            localStorage.setItem('finsaas_current_empresa', currentEmpresaId);
                        }
                        loadDashboardStats();
                    });
                } else {
                    select.innerHTML = '<option value="">Sin empresas</option>';
                    // Show empty state
                    loadDashboardStats(); // This will show zeros
                }
            } catch (e) {
                console.error('[FinSaaS] Error loading empresas:', e);
                document.getElementById('empresa-selector').innerHTML = '<option value="">Error cargando empresas</option>';
            }
        }

        let evolutionChart = null;

        async function loadEvolutionChart() {
            const chartEl = document.getElementById('evolutionChart');
            const loader = document.getElementById('chart-loader');
            if (!chartEl) return;

            try {
                const res = await apiGet('/api/contabilidad/reports/evolucion');
                if (!res.ok) throw new Error('Failed to fetch evolution');

                // Process data for Chart.js
                // Group by mes, separate Ingresos/Egresos
                const rawData = res.data || [];
                const months = [...new Set(rawData.map(d => d.mes_nombre))];

                const ingresosByMonth = {};
                const egresosByMonth = {};

                rawData.forEach(d => {
                    if (d.tipo === 'INGRESO') ingresosByMonth[d.mes_nombre] = parseFloat(d.total);
                    else egresosByMonth[d.mes_nombre] = parseFloat(d.total);
                });

                const datasetIngresos = months.map(m => ingresosByMonth[m] || 0);
                const datasetEgresos = months.map(m => egresosByMonth[m] || 0);

                if (evolutionChart) {
                    evolutionChart.destroy();
                }

                evolutionChart = new Chart(chartEl, {
                    type: 'line',
                    data: {
                        labels: months.map(m => m.trim()),
                        datasets: [
                            {
                                label: 'Ingresos',
                                data: datasetIngresos,
                                borderColor: '#46ec13',
                                backgroundColor: 'rgba(70, 236, 19, 0.1)',
                                fill: true,
                                tension: 0.4,
                                borderWidth: 3,
                                pointRadius: 4,
                                pointBackgroundColor: '#46ec13'
                            },
                            {
                                label: 'Gastos',
                                data: datasetEgresos,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                fill: true,
                                tension: 0.4,
                                borderWidth: 3,
                                pointRadius: 4,
                                pointBackgroundColor: '#ef4444'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: { color: '#9ca3af', font: { family: 'Manrope', weight: 'bold' }, usePointStyle: true }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: '#1a2c15',
                                titleColor: '#fff',
                                bodyColor: '#9ca3af',
                                borderColor: '#25381e',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true,
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${formatCurrency(context.raw)}`
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { color: '#6b7280', font: { size: 10 } }
                            },
                            y: {
                                grid: { color: 'rgba(75, 85, 99, 0.1)' },
                                ticks: {
                                    color: '#6b7280',
                                    font: { size: 10 },
                                    callback: (value) => value >= 1000 ? (value / 1000).toFixed(1) + 'k' : value
                                }
                            }
                        }
                    }
                });

                loader.classList.add('hidden');
            } catch (e) {
                console.error('Error loading evolution chart:', e);
                loader.innerHTML = '<p class="text-xs text-red-400">Error al cargar datos</p>';
            }
        }

        async function loadDashboardStats() {
            if (!currentEmpresaId) {
                document.getElementById('stat-ingresos').textContent = '-- €';
                document.getElementById('stat-gastos').textContent = '-- €';
                document.getElementById('stat-resultado').textContent = '-- €';
                document.getElementById('stat-iva').textContent = '-- €';
                document.getElementById('recent-activity-list').innerHTML = '<p class="text-center text-gray-500 text-sm py-8">Selecciona una empresa para ver estadísticas</p>';
                return;
            }

            try {
                // Load parallelly
                loadEvolutionChart();

                // Fetch real stats from API
                const res = await apiGet('/api/contabilidad/dashboard');

                if (res.ok && res.data) {
                    const data = res.data;

                    // Ingresos del mes
                    document.getElementById('stat-ingresos').textContent = formatCurrency(data.ingreso_mensual || 0);

                    // Gastos del mes
                    document.getElementById('stat-gastos').textContent = formatCurrency(data.gasto_mensual || 0);

                    // Resultado = Ingresos - Gastos
                    const resultado = (data.ingreso_mensual || 0) - (data.gasto_mensual || 0);
                    const resEl = document.getElementById('stat-resultado');
                    resEl.textContent = formatCurrency(resultado);
                    resEl.className = `text-2xl font-bold mt-1 ${resultado >= 0 ? 'text-green-500' : 'text-red-500'}`;

                    // IVA del trimestre
                    const ivaEstimado = data.iva_trimestre?.resultado || 0;
                    document.getElementById('stat-iva').textContent = formatCurrency(ivaEstimado);

                    // Update badges with counts if available
                    if (data.vencidas?.count > 0) {
                        const alertBadge = document.getElementById('stat-alerts-count');
                        if (alertBadge) {
                            alertBadge.textContent = `${data.vencidas.count} Vencidas`;
                            alertBadge.classList.replace('text-yellow-500', 'text-red-500');
                            alertBadge.classList.replace('bg-yellow-500/10', 'bg-red-500/10');
                        }
                    }
                }

                // Recent activity - show real data summary
                document.getElementById('recent-activity-list').innerHTML = `
                    <div class="flex items-start gap-3 p-3 rounded-xl bg-green-500/5 border border-green-500/10">
                        <div class="p-2 bg-green-500/10 rounded-lg">
                            <span class="material-symbols-outlined text-[18px] text-green-500">receipt_long</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-slate-900 dark:text-white">Por Cobrar</p>
                            <p class="text-xs text-gray-500">${res.data?.pendiente_cobrar?.count || 0} facturas pendientes</p>
                        </div>
                        <p class="text-sm font-bold text-green-500">${formatCurrency(res.data?.pendiente_cobrar?.total || 0)}</p>
                    </div>
                    <div class="flex items-start gap-3 p-3 rounded-xl bg-red-500/5 border border-red-500/10">
                        <div class="p-2 bg-red-500/10 rounded-lg">
                            <span class="material-symbols-outlined text-[18px] text-red-500">money_off</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-slate-900 dark:text-white">Por Pagar</p>
                            <p class="text-xs text-gray-500">${res.data?.pendiente_pagar?.count || 0} facturas pendientes</p>
                        </div>
                        <p class="text-sm font-bold text-red-500">${formatCurrency(res.data?.pendiente_pagar?.total || 0)}</p>
                    </div>
                    <div class="flex items-start gap-3 p-3 rounded-xl bg-blue-500/5 border border-blue-500/10">
                        <div class="p-2 bg-blue-500/10 rounded-lg">
                            <span class="material-symbols-outlined text-[18px] text-blue-500">account_balance_wallet</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-slate-900 dark:text-white">Saldo Caja</p>
                            <p class="text-xs text-gray-500">Balance actual</p>
                        </div>
                        <p class="text-sm font-bold text-blue-500">${formatCurrency(res.data?.saldo_caja || 0)}</p>
                    </div>
                `;

            } catch (e) {
                console.error('[FinSaaS] Error loading dashboard:', e);
            }
        }

        async function linkBank() {
            try {
                const url = buildApiUrl('/api/open-banking/truelayer/link');
                const res = await fetch(url, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ redirect_path: window.location.pathname })
                });
                const data = await res.json();
                if (data.ok && data.url) {
                    window.location.href = data.url;
                } else {
                    alert('Error al iniciar conexión: ' + (data.error || 'Desconocido'));
                }
            } catch (error) {
                console.error('Error linking bank:', error);
                alert('Incapaz de conectar con el servidor bancario.');
            }
        }

        async function checkBankingStatus() {
            try {
                const res = await apiGet('/api/open-banking/connections');
                if (res.ok && res.connections && res.connections.length > 0) {
                    document.getElementById('banking-status').classList.add('hidden');
                    document.getElementById('banking-active').classList.remove('hidden');
                    const conn = res.connections[0];
                    document.getElementById('bank-name').textContent = conn.provider_id || 'Banco Vinculado';
                }
            } catch (e) { }
        }

        async function init() {
            session = await requireAuth();
            if (session) {
                const welcomeEl = document.getElementById('welcome-message');
                if (welcomeEl) welcomeEl.textContent = `Hola, ${session.nombre}. Aquí tienes un resumen de hoy.`;
            }
            const layout = new FinSaaSLayout('app-shell');
            layout.init();
            await loadEmpresas();
            checkBankingStatus();
        }

        init();

    </script>
</body>

</html>