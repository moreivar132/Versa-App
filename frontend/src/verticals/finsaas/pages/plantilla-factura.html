<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factura | FinSaaS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <style>
        body {
            font-family: 'Manrope', sans-serif;
            background: #555;
        }

        .page {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 2rem auto;
            padding: 20mm;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        @media print {
            body {
                background: white;
                margin: 0;
            }

            .page {
                margin: 0;
                box-shadow: none;
                width: 100%;
                min-height: auto;
            }

            .no-print {
                display: none !important;
            }
        }

        .accent-bg {
            background-color: #46ec13;
        }

        .accent-text {
            color: #142210;
        }
    </style>
</head>

<body>

    <div class="no-print fixed top-4 right-4 flex gap-3">
        <button onclick="window.close()"
            class="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Cerrar</button>
        <button onclick="window.print()"
            class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-lg">Descargar PDF /
            Imprimir</button>
    </div>

    <div class="page text-gray-800" id="invoice-content">
        <!-- Header -->
        <div class="flex justify-between items-start mb-12">
            <div>
                <h1 class="text-4xl font-extrabold text-[#142210] tracking-tight">FACTURA</h1>
                <p id="factura-numero" class="text-xl text-gray-500 mt-2 font-medium">Loading...</p>
            </div>
            <div class="text-right">
                <!-- Logo placeholder -->
                <div
                    class="w-16 h-16 bg-[#46ec13] rounded-xl flex items-center justify-center text-[#142210] font-bold text-2xl mb-2 ml-auto">
                    V
                </div>
                <h2 id="empresa-nombre" class="font-bold text-lg">Tu Empresa</h2>
                <p id="empresa-dir" class="text-sm text-gray-500 whitespace-pre-line">Dirección empresa</p>
                <p id="empresa-nif" class="text-sm text-gray-500 mt-1">NIF: -</p>
            </div>
        </div>

        <!-- Info Grid -->
        <div class="grid grid-cols-2 gap-12 mb-12">
            <div>
                <p class="text-xs font-bold uppercase text-gray-400 tracking-wider mb-2">Facturado a</p>
                <h3 id="cliente-nombre" class="text-xl font-bold text-[#142210]">Cliente</h3>
                <p id="cliente-dir" class="text-gray-600 mt-1 text-sm whitespace-pre-line">-</p>
                <p id="cliente-nif" class="text-gray-600 mt-1 text-sm">NIF: -</p>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-xs font-bold uppercase text-gray-400 tracking-wider mb-1">Fecha Emisión</p>
                    <p id="fecha-emision" class="font-bold text-[#142210]">-</p>
                </div>
                <div>
                    <p class="text-xs font-bold uppercase text-gray-400 tracking-wider mb-1">Fecha Vencimiento</p>
                    <p id="fecha-vencimiento" class="font-bold text-[#142210]">-</p>
                </div>
                <div>
                    <p class="text-xs font-bold uppercase text-gray-400 tracking-wider mb-1">Estado</p>
                    <span id="estado-badge"
                        class="px-2 py-1 rounded text-xs font-bold bg-gray-100 text-gray-500">PENDIENTE</span>
                </div>
            </div>
        </div>

        <!-- Concepts Table -->
        <table class="w-full mb-12">
            <thead>
                <tr class="border-b-2 border-[#142210]">
                    <th class="text-left py-3 font-bold text-sm uppercase">Concepto</th>
                    <th class="text-right py-3 font-bold text-sm uppercase">Cantidad</th>
                    <th class="text-right py-3 font-bold text-sm uppercase">Precio</th>
                    <th class="text-right py-3 font-bold text-sm uppercase">Total</th>
                </tr>
            </thead>
            <tbody id="line-items" class="text-sm">
                <!-- Fallback single line if no items -->
                <tr class="border-b border-gray-100">
                    <td class="py-4" id="main-concept">Servicios profesionales</td>
                    <td class="text-right py-4">1</td>
                    <td class="text-right py-4" id="main-base">0.00 €</td>
                    <td class="text-right py-4 font-bold" id="main-total">0.00 €</td>
                </tr>
            </tbody>
        </table>

        <!-- Totals -->
        <div class="flex justify-end mb-20">
            <div class="w-1/3">
                <div class="flex justify-between py-2 border-b border-gray-100">
                    <span class="text-gray-500 text-sm">Base Imponible</span>
                    <span id="total-base" class="font-bold">0.00 €</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-100">
                    <span class="text-gray-500 text-sm">IVA (<span id="iva-pct">21</span>%)</span>
                    <span id="total-iva" class="font-bold">0.00 €</span>
                </div>
                <!-- IRPF placeholder if needed -->

                <div class="flex justify-between py-4 text-xl">
                    <span class="font-extrabold">TOTAL</span>
                    <span id="total-final" class="font-extrabold text-[#142210]">0.00 €</span>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="border-t border-gray-200 pt-8">
            <h4 class="font-bold text-sm mb-2">Métodos de Pago</h4>
            <p id="notas" class="text-sm text-gray-500 italic">Transferencia bancaria a: ES00 0000 0000 0000 0000</p>
        </div>

    </div>

    <script type="module">
        import { getSession, getApiBaseUrl } from '/auth.js';

        const API_BASE = getApiBaseUrl();
        const session = getSession();

        // Load config from localStorage
        function applyConfig() {
            const config = JSON.parse(localStorage.getItem('finsaas_invoice_config') || '{}');
            if (config.color) {
                document.documentElement.style.setProperty('--accent-color', config.color);

                // Apply dynamic color
                document.querySelectorAll('.accent-bg').forEach(el => el.style.backgroundColor = config.color);
                document.querySelectorAll('.accent-text').forEach(el => el.style.color = config.color);
                // Logo background
                const logo = document.querySelector('.w-16.h-16');
                if (logo) {
                    logo.style.backgroundColor = config.color;
                    logo.style.color = getContrastColor(config.color);
                }
                const headings = document.querySelectorAll('h1, h2, h3, h4, th');
                // Optional: color them? For now keeping black/dark green but respecting user choice if implemented deeper
            }
            if (config.footerText) {
                document.getElementById('notas').textContent = config.footerText;
            }
        }

        function getContrastColor(hex) {
            // Simple logic to decide white or black text based on background
            if (!hex) return 'white';
            const r = parseInt(hex.substr(1, 2), 16);
            const g = parseInt(hex.substr(3, 2), 16);
            const b = parseInt(hex.substr(5, 2), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#142210' : 'white';
        }

        async function loadInvoice() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if (!id) return alert('No invoice ID specified');

            applyConfig(); // Apply basic placeholders first

            try {
                const res = await fetch(`${API_BASE}/api/contabilidad/facturas/${id}`, {
                    headers: { 'Authorization': `Bearer ${session?.token}` }
                });
                const f = await res.json();

                if (f.error) throw new Error(f.error);
                const data = f.data || f;

                // Fill data
                document.getElementById('factura-numero').textContent = data.numero_factura;
                document.getElementById('fecha-emision').textContent = new Date(data.fecha_emision).toLocaleDateString();
                document.getElementById('fecha-vencimiento').textContent = data.fecha_vencimiento ? new Date(data.fecha_vencimiento).toLocaleDateString() : '-';

                document.getElementById('estado-badge').textContent = data.estado;

                // Format Currency
                const fmt = (v) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(v);

                // Try to parse structured notas for items
                let notasData = null;
                let publicNotes = '';
                try {
                    notasData = typeof data.notas === 'string' ? JSON.parse(data.notas) : data.notas;
                    publicNotes = notasData?.public_notes || '';
                } catch (e) {
                    publicNotes = data.notas || '';
                }

                // Render line items
                const tbody = document.getElementById('line-items');
                if (notasData && notasData.items && notasData.items.length > 0) {
                    tbody.innerHTML = notasData.items.map(item => `
                        <tr class="border-b border-gray-100">
                            <td class="py-4">${item.concepto}</td>
                            <td class="text-right py-4">${item.cantidad}</td>
                            <td class="text-right py-4">${fmt(item.precio)}</td>
                            <td class="text-right py-4 font-bold">${fmt(item.subtotal)}</td>
                        </tr>
                    `).join('');
                } else {
                    // Fallback single line
                    document.getElementById('main-concept').textContent = 'Servicios profesionales';
                    document.getElementById('main-base').textContent = fmt(data.base_imponible);
                    document.getElementById('main-total').textContent = fmt(data.total);
                }

                document.getElementById('total-base').textContent = fmt(data.base_imponible);
                document.getElementById('iva-pct').textContent = data.iva_porcentaje;
                document.getElementById('total-iva').textContent = fmt(data.iva_importe);
                document.getElementById('total-final').textContent = fmt(data.total);

                // Set public notes if present
                if (publicNotes) {
                    const current = document.getElementById('notas').textContent;
                    if (current.includes('Transferencia')) {
                        document.getElementById('notas').textContent = publicNotes;
                    } else {
                        document.getElementById('notas').textContent = current + ' | ' + publicNotes;
                    }
                }

                // Initial Placeholder for client info
                document.getElementById('cliente-nombre').textContent = data.contacto_nombre || 'Cliente General';
                if (data.contacto_nif) document.getElementById('cliente-nif').textContent = 'NIF/CIF: ' + data.contacto_nif;

                // Fetch full contact and empresa details
                fetchDetails(data.id_contacto, data.id_empresa);

            } catch (e) {
                alert('Error loading invoice: ' + e.message);
                console.error(e);
            }
        }

        async function fetchDetails(contactId, empresaId) {
            try {
                if (contactId) {
                    const cRes = await fetch(`${API_BASE}/api/contabilidad/contactos/${contactId}`, { headers: { 'Authorization': `Bearer ${session?.token}` } });
                    const cWrapped = await cRes.json();

                    // Unpack response: items? data?
                    const c = cWrapped.data || cWrapped;

                    if (c && !c.error) {
                        // Priority: nombre_fiscal -> nombre
                        const name = c.nombre_fiscal || c.nombre || 'Cliente sin nombre';
                        const nif = c.nif_cif || c.nif || '-';
                        const w = (text) => text || '';
                        const address = [w(c.direccion), w(c.codigo_postal), w(c.ciudad), w(c.provincia), w(c.pais)].filter(Boolean).join(', ');

                        document.getElementById('cliente-nombre').textContent = name;
                        document.getElementById('cliente-dir').textContent = address || '-';
                        document.getElementById('cliente-nif').textContent = 'NIF: ' + nif;
                    }
                }
                if (empresaId) {
                    const eRes = await fetch(`${API_BASE}/api/contabilidad/empresas`, { headers: { 'Authorization': `Bearer ${session?.token}` } });
                    const eData = await eRes.json();
                    const items = eData.data?.items || eData.data || [];
                    const emp = items.find(x => x.id === empresaId);

                    if (emp) {
                        document.getElementById('empresa-nombre').textContent = emp.nombre_legal || emp.nombre_comercial;
                        document.getElementById('empresa-dir').textContent = [emp.direccion, emp.codigo_postal, emp.ciudad].filter(Boolean).join('\n');
                        document.getElementById('empresa-nif').textContent = 'NIF: ' + (emp.nif || '-');
                    }
                }
            } catch (e) { console.error(e); }
        }

        loadInvoice().then(applyConfig);
    </script>
</body>

</html>