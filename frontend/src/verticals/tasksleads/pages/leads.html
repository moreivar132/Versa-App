<!DOCTYPE html>
<html class="dark" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Leads | Tasks & Leads</title>

    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#3b82f6",
                        "background-dark": "#0f172a",
                        "surface-dark": "#1e293b",
                    },
                    fontFamily: { "display": ["Manrope", "sans-serif"] },
                },
            },
        }
    </script>
    <link href="/src/verticals/tasksleads/layout/TasksLeadsLayout.css" rel="stylesheet" />
</head>

<body class="font-display bg-background-dark text-white antialiased overflow-auto">
    <div class="max-w-7xl mx-auto p-6 flex flex-col gap-6">

        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center text-green-400">
                    <span class="material-symbols-outlined">person_add</span>
                </div>
                <div>
                    <a href="/src/verticals/tasksleads/pages/dashboard.html"
                        class="text-primary text-sm hover:underline mb-1 inline-block">← Dashboard</a>
                    <h1 class="text-3xl font-extrabold tracking-tight">Leads</h1>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <p class="text-sm font-bold" id="user-name">Usuario</p>
                    <p class="text-xs text-gray-500" id="user-tenant">Tenant</p>
                </div>
                <div class="flex gap-3">
                    <select id="filter-status" onchange="applyFilters()"
                        class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                        <option value="">Todos los estados</option>
                        <option value="new">Nuevo</option>
                        <option value="open">Abierto</option>
                        <option value="followup">Seguimiento</option>
                        <option value="won">Ganado</option>
                        <option value="lost">Perdido</option>
                    </select>
                    <button onclick="syncFromTimeline()"
                        class="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-500 transition-all"
                        id="sync-btn">
                        <span class="material-symbols-outlined">sync</span>
                        Sincronizar
                    </button>
                    <button onclick="openCreateModal()"
                        class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/80 transition-all">
                        <span class="material-symbols-outlined">add</span>
                        Nuevo Lead
                    </button>
                </div>
            </div>
        </div>

        <!-- Pending Chats from Timeline (collapsible) -->
        <div id="pending-chats-section"
            class="bg-surface-dark border border-emerald-700/50 rounded-2xl overflow-hidden hidden">
            <!-- Header with filters -->
            <div class="p-4 bg-emerald-900/20 border-b border-emerald-700/50">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div class="flex items-center gap-3 cursor-pointer" onclick="togglePendingSection()">
                        <span class="material-symbols-outlined text-emerald-400">chat</span>
                        <h3 class="font-bold text-emerald-400">Chats Pendientes de WhatsApp</h3>
                        <span class="text-xs px-2 py-1 rounded-full bg-emerald-500/20 text-emerald-300"
                            id="pending-count">0</span>
                        <span class="material-symbols-outlined text-gray-400"
                            id="pending-toggle-icon">expand_more</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <select id="filter-label" onchange="filterPendingByLabel()"
                            class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-1.5 text-sm">
                            <option value="">Todas las etiquetas</option>
                        </select>
                        <div class="flex items-center gap-2 text-xs">
                            <span class="text-gray-400">Tiempo promedio:</span>
                            <span id="avg-response-time" class="font-bold text-amber-400">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metrics by Label -->
            <div id="label-metrics" class="p-4 bg-slate-800/30 border-b border-emerald-700/30 hidden">
                <div class="flex flex-wrap gap-3" id="label-metrics-list"></div>
            </div>

            <!-- Chats List -->
            <div id="pending-chats-list" class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- Leads Table -->
        <div class="bg-surface-dark border border-slate-700 rounded-2xl overflow-hidden">
            <table class="w-full">
                <thead class="bg-slate-800">
                    <tr>
                        <th class="text-left px-6 py-4 text-sm font-semibold text-gray-400">Nombre / Empresa</th>
                        <th class="text-left px-6 py-4 text-sm font-semibold text-gray-400">Contacto</th>
                        <th class="text-left px-6 py-4 text-sm font-semibold text-gray-400">Canal</th>
                        <th class="text-left px-6 py-4 text-sm font-semibold text-gray-400">Estado</th>
                        <th class="text-left px-6 py-4 text-sm font-semibold text-gray-400">Interés</th>
                        <th class="text-right px-6 py-4 text-sm font-semibold text-gray-400">Acciones</th>
                    </tr>
                </thead>
                <tbody id="leads-table-body">
                    <tr>
                        <td colspan="6" class="text-center py-12 text-gray-400">Cargando...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="lead-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-surface-dark rounded-2xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-6" id="modal-title">Nuevo Lead</h2>
            <form id="lead-form" class="space-y-4">
                <input type="hidden" id="lead-id" />
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Nombre</label>
                        <input type="text" id="lead-name"
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Empresa</label>
                        <input type="text" id="lead-company"
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2" />
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Teléfono</label>
                        <input type="tel" id="lead-phone"
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Email</label>
                        <input type="email" id="lead-email"
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2" />
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Canal</label>
                        <select id="lead-channel"
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                            <option value="whatsapp">WhatsApp</option>
                            <option value="web">Web</option>
                            <option value="timeline">Timeline IA</option>
                            <option value="referral">Referido</option>
                            <option value="other">Otro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Estado</label>
                        <select id="lead-status"
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                            <option value="new">Nuevo</option>
                            <option value="open">Abierto</option>
                            <option value="followup">Seguimiento</option>
                            <option value="won">Ganado</option>
                            <option value="lost">Perdido</option>
                            <option value="closed">Cerrado</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Interés en</label>
                    <select id="lead-vertical" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                        <option value="">Sin especificar</option>
                        <option value="manager">Manager (Taller)</option>
                        <option value="saas">FinSaaS (Contabilidad)</option>
                        <option value="marketplace">Marketplace</option>
                        <option value="tasks_leads">Tasks & Leads</option>
                        <option value="other">Otro</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">Notas</label>
                    <textarea id="lead-notes" rows="3"
                        class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2"></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 px-4 py-2 bg-slate-600 rounded-lg hover:bg-slate-500">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-primary rounded-lg hover:bg-primary/80">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <script type="module">
        import { getSession, buildApiUrl } from '/auth.js';

        let session = null;
        let allLeads = [];
        let allPendingChats = [];
        let pendingChatsExpanded = true;

        window.openCreateModal = openCreateModal;
        window.closeModal = closeModal;
        window.editLead = editLead;
        window.deleteLead = deleteLead;
        window.closeLead = closeLead;
        window.applyFilters = applyFilters;
        window.syncFromTimeline = syncFromTimeline;
        window.togglePendingSection = togglePendingSection;
        window.filterPendingByLabel = filterPendingByLabel;
        window.showToast = showToast;

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            // Icons and colors configuration
            const config = {
                success: { icon: 'check_circle', bg: 'bg-slate-800', border: 'border-emerald-500/50', text: 'text-white', iconColor: 'text-emerald-400' },
                error: { icon: 'error', bg: 'bg-slate-800', border: 'border-red-500/50', text: 'text-white', iconColor: 'text-red-400' },
                info: { icon: 'info', bg: 'bg-slate-800', border: 'border-blue-500/50', text: 'text-white', iconColor: 'text-blue-400' }
            };

            const style = config[type] || config.info;

            toast.className = `transform translate-y-10 opacity-0 transition-all duration-300 pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl border ${style.bg} ${style.border} shadow-lg shadow-black/20 min-w-[300px] max-w-md`;
            toast.innerHTML = `
                <span class="material-symbols-outlined ${style.iconColor}">${style.icon}</span>
                <p class="text-sm font-medium ${style.text} flex-1">${message}</p>
                <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined text-sm">close</span>
                </button>
            `;

            container.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });

            // Auto remove
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        async function init() {
            session = await getSession();
            if (!session) {
                window.location.href = '/login.html';
                return;
            }
            document.getElementById('user-name').textContent = session.user.nombre || session.user.email;
            document.getElementById('user-tenant').textContent = `ID: ${session.user.id_tenant}`;
            document.getElementById('lead-form').addEventListener('submit', saveLead);

            loadLeads();
            loadPendingChats();
        }

        async function loadPendingChats() {
            try {
                const response = await fetch(buildApiUrl('/api/tasks-leads/timeline/pending'), {
                    headers: { 'Authorization': `Bearer ${session.token}`, 'X-Tenant-Id': session.user.id_tenant }
                });
                const { data: chats, ok } = await response.json();

                if (ok && chats && chats.length > 0) {
                    allPendingChats = chats;
                    document.getElementById('pending-chats-section').classList.remove('hidden');
                    document.getElementById('pending-count').textContent = chats.length;

                    // Populate label filter
                    populateLabelFilter(chats);

                    // Calculate and display metrics
                    calculateMetrics(chats);

                    // Render chats
                    renderPendingChats(chats);
                } else {
                    document.getElementById('pending-chats-section').classList.add('hidden');
                }
            } catch (error) {
                console.log('Timeline not available:', error.message);
            }
        }

        function populateLabelFilter(chats) {
            const allLabels = new Set();
            chats.forEach(c => (c.labels || []).forEach(l => allLabels.add(l)));

            const select = document.getElementById('filter-label');
            select.innerHTML = '<option value="">Todas las etiquetas</option>';

            [...allLabels].sort().forEach(label => {
                const count = chats.filter(c => (c.labels || []).includes(label)).length;
                select.innerHTML += `<option value="${label}">${label} (${count})</option>`;
            });
        }

        function calculateMetrics(chats) {
            const now = new Date();
            let totalMs = 0;
            let count = 0;
            const labelMetrics = {};

            chats.forEach(chat => {
                if (chat.last_message_at) {
                    const lastMsg = new Date(chat.last_message_at);
                    const waitMs = now - lastMsg;
                    totalMs += waitMs;
                    count++;

                    // Per-label metrics
                    (chat.labels || []).forEach(label => {
                        if (!labelMetrics[label]) labelMetrics[label] = { total: 0, count: 0 };
                        labelMetrics[label].total += waitMs;
                        labelMetrics[label].count++;
                    });
                }
            });

            // Overall average
            const avgMs = count > 0 ? totalMs / count : 0;
            document.getElementById('avg-response-time').textContent = formatDuration(avgMs);

            // Label metrics
            const metricsContainer = document.getElementById('label-metrics-list');
            const labelEntries = Object.entries(labelMetrics).sort((a, b) => b[1].count - a[1].count);

            if (labelEntries.length > 0) {
                document.getElementById('label-metrics').classList.remove('hidden');
                metricsContainer.innerHTML = labelEntries.map(([label, data]) => {
                    const avg = data.total / data.count;
                    const urgencyClass = avg > 86400000 ? 'text-red-400' : avg > 43200000 ? 'text-amber-400' : 'text-emerald-400';
                    return `
                        <div class="bg-slate-700/50 rounded-lg px-3 py-2 flex items-center gap-2">
                            <span class="text-xs font-semibold ${getLabelColor(label)}">${label}</span>
                            <span class="text-xs text-gray-400">(${data.count})</span>
                            <span class="text-xs font-bold ${urgencyClass}">${formatDuration(avg)}</span>
                        </div>
                    `;
                }).join('');
            } else {
                document.getElementById('label-metrics').classList.add('hidden');
            }
        }

        function filterPendingByLabel() {
            const selectedLabel = document.getElementById('filter-label').value;
            let filtered = allPendingChats;

            if (selectedLabel) {
                filtered = allPendingChats.filter(c => (c.labels || []).includes(selectedLabel));
            }

            renderPendingChats(filtered);
            document.getElementById('pending-count').textContent = filtered.length;
        }

        function renderPendingChats(chats) {
            const container = document.getElementById('pending-chats-list');
            const now = new Date();

            container.innerHTML = chats.map(chat => {
                const waitMs = chat.last_message_at ? now - new Date(chat.last_message_at) : 0;
                const waitClass = waitMs > 86400000 ? 'text-red-400' : waitMs > 43200000 ? 'text-amber-400' : 'text-gray-400';

                return `
                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700 hover:border-emerald-700/50 transition-all">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 flex-shrink-0">
                            <span class="material-symbols-outlined text-lg">person</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold truncate">${chat.full_name || chat.phone}</p>
                            <p class="text-xs text-gray-400">${chat.phone}</p>
                            <p class="text-xs text-emerald-400 mt-1">${chat.responsible || 'Sin asignar'}</p>
                        </div>
                    </div>
                    
                    <!-- Labels -->
                    ${(chat.labels && chat.labels.length > 0) ? `
                        <div class="mt-2 flex flex-wrap gap-1">
                            ${chat.labels.map(label => `
                                <span class="text-[10px] px-1.5 py-0.5 rounded ${getLabelColor(label)} bg-opacity-20">${label}</span>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- Time info -->
                    <div class="mt-3 flex items-center justify-between text-xs">
                        <div class="flex items-center gap-1 ${waitClass}">
                            <span class="material-symbols-outlined text-xs">schedule</span>
                            <span class="font-medium">${formatDuration(waitMs)}</span>
                        </div>
                        <a href="https://app.timelines.ai${chat.chat_url}" target="_blank" 
                           class="text-emerald-400 hover:underline flex items-center gap-1">
                            <span class="material-symbols-outlined text-xs">open_in_new</span>
                            Ver chat
                        </a>
                    </div>
                </div>
            `}).join('');
        }

        function getLabelColor(label) {
            const colors = {
                'Lead': 'bg-blue-500/20 text-blue-400',
                'Bicicleta': 'bg-green-500/20 text-green-400',
                'REPARTIDOR': 'bg-purple-500/20 text-purple-400',
                'CONTRATADO': 'bg-emerald-500/20 text-emerald-400',
                'S/DOCUMENTOS': 'bg-orange-500/20 text-orange-400',
                'COBRANZA': 'bg-red-500/20 text-red-400',
                'PAQUETERIA': 'bg-cyan-500/20 text-cyan-400',
                'TALLER/TESORO': 'bg-yellow-500/20 text-yellow-400'
            };
            return colors[label] || 'bg-slate-500/20 text-slate-400';
        }

        function formatDuration(ms) {
            if (!ms || ms <= 0) return '-';
            const mins = Math.floor(ms / 60000);
            const hours = Math.floor(ms / 3600000);
            const days = Math.floor(ms / 86400000);

            if (days > 0) return `${days}d ${hours % 24}h`;
            if (hours > 0) return `${hours}h ${mins % 60}m`;
            return `${mins}m`;
        }

        function formatTimeAgo(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            return formatDuration(diffMs);
        }

        function togglePendingSection() {
            pendingChatsExpanded = !pendingChatsExpanded;
            const list = document.getElementById('pending-chats-list');
            const metrics = document.getElementById('label-metrics');
            const icon = document.getElementById('pending-toggle-icon');
            list.classList.toggle('hidden', !pendingChatsExpanded);
            metrics.classList.toggle('hidden', !pendingChatsExpanded);
            icon.textContent = pendingChatsExpanded ? 'expand_less' : 'expand_more';
        }

        async function syncFromTimeline() {
            const btn = document.getElementById('sync-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span> Sincronizando...';

            try {
                const response = await fetch(buildApiUrl('/api/tasks-leads/timeline/sync'), {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.token}`,
                        'X-Tenant-Id': session.user.id_tenant,
                        'Content-Type': 'application/json'
                    }
                });
                const { data, message, ok } = await response.json();

                if (ok) {
                    showToast(message || `Sincronización completada: ${data?.created || 0} nuevos leads`, 'success');
                    loadLeads();
                    loadPendingChats();
                } else {
                    showToast('Error en sincronización', 'error');
                }
            } catch (error) {
                console.error('Sync error:', error);
                showToast('Error sincronizando con Timeline', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined">sync</span> Sincronizar';
            }
        }

        async function loadLeads() {
            const tbody = document.getElementById('leads-table-body');
            try {
                const response = await fetch(buildApiUrl('/api/tasks-leads/leads'), {
                    headers: { 'Authorization': `Bearer ${session.token}`, 'X-Tenant-Id': session.user.id_tenant }
                });
                const { data: leads } = await response.json();
                allLeads = leads || [];
                renderLeads(allLeads);
            } catch (error) {
                console.error('Error:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-12 text-red-400">Error cargando leads</td></tr>';
            }
        }

        function applyFilters() {
            const status = document.getElementById('filter-status').value;
            let filtered = [...allLeads];
            if (status) filtered = filtered.filter(l => l.status === status);
            renderLeads(filtered);
        }

        function getTagColor(tag) {
            const colors = {
                'BICI': 'bg-orange-500/20 text-orange-400 border-orange-500/30',
                'TALLER': 'bg-purple-500/20 text-purple-400 border-purple-500/30',
                'TESORO': 'bg-purple-500/20 text-purple-400 border-purple-500/30',
                'MOTO': 'bg-blue-500/20 text-blue-400 border-blue-500/30',
                'SAAS': 'bg-cyan-500/20 text-cyan-400 border-cyan-500/30',
                'URGENTE': 'bg-red-500/20 text-red-400 border-red-500/30 animate-pulse',
                'SOPORTE': 'bg-slate-500/20 text-slate-400 border-slate-500/30',
                'REPARTIDOR': 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
                'COBRANZA': 'bg-rose-500/20 text-rose-400 border-rose-500/30',
                'PAQUETERIA': 'bg-amber-600/20 text-amber-500 border-amber-600/30',
                'CONTRATADO': 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'
            };
            return colors[tag.toUpperCase()] || 'bg-slate-700/50 text-slate-400 border-slate-600';
        }

        function renderLeads(leads) {
            const tbody = document.getElementById('leads-table-body');

            if (!leads || leads.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="6" class="text-center py-12 text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">person_off</span>
                        <p>No hay leads</p>
                        <button onclick="openCreateModal()" class="mt-4 px-4 py-2 bg-primary rounded-lg">Crear primer lead</button>
                    </td></tr>
                `;
                return;
            }

            tbody.innerHTML = leads.map(lead => {
                const tagsList = lead.tags || [];
                const aiCategory = lead.ai_category;
                const aiSummary = lead.ai_summary;
                const aiUrgency = lead.ai_urgency;

                return `
                <tr class="border-b border-slate-700 hover:bg-slate-800/50 transition-all group">
                    <td class="px-6 py-4">
                        <div class="font-semibold flex items-center gap-2">
                            ${lead.full_name || '-'}
                            ${aiUrgency === 'ALTA' ? '<span class="w-2 h-2 rounded-full bg-red-500 animate-ping"></span>' : ''}
                        </div>
                        <div class="text-xs text-gray-500 mb-2">${lead.company || ''}</div>
                        
                        <!-- Auto Tags from Phase 2 -->
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${tagsList.map(tag => `
                                <span class="text-[9px] uppercase font-bold px-1.5 py-0.5 rounded border ${getTagColor(tag)}">
                                    ${tag}
                                </span>
                            `).join('')}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-slate-300">${lead.phone || '-'}</div>
                        <div class="text-xs text-gray-500">${lead.email || ''}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded-md border border-slate-600 bg-slate-700/50 text-slate-400">
                            ${getChannelLabel(lead.channel)}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-[10px] uppercase font-bold px-2 py-1 rounded-full ${getStatusClass(lead.status)}">
                            ${getStatusLabel(lead.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-col gap-1">
                            <span class="text-sm text-slate-300 font-semibold">${getVerticalLabel(lead.interested_vertical || aiCategory)}</span>
                            ${aiSummary ? `
                                <div class="flex items-start gap-1 text-[10px] text-gray-500 italic max-w-[200px] leading-tight" title="${aiSummary}">
                                    <span class="material-symbols-outlined text-[12px] text-emerald-500 flex-shrink-0">smart_toy</span>
                                    <span class="line-clamp-2">${aiSummary}</span>
                                </div>
                            ` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            ${lead.timeline_external_id ? `
                                <a href="https://app.timelines.ai/chat/${lead.timeline_external_id}" target="_blank" class="p-2 hover:bg-blue-500/20 rounded-lg text-blue-400 border border-transparent hover:border-blue-500/30" title="Ver chat en WhatsApp">
                                    <span class="material-symbols-outlined text-sm">chat</span>
                                </a>
                            ` : ''}
                            <button onclick="editLead(${lead.id})" class="p-2 hover:bg-slate-600 rounded-lg" title="Editar">
                                <span class="material-symbols-outlined text-sm">edit</span>
                            </button>
                            ${!['won', 'lost', 'closed'].includes(lead.status) ? `
                                <button onclick="closeLead(${lead.id}, 'won')" class="p-2 hover:bg-green-500/20 rounded-lg text-green-400" title="Marcar ganado">
                                    <span class="material-symbols-outlined text-sm">check_circle</span>
                                </button>
                                <button onclick="closeLead(${lead.id}, 'lost')" class="p-2 hover:bg-red-500/20 rounded-lg text-red-400" title="Marcar perdido">
                                    <span class="material-symbols-outlined text-sm">cancel</span>
                                </button>
                            ` : ''}
                            <button onclick="deleteLead(${lead.id})" class="p-2 hover:bg-red-500/20 rounded-lg text-red-400" title="Eliminar">
                                <span class="material-symbols-outlined text-sm">delete</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function getStatusClass(status) {
            return {
                'new': 'bg-blue-500/10 text-blue-400',
                'open': 'bg-green-500/10 text-green-400',
                'followup': 'bg-yellow-500/10 text-yellow-400',
                'won': 'bg-emerald-500/10 text-emerald-400',
                'lost': 'bg-red-500/10 text-red-400',
                'closed': 'bg-gray-500/10 text-gray-400'
            }[status] || 'bg-gray-500/10 text-gray-400';
        }

        function getStatusLabel(status) {
            return { 'new': 'Nuevo', 'open': 'Abierto', 'followup': 'Seguimiento', 'won': 'Ganado', 'lost': 'Perdido', 'closed': 'Cerrado' }[status] || status;
        }

        function getChannelLabel(channel) {
            return { 'whatsapp': 'WhatsApp', 'web': 'Web', 'timeline': 'Timeline', 'referral': 'Referido', 'other': 'Otro' }[channel] || channel || '-';
        }

        function getVerticalLabel(vertical) {
            return { 'manager': 'Manager', 'saas': 'FinSaaS', 'marketplace': 'Marketplace', 'tasks_leads': 'Tasks & Leads', 'other': 'Otro' }[vertical] || '-';
        }

        function openCreateModal() {
            document.getElementById('modal-title').textContent = 'Nuevo Lead';
            document.getElementById('lead-id').value = '';
            document.getElementById('lead-name').value = '';
            document.getElementById('lead-company').value = '';
            document.getElementById('lead-phone').value = '';
            document.getElementById('lead-email').value = '';
            document.getElementById('lead-channel').value = 'whatsapp';
            document.getElementById('lead-status').value = 'new';
            document.getElementById('lead-vertical').value = '';
            document.getElementById('lead-notes').value = '';
            document.getElementById('lead-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('lead-modal').classList.add('hidden');
        }

        async function editLead(id) {
            try {
                const response = await fetch(buildApiUrl(`/api/tasks-leads/leads/${id}`), {
                    headers: { 'Authorization': `Bearer ${session.token}`, 'X-Tenant-Id': session.user.id_tenant }
                });
                const { data: lead } = await response.json();

                document.getElementById('modal-title').textContent = 'Editar Lead';
                document.getElementById('lead-id').value = lead.id;
                document.getElementById('lead-name').value = lead.full_name || '';
                document.getElementById('lead-company').value = lead.company || '';
                document.getElementById('lead-phone').value = lead.phone || '';
                document.getElementById('lead-email').value = lead.email || '';
                document.getElementById('lead-channel').value = lead.channel || 'other';
                document.getElementById('lead-status').value = lead.status;
                document.getElementById('lead-vertical').value = lead.interested_vertical || '';
                document.getElementById('lead-notes').value = lead.notes || '';
                document.getElementById('lead-modal').classList.remove('hidden');
            } catch (error) {
                alert('Error cargando lead');
            }
        }

        async function saveLead(e) {
            e.preventDefault();
            const id = document.getElementById('lead-id').value;
            const data = {
                full_name: document.getElementById('lead-name').value || null,
                company: document.getElementById('lead-company').value || null,
                phone: document.getElementById('lead-phone').value || null,
                email: document.getElementById('lead-email').value || null,
                channel: document.getElementById('lead-channel').value,
                status: document.getElementById('lead-status').value,
                interested_vertical: document.getElementById('lead-vertical').value || null,
                notes: document.getElementById('lead-notes').value || null
            };

            try {
                const url = id ? `/api/tasks-leads/leads/${id}` : '/api/tasks-leads/leads';
                const method = id ? 'PATCH' : 'POST';

                const response = await fetch(buildApiUrl(url), {
                    method,
                    headers: {
                        'Authorization': `Bearer ${session.token}`,
                        'X-Tenant-Id': session.user.id_tenant,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Error saving');
                closeModal();
                loadLeads();
            } catch (error) {
                alert('Error guardando lead');
            }
        }

        async function closeLead(id, status) {
            const label = status === 'won' ? 'ganado' : 'perdido';
            if (!confirm(`¿Marcar este lead como ${label}?`)) return;

            try {
                await fetch(buildApiUrl(`/api/tasks-leads/leads/${id}/close`), {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.token}`,
                        'X-Tenant-Id': session.user.id_tenant,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                loadLeads();
            } catch (error) {
                alert('Error cerrando lead');
            }
        }

        async function deleteLead(id) {
            if (!confirm('¿Eliminar este lead?')) return;
            try {
                await fetch(buildApiUrl(`/api/tasks-leads/leads/${id}`), {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${session.token}`, 'X-Tenant-Id': session.user.id_tenant }
                });
                loadLeads();
            } catch (error) {
                alert('Error eliminando');
            }
        }

        init();
    </script>
</body>

</html>