<!DOCTYPE html>
<html class="dark" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Marketplace - Encuentra tu taller | VERSA</title>
    <link rel="icon" type="image/png" href="assets/favicon.png">

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- Leaflet CSS for the Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* Skeleton loader */
        @keyframes skeleton-loading {
            0% {
                background-position: -200px 0;
            }

            100% {
                background-position: calc(200px + 100%) 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg, #1E1E1E 0px, #2A2A2A 40px, #1E1E1E 80px);
            background-size: 200px 100%;
            animation: skeleton-loading 1.5s infinite;
        }

        /* Filters mobile toggle */
        .filters-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .filters-panel.open {
            max-height: 1000px;
        }

        /* Smooth transitions */
        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(255, 68, 0, 0.2);
        }
    </style>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ff4400",
                        "background-dark": "#121212",
                    },
                    fontFamily: {
                        "display": ["Montserrat", "sans-serif"]
                    },
                },
            },
        }
    </script>
</head>

<body class="bg-background-dark text-[#E0E0E0] font-display">

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-background-dark/95 backdrop-blur-sm border-b border-white/10">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="/index.html" class="flex items-center gap-4">
                        <img src="https://imgur.com/iBrjKwv.png" alt="VERSA Logo" class="h-6 w-auto">
                        <h2 class="text-xl font-bold tracking-tight text-white">Marketplace</h2>
                    </a>
                </div>
                <div class="flex items-center gap-4">
                    <a href="/index.html" class="text-sm text-[#A0A0A0] hover:text-white transition-colors">
                        ← Volver
                    </a>
                    <a href="/login.html"
                        class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold tracking-wide transition-opacity hover:opacity-90">
                        <span class="truncate">Ingresar</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Hero Search Bar -->
        <div class="mb-8 bg-gradient-to-r from-primary/20 to-transparent border border-primary/30 rounded-2xl p-6">
            <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">Encuentra tu taller ideal</h1>
            <p class="text-gray-400 mb-4">Busca entre cientos de talleres verificados cerca de ti</p>

            <!-- Main Search -->
            <div class="flex flex-col md:flex-row gap-3 mb-4">
                <div class="flex-1 relative">
                    <span
                        class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">search</span>
                    <input type="text" id="mainSearch" placeholder="Buscar taller, servicio o ubicación..."
                        class="w-full pl-12 pr-4 py-4 bg-[#1E1E1E] border border-white/10 rounded-xl text-white placeholder-gray-500 focus:border-primary focus:ring-2 focus:ring-primary/30 transition-all text-lg">
                </div>
                <button id="mainSearchBtn"
                    class="px-8 py-4 bg-primary text-white font-bold rounded-xl hover:bg-primary/90 transition-colors flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">search</span>
                    <span>Buscar</span>
                </button>
            </div>

            <!-- Quick Services -->
            <div class="flex flex-wrap gap-2">
                <span class="text-gray-500 text-sm mr-2 self-center">Servicios populares:</span>
                <button type="button" data-service="aceite"
                    class="quick-service-chip px-4 py-2 bg-[#1E1E1E] border border-white/10 rounded-full text-sm text-white hover:border-primary hover:bg-primary/10 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined" style="font-size: 18px;">oil_barrel</span>
                    Cambio de aceite
                </button>
                <button type="button" data-service="frenos"
                    class="quick-service-chip px-4 py-2 bg-[#1E1E1E] border border-white/10 rounded-full text-sm text-white hover:border-primary hover:bg-primary/10 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined" style="font-size: 18px;">brake_alert</span>
                    Frenos
                </button>
                <button type="button" data-service="neumaticos"
                    class="quick-service-chip px-4 py-2 bg-[#1E1E1E] border border-white/10 rounded-full text-sm text-white hover:border-primary hover:bg-primary/10 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined" style="font-size: 18px;">tire_repair</span>
                    Neumáticos
                </button>
                <button type="button" data-service="revision"
                    class="quick-service-chip px-4 py-2 bg-[#1E1E1E] border border-white/10 rounded-full text-sm text-white hover:border-primary hover:bg-primary/10 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined" style="font-size: 18px;">build_circle</span>
                    Revisión
                </button>
                <button type="button" data-service="itv"
                    class="quick-service-chip px-4 py-2 bg-[#1E1E1E] border border-white/10 rounded-full text-sm text-white hover:border-primary hover:bg-primary/10 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined" style="font-size: 18px;">verified</span>
                    Pre-ITV
                </button>
            </div>
        </div>

        <!-- Mobile Filters Toggle -->
        <div class="lg:hidden mb-4">
            <button id="toggleFilters"
                class="w-full flex items-center justify-between px-4 py-3 bg-[#1E1E1E] border border-white/10 rounded-lg text-white font-semibold hover:border-primary/50 transition-colors">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined">tune</span>
                    <span>Filtros</span>
                </div>
                <span id="filterIcon" class="material-symbols-outlined">expand_more</span>
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- Filters Sidebar -->
            <aside id="filtersPanel" class="lg:block filters-panel lg:open">
                <div class="bg-[#1E1E1E] border border-white/10 rounded-xl p-6 sticky top-24">
                    <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">tune</span>
                        Filtros
                    </h2>

                    <form id="filterForm" class="space-y-4">

                        <!-- Búsqueda rápida -->
                        <div>
                            <label class="block text-sm font-semibold text-white mb-2">Buscar taller</label>
                            <input type="text" id="busqueda" placeholder="Nombre del taller..."
                                class="w-full px-4 py-2 bg-[#121212] border border-white/10 rounded-lg text-white placeholder-[#707070] focus:border-primary focus:ring-1 focus:ring-primary transition-colors">
                        </div>

                        <!-- Ubicación -->
                        <div>
                            <label class="block text-sm font-semibold text-white mb-2">Ubicación</label>
                            <input type="text" id="ubicacion" placeholder="Zona o código postal"
                                class="w-full px-4 py-2 bg-[#121212] border border-white/10 rounded-lg text-white placeholder-[#707070] focus:border-primary focus:ring-1 focus:ring-primary transition-colors">
                            <button type="button" id="useLocation"
                                class="mt-2 text-sm text-primary hover:text-white transition-colors flex items-center gap-1">
                                <span class="material-symbols-outlined" style="font-size: 18px;">my_location</span>
                                <span>Usar mi ubicación</span>
                            </button>
                        </div>

                        <!-- Distancia -->
                        <div>
                            <label class="block text-sm font-semibold text-white mb-2">Distancia</label>
                            <select id="distancia"
                                class="w-full px-4 py-2 bg-[#121212] border border-white/10 rounded-lg text-white focus:border-primary focus:ring-1 focus:ring-primary transition-colors">
                                <option value="1">1 km</option>
                                <option value="2">2 km</option>
                                <option value="5" selected>5 km</option>
                                <option value="10">10 km</option>
                                <option value="20">20 km</option>
                            </select>
                        </div>

                        <!-- Servicio -->
                        <div>
                            <label class="block text-sm font-semibold text-white mb-2">Servicio</label>
                            <select id="servicio"
                                class="w-full px-4 py-2 bg-[#121212] border border-white/10 rounded-lg text-white focus:border-primary focus:ring-1 focus:ring-primary transition-colors">
                                <option value="">Todos</option>
                                <option value="aceite">Cambio de aceite</option>
                                <option value="frenos">Frenos</option>
                                <option value="neumaticos">Neumáticos</option>
                                <option value="diagnosis">Diagnóstico</option>
                                <option value="itv">ITV</option>
                                <option value="revision">Revisión general</option>
                            </select>
                        </div>

                        <!-- Tipo Vehículo -->
                        <div>
                            <label class="block text-sm font-semibold text-white mb-2">Tipo de vehículo</label>
                            <select id="tipoVehiculo"
                                class="w-full px-4 py-2 bg-[#121212] border border-white/10 rounded-lg text-white focus:border-primary focus:ring-1 focus:ring-primary transition-colors">
                                <option value="">Todos</option>
                                <option value="moto">Moto</option>
                                <option value="coche">Coche</option>
                                <option value="bici">Bici/E-bike</option>
                            </select>
                        </div>

                        <!-- Precio -->
                        <div>
                            <label class="block text-sm font-semibold text-white mb-2">Rango de precio (€)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="precioMin" placeholder="Mín"
                                    class="w-full px-4 py-2 bg-[#121212] border border-white/10 rounded-lg text-white placeholder-[#707070] focus:border-primary focus:ring-1 focus:ring-primary transition-colors">
                                <input type="number" id="precioMax" placeholder="Máx"
                                    class="w-full px-4 py-2 bg-[#121212] border border-white/10 rounded-lg text-white placeholder-[#707070] focus:border-primary focus:ring-1 focus:ring-primary transition-colors">
                            </div>
                        </div>

                        <!-- Rating -->
                        <div>
                            <label class="block text-sm font-semibold text-white mb-2">Rating mínimo</label>
                            <select id="ratingMin"
                                class="w-full px-4 py-2 bg-[#121212] border border-white/10 rounded-lg text-white focus:border-primary focus:ring-1 focus:ring-primary transition-colors">
                                <option value="">Todos</option>
                                <option value="3">3+ estrellas</option>
                                <option value="4">4+ estrellas</option>
                                <option value="4.5">4.5+ estrellas</option>
                            </select>
                        </div>

                        <!-- Fecha -->
                        <div>
                            <label class="block text-sm font-semibold text-white mb-2">Fecha</label>
                            <input type="date" id="fecha"
                                class="w-full px-4 py-2 bg-[#121212] border border-white/10 rounded-lg text-white focus:border-primary focus:ring-1 focus:ring-primary transition-colors">
                        </div>

                        <!-- Solo Ofertas -->
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="soloOfertas"
                                class="w-5 h-5 bg-[#121212] border-white/10 rounded text-primary focus:ring-primary focus:ring-offset-0">
                            <label for="soloOfertas" class="text-sm font-semibold text-white cursor-pointer">Solo
                                ofertas</label>
                        </div>

                        <!-- Buttons -->
                        <div class="space-y-2 pt-4">
                            <button type="submit"
                                class="w-full px-4 py-3 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity">
                                Buscar
                            </button>
                            <button type="button" id="clearFilters"
                                class="w-full px-4 py-3 bg-white/5 border border-white/10 text-white font-semibold rounded-lg hover:bg-white/10 transition-colors">
                                Limpiar filtros
                            </button>
                        </div>

                    </form>
                </div>
            </aside>

            <!-- Results Section -->
            <div class="lg:col-span-3 space-y-6">

                <!-- Results Header -->
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold text-white">
                        <span id="resultsCount">Cargando...</span>
                    </h1>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-[#A0A0A0]">Ordenar por:</span>
                        <select id="sortBy"
                            class="px-3 py-2 bg-[#1E1E1E] border border-white/10 rounded-lg text-white text-sm focus:border-primary focus:ring-1 focus:ring-primary transition-colors">
                            <option value="rating">Mejor valorados</option>
                            <option value="precio">Precio</option>
                            <option value="distancia">Distancia</option>
                            <option value="disponibilidad">Disponibilidad</option>
                        </select>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="space-y-4">
                    <div class="skeleton h-64 rounded-xl"></div>
                    <div class="skeleton h-64 rounded-xl"></div>
                    <div class="skeleton h-64 rounded-xl"></div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="hidden text-center py-16">
                    <span class="material-symbols-outlined text-[#707070]" style="font-size: 80px;">search_off</span>
                    <h3 class="text-xl font-bold text-white mt-4">No se encontraron talleres</h3>
                    <p class="text-[#A0A0A0] mt-2">Intenta ajustar los filtros de búsqueda</p>
                </div>

                <!-- Error State -->
                <div id="errorState" class="hidden">
                    <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 mb-4">
                        <div class="flex items-center gap-2 text-yellow-500">
                            <span class="material-symbols-outlined">warning</span>
                            <span class="font-semibold">Modo sin conexión</span>
                        </div>
                        <p class="text-sm text-yellow-500/80 mt-1">Mostrando datos de demostración</p>
                    </div>
                </div>

                <!-- Results Grid (Cards) -->
                <div id="resultsCards" class="hidden space-y-4">
                    <!-- Cards will be inserted here by JavaScript -->
                </div>

                <!-- Results Table -->
                <div id="resultsTable" class="hidden overflow-x-auto">
                    <table class="w-full bg-[#1E1E1E] border border-white/10 rounded-xl overflow-hidden">
                        <thead>
                            <tr class="bg-[#121212] border-b border-white/10">
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white">Taller</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white">Zona</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white">Desde</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white">Rating</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white">Próxima cita</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-white">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- Table rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Map -->
                <div class="bg-[#1E1E1E] border border-white/10 rounded-xl p-4">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">map</span>
                        Mapa de talleres
                    </h3>
                    <div id="map" class="w-full h-[400px] rounded-lg"></div>
                </div>

            </div>
        </div>

    </main>

    <!-- Leaflet Script -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- App Script -->
    <script type="module">
        import { searchMarketplace } from './services/marketplace-service.js';

        // State
        let currentResults = [];
        let map = null;
        let markers = [];

        // DOM Elements
        const filterForm = document.getElementById('filterForm');
        const clearFiltersBtn = document.getElementById('clearFilters');
        const useLocationBtn = document.getElementById('useLocation');
        const toggleFiltersBtn = document.getElementById('toggleFilters');
        const filtersPanel = document.getElementById('filtersPanel');
        const filterIcon = document.getElementById('filterIcon');

        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const errorState = document.getElementById('errorState');
        const resultsCards = document.getElementById('resultsCards');
        const resultsTable = document.getElementById('resultsTable');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const resultsCount = document.getElementById('resultsCount');
        const sortBy = document.getElementById('sortBy');

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadResults();
            setupEventListeners();
        });

        // Event Listeners
        function setupEventListeners() {
            // Form submit
            filterForm.addEventListener('submit', (e) => {
                e.preventDefault();
                loadResults();
            });

            // Clear filters
            clearFiltersBtn.addEventListener('click', () => {
                filterForm.reset();
                loadResults();
            });

            // Use location
            useLocationBtn.addEventListener('click', async () => {
                if ('geolocation' in navigator) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject);
                        });

                        document.getElementById('ubicacion').value = `${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`;
                        loadResults();
                    } catch (error) {
                        alert('No se pudo obtener tu ubicación. Por favor, activa los permisos de ubicación.');
                    }
                } else {
                    alert('Tu navegador no soporta geolocalización.');
                }
            });

            // Toggle filters (mobile)
            if (toggleFiltersBtn) {
                toggleFiltersBtn.addEventListener('click', () => {
                    filtersPanel.classList.toggle('open');
                    const isOpen = filtersPanel.classList.contains('open');
                    filterIcon.textContent = isOpen ? 'expand_less' : 'expand_more';
                });
            }

            // Sort
            sortBy.addEventListener('change', () => {
                sortResults();
                renderResults();
            });

            // Main search bar
            const mainSearchInput = document.getElementById('mainSearch');
            const mainSearchBtn = document.getElementById('mainSearchBtn');

            if (mainSearchBtn) {
                mainSearchBtn.addEventListener('click', () => {
                    const searchValue = mainSearchInput.value.trim();
                    document.getElementById('busqueda').value = searchValue;
                    loadResults();
                });
            }

            if (mainSearchInput) {
                mainSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.getElementById('busqueda').value = mainSearchInput.value.trim();
                        loadResults();
                    }
                });
            }

            // Quick service chips
            const serviceChips = document.querySelectorAll('.quick-service-chip');
            serviceChips.forEach(chip => {
                chip.addEventListener('click', () => {
                    const service = chip.dataset.service;
                    const currentService = document.getElementById('servicio').value;

                    // Toggle: si ya está seleccionado, deseleccionar
                    if (currentService === service) {
                        document.getElementById('servicio').value = '';
                        chip.classList.remove('border-primary', 'bg-primary/20');
                    } else {
                        document.getElementById('servicio').value = service;
                        // Update chip visuals
                        serviceChips.forEach(c => c.classList.remove('border-primary', 'bg-primary/20'));
                        chip.classList.add('border-primary', 'bg-primary/20');
                    }

                    loadResults();
                });
            });
        }

        // Load Results
        async function loadResults() {
            // Show loading
            loadingState.classList.remove('hidden');
            emptyState.classList.add('hidden');
            errorState.classList.add('hidden');
            resultsCards.classList.add('hidden');
            resultsTable.classList.add('hidden');

            // Get filter values
            const params = {
                ubicacion: document.getElementById('ubicacion').value,
                distancia: document.getElementById('distancia').value,
                servicio: document.getElementById('servicio').value,
                tipoVehiculo: document.getElementById('tipoVehiculo').value,
                precioMin: document.getElementById('precioMin').value,
                precioMax: document.getElementById('precioMax').value,
                ratingMin: document.getElementById('ratingMin').value,
                fecha: document.getElementById('fecha').value,
                soloOfertas: document.getElementById('soloOfertas').checked,
            };

            try {
                const response = await searchMarketplace(params);

                // Extract data array from response (API returns {ok, data} or array directly)
                let results = [];
                if (Array.isArray(response)) {
                    results = response;
                } else if (response && response.data && Array.isArray(response.data)) {
                    results = response.data;
                } else if (response && response.ok && response.data) {
                    results = response.data;
                }

                // Apply search filter if present (also sync mainSearch)
                const busqueda = document.getElementById('busqueda').value.toLowerCase().trim();
                const mainSearchValue = document.getElementById('mainSearch')?.value.toLowerCase().trim() || '';
                const searchTerm = busqueda || mainSearchValue;

                if (searchTerm) {
                    results = results.filter(t => {
                        // Buscar en nombre y dirección
                        const matchNombre = (t.nombre && t.nombre.toLowerCase().includes(searchTerm)) ||
                            (t.direccion && t.direccion.toLowerCase().includes(searchTerm)) ||
                            (t.titulo_publico && t.titulo_publico.toLowerCase().includes(searchTerm)) ||
                            (t.sucursal_nombre && t.sucursal_nombre.toLowerCase().includes(searchTerm));

                        // Buscar en servicios destacados
                        const servicios = t.servicios_destacados || [];
                        const matchServicio = servicios.some(s =>
                            s.nombre && s.nombre.toLowerCase().includes(searchTerm)
                        );

                        return matchNombre || matchServicio;
                    });
                }

                currentResults = results;
                sortResults();
                renderResults();
                renderMap();
            } catch (error) {
                console.error('Error loading results:', error);
                currentResults = [];
                renderResults();
            } finally {
                loadingState.classList.add('hidden');
            }
        }

        // Sort Results
        function sortResults() {
            if (!Array.isArray(currentResults) || currentResults.length === 0) return;

            const sortValue = sortBy.value;

            currentResults.sort((a, b) => {
                switch (sortValue) {
                    case 'rating':
                        return (parseFloat(b.rating) || 0) - (parseFloat(a.rating) || 0);
                    case 'precio':
                        const serviciosA = a.servicios_destacados || [];
                        const serviciosB = b.servicios_destacados || [];
                        const precioA = serviciosA.length > 0 ? Math.min(...serviciosA.map(s => parseFloat(s.precio) || 999999)) : 999999;
                        const precioB = serviciosB.length > 0 ? Math.min(...serviciosB.map(s => parseFloat(s.precio) || 999999)) : 999999;
                        return precioA - precioB;
                    case 'distancia':
                        // TODO: Implement real distance calculation
                        return 0;
                    case 'disponibilidad':
                        const citaA = a.proximaCita || 'zzz';
                        const citaB = b.proximaCita || 'zzz';
                        return citaA.localeCompare(citaB);
                    default:
                        return 0;
                }
            });
        }

        // Render Results
        function renderResults() {
            if (currentResults.length === 0) {
                emptyState.classList.remove('hidden');
                resultsCards.classList.add('hidden');
                resultsTable.classList.add('hidden');
                resultsCount.textContent = 'No hay resultados';
                return;
            }

            // Update count
            resultsCount.textContent = `${currentResults.length} talleres encontrados`;

            // Render Cards
            resultsCards.innerHTML = currentResults.map(taller => {
                const servicios = taller.servicios_destacados || [];
                const rating = parseFloat(taller.rating) || 0;
                const reviewsCount = taller.reviews_count || 0;
                const zona = taller.zona || '';
                const direccion = taller.direccion || 'Sin dirección';
                const proximaCita = taller.proximaCita || 'Consultar';

                return `
        <div class="bg-[#1E1E1E] border border-white/10 rounded-xl p-6 card-hover cursor-pointer" 
             data-id="${taller.id_sucursal}"
             onclick="viewTaller(${taller.id_sucursal})">
          <div class="flex flex-col sm:flex-row gap-4">
            
            <!-- Left: Info -->
            <div class="flex-1">
              <div class="flex items-start justify-between mb-2">
                <div>
                  <h3 class="text-xl font-bold text-white mb-1">${taller.nombre || taller.titulo_publico || 'Taller'}</h3>
                  <p class="text-sm text-[#A0A0A0] flex items-center gap-1">
                    <span class="material-symbols-outlined" style="font-size: 16px;">location_on</span>
                    ${zona ? zona + ' · ' : ''}${direccion}
                  </p>
                </div>
                ${taller.tiene_oferta ? `
                  <span class="px-3 py-1 bg-primary/20 border border-primary rounded-full text-primary text-xs font-bold">
                    OFERTA
                  </span>
                ` : ''}
              </div>
              
              <!-- Rating -->
              <div class="flex items-center gap-2 mb-4">
                <div class="flex items-center gap-1 text-yellow-500">
                  <span class="material-symbols-outlined" style="font-size: 20px; font-variation-settings: 'FILL' 1;">star</span>
                  <span class="font-bold">${rating.toFixed(1)}</span>
                </div>
                <span class="text-sm text-[#707070]">(${reviewsCount} reseñas)</span>
              </div>

              <!-- Servicios destacados -->
              <div class="space-y-2 mb-4">
                ${servicios.length > 0 ? servicios.slice(0, 3).map(servicio => `
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-white">${servicio.nombre}</span>
                    <div class="flex items-center gap-3">
                      <span class="text-[#A0A0A0]">${servicio.duracion_min} min</span>
                      <span class="font-bold text-primary">${servicio.precio}€</span>
                    </div>
                  </div>
                `).join('') : '<p class="text-sm text-[#707070]">Consultar servicios disponibles</p>'}
              </div>

              <!-- Proxima cita -->
              <div class="flex items-center gap-2 text-sm">
                <span class="material-symbols-outlined text-primary" style="font-size: 18px;">schedule</span>
                <span class="text-[#A0A0A0]">Próxima disponibilidad:</span>
                <span class="font-semibold text-white">${proximaCita}</span>
              </div>
            </div>

            <!-- Right: CTA -->
            <div class="flex flex-col justify-center">
              <button onclick="viewTaller(${taller.id_sucursal}); event.stopPropagation();"
                class="px-6 py-3 bg-primary text-white font-bold rounded-lg hover:opacity-90 transition-opacity whitespace-nowrap">
                Ver taller
              </button>
            </div>

          </div>
        </div>
      `;
            }).join('');

            // Render Table  
            resultsTableBody.innerHTML = currentResults.map(taller => {
                const servicios = taller.servicios_destacados || [];
                const precioMin = servicios.length > 0 ? Math.min(...servicios.map(s => parseFloat(s.precio) || 0)) : '-';
                const rating = parseFloat(taller.rating) || 0;
                const zona = taller.zona || '-';
                const proximaCita = taller.proximaCita || 'Consultar';

                return `
          <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
            <td class="px-4 py-3">
              <div class="font-semibold text-white">${taller.nombre || taller.titulo_publico || 'Taller'}</div>
              <div class="text-xs text-[#707070]">${taller.direccion || ''}</div>
            </td>
            <td class="px-4 py-3 text-sm text-[#A0A0A0]">${zona}</td>
            <td class="px-4 py-3">
              <span class="font-bold text-primary">${precioMin === '-' ? precioMin : precioMin + '€'}</span>
            </td>
            <td class="px-4 py-3">
              <div class="flex items-center gap-1 text-yellow-500 text-sm">
                <span class="material-symbols-outlined" style="font-size: 16px; font-variation-settings: 'FILL' 1;">star</span>
                <span class="font-semibold">${rating.toFixed(1)}</span>
              </div>
            </td>
            <td class="px-4 py-3 text-sm text-white">${proximaCita}</td>
            <td class="px-4 py-3">
              <button onclick="viewTaller(${taller.id_sucursal})"
                class="px-4 py-2 bg-primary/20 border border-primary text-primary text-sm font-bold rounded hover:bg-primary hover:text-white transition-colors">
                Ver
              </button>
            </td>
          </tr>
        `;
            }).join('');

            // Show results
            resultsCards.classList.remove('hidden');
            resultsTable.classList.remove('hidden');
        }

        // Init Map
        function initMap() {
            map = L.map('map').setView([40.4168, -3.7038], 12);

            // Dark theme tiles
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);
        }

        // ===== SAFE COORDINATE UTILITIES =====
        function toNum(v) {
            if (v === null || v === undefined || v === '') return null;
            const n = typeof v === 'string' ? parseFloat(v.replace(',', '.')) : Number(v);
            return Number.isFinite(n) ? n : null;
        }

        function isValidLatLng(lat, lng) {
            return Number.isFinite(lat) && Number.isFinite(lng)
                && Math.abs(lat) <= 90 && Math.abs(lng) <= 180;
        }

        function safeAddMarker(taller) {
            const lat = toNum(taller.lat);
            const lng = toNum(taller.lng);

            if (!isValidLatLng(lat, lng)) {
                console.warn('[Marketplace] Marker omitido por coords inválidas:', {
                    id: taller.id_sucursal,
                    nombre: taller.nombre || taller.titulo_publico,
                    rawLat: taller.lat,
                    rawLng: taller.lng
                });
                return null;
            }

            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `
              <div style="position: relative; width: 32px; height: 32px;">
                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 68, 0, 0.5); border-radius: 50%; animation: pulse 2s infinite;"></div>
                <img src="https://imgur.com/iBrjKwv.png" style="width: 32px; height: 32px; position: relative; z-index: 2; border-radius: 50%; border: 2px solid #ff4400; background: #121212;" />
              </div>
            `,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                })
            }).addTo(map);

            const nombre = taller.nombre || taller.titulo_publico || 'Taller';
            const direccion = taller.direccion || '';
            const rating = parseFloat(taller.rating) || 0;
            const reviewsCount = taller.reviews_count || 0;

            marker.bindPopup(`
          <div style="font-family: Montserrat, sans-serif;">
            <h3 style="font-weight: bold; margin-bottom: 4px;">${nombre}</h3>
            <p style="font-size: 12px; color: #707070; margin-bottom: 8px;">${direccion}</p>
            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 8px;">
              <span style="color: #fbbf24;">★</span>
              <span style="font-weight: 600;">${rating.toFixed(1)}</span>
              <span style="font-size: 12px; color: #707070;">(${reviewsCount})</span>
            </div>
            <button onclick="viewTaller(${taller.id_sucursal})" 
                    style="width: 100%; padding: 8px; background: #ff4400; color: white; font-weight: bold; border: none; border-radius: 6px; cursor: pointer;">
              Ver taller
            </button>
          </div>
        `);

            return marker;
        }

        // Render Map (SAFE - no crash on null coords)
        function renderMap() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            if (currentResults.length === 0) return;

            let invalidCount = 0;

            // Add markers (only for items with valid coords)
            currentResults.forEach(taller => {
                const marker = safeAddMarker(taller);
                if (marker) {
                    markers.push(marker);
                } else {
                    invalidCount++;
                }
            });

            // Log summary if there were items without location
            if (invalidCount > 0) {
                console.warn(`[Marketplace] ${invalidCount} talleres sin ubicación (no aparecen en el mapa)`);
            }

            // Fit bounds only if we have valid markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // View Taller (navigate to detail page)
        window.viewTaller = function (id) {
            window.location.href = `/marketplace-taller.html?id_sucursal=${id}`;
        };
    </script>

</body>

</html>