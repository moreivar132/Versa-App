
> versa-backend@1.0.0 test
> jest --detectOpenHandles -c jest.qa.config.js tests/integration/contabilidad.qa.test.js

  console.log
    [dotenv@17.2.3] injecting env (10) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.log
    [dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

      at _log (../node_modules/dotenv/lib/main.js:142:11)

  console.warn
    EmailService: No SMTP credentials found (SMTP_HOST, SMTP_USER, SMTP_PASS). Emails will be logged to console only.

      21 |             console.log('EmailService: SMTP Transporter initialized');
      22 |         } else {
    > 23 |             console.warn('EmailService: No SMTP credentials found (SMTP_HOST, SMTP_USER, SMTP_PASS). Emails will be logged to console only.');
         |                     ^
      24 |         }
      25 |     }
      26 |

      at EmailService.warn (services/emailService.js:23:21)
      at new init (services/emailService.js:6:14)
      at Object.<anonymous> (services/emailService.js:94:18)
      at Object.require (routes/billingRoutes.js:22:22)
      at require (src/app.js:104:29)
      at Object.createApp (src/app.js:167:13)
      at Object.require (tests/integration/contabilidad.qa.test.js:2:17)

  console.log
    ðŸ”Œ ConexiÃ³n exitosa a la base de datos de Neon!

      at BoundPool.log (db.js:24:11)

  console.info
    {"timestamp":"2026-01-13T17:47:49.792Z","level":"info","message":"Incoming request","requestId":"ad11eb64-37d7-4aa7-9b00-d55c7becfba0","method":"GET","url":"/api/contabilidad/empresas"}

      at Object.info (src/core/logging/logger.js:45:21)

  console.log
    ðŸ”Œ ConexiÃ³n exitosa a la base de datos de Neon!

      at BoundPool.log (db.js:24:11)

  console.info
    {"timestamp":"2026-01-13T17:47:50.184Z","level":"info","message":"Incoming request","requestId":"b9d5ae9c-529e-4df0-a498-bbfab38cfc89","method":"GET","url":"/api/contabilidad/empresas"}

      at Object.info (src/core/logging/logger.js:45:21)

  console.info
    {"timestamp":"2026-01-13T17:47:50.272Z","level":"info","message":"Incoming request","requestId":"1263674c-9a01-44fc-a47b-0141ce6157b9","method":"POST","url":"/api/contabilidad/facturas"}

      at Object.info (src/core/logging/logger.js:45:21)

  console.info
    {"timestamp":"2026-01-13T17:47:50.343Z","level":"info","message":"Incoming request","requestId":"a2f9264d-6fc0-47fe-9b4d-e29a9c8af270","method":"POST","url":"/api/contabilidad/facturas"}

      at Object.info (src/core/logging/logger.js:45:21)

  console.info
    {"timestamp":"2026-01-13T17:47:50.416Z","level":"info","message":"Incoming request","requestId":"3b7ad6a6-1eff-4343-b35c-3df65cbf2252","method":"POST","url":"/api/contabilidad/facturas"}

      at Object.info (src/core/logging/logger.js:45:21)

  console.info
    {"timestamp":"2026-01-13T17:47:50.595Z","level":"info","message":"Incoming request","requestId":"4c556fae-7300-4d00-80bd-45bd8e26a6b9","method":"POST","url":"/api/contabilidad/contactos"}

      at Object.info (src/core/logging/logger.js:45:21)

  console.info
    {"timestamp":"2026-01-13T17:47:50.700Z","level":"info","message":"Incoming request","requestId":"9cead9cb-a237-4ddf-af2b-76508f80eeb4","method":"GET","url":"/api/contabilidad/dashboard?anio=2026&trimestre=1"}

      at Object.info (src/core/logging/logger.js:45:21)

  console.info
    {"timestamp":"2026-01-13T17:47:50.817Z","level":"info","message":"Incoming request","requestId":"fdddc69e-a213-4c6b-9e8b-454cdd81bda6","method":"GET","url":"/api/contabilidad/dashboard?anio=2026&trimestre=1"}

      at Object.info (src/core/logging/logger.js:45:21)

FAIL tests/integration/contabilidad.qa.test.js
  Contabilidad V2 Integration Tests (QA)
    GET /api/contabilidad/empresas
      âœ• QA-01: Admin A should see companies A1 and A2 (408 ms)
      âœ• QA-02: Admin B should NOT see companies from Tenant A (72 ms)
    POST /api/contabilidad/facturas
      âœ• QA-03: Should fail if x-empresa-id header is missing (86 ms)
      âœ“ QA-04: Should fail if accessing empresa from another tenant (72 ms)
      âœ• QA-05: Should create invoice in correct empresa context (174 ms)
    GET /api/contabilidad/contactos
      âœ• QA-06: Should verify IBAN format on creation (92 ms)
    GET /api/contabilidad/dashboard
      âœ• QA-07: Should return distinct metrics for different companies (210 ms)

  â— Contabilidad V2 Integration Tests (QA) â€º GET /api/contabilidad/empresas â€º QA-01: Admin A should see companies A1 and A2

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      55 |                 .set('Authorization', `Bearer ${tokens.adminA}`);
      56 |
    > 57 |             expect(res.statusCode).toBe(200);
         |                                    ^
      58 |             expect(res.body.items).toHaveLength(2);
      59 |             expect(res.body.items.map(e => e.id)).toContain(data.empresaA1);
      60 |             expect(res.body.items.map(e => e.id)).toContain(data.empresaA2);

      at Object.toBe (tests/integration/contabilidad.qa.test.js:57:36)

  â— Contabilidad V2 Integration Tests (QA) â€º GET /api/contabilidad/empresas â€º QA-02: Admin B should NOT see companies from Tenant A

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      66 |                 .set('Authorization', `Bearer ${tokens.adminB}`);
      67 |
    > 68 |             expect(res.statusCode).toBe(200);
         |                                    ^
      69 |             // Admin B has 1 company (B1)
      70 |             expect(res.body.items).toHaveLength(1);
      71 |             expect(res.body.items[0].id).not.toBe(data.empresaA1);

      at Object.toBe (tests/integration/contabilidad.qa.test.js:68:36)

  â— Contabilidad V2 Integration Tests (QA) â€º POST /api/contabilidad/facturas â€º QA-03: Should fail if x-empresa-id header is missing

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 403

      92 |             // Expect 400 or 403 depending on middleware impl.
      93 |             // Middleware checks header/query. If missing => 400 'Empresa ID requerida'
    > 94 |             expect(res.statusCode).toBe(400);
         |                                    ^
      95 |         });
      96 |
      97 |         it('QA-04: Should fail if accessing empresa from another tenant', async () => {

      at Object.toBe (tests/integration/contabilidad.qa.test.js:94:36)

  â— Contabilidad V2 Integration Tests (QA) â€º POST /api/contabilidad/facturas â€º QA-05: Should create invoice in correct empresa context

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 403

      130 |                 });
      131 |
    > 132 |             expect(res.statusCode).toBe(201); // Created
          |                                    ^
      133 |             expect(res.body.id_empresa).toBe(data.empresaA1);
      134 |             expect(res.body.numero_factura).toBe('FAC-QA-TEST-1');
      135 |         });

      at Object.toBe (tests/integration/contabilidad.qa.test.js:132:36)

  â— Contabilidad V2 Integration Tests (QA) â€º GET /api/contabilidad/contactos â€º QA-06: Should verify IBAN format on creation

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 403

      156 |             // If loose => 201. Assuming loose for now or strict? 
      157 |             // Let's assume repo just stores it as text, so 201, but we verify field exists.
    > 158 |             expect(res.statusCode).toBe(201);
          |                                    ^
      159 |             expect(res.body.iban).toBe('INVALID-IBAN');
      160 |         });
      161 |     });

      at Object.toBe (tests/integration/contabilidad.qa.test.js:158:36)

  â— Contabilidad V2 Integration Tests (QA) â€º GET /api/contabilidad/dashboard â€º QA-07: Should return distinct metrics for different companies

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      179 |                 .set('x-empresa-id', data.empresaA2);
      180 |
    > 181 |             expect(resA1.statusCode).toBe(200);
          |                                      ^
      182 |             expect(resA2.statusCode).toBe(200);
      183 |
      184 |             // Verify they are different

      at Object.toBe (tests/integration/contabilidad.qa.test.js:181:38)

Test Suites: 1 failed, 1 total
Tests:       6 failed, 1 passed, 7 total
Snapshots:   0 total
Time:        2.802 s, estimated 5 s
Ran all test suites matching /tests\/integration\/contabilidad.qa.test.js/i.

Jest has detected the following 1 open handle potentially keeping Jest from exiting:

  â—  Timeout

      38 |
      39 | // Limpiar rate limit map cada 5 minutos
    > 40 | setInterval(() => {
         | ^
      41 |     const now = Date.now();
      42 |     for (const [key, value] of rateLimitMap) {
      43 |         if (now > value.resetAt) {

      at Object.setInterval (routes/fidelizacionPublic.js:40:1)
      at require (src/app.js:133:41)
      at Object.createApp (src/app.js:167:13)
      at Object.require (tests/integration/contabilidad.qa.test.js:2:17)

npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path /Users/admin/Library/Mobile Documents/com~apple~CloudDocs/Versa-App/backend
npm error workspace versa-backend@1.0.0
npm error location /Users/admin/Library/Mobile Documents/com~apple~CloudDocs/Versa-App/backend
npm error command failed
npm error command sh -c jest --detectOpenHandles -c jest.qa.config.js tests/integration/contabilidad.qa.test.js
