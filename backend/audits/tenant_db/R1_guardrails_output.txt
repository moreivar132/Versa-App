
> versa-backend@1.0.0 check:db-guardrails
> node scripts/check-no-pool-query.js

ğŸ” CRIT-FIX-01 Guardrail: Scanning for pool.query violations...

ğŸ“ Scanned 120 files

âŒ VIOLATIONS FOUND:

  ğŸ“„ routes/marketplace.js:91
     const result = await pool.query(`

  ğŸ“„ routes/marketplace.js:91
     const result = await pool.query(`

  ğŸ“„ routes/marketplaceAdmin.js:425
     const result = await pool.query(`

  ğŸ“„ routes/marketplaceAdmin.js:425
     const result = await pool.query(`

  ğŸ“„ routes/meRoutes.js:84
     const result = await pool.query(`

  ğŸ“„ routes/meRoutes.js:84
     const result = await pool.query(`

  ğŸ“„ src/modules/contable/api/controllers/documentos.controller.js:206
     const intakesResult = await pool.query(intakesQuery, intakesParams);

  ğŸ“„ src/modules/contable/api/controllers/documentos.controller.js:206
     const intakesResult = await pool.query(intakesQuery, intakesParams);

  ğŸ“„ src/modules/contable/api/controllers/documentos.controller.js:216
     const facturasResult = await pool.query(facturasQuery, facturasParams);

  ğŸ“„ src/modules/contable/api/controllers/documentos.controller.js:216
     const facturasResult = await pool.query(facturasQuery, facturasParams);

  ğŸ“„ src/modules/contable/api/controllers/documentos.controller.js:419
     const intakeCheck = await pool.query(`

  ğŸ“„ src/modules/contable/api/controllers/documentos.controller.js:419
     const intakeCheck = await pool.query(`

  ğŸ“„ services/auditService.js:33
     await pool.query(`

  ğŸ“„ services/auditService.js:33
     await pool.query(`

  ğŸ“„ services/auditService.js:116
     const result = await pool.query(query, params);

  ğŸ“„ services/auditService.js:116
     const result = await pool.query(query, params);

  ğŸ“„ services/customerPortalService.js:97
     const pagoResult = await pool.query(

  ğŸ“„ services/customerPortalService.js:97
     const pagoResult = await pool.query(

  ğŸ“„ services/customerPortalService.js:108
     await pool.query(

  ğŸ“„ services/customerPortalService.js:108
     await pool.query(

  ğŸ“„ services/customerPortalService.js:123
     await pool.query(

  ğŸ“„ services/customerPortalService.js:123
     await pool.query(

  ğŸ“„ services/makeEmailProvider.js:25
     const result = await pool.query(

  ğŸ“„ services/makeEmailProvider.js:25
     const result = await pool.query(

  ğŸ“„ services/marketplaceService.js:131
     const listingResult = await pool.query(

  ğŸ“„ services/marketplaceService.js:131
     const listingResult = await pool.query(

  ğŸ“„ services/marketplaceService.js:162
     const citasResult = await pool.query(

  ğŸ“„ services/marketplaceService.js:162
     const citasResult = await pool.query(

  ğŸ“„ services/ordenPDFService.js:19
     const result = await pool.query(`

  ğŸ“„ services/ordenPDFService.js:19
     const result = await pool.query(`

  ğŸ“„ services/ordenPDFService.js:58
     const ordenResult = await pool.query(`

  ğŸ“„ services/ordenPDFService.js:58
     const ordenResult = await pool.query(`

  ğŸ“„ services/ordenPDFService.js:94
     const lineasResult = await pool.query(`

  ğŸ“„ services/ordenPDFService.js:94
     const lineasResult = await pool.query(`

  ğŸ“„ services/ordenPDFService.js:108
     const pagosResult = await pool.query(`

  ğŸ“„ services/ordenPDFService.js:108
     const pagosResult = await pool.query(`

  ğŸ“„ services/unifiedNotificationService.js:44
     const clientResult = await pool.query(

  ğŸ“„ services/unifiedNotificationService.js:44
     const clientResult = await pool.query(

  ğŸ“„ services/unifiedNotificationService.js:133
     await pool.query(`

  ğŸ“„ services/unifiedNotificationService.js:133
     await pool.query(`

  ğŸ“„ services/unifiedNotificationService.js:155
     await pool.query(`

  ğŸ“„ services/unifiedNotificationService.js:155
     await pool.query(`

  ğŸ“„ services/ventaPDFService.js:23
     const ventaResult = await pool.query(ventaQuery, [idVenta, tenantId]);

  ğŸ“„ services/ventaPDFService.js:23
     const ventaResult = await pool.query(ventaQuery, [idVenta, tenantId]);

  ğŸ“„ services/ventaPDFService.js:39
     const lineasResult = await pool.query(lineasQuery, [idVenta]);

  ğŸ“„ services/ventaPDFService.js:39
     const lineasResult = await pool.query(lineasQuery, [idVenta]);

  ğŸ“„ services/ventaPDFService.js:49
     const pagosResult = await pool.query(pagosQuery, [idVenta]);

  ğŸ“„ services/ventaPDFService.js:49
     const pagosResult = await pool.query(pagosQuery, [idVenta]);


ğŸš¨ Total violations: 48

ğŸ“– To fix:
   - Replace pool.query with getTenantDb(ctx).query()
   - Or move SQL logic to a repository in src/modules/*/infra/repos/
   - See docs/CLEANUP/CRIT_FIX_01_REPORT.md for details

npm error Lifecycle script `check:db-guardrails` failed with error:
npm error code 1
npm error path /Users/admin/Library/Mobile Documents/com~apple~CloudDocs/Versa-App/backend
npm error workspace versa-backend@1.0.0
npm error location /Users/admin/Library/Mobile Documents/com~apple~CloudDocs/Versa-App/backend
npm error command failed
npm error command sh -c node scripts/check-no-pool-query.js
