# =============================================================================
# VERSA Backend CI Pipeline
# =============================================================================
# Este workflow se ejecuta automÃ¡ticamente en cada Push y Pull Request.
# Valida que el cÃ³digo cumpla con los estÃ¡ndares de calidad antes de 
# permitir que se fusione o despliegue.
#
# DocumentaciÃ³n: https://docs.github.com/en/actions
# =============================================================================

name: Backend CI

on:
  push:
    branches: [main, master, develop, rafael]
  pull_request:
    branches: [main, master, develop]

env:
  NODE_VERSION: '20'

jobs:
  # ===========================================================================
  # JOB 1: VerificaciÃ³n de Calidad del CÃ³digo
  # ===========================================================================
  quality-check:
    name: ðŸ” Quality Check
    runs-on: ubuntu-latest
    
    steps:
      # Paso 1: Obtener el cÃ³digo del repositorio
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Paso 2: Configurar Node.js
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      # Paso 3: Instalar dependencias del backend
      - name: ðŸ“š Install Backend Dependencies
        working-directory: ./backend
        run: npm ci

      # Paso 4: Ejecutar Linting (Verificar sintaxis y estilo)
      - name: ðŸ§¹ Run Linter
        working-directory: ./backend
        run: npm run lint
        continue-on-error: true  # No bloquear por ahora, solo reportar

  # ===========================================================================
  # JOB 2: VerificaciÃ³n de Seguridad de Base de Datos
  # ===========================================================================
  db-guardrails:
    name: ðŸ›¡ï¸ DB Security Guardrails
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ðŸ“š Install Backend Dependencies
        working-directory: ./backend
        run: npm ci

      # âš ï¸ CRÃTICO: Este paso BLOQUEA si encuentra acceso directo a pool.query
      - name: ðŸ”’ Check DB Access Patterns (CRIT-FIX-01)
        working-directory: ./backend
        run: npm run check:db-guardrails

  # ===========================================================================
  # JOB 3: EjecuciÃ³n de Tests
  # ===========================================================================
  tests:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: [db-guardrails]  # Solo correr tests si los guardrails pasan
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ðŸ“š Install Backend Dependencies
        working-directory: ./backend
        run: npm ci

      # Ejecutar tests (por ahora no bloquea, solo reporta)
      - name: ðŸ§ª Run Test Suite
        working-directory: ./backend
        run: npm test
        continue-on-error: true  # TODO: Cambiar a false cuando arreglemos los 63 tests fallidos
        env:
          # Variables de entorno simuladas para tests
          NODE_ENV: test
          JWT_SECRET: test-secret-for-ci
          DATABASE_URL: postgresql://test:test@localhost:5432/test

      # Generar reporte de cobertura (opcional)
      - name: ðŸ“Š Generate Coverage Report
        working-directory: ./backend
        run: npm run test:coverage || true
        continue-on-error: true

  # ===========================================================================
  # JOB 4: Resumen Final
  # ===========================================================================
  ci-summary:
    name: âœ… CI Summary
    runs-on: ubuntu-latest
    needs: [quality-check, db-guardrails, tests]
    if: always()
    
    steps:
      - name: ðŸ“‹ Generate CI Summary
        run: |
          echo "## ðŸš€ VERSA CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Check | ${{ needs.quality-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DB Guardrails | ${{ needs.db-guardrails.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“– Ver [RUNBOOK](docs/OPERATIONS/RUNBOOK.md) para procedimientos de emergencia." >> $GITHUB_STEP_SUMMARY
